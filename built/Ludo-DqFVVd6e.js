import{B as t}from"./BaseGame-DUxbXJM9.js";import{T as e,S as s,F as i,B as n,a}from"./types-DkjE4TWX.js";import"./socket-DRbsQkF5.js";import"./index-C-PEJHEx.js";import"./react-vendor-CuhjoSvJ.js";import"./zustand-BnWM_GpQ.js";const o=["red","green","yellow","blue"];class r extends t{getInitState(){return{players:o.map((t,e)=>({id:this.players[e]?.id||null,username:this.players[e]?.username||`Player ${e+1}`,color:t,isBot:!1,tokens:this.createInitialTokens(),hasFinished:!1})),currentPlayerIndex:0,diceValue:null,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,lastMove:null,consecutiveSixes:0}}createInitialTokens(){return Array(e).fill(null).map((t,e)=>({id:e,position:{type:"home",index:e}}))}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"ROLL_DICE":this.handleRollDice(e.playerId);break;case"MOVE_TOKEN":this.handleMoveToken(e.playerId,e.tokenId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex)}}handleStartGame(){if("waiting"!==this.state.gamePhase)return;this.state.players.filter(t=>null!==t.id).length<2||(this.state.players.forEach(t=>{t.tokens=this.createInitialTokens(),t.hasFinished=!1}),this.state.gamePhase="playing",this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.winner=null,this.state.lastMove=null,this.state.consecutiveSixes=0,this.syncState(),this.checkBotTurn())}findFirstActivePlayer(){for(let t=0;t<this.state.players.length;t++)if(null!==this.state.players[t].id)return t;return 0}handleRollDice(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id!==t)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;let s;s=this.hasAnyTokenOnBoard(e)?Math.floor(6*Math.random())+1:Math.random()<.5?6:Math.floor(6*Math.random())+1,this.state.diceValue=s,this.state.hasRolled=!0,this.state.canRollAgain=!1,6===s?this.state.consecutiveSixes++:this.state.consecutiveSixes=0;const i=this.getMovableTokens(e,s);this.syncState(),0===i.length?setTimeout(()=>{this.nextTurn(),this.syncState(),this.checkBotTurn()},3e3):1!==i.length||e.isBot?this.checkBotTurn():setTimeout(()=>{this.handleMoveToken(t,i[0].id)},800)}handleMoveToken(t,e){if("playing"!==this.state.gamePhase)return;if(null===this.state.diceValue)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;const i=s.tokens.find(t=>t.id===e);if(!i)return;const n=this.state.diceValue,a=this.calculateNewPosition(i,s.color,n);if(a){if(this.state.lastMove={playerId:t,tokenId:e,from:{...i.position},to:a},i.position=a,"board"===a.type&&this.checkCapture(s.color,a.position),"finished"===a.type&&s.tokens.every(t=>"finished"===t.position.type))return s.hasFinished=!0,this.state.winner=t,this.state.gamePhase="ended",this.clearSavedState(),void this.syncState();6===n?(this.state.canRollAgain=!0,this.state.hasRolled=!1,this.state.diceValue=null):this.nextTurn(),this.syncState(),this.checkBotTurn()}}getMovableTokens(t,e){return t.tokens.filter(s=>null!==this.calculateNewPosition(s,t.color,e))}calculateNewPosition(t,e,a){const o=t.position,r=s[e];if("home"===o.type)return 6!==a?null:{type:"board",position:r};if("board"===o.type){let t=o.position,s=this.getStepsToFinishEntry(o.position,e);if(s<a){const t=a-s-1;return t>=i?null:t===i-1?{type:"finished"}:{type:"finish",position:t}}return s===a?{type:"finish",position:0}:(t=(o.position+a)%n,{type:"board",position:t})}if("finish"===o.type){const t=o.position+a;return t>i-1?null:t===i-1?{type:"finished"}:{type:"finish",position:t}}return null}getStepsToFinishEntry(t,e){const i=(s[e]+n-1)%n;return t<=i?i-t:n-t+i}checkCapture(t,e){if(!a.includes(e))for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if("board"===t.position.type&&t.position.position===e){const e=s.tokens.filter(t=>"home"===t.position.type).length;t.position={type:"home",index:e}}}nextTurn(){this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.consecutiveSixes=0;let t=this.state.currentPlayerIndex;do{t=(t+1)%this.state.players.length}while(null===this.state.players[t].id||this.state.players[t].hasFinished);this.state.currentPlayerIndex=t}hasAnyTokenOnBoard(t){if(null===t.id)return!1;for(const e of t.tokens)if("board"===e.position.type||"finish"===e.position.type)return!0;return!1}handleAddBot(t){"waiting"===this.state.gamePhase&&(t<0||t>=4||null===this.state.players[t].id&&(this.state.players[t]={...this.state.players[t],id:`BOT_${Date.now()}_${t}`,username:`Bot ${t+1}`,isBot:!0},this.syncState()))}handleRemoveBot(t){"waiting"===this.state.gamePhase&&(t<0||t>=4||this.state.players[t].isBot&&(this.state.players[t]={...this.state.players[t],id:null,username:`Player ${t+1}`,isBot:!1},this.syncState()))}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.executeBotTurn(t.id),800)}executeBotTurn(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id===t)if(this.state.hasRolled&&!this.state.canRollAgain){if(null!==this.state.diceValue){const s=this.getMovableTokens(e,this.state.diceValue);if(s.length>0){const i=this.pickBestToken(e,s,this.state.diceValue);this.handleMoveToken(t,i.id)}}}else this.handleRollDice(t)}pickBestToken(t,e,s){for(const n of e){const e=this.calculateNewPosition(n,t.color,s);if("finished"===e?.type)return n}for(const n of e){const e=this.calculateNewPosition(n,t.color,s);if("board"===e?.type&&!a.includes(e.position)&&this.canCaptureAt(t.color,e.position))return n}const i=e.find(t=>"home"===t.position.type);return i&&6===s?i:e.reduce((e,s)=>{const i=this.getTokenProgress(e,t.color);return this.getTokenProgress(s,t.color)>i?s:e})}canCaptureAt(t,e){for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if("board"===t.position.type&&t.position.position===e)return!0;return!1}getTokenProgress(t,e){const a=t.position;if("home"===a.type)return 0;if("finished"===a.type)return n+i+1;if("finish"===a.type)return n+a.position;if("board"===a.type){const t=s[e];return a.position>=t?a.position-t:n-t+a.position}return 0}requestRollDice(){const t={type:"ROLL_DICE",playerId:this.userId};this.makeAction(t)}requestMoveToken(t){const e={type:"MOVE_TOKEN",playerId:this.userId,tokenId:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeAction(e)}requestRemoveBot(t){const e={type:"REMOVE_BOT",slotIndex:t};this.makeAction(e)}requestNewGame(){this.makeAction({type:"RESET"})}reset(){this.state={...this.state,players:this.state.players.map(t=>({...t,tokens:this.createInitialTokens(),hasFinished:!1})),currentPlayerIndex:0,diceValue:null,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,lastMove:null,consecutiveSixes:0},this.syncState()}updatePlayers(t){if("waiting"!==this.state.gamePhase)return;this.state.players.forEach((t,e)=>{t.isBot||(t.id=null,t.username=`Player ${e+1}`)});let e=0;for(let s=0;s<4;s++)this.state.players[s].isBot||e<t.length&&(this.state.players[s].id=t[e].id,this.state.players[s].username=t[e].username,e++);this.syncState()}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return this.state.players.filter(t=>null!==t.id).length>=2}getMovableTokensForCurrentPlayer(){if(null===this.state.diceValue)return[];const t=this.state.players[this.state.currentPlayerIndex];return this.getMovableTokens(t,this.state.diceValue)}isTokenMovable(t){return this.getMovableTokensForCurrentPlayer().some(e=>e.id===t)}}export{r as default};
