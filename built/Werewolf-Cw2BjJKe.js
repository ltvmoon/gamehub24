import{t}from"./index-C2uk-7Ac.js";import{B as e}from"./BaseGame-C5gQy5jq.js";import{D as s,R as i,a,Q as n}from"./types-CsNQcsE1.js";import"./react-vendor-oAIxreiG.js";import"./socket-DRbsQkF5.js";import"./zustand-BCVlJ__8.js";class h extends e{isGameOver(t){return t.isGameOver}timerInterval=null;getInitState(){const t=[];for(let e=0;e<12;e++)t.push({id:null,username:`Slot ${e+1}`,role:null,isAlive:!0,isBot:!1,loverId:null,hasPendingShot:!1,hasVoted:!1,messagesRemaining:3,history:[]});return this.players.forEach((e,s)=>{s<12&&(t[s]={...t[s],id:e.id,username:e.username})}),{players:t,minPlayers:5,maxPlayers:12,phase:"setup",nightSubPhase:"done",day:0,isGameStarted:!1,isGameOver:!1,winner:null,nightActions:{wolfTarget:null,wolfVotes:[],seerTarget:null,bodyguardTarget:null,lastBodyguardTarget:null,witchHealTarget:null,witchKillTarget:null,cupidTargets:null},witchPotions:{},nightResult:null,suspicionMarkers:[],eliminationVotes:[],pendingElimination:null,chatMessages:[],config:{...s},logs:[],phaseEndTime:null,isPaused:!1,pausedTimeRemaining:null}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"JOIN_SLOT":this.handleJoinSlot(e.slotIndex,e.playerId,e.playerName);break;case"LEAVE_SLOT":this.handleLeaveSlot(e.slotIndex);break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex);break;case"UPDATE_CONFIG":this.handleUpdateConfig(e.config);break;case"START_GAME":this.handleStartGame(e.hostRole);break;case"NIGHT_ACTION":this.handleNightAction(e.playerId,e.role,e.targetId,e.useHealPotion,e.useKillPotion,e.secondTargetId);break;case"SKIP_NIGHT_ACTION":this.handleSkipNightAction(e.playerId,e.role);break;case"SEND_MESSAGE":this.handleSendMessage(e.playerId,e.content,e.messageType,e.targetPlayerId,e.quickMessageId);break;case"ADD_SUSPICION":this.handleAddSuspicion(e.playerId,e.targetId);break;case"REMOVE_SUSPICION":this.handleRemoveSuspicion(e.playerId,e.targetId);break;case"CAST_VOTE":this.handleCastVote(e.playerId,e.targetId);break;case"HUNTER_SHOOT":this.handleHunterShoot(e.playerId,e.targetId);break;case"PHASE_TIMEOUT":this.handlePhaseTimeout();break;case"SKIP_PHASE":this.handleSkipPhase();break;case"RESET_GAME":this.handleResetGame()}}updatePlayers(t){super.updatePlayers(t),this.state.isGameStarted||this.state.players.forEach(e=>{if(e.id&&!e.isBot){const s=t.find(t=>t.id===e.id);s?e.username!==s.username&&(e.username=s.username):(e.id=null,e.username=`Slot ${this.state.players.indexOf(e)+1}`,e.role=null,e.isBot=!1)}})}handleJoinSlot(t,e,s){if(this.state.isGameStarted)return;const i=this.state.players[t];if(!i||null!==i.id)return;const a=this.state.players.find(t=>t.id===e);a&&(a.id=null,a.username=`Slot ${this.state.players.indexOf(a)+1}`,a.isBot=!1),i.id=e,i.username=s,i.isBot=!1}handleLeaveSlot(t){if(this.state.isGameStarted)return;const e=this.state.players[t];e&&(e.id=null,e.username=`Slot ${t+1}`,e.isBot=!1)}handleAddBot(t){if(this.state.isGameStarted)return;const e=this.state.players[t];if(!e||null!==e.id)return;const s="Bot "+this.state.players.filter(t=>t.isBot).length;e.id=`bot_${Date.now()}_${t}`,e.username=s,e.isBot=!0}handleRemoveBot(t){if(this.state.isGameStarted)return;const e=this.state.players[t];e&&e.isBot&&(e.id=null,e.username=`Slot ${t+1}`,e.isBot=!1)}handleUpdateConfig(t){this.state.isGameStarted||(this.state.config={...this.state.config,...t})}handleStartGame(t){const e=this.state.players.filter(t=>null!==t.id);if(e.length<this.state.minPlayers)return;if(this.state.isGameStarted)return;this.assignRoles(e,t);this.state.players.filter(t=>"witch"===t.role).forEach(t=>{t.id&&(this.state.witchPotions[t.id]={hasHealPotion:!0,hasKillPotion:!0})}),this.state.isGameStarted=!0,this.state.day=1,this.addLog({en:"Game started!",vi:"Trò chơi bắt đầu!"},"info"),this.startNightPhase()}assignRoles(t,e){const s=t.length;let a=this.state.config.roles;for(i[s.toString()]&&(a=[...i[s.toString()]]);a.length<s;)a.push("villager");for(;a.length>s;){const t=a.lastIndexOf("villager");-1!==t?a.splice(t,1):a.pop()}if(e){const s=t.filter(t=>!t.isBot),i=s.length>0?s[0]:null;if(i){const t=a.indexOf(e);if(-1!==t)a.splice(t,1);else{const t=a.lastIndexOf("villager");-1!==t?a.splice(t,1):a.pop()}i.role=e}}const n=this.shuffleArray([...a]);let h=0;this.state.players.forEach(t=>{null===t.id||t.role||(t.role=n[h++]),null!==t.id&&(t.isAlive=!0,t.hasVoted=!1,t.hasPendingShot=!1,t.loverId=null,t.messagesRemaining=this.state.config.chatLimit)})}shuffleArray(t){const e=[...t];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}startNightPhase(){this.state.phase="night",this.state.nightActions={wolfTarget:null,wolfVotes:[],seerTarget:null,bodyguardTarget:null,lastBodyguardTarget:this.state.nightActions.lastBodyguardTarget,witchHealTarget:null,witchKillTarget:null,cupidTargets:this.state.nightActions.cupidTargets},1===this.state.day&&this.hasAliveRole("cupid")?this.state.nightSubPhase="cupid":this.hasAliveRole("seer")?this.state.nightSubPhase="seer":this.hasAliveRole("bodyguard")?this.state.nightSubPhase="bodyguard":this.hasAliveRole("wolf")?this.state.nightSubPhase="wolf":this.hasAliveRole("witch")?this.state.nightSubPhase="witch":this.state.nightSubPhase="done",this.startPhaseTimer(),this.processBotNightAction()}hasAliveRole(t){return this.state.players.some(e=>e.role===t&&e.isAlive)}advanceNightSubPhase(){const t=["cupid","seer","bodyguard","wolf","witch","done"];for(let e=t.indexOf(this.state.nightSubPhase)+1;e<t.length;e++){const s=t[e];if("done"===s)return void this.processNightResults();if(("cupid"!==s||1===this.state.day)&&this.hasAliveRole(s))return this.state.nightSubPhase=s,this.startPhaseTimer(),void this.processBotNightAction()}this.processNightResults()}handleNightAction(t,e,s,i,a,n){if("night"!==this.state.phase)return;const h=this.state.players.find(e=>e.id===t);if(h&&h.role===e&&h.isAlive)switch(e){case"wolf":this.handleWolfAction(t,s);break;case"seer":this.handleSeerAction(t,s);break;case"bodyguard":this.handleBodyguardAction(t,s);break;case"witch":this.handleWitchAction(t,s,i,a);break;case"cupid":this.handleCupidAction(t,s,n)}}handleWolfAction(t,e){if("wolf"!==this.state.nightSubPhase)return;const s=this.state.nightActions.wolfVotes.findIndex(e=>e.wolfId===t);-1!==s?this.state.nightActions.wolfVotes[s].targetId=e||"":e&&this.state.nightActions.wolfVotes.push({wolfId:t,targetId:e});if(this.state.players.filter(t=>"wolf"===t.role&&t.isAlive).every(t=>this.state.nightActions.wolfVotes.some(e=>e.wolfId===t.id))){const t={};this.state.nightActions.wolfVotes.forEach(e=>{t[e.targetId]=(t[e.targetId]||0)+1});let e=0,s=null;Object.entries(t).forEach(([t,i])=>{i>e&&(e=i,s=t)}),this.state.nightActions.wolfTarget=s,this.advanceNightSubPhase()}}handleSeerAction(t,e){if("seer"!==this.state.nightSubPhase)return;if(!e)return;this.state.nightActions.seerTarget=e;const s=this.state.players.find(t=>t.id===e);if(s){const e="wolf"===s.role;this.addPlayerHistory(t,"info",{vi:`Kết quả soi: ${s.username} là ${e?"MA SÓI":"Dân Làng"}`,en:`Seer Result: ${s.username} is ${e?"a WEREWOLF":"a Villager"}`},!0)}this.advanceNightSubPhase()}handleBodyguardAction(t,e){"bodyguard"===this.state.nightSubPhase&&e&&(e!==this.state.nightActions.lastBodyguardTarget?(this.state.nightActions.bodyguardTarget=e,console.log(`Bodyguard protected ${e}`),this.advanceNightSubPhase()):console.log(`Bodyguard protect failed: Cannot protect ${e} twice in a row.`))}handleWitchAction(t,e,s,i){if("witch"!==this.state.nightSubPhase)return;const a=this.state.witchPotions[t];a&&(s&&a.hasHealPotion&&this.state.nightActions.wolfTarget?(this.state.nightActions.witchHealTarget=this.state.nightActions.wolfTarget,a.hasHealPotion=!1,console.log("Witch healed:",this.state.nightActions.witchHealTarget,"Wolf target:",this.state.nightActions.wolfTarget)):s&&console.log("Witch heal failed:","Has potion:",a.hasHealPotion,"Wolf target:",this.state.nightActions.wolfTarget),i&&a.hasKillPotion&&e&&(this.state.nightActions.witchKillTarget=e,a.hasKillPotion=!1),this.advanceNightSubPhase())}handleCupidAction(t,e,s){if("cupid"!==this.state.nightSubPhase)return;if(!e||!s)return;if(1!==this.state.day)return;const i=this.state.players.find(t=>t.id===e),a=this.state.players.find(t=>t.id===s);i&&a&&(i.loverId=s,a.loverId=e,this.state.nightActions.cupidTargets=[e,s]),this.advanceNightSubPhase()}handleSkipNightAction(t,e){if("night"!==this.state.phase)return;const s=this.state.players.find(e=>e.id===t);s&&s.role===e&&s.isAlive&&("witch"!==e&&"bodyguard"!==e||this.advanceNightSubPhase())}processNightResults(){const t={killedByWolves:null,savedByBodyguard:!1,savedByWitch:!1,killedByWitch:null};if(this.state.nightActions.wolfTarget){const e=this.state.nightActions.bodyguardTarget===this.state.nightActions.wolfTarget,s=!!this.state.nightActions.witchHealTarget&&this.state.nightActions.witchHealTarget===this.state.nightActions.wolfTarget;console.log("Process Night Result:",{wolfTarget:this.state.nightActions.wolfTarget,healTarget:this.state.nightActions.witchHealTarget,isHealed:s}),e?t.savedByBodyguard=!0:s?t.savedByWitch=!0:t.killedByWolves=this.state.nightActions.wolfTarget}if(this.state.nightActions.witchKillTarget&&(t.killedByWitch=this.state.nightActions.witchKillTarget),this.state.nightActions.seerTarget){const e=this.state.players.find(t=>t.id===this.state.nightActions.seerTarget);e&&e.role&&(t.seerCheck={targetId:e.id,isWolf:"wolf"===e.role})}this.state.nightActions.lastBodyguardTarget=this.state.nightActions.bodyguardTarget,this.state.nightResult=t,this.startMorningPhase()}startMorningPhase(){this.state.phase="morning",this.state.nightSubPhase="done";const t=[];this.state.nightResult?.killedByWolves&&t.push(this.state.nightResult.killedByWolves),this.state.nightResult?.killedByWitch&&t.push(this.state.nightResult.killedByWitch),t.forEach(t=>{this.killPlayer(t)}),0===t.length?this.addLog({en:"No one died last night!",vi:"Không ai chết đêm qua!"},"death"):t.forEach(t=>{const e=this.state.players.find(e=>e.id===t);if(e&&(this.addLog({en:`${e.username} was killed last night!`,vi:`${e.username} đã bị giết đêm qua!`},"death"),this.state.config.revealRolesOnDeath&&e.role)){const t=a[e.role];this.addLog({en:`${e.username} was a ${t.name.en}`,vi:`${e.username} là ${t.name.vi}`},"info")}});const e=this.state.players.find(t=>"hunter"===t.role&&t.hasPendingShot&&!t.isAlive);if(e)return this.state.phase="hunterRevenge",this.state.pendingElimination=e.id,e.hasVoted=!1,this.startPhaseTimer(),void this.processBotHunterAction();this.checkWinCondition()?this.endGame():this.startPhaseTimer()}killPlayer(t){const e=this.state.players.find(e=>e.id===t);if(e&&e.isAlive&&(e.isAlive=!1,"hunter"===e.role&&(e.hasPendingShot=!0),e.loverId)){const t=this.state.players.find(t=>t.id===e.loverId);t&&t.isAlive&&(this.addLog({en:`${t.username} died of a broken heart!`,vi:`${t.username} chết vì đau tim!`},"death"),t.isAlive=!1,"hunter"===t.role&&(t.hasPendingShot=!0))}}startDiscussionPhase(){this.state.phase="discussion",this.state.suspicionMarkers=[],this.state.players.forEach(t=>{t.isAlive&&(t.messagesRemaining=this.state.config.chatLimit)}),this.startPhaseTimer(),this.processBotDiscussion()}handleSendMessage(t,e,s,i,a){if("discussion"!==this.state.phase)return;const n=this.state.players.find(e=>e.id===t);if(!n||!n.isAlive)return;if("text"===s&&n.messagesRemaining<=0)return;"text"===s&&e.length>100&&(e=e.substring(0,100));const h={id:`msg_${Date.now()}_${Math.random()}`,playerId:t,playerName:n.username,content:e,type:s,timestamp:Date.now(),targetPlayerId:i,quickMessageId:a,day:this.state.day};this.state.chatMessages.push(h),"text"===s&&(n.messagesRemaining--,this.addPlayerHistory(t,"chat",{en:`Chat: "${e}"`,vi:`Chat: "${e}"`})),this.state.chatMessages.length>500&&(this.state.chatMessages=this.state.chatMessages.slice(-500))}handleAddSuspicion(t,e){if("discussion"!==this.state.phase)return;const s=this.state.players.find(e=>e.id===t);if(!s||!s.isAlive)return;this.state.suspicionMarkers.some(s=>s.fromPlayerId===t&&s.toPlayerId===e)?(this.state.suspicionMarkers=this.state.suspicionMarkers.filter(s=>!(s.fromPlayerId===t&&s.toPlayerId===e)),this.addPlayerHistory(t,"action",{en:`Removed suspicion on ${this.state.players.find(t=>t.id===e)?.username}`,vi:`Bỏ nghi ngờ ${this.state.players.find(t=>t.id===e)?.username}`})):(this.state.suspicionMarkers.push({fromPlayerId:t,toPlayerId:e,timestamp:Date.now()}),this.addPlayerHistory(t,"action",{en:`Suspects ${this.state.players.find(t=>t.id===e)?.username}`,vi:`Nghi ngờ ${this.state.players.find(t=>t.id===e)?.username}`}),this.addPlayerHistory(e,"info",{en:`${s.username} suspects you`,vi:`${s.username} nghi ngờ bạn`}))}handleRemoveSuspicion(t,e){"discussion"===this.state.phase&&(this.state.suspicionMarkers=this.state.suspicionMarkers.filter(s=>!(s.fromPlayerId===t&&s.toPlayerId===e)))}startVotingPhase(){this.state.phase="voting",this.state.eliminationVotes=[],this.state.players.forEach(t=>{t.hasVoted=!1}),this.startPhaseTimer(),this.processBotVoting()}handleCastVote(t,e){if("voting"!==this.state.phase)return;const s=this.state.players.find(e=>e.id===t);if(!s||!s.isAlive||s.hasVoted)return;if(e){const t=this.state.players.find(t=>t.id===e);if(!t||!t.isAlive)return}s.hasVoted=!0,this.state.eliminationVotes=this.state.eliminationVotes.filter(e=>e.voterId!==t),this.state.eliminationVotes.push({voterId:t,targetId:e}),e&&this.addPlayerHistory(e,"vote",{en:`${s.username} voted for you`,vi:`${s.username} đã bình chọn bạn`});this.state.players.filter(t=>t.isAlive&&null!==t.id).every(t=>t.hasVoted)&&this.processVotes()}processVotes(){const t={};this.state.eliminationVotes.forEach(e=>{e.targetId&&(t[e.targetId]=(t[e.targetId]||0)+1)});let e=0,s=null,i=!1;Object.entries(t).forEach(([t,a])=>{a>e?(e=a,s=t,i=!1):a===e&&(i=!0)}),i&&"noElimination"===this.state.config.tieHandling&&(s=null,this.addLog({en:"Vote was tied - no one eliminated!",vi:"Bình chọn hòa - không ai bị loại!"},"vote")),s?(this.state.pendingElimination=s,this.startEliminationPhase()):(this.state.day++,this.startNightPhase())}startEliminationPhase(){this.state.phase="elimination";const t=this.state.pendingElimination;if(!t)return this.state.day++,void this.startNightPhase();const e=this.state.players.find(e=>e.id===t);if(e&&(this.addLog({en:`${e.username} was voted out!`,vi:`${e.username} bị bình chọn loại!`},"vote"),this.killPlayer(t),this.state.config.revealRolesOnDeath&&e.role)){const t=a[e.role];this.addLog({en:`${e.username} was a ${t.name.en}`,vi:`${e.username} là ${t.name.vi}`},"info")}const s=this.state.players.find(t=>"hunter"===t.role&&t.hasPendingShot&&!t.isAlive);if(s)return this.state.phase="hunterRevenge",this.state.pendingElimination=s.id,s.hasVoted=!1,this.startPhaseTimer(),void this.processBotHunterAction();this.checkWinCondition()?this.endGame():this.startPhaseTimer()}handleHunterShoot(t,e){if("hunterRevenge"!==this.state.phase)return;const s=this.state.players.find(e=>e.id===t);if(!s||"hunter"!==s.role||!s.hasPendingShot)return;const i=this.state.players.find(t=>t.id===e);if(i&&i.isAlive){if(this.addLog({en:`${s.username} took ${i.username} with them!`,vi:`${s.username} kéo ${i.username} đi cùng!`},"death"),this.killPlayer(e),this.state.config.revealRolesOnDeath&&i.role){const t=a[i.role];this.addLog({en:`${i.username} was a ${t.name.en}`,vi:`${i.username} là ${t.name.vi}`},"info")}}else this.addLog({en:`${s.username} didn't shoot anyone.`,vi:`${s.username} không bắn ai cả.`},"info");const n=this.state.players.find(e=>"hunter"===e.role&&e.hasPendingShot&&!e.isAlive&&e.id!==t);n?this.state.pendingElimination=n.id:this.checkWinCondition()?this.endGame():this.state.nightResult&&(this.state.nightResult.killedByWolves||this.state.nightResult.killedByWitch)?(this.state.pendingElimination=null,this.startDiscussionPhase()):(this.state.pendingElimination=null,this.state.day++,this.startNightPhase())}checkWinCondition(){const t=this.state.players.filter(t=>t.isAlive&&null!==t.id),e=t.filter(t=>"wolf"===t.role),s=t.filter(t=>"wolf"!==t.role),i=this.state.players.filter(t=>t.loverId&&t.isAlive);if(2===i.length&&2===t.length){if(i.some(t=>"wolf"===t.role))return this.state.winner="lovers",!0}return e.length>=s.length?(this.state.winner="wolf",!0):0===e.length&&(this.state.winner="village",!0)}endGame(){this.state.phase="end",this.state.isGameOver=!0,this.clearTimer();const t="wolf"===this.state.winner?{en:"Werewolves win!",vi:"Ma Sói thắng!"}:"village"===this.state.winner?{en:"Village wins!",vi:"Dân Làng thắng!"}:{en:"Lovers win!",vi:"Tình Nhân thắng!"};this.addLog(t,"info"),this.clearSavedState()}startPhaseTimer(){let t;switch(this.clearTimer(),this.state.phase){case"night":t=1e3*this.state.config.nightPhaseTime;break;case"discussion":t=1e3*this.state.config.discussionTime;break;case"voting":t=1e3*this.state.config.voteTime;break;case"hunterRevenge":t=15e3;break;case"morning":case"elimination":t=1e4;break;default:t=3e4}this.state.phaseEndTime=Date.now()+t,this.isHost&&(this.timerInterval=setInterval(()=>{!this.state.isPaused&&null!==this.state.phaseEndTime&&Date.now()>=this.state.phaseEndTime&&this.handlePhaseTimeout()},1e3))}requestPauseGame(){if(!this.isHost||!this.state.phaseEndTime||this.state.isPaused)return;const t=Date.now(),e=Math.max(0,this.state.phaseEndTime-t);this.state.isPaused=!0,this.state.pausedTimeRemaining=e,this.state.phaseEndTime=null,this.clearTimer()}requestResumeGame(){this.isHost&&this.state.isPaused&&null!==this.state.pausedTimeRemaining&&(this.state.isPaused=!1,this.state.phaseEndTime=Date.now()+this.state.pausedTimeRemaining,this.state.pausedTimeRemaining=null,this.timerInterval=setInterval(()=>{!this.state.isPaused&&null!==this.state.phaseEndTime&&Date.now()>=this.state.phaseEndTime&&this.handlePhaseTimeout()},1e3))}clearTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}handlePhaseTimeout(){if(!this.state.isGameOver&&!this.state.isPaused&&this.state.phaseEndTime)switch(this.state.phase){case"discussion":this.startVotingPhase();break;case"voting":this.processVotes();break;case"night":this.advanceNightSubPhase();break;case"hunterRevenge":this.handleHunterShoot(this.state.players.find(t=>t.hasPendingShot)?.id||"","");break;case"morning":this.startDiscussionPhase();break;case"elimination":this.state.pendingElimination=null,this.state.day++,this.startNightPhase()}}handleSkipPhase(){this.state.isGameOver||this.state.isPaused||(this.state.phaseEndTime=Date.now()+5e3,this.state.isPaused=!1,this.state.pausedTimeRemaining=null)}processBotNightAction(){if(!this.isHost)return;const t=1e3+2e3*Math.random();setTimeout(()=>{if("night"===this.state.phase)switch(this.state.nightSubPhase){case"wolf":this.processBotWolfAction();break;case"seer":this.processBotSeerAction();break;case"bodyguard":this.processBotBodyguardAction();break;case"witch":this.processBotWitchAction();break;case"cupid":this.processBotCupidAction()}},t)}processBotWolfAction(){this.state.players.filter(t=>"wolf"===t.role&&t.isAlive&&t.isBot).forEach(t=>{if(!t.id)return;if(this.state.nightActions.wolfVotes.some(e=>e.wolfId===t.id))return;const e=this.state.players.filter(t=>t.isAlive&&"wolf"!==t.role&&null!==t.id);if(0===e.length)return;let s="";const i=this.state.nightActions.wolfVotes;if(i.length>0&&Math.random()<.8){const t={};i.forEach(e=>{t[e.targetId]=(t[e.targetId]||0)+1});let e=0,a="";Object.entries(t).forEach(([t,s])=>{s>e&&(e=s,a=t)}),a&&(s=a)}if(!s){const t=e[Math.floor(Math.random()*e.length)];t?.id&&(s=t.id)}s&&this.handleNightAction(t.id,"wolf",s,!1,!1,void 0)})}processBotSeerAction(){const t=this.state.players.find(t=>"seer"===t.role&&t.isAlive&&t.isBot);if(!t?.id)return;const e=this.state.players.filter(e=>e.isAlive&&e.id!==t.id&&null!==e.id),s=e.filter(e=>!t.history.some(t=>"info"===t.type&&t.content.en.startsWith("Seer Result:")&&t.content.en.includes(e.username))),i=s.length>0?s:e;if(0===i.length)return;const a=i[Math.floor(Math.random()*i.length)];this.handleNightAction(t.id,"seer",a.id,!1,!1,void 0)}processBotBodyguardAction(){const t=this.state.players.find(t=>"bodyguard"===t.role&&t.isAlive&&t.isBot);if(!t?.id)return;const e=this.state.players.filter(t=>t.isAlive&&null!==t.id&&t.id!==this.state.nightActions.lastBodyguardTarget);if(0===e.length)return;const s=e[Math.floor(Math.random()*e.length)];this.handleNightAction(t.id,"bodyguard",s.id,!1,!1,void 0)}processBotWitchAction(){const t=this.state.players.find(t=>"witch"===t.role&&t.isAlive&&t.isBot);if(!t?.id)return;const e=this.state.witchPotions[t.id];if(!e)return void this.advanceNightSubPhase();const s=e.hasHealPotion&&this.state.nightActions.wolfTarget&&Math.random()>.5;let i=null;if(e.hasKillPotion&&this.state.day>1&&Math.random()>.7){const e=this.state.players.filter(e=>e.isAlive&&e.id!==t.id&&null!==e.id&&this.state.suspicionMarkers.some(t=>t.toPlayerId===e.id)),s=e.length>0?e:this.state.players.filter(e=>e.isAlive&&e.id!==t.id&&null!==e.id);s.length>0&&(i=s[Math.floor(Math.random()*s.length)].id)}this.handleNightAction(t.id,"witch",i,s||!1,!!i,void 0)}processBotCupidAction(){const t=this.state.players.find(t=>"cupid"===t.role&&t.isAlive&&t.isBot);if(!t?.id)return;const e=this.state.players.filter(t=>t.isAlive&&null!==t.id);if(e.length<2)return;const s=this.shuffleArray(e);this.handleNightAction(t.id,"cupid",s[0].id,!1,!1,s[1].id||void 0)}processBotHunterAction(){const t=this.state.players.find(t=>"hunter"===t.role&&t.id===this.state.pendingElimination&&t.isBot&&!t.isAlive);t?.id&&setTimeout(()=>{if("hunterRevenge"!==this.state.phase)return;if(this.state.pendingElimination!==t.id)return;const e=this.state.players.filter(e=>e.isAlive&&e.id&&e.id!==t.id);if(0===e.length)return void this.handleHunterShoot(t.id,"SKIP");const s=e[Math.floor(Math.random()*e.length)];s.id&&this.handleHunterShoot(t.id,s.id)},3e3+2e3*Math.random())}processBotDiscussion(){if(!this.isHost)return;if("discussion"!==this.state.phase)return;this.state.players.filter(t=>t.isBot&&t.isAlive&&t.id).forEach((t,e)=>{const s=2e3+1500*e+3e3*Math.random();setTimeout(()=>{if("discussion"!==this.state.phase)return;if(!t.id)return;const e=this.state.players.filter(e=>e.isAlive&&e.id&&e.id!==t.id);if(e.length>0){let s=e;"wolf"===t.role&&(s=e.filter(t=>"wolf"!==t.role),0===s.length&&(s=e));const i=s[Math.floor(Math.random()*s.length)];Math.random()<.7&&i.id&&this.handleAddSuspicion(t.id,i.id),Math.random()<.4&&this.handleBotQuickMessage(t,e)}},s)})}handleBotQuickMessage(e,s){if(!e.id)return;let i=n.filter(t=>"claim"===t.type?"claim_seer"===t.id&&"seer"===e.role?Math.random()<.3:"claim_bodyguard"===t.id&&"bodyguard"===e.role?Math.random()<.2:"wolf"===e.role&&("claim_seer"===t.id||"claim_bodyguard"===t.id)&&Math.random()<.1:!t.id.startsWith("seer_result")||("seer"===e.role||"wolf"===e.role&&Math.random()<.2));if(0===i.length)return;const a=i[Math.floor(Math.random()*i.length)];let h;if(a.targetRequired){let t=s;"wolf"===e.role&&"accuse"===a.type&&(t=s.filter(t=>"wolf"!==t.role),0===t.length&&(t=s)),"seer"===e.role&&("seer_result_wolf"===a.id||a.id);const i=t[Math.floor(Math.random()*t.length)];if(!i||!i.id)return;h=i.id}let o=t(a.text);if(h){const t=this.state.players.find(t=>t.id===h)?.username||"Unknown";o=o.replace("{target}",t)}this.handleSendMessage(e.id,o,"quick",h,a.id)}processBotVoting(){if(!this.isHost)return;if("voting"!==this.state.phase)return;this.state.players.filter(t=>t.isBot&&t.isAlive&&t.id&&!t.hasVoted).forEach((t,e)=>{const s=1e3+1e3*e+2e3*Math.random();setTimeout(()=>{if("voting"!==this.state.phase)return;if(!t.id||t.hasVoted)return;const e=this.state.players.filter(e=>e.isAlive&&e.id&&e.id!==t.id);if(0===e.length)return void this.handleCastVote(t.id,null);let s=e;"wolf"===t.role&&(s=e.filter(t=>"wolf"!==t.role),0===s.length&&(s=e));const i=s.filter(t=>this.state.suspicionMarkers.some(e=>e.toPlayerId===t.id));let a=i.length>0?i:s;if(Math.random()<.1)return void this.handleCastVote(t.id,null);const n=a[Math.floor(Math.random()*a.length)];n.id&&this.handleCastVote(t.id,n.id)},s)})}addLog(t,e){this.state.logs.push({id:`log_${Date.now()}_${Math.random()}`,message:t,type:e,timestamp:Date.now(),day:this.state.day}),this.state.logs.length>100&&(this.state.logs=this.state.logs.slice(-100))}addPlayerHistory(t,e,s,i){const a=this.state.players.find(e=>e.id===t);a&&a.history.push({id:`hist_${Date.now()}_${Math.random()}`,type:e,content:s,timestamp:Date.now(),day:this.state.day,isSecret:i})}handleResetGame(){this.clearTimer();const t=this.getInitState();this.state.players.forEach((e,s)=>{null!==e.id&&(t.players[s]={...t.players[s],id:e.id,username:e.username,isBot:e.isBot})}),this.state=t}requestJoinSlot(t,e){this.makeAction({type:"JOIN_SLOT",playerId:this.userId,playerName:e,slotIndex:t})}requestLeaveSlot(t){this.makeAction({type:"LEAVE_SLOT",slotIndex:t})}requestAddBot(t){this.isHost&&this.handleAddBot(t)}requestRemoveBot(t){this.isHost&&this.handleRemoveBot(t)}requestUpdateConfig(t){this.isHost&&this.handleUpdateConfig(t)}requestStartGame(t){this.isHost&&this.handleStartGame(t)}requestNightAction(t,e,s,i,a){this.makeAction({type:"NIGHT_ACTION",playerId:this.userId,role:t,targetId:e,useHealPotion:s,useKillPotion:i,secondTargetId:a})}requestSkipNightAction(t){this.makeAction({type:"SKIP_NIGHT_ACTION",playerId:this.userId,role:t})}requestSendMessage(t,e,s,i){this.makeAction({type:"SEND_MESSAGE",playerId:this.userId,content:t,messageType:e,targetPlayerId:s,quickMessageId:i})}requestAddSuspicion(t){this.makeAction({type:"ADD_SUSPICION",playerId:this.userId,targetId:t})}requestRemoveSuspicion(t){this.makeAction({type:"REMOVE_SUSPICION",playerId:this.userId,targetId:t})}requestCastVote(t){this.makeAction({type:"CAST_VOTE",playerId:this.userId,targetId:t})}requestHunterShoot(t){this.makeAction({type:"HUNTER_SHOOT",playerId:this.userId,targetId:t})}requestResetGame(){this.isHost&&this.handleResetGame()}requestSkipPhase(){this.isHost&&this.makeAction({type:"SKIP_PHASE"})}getMyPlayer(){return this.state.players.find(t=>t.id===this.userId)||null}getMyRole(){return this.getMyPlayer()?.role||null}canStartGame(){return this.state.players.filter(t=>null!==t.id).length>=this.state.minPlayers&&!this.state.isGameStarted}destroy(){this.clearTimer(),super.destroy()}}export{h as default};
