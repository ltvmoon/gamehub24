import{c as t,d as s}from"./index-BwFFTHxy.js";import{B as e}from"./BaseGame-CsKbx1S6.js";import{G as i,a,W as r,M as o,g as h,b as n}from"./words-C4-zhQWL.js";import"./react-vendor-BqGe223k.js";import"./socket-DRbsQkF5.js";import"./zustand-B1murped.js";class d extends e{isGameOver(t){return t.gartic?.status===i.ROUND_END&&t.mode===a.GARTIC}roundTimeout=null;currentRoundDuration=6e4;getInitState(){return{mode:a.FREE,strokes:[],scores:{},guesses:[],messages:[],wordLanguage:r.VI}}onSocketGameAction(t){const s=t.action;switch(s.type){case"DRAW":this.handleDraw(s.payload);break;case"CLEAR":this.handleClear();break;case"UNDO":this.handleUndo(s.payload);break;case"START_GARTIC":this.handleStartGartic();break;case"CHOOSE_WORD":this.handleChooseWord(s.payload);break;case"SUBMIT_GUESS":this.handleSubmitGuess(s.payload);break;case"NEXT_ROUND":this.handleNextRound();break;case"SEND_MESSAGE":this.handleSendMessage(s.payload);break;case"REROLL_OPTIONS":this.handleRerollOptions(s.payload);break;case"PAUSE_GAME":this.handlePauseGame();break;case"BUY_HINT":this.handleBuyHint(s.payload);break;case"SELECT_DIFFICULTY":this.handleSelectDifficulty(s.payload)}}makeAction(t){if(this.isHost)this.onSocketGameAction({action:t});else{if("DRAW"===t.type)this.state.strokes.push(t.payload);else if("CLEAR"===t.type)(this.state.mode===a.FREE||this.state.gartic&&this.state.gartic.drawerId===this.userId)&&(this.state.strokes=[]);else if("UNDO"===t.type){const s=t.payload;let e=-1;for(let t=this.state.strokes.length-1;t>=0;t--)if(this.state.strokes[t].playerId===s){e=t;break}-1!==e&&this.state.strokes.splice(e,1)}this.players.find(t=>t.id===this.userId)&&this.sendSocketGameAction(t)}}handleDraw(t){if(this.isHost){if(this.state.mode===a.GARTIC){if(this.state.gartic?.status!==i.DRAWING)return;if(this.state.gartic.isPaused)return;if(this.state.gartic?.drawerId!==t.playerId)return}this.state.strokes.push(t)}}handleClear(){this.isHost&&(this.state.strokes=[])}handleUndo(t){if(!this.isHost)return;let s=-1;for(let e=this.state.strokes.length-1;e>=0;e--)if(this.state.strokes[e].playerId===t){s=e;break}-1!==s&&this.state.strokes.splice(s,1)}handleStartGartic(){this.isHost&&(this.state.mode=a.GARTIC,this.state.scores={},this.players.forEach(t=>this.state.scores[t.id]=0),this.state.messages=[],this.state.wordLanguage=r.VI,this.startNewRound())}handleChooseWord(t){this.isHost&&this.state.gartic&&this.state.gartic.status===i.CHOOSING_WORD&&(this.state.gartic.word=t,this.state.gartic.maskedWord=t.replace(/\S/g,"_"),this.state.gartic.status=i.DRAWING,this.currentRoundDuration=6e4,this.state.gartic.roundEndTime=Date.now()+this.currentRoundDuration,this.state.gartic.isPaused=!1,this.state.gartic.pausedRemainingTime=void 0,this.state.strokes=[],this.addSystemMessage({en:"Drawer has chosen a word! Start guessing!",vi:"Người vẽ đã chọn từ! Bắt đầu đoán!"},o.INFO),this.roundTimeout&&clearTimeout(this.roundTimeout),this.roundTimeout=setTimeout(()=>{this.endRound({en:"Time's up!",vi:"Hết thời gian!"})},this.currentRoundDuration))}handleSubmitGuess(s){if(!this.isHost)return;const{playerId:e,text:r}=s;if(this.state.mode!==a.GARTIC||!this.state.gartic||this.state.gartic.status!==i.DRAWING)return void this.addChatMessage(e,r);if(this.state.gartic.isPaused)return void this.addChatMessage(e,r);const h=this.players.find(t=>t.id===e);if(!h)return;if(e===this.state.gartic.drawerId)return void this.addChatMessage(e,r);if(this.state.guesses.includes(e))return void this.addChatMessage(e,r);const n=r.trim().toLowerCase(),d=this.state.gartic.word.toLowerCase();if(n===d){this.state.guesses.push(e);const t=this.state.guesses.length;let s=0;s=1===t?5:2===t?4:3===t?3:2,this.state.scores[e]=(this.state.scores[e]||0)+s;const i=this.state.gartic.drawerId;this.state.scores[i]=(this.state.scores[i]||0)+2,this.addSystemMessage({en:`${h.username} guessed correctly!`,vi:`${h.username} đoán đúng!`},o.SUCCESS);const a=this.players.length-1;this.state.guesses.length>=a&&a>0&&this.endRound({en:"Everyone guessed correctly!",vi:"Mọi người đều đoán đúng!"})}else{const s=Math.round(t(n,d));this.addChatMessage(e,r,s)}}handleNextRound(){this.isHost&&this.startNewRound()}handleSendMessage(t){this.isHost&&this.addChatMessage(t.playerId,t.text)}handleRerollOptions(t){if(!this.isHost)return;if(this.state.gartic?.status!==i.CHOOSING_WORD)return;this.state.wordLanguage=t.language;const s=this.state.wordDifficulty||"easy",e=t.language===r.EN?"en":"vi",a=h(s,3,e);this.state.wordOptions=a}handleSelectDifficulty(t){if(!this.isHost)return;if(this.state.gartic?.status!==i.CHOOSING_WORD)return;this.state.wordDifficulty=t.difficulty;const s=this.state.wordLanguage===r.EN?"en":"vi",e=h(t.difficulty,3,s);this.state.wordOptions=e}handlePauseGame(){if(this.isHost&&this.state.gartic&&(this.state.gartic.status===i.DRAWING||this.state.gartic.status===i.CHOOSING_WORD))if(this.state.gartic.isPaused){this.state.gartic.isPaused=!1;const t=this.state.gartic.pausedRemainingTime||0;this.state.gartic.roundEndTime=Date.now()+t,this.state.gartic.pausedRemainingTime=void 0,this.roundTimeout&&clearTimeout(this.roundTimeout),this.state.gartic.status===i.CHOOSING_WORD?this.roundTimeout=setTimeout(()=>{this.state.gartic?.status===i.CHOOSING_WORD&&this.handleChooseWord(this.state.wordOptions?.[0]||"apple")},t):this.roundTimeout=setTimeout(()=>{this.endRound({en:"Time's up!",vi:"Hết thời gian!"})},t)}else{this.state.gartic.isPaused=!0;const t=Math.max(0,this.state.gartic.roundEndTime-Date.now());this.state.gartic.pausedRemainingTime=t,this.roundTimeout&&clearTimeout(this.roundTimeout)}}handleBuyHint(t){if(!this.isHost)return;if(!this.state.gartic||this.state.gartic.status!==i.DRAWING)return;if(this.state.guesses.includes(t))return;if(this.state.gartic.drawerId===t)return;const s=this.state.scores[t]||0;this.state.scores[t]=s-2;const e=this.state.gartic.word,a=this.state.gartic.playerHints[t]||[],r=[];for(let i=0;i<e.length;i++)" "===e[i]||a.includes(i)||r.push(i);if(r.length>0){const s=r[Math.floor(Math.random()*r.length)];a.push(s),this.state.gartic.playerHints[t]=a;const e=this.players.find(s=>s.id===t);this.addSystemMessage({en:`${e?.username} used a hint!`,vi:`${e?.username} đã sử dụng gợi ý!`},o.INFO)}}startNewRound(){let t=0;if(this.state.gartic){const s=this.state.gartic.drawerId;t=(this.players.findIndex(t=>t.id===s)+1)%this.players.length}const s=this.players[t];if(!s)return;const e=this.state.wordDifficulty||"easy",a=this.state.wordLanguage===r.EN?"en":"vi",n=h(e,3,a);this.state.wordOptions=n,this.state.guesses=[],this.state.gartic={drawerId:s.id,word:"",status:i.CHOOSING_WORD,roundEndTime:Date.now()+15e3,maskedWord:"",isPaused:!1,playerHints:{}},this.addSystemMessage({en:`Round starting! ${s.username} is choosing a word.`,vi:`Vòng mới bắt đầu! ${s.username} đang chọn từ.`},o.INFO),this.roundTimeout&&clearTimeout(this.roundTimeout),this.roundTimeout=setTimeout(()=>{this.state.gartic?.status===i.CHOOSING_WORD&&this.handleChooseWord(this.state.wordOptions?.[0]||"apple")},15e3)}endRound(t){this.roundTimeout&&clearTimeout(this.roundTimeout),this.state.gartic&&(this.state.gartic.status=i.ROUND_END,this.state.gartic.maskedWord=this.state.gartic.word,this.state.gartic.roundEndTime=Date.now()+5e3,this.addSystemMessage({en:`Round Ended: ${t.en}. The word was: ${this.state.gartic.word}`,vi:`Vòng kết thúc: ${t.vi}. Từ cần đoán là: ${this.state.gartic.word}`},o.WARNING),this.roundTimeout=setTimeout(()=>{this.startNewRound()},5e3))}addChatMessage(t,e,i){const a={id:s(),senderId:t,content:e,type:n.CHAT,similarity:i,timestamp:Date.now()};this.state.messages.push(a),this.state.messages.length>100&&this.state.messages.splice(0,50)}addSystemMessage(t,e=o.INFO){const i={id:s(),senderId:"SYSTEM",content:t,type:n.SYSTEM,subType:e,timestamp:Date.now()};this.state.messages.push(i),this.state.messages.length>100&&this.state.messages.splice(0,50)}startGartic(){this.makeAction({type:"START_GARTIC"})}chooseWord(t){this.makeAction({type:"CHOOSE_WORD",payload:t})}submitGuess(t){this.makeAction({type:"SUBMIT_GUESS",payload:{playerId:this.userId,text:t}})}draw(t){this.makeAction({type:"DRAW",payload:t})}clear(){this.makeAction({type:"CLEAR"})}undo(){this.makeAction({type:"UNDO",payload:this.userId})}rerollOptions(t){this.makeAction({type:"REROLL_OPTIONS",payload:{language:t}})}pauseGame(){this.makeAction({type:"PAUSE_GAME"})}buyHint(){this.makeAction({type:"BUY_HINT",payload:this.userId})}selectDifficulty(t){this.makeAction({type:"SELECT_DIFFICULTY",payload:{difficulty:t}})}}export{d as default};
