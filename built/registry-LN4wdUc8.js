import{c as t}from"./zustand-BrUGvFZl.js";import"./socket-DRbsQkF5.js";import{C as e}from"./chess-DTd62Tay.js";import{f as s,h as a,C as i,i as n,j as r}from"./react-vendor-8v1eX67m.js";const o=t(t=>({currentRoom:null,publicRooms:[],setCurrentRoom:e=>t({currentRoom:e}),setPublicRooms:e=>t({publicRooms:e}),updatePlayers:e=>t(t=>({currentRoom:t.currentRoom?{...t.currentRoom,players:e}:null})),leaveRoom:()=>t({currentRoom:null})}));class h{roomId;socket;isHost;userId;constructor(t,e,s,a){this.roomId=t,this.socket=e,this.isHost=s,this.userId=a,this.isHost||this.socket.on("game:state",this.handleStateSync.bind(this)),this.socket.on("game:action",this.handleAction.bind(this))}get isHostUser(){return this.isHost}get getRoomId(){return this.roomId}broadcastState(){if(this.isHost){const t=this.getState();this.socket.emit("game:state",{roomId:this.roomId,state:t})}}sendAction(t){this.socket.emit("game:action",{roomId:this.roomId,action:t})}handleStateSync(t){this.isHost||this.setState(t.state)}broadcastGameEnd(t){this.socket.emit("game:end",{roomId:this.roomId,result:t})}destroy(){this.socket.off("game:state"),this.socket.off("game:action")}}class l extends h{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={board:Array(9).fill(null),currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:{X:i[0]?.id||null,O:i[1]?.id||null},gameOver:!1,lastMoveIndex:null},this.init()}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;"MAKE_MOVE"===e.type&&this.isHost?this.makeMove(e):"RESET_GAME"===e.type&&this.isHost?this.reset():"SWITCH_TURN"===e.type&&this.isHost&&this.handleSwitchTurn()}makeMove(t){if("MAKE_MOVE"!==t.type)return;const{cellIndex:e,playerId:s}=t;if(this.state.gameOver)return;if(null!==this.state.board[e])return;const a=this.getPlayerSymbolInternal(s);if(!a)return;if(a!==this.state.currentTurn)return;this.state.board[e]=a,this.state.lastMoveIndex=e;const i=this.checkGameEnd();i?(this.state.winner=i.winner||null,i.pattern&&(this.state.winningLine=i.pattern),this.state.isDraw=i.isDraw||!1,this.state.gameOver=!0,this.broadcastGameEnd(i)):this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkGameEnd(){const{board:t}=this.state,e=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const s of e){const[e,a,i]=s;if(t[e]&&t[e]===t[a]&&t[e]===t[i])return{winner:t[e],pattern:s}}return t.every(t=>null!==t)?{isDraw:!0}:null}reset(){this.state={board:Array(9).fill(null),currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:this.state.players,gameOver:!1,lastMoveIndex:null},this.broadcastState(),this.setState({...this.state})}updatePlayers(t){this.state.players={X:t[0]?.id||null,O:t[1]?.id||null},this.broadcastState(),this.setState({...this.state})}requestMove(t){const e={type:"MAKE_MOVE",cellIndex:t,playerId:this.userId};this.isHost?this.makeMove(e):this.sendAction(e)}requestReset(){this.isHost?this.reset():this.sendAction({type:"RESET_GAME"})}handleSwitchTurn(){this.state.gameOver||this.state.board.some(t=>null!==t)||(this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}switchTurn(){this.isHost?this.handleSwitchTurn():this.sendAction({type:"SWITCH_TURN"})}addBot(){this.isHost&&(this.state.players.O="BOT",this.broadcastState(),this.setState({...this.state}))}checkBotTurn(){if(!this.isHost)return;"BOT"!==("X"===this.state.currentTurn?this.state.players.X:this.state.players.O)||this.state.gameOver||setTimeout(()=>this.makeBotMove(),600)}makeBotMove(){if(this.state.gameOver)return;const t=this.getBestMove();-1!==t&&this.makeMove({type:"MAKE_MOVE",cellIndex:t,playerId:"BOT"})}getBestMove(){const t=this.state.board;let e=-1/0,s=-1;for(let a=0;a<9;a++)if(null===t[a]){t[a]="O";const i=this.minimax(t,0,!1,"O","X");t[a]=null,i>e&&(e=i,s=a)}return s}minimax(t,e,s,a,i){const n=this.checkWinInternal(t);if(n===a)return 10-e;if(n===i)return e-10;if("draw"===n)return 0;if(s){let s=-1/0;for(let n=0;n<9;n++)if(null===t[n]){t[n]=a;const r=this.minimax(t,e+1,!1,a,i);t[n]=null,s=Math.max(r,s)}return s}{let s=1/0;for(let n=0;n<9;n++)if(null===t[n]){t[n]=i;const r=this.minimax(t,e+1,!0,a,i);t[n]=null,s=Math.min(r,s)}return s}}checkWinInternal(t){const e=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const s of e){const[e,a,i]=s;if(t[e]&&t[e]===t[a]&&t[e]===t[i])return t[e]}return t.every(t=>null!==t)?"draw":null}getPlayerSymbolInternal(t){return this.state.players.X===t?"X":this.state.players.O===t?"O":null}getPlayerSymbol(){return this.getPlayerSymbolInternal(this.userId)}}const c=50;class d extends h{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:{X:i[0]?.id||null,O:i[1]?.id||null},gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null},this.init()}init(){this.isHost&&(this.broadcastState(),this.checkBotTurn())}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.makeMove(e);break;case"UNDO_REQUEST":this.handleUndoRequest(e.playerId);break;case"UNDO_RESPONSE":this.handleUndoResponse(e.accepted);break;case"SWITCH_TURN":this.handleSwitchTurn();break;case"RESET_GAME":this.reset()}}makeMove(t){const{row:e,col:s,playerId:a}=t;if(this.state.gameOver)return;const i=`${e},${s}`;if(this.state.board[i])return;const n=this.getPlayerSymbolInternal(a);if(!n||n!==this.state.currentTurn)return;this.state.board[i]=n,this.state.history.push(i),this.state.pendingUndoRequest=null;const r=this.checkWin(e,s,n);r?(this.state.winner=n,this.state.winningLine=r,this.state.gameOver=!0,this.broadcastGameEnd({winner:n})):this.state.currentTurn="X"===n?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkGameEnd(){return this.state.gameOver?{winner:this.state.winner||void 0}:null}reset(){this.state={board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:this.state.players,gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null},this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}updatePlayers(t){const e=t[0]?.id||null;let s=t[1]?.id||null;"BOT"!==this.state.players.O||s||(s="BOT"),this.state.players={X:e,O:s},this.broadcastState(),this.setState({...this.state})}checkWin(t,e,s){const a=[[0,1],[1,0],[1,1],[1,-1]];for(const[i,n]of a){const a=[[t,e]];let r=t+i,o=e+n;for(;r>=0&&r<c&&o>=0&&o<c&&this.state.board[`${r},${o}`]===s;)a.push([r,o]),r+=i,o+=n;for(r=t-i,o=e-n;r>=0&&r<c&&o>=0&&o<c&&this.state.board[`${r},${o}`]===s;)a.push([r,o]),r-=i,o-=n;if(a.length>=5)return a}return null}getPlayerSymbolInternal(t){return this.state.players.X===t?"X":this.state.players.O===t?"O":null}getPlayerSymbol(){return this.getPlayerSymbolInternal(this.userId)}requestMove(t,e){const s={type:"MAKE_MOVE",row:t,col:e,playerId:this.userId};this.isHost?this.makeMove(s):this.sendAction(s)}requestUndo(){const t={type:"UNDO_REQUEST",playerId:this.userId};this.isHost?this.handleUndoRequest(this.userId):this.sendAction(t)}responseUndo(t){const e={type:"UNDO_RESPONSE",accepted:t};this.isHost?this.handleUndoResponse(t):this.sendAction(e)}switchTurn(){this.isHost?this.handleSwitchTurn():this.sendAction({type:"SWITCH_TURN"})}requestReset(){this.isHost?this.reset():this.sendAction({type:"RESET_GAME"})}handleUndoRequest(t){if(0===this.state.history.length)return;const e=this.state.history[this.state.history.length-1];this.state.board[e]===this.getPlayerSymbolInternal(t)&&(this.state.pendingUndoRequest=t,this.broadcastState(),this.setState({...this.state}))}handleUndoResponse(t){if(t){const t=this.state.history.pop();t&&(delete this.state.board[t],this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.state.gameOver=!1,this.state.winner=null,this.state.winningLine=null),this.state.pendingUndoRequest=null}else this.state.pendingUndoRequest=null;this.broadcastState(),this.setState({...this.state})}handleSwitchTurn(){this.state.gameOver||this.state.history.length>0||(this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}))}addBot(){this.isHost&&(this.state.players.O="BOT",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}checkBotTurn(){if(!this.isHost)return;"BOT"!==("X"===this.state.currentTurn?this.state.players.X:this.state.players.O)||this.state.gameOver||setTimeout(()=>this.makeBotMove(),600)}makeBotMove(){if(this.state.gameOver)return;const t=this.getBestMove();t&&this.makeMove({type:"MAKE_MOVE",row:t.row,col:t.col,playerId:"BOT"})}getBestMove(){const t=this.getCandidateMoves();if(0===t.length)return{row:Math.floor(25),col:Math.floor(25)};let e=-1/0,s=[];for(const a of t){const{row:t,col:i}=a,n=this.evaluateMove(t,i,"O","X");n>e?(e=n,s=[a]):n===e&&s.push(a)}if(s.length>0){return s[Math.floor(Math.random()*s.length)]}return null}getCandidateMoves(){const t=new Set,e=Object.keys(this.state.board);if(0===e.length)return[];const s=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const a of e){const[e,i]=a.split(",").map(Number);for(const[a,n]of s){const s=e+a,r=i+n;s>=0&&s<c&&r>=0&&r<c&&!this.state.board[`${s},${r}`]&&t.add(`${s},${r}`)}}return Array.from(t).map(t=>{const[e,s]=t.split(",").map(Number);return{row:e,col:s}})}evaluateMove(t,e,s,a){let i=0;const n=[[0,1],[1,0],[1,1],[1,-1]];for(const[r,o]of n)i+=this.evaluateLine(t,e,r,o,s,!0),i+=this.evaluateLine(t,e,r,o,a,!1);return i}evaluateLine(t,e,s,a,i,n){let r=0,o=0,h=t+s,l=e+a;for(;this.state.board[`${h},${l}`]===i;)r++,h+=s,l+=a;for(h>=0&&h<c&&l>=0&&l<c&&!this.state.board[`${h},${l}`]&&o++,h=t-s,l=e-a;this.state.board[`${h},${l}`]===i;)r++,h-=s,l-=a;h>=0&&h<c&&l>=0&&l<c&&!this.state.board[`${h},${l}`]&&o++;const d=r+1;if(d>=5)return 1e5;if(4===d){if(2===o)return 1e4;if(1===o)return n?1e3:2e3}if(3===d){if(2===o)return n?500:1e3;if(1===o)return 100}return 2===d&&2===o?10:d}}class u extends h{state;onStateChange;chess;constructor(t,s,a,i,n){super(t,s,a,i),this.chess=new e,this.state={fen:this.chess.fen(),turn:"w",winner:null,isDraw:!1,check:!1,players:{white:n[0]?.id||null,black:n[1]?.id||null},gameOver:!1,history:[],lastMove:null,capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null},this.init()}init(){this.isHost&&(this.broadcastState(),this.checkBotTurn())}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(console.log("[Chess] handleAction:",e,"isHost:",this.isHost),this.isHost)switch(e.type){case"MAKE_MOVE":this.makeMove(e);break;case"UNDO_REQUEST":case"UNDO_RESPONSE":break;case"RESET_GAME":this.reset();break;case"NEW_GAME_REQUEST":this.handleNewGameRequest(e.playerId);break;case"NEW_GAME_RESPONSE":this.handleNewGameResponse(e.accepted)}}makeMove(t){const{from:s,to:a,promotion:i,playerId:n}=t;if(console.log("[Chess] makeMove called",{from:s,to:a,playerId:n,turn:this.state.turn}),console.log("[Chess] Players:",this.state.players),this.state.gameOver)return void console.log("[Chess] Game over, ignoring move");let r=null;if(this.state.players.white===n?r="w":this.state.players.black===n&&(r="b"),console.log("[Chess] Player color resolved:",r),null!==r&&this.state.turn===r)try{const t=new e(this.state.fen),n=t.move({from:s,to:a,promotion:i});n?(this.chess.load(t.fen()),this.updateStateFromChess(n),this.broadcastState(),this.checkBotTurn()):console.log("[Chess] Move validation failed (move returned null)")}catch(o){console.error("Invalid move:",o)}else console.log("[Chess] Invalid turn or player. Turn:",this.state.turn,"Color:",r)}updateStateFromChess(t){this.state.fen=this.chess.fen(),this.state.turn=this.chess.turn(),this.state.gameOver=this.chess.isGameOver(),this.state.check=this.chess.inCheck(),this.state.isDraw=this.chess.isDraw(),this.state.lastMove={from:t.from,to:t.to},this.state.history.push(this.state.fen),this.state.gameOver?(this.chess.isCheckmate()?this.state.winner="w"===this.chess.turn()?"black":"white":this.state.winner=null,this.broadcastGameEnd({winner:this.state.winner||void 0})):t.captured&&("w"===t.color?this.state.capturedPieces.white.push(t.captured):this.state.capturedPieces.black.push(t.captured)),this.setState({...this.state})}checkGameEnd(){return this.state.gameOver?{winner:this.state.winner||void 0}:null}reset(){this.chess.reset(),this.state={fen:this.chess.fen(),turn:"w",winner:null,isDraw:!1,check:!1,players:this.state.players,gameOver:!1,history:[],lastMove:null,capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null},this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}requestMove(t,e,s){const a={type:"MAKE_MOVE",from:t,to:e,promotion:s,playerId:this.userId};this.isHost?this.makeMove(a):this.sendAction(a)}requestReset(){if("BOT"===this.state.players.black||"BOT"===this.state.players.white)return void(this.isHost&&this.reset());const t={type:"NEW_GAME_REQUEST",playerId:this.userId};this.isHost?this.handleNewGameRequest(this.userId):this.sendAction(t)}requestUndo(){}handleNewGameRequest(t){this.state.pendingNewGameRequest=t,this.broadcastState(),this.setState({...this.state})}handleNewGameResponse(t){t?this.reset():(this.state.pendingNewGameRequest=null,this.broadcastState(),this.setState({...this.state}))}getPlayerColor(){return this.state.players.white===this.userId?"w":this.state.players.black===this.userId?"b":null}updatePlayers(t){const e=t[0]?.id||null;let s=t[1]?.id||null;"BOT"!==this.state.players.black||s||(s="BOT"),this.state.players={white:e,black:s},this.broadcastState(),this.setState({...this.state})}stockfishWorker=null;isBotThinking=!1;addBot(){this.isHost&&(this.state.players.black?this.state.players.white||(this.state.players.white="BOT"):this.state.players.black="BOT",this.stockfishWorker||(this.stockfishWorker=new Worker("/stockfish.js"),this.stockfishWorker.onmessage=t=>{this.handleStockfishMessage(t.data)},this.stockfishWorker.postMessage("uci"),this.stockfishWorker.postMessage("isready")),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}checkBotTurn(){if(!this.isHost)return;if(this.state.gameOver)return;"BOT"!==("w"===this.state.turn?this.state.players.white:this.state.players.black)||this.isBotThinking||this.makeBotMove()}makeBotMove(){!this.state.gameOver&&this.stockfishWorker&&(this.isBotThinking=!0,this.stockfishWorker.postMessage(`position fen ${this.state.fen}`),this.stockfishWorker.postMessage("go movetime 1000"))}handleStockfishMessage(t){if(t.startsWith("bestmove")){const e=t.split(" ")[1];if(e&&"(none)"!==e){const t=e.substring(0,2),s=e.substring(2,4),a=e.length>4?e.substring(4,5):void 0;this.makeMove({type:"MAKE_MOVE",from:t,to:s,promotion:a,playerId:"BOT"})}this.isBotThinking=!1}}destroy(){super.destroy(),this.stockfishWorker&&(this.stockfishWorker.terminate(),this.stockfishWorker=null)}}class m extends h{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={videoId:"",isPlaying:!1,timestamp:0,lastUpdate:Date.now(),allowGuestControl:!1},this.init()}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t,t(this.state)}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;"SET_VIDEO"===e.type?this.handleSetVideo(e.payload):"SYNC_STATE"===e.type?this.isHost&&this.state.allowGuestControl&&this.handleSyncState(e.payload):"REQUEST_SYNC"===e.type?this.isHost&&this.broadcastState():"TOGGLE_GUEST_CONTROL"===e.type&&this.isHost&&this.handleToggleGuestControl(e.payload)}makeMove(t){this.isHost?("SET_VIDEO"===t.type&&this.handleSetVideo(t.payload),"SYNC_STATE"===t.type&&this.handleSyncState(t.payload),"TOGGLE_GUEST_CONTROL"===t.type&&this.handleToggleGuestControl(t.payload)):this.sendAction(t)}handleSetVideo(t){this.isHost&&(this.state.videoId=t,this.state.isPlaying=!0,this.state.timestamp=0,this.state.lastUpdate=Date.now(),this.broadcastState(),this.setState({...this.state}))}handleSyncState(t){this.isHost&&(this.state.isPlaying=t.isPlaying,this.state.timestamp=t.timestamp,this.state.lastUpdate=Date.now(),this.broadcastState(),this.setState({...this.state}))}handleToggleGuestControl(t){this.isHost&&(this.state.allowGuestControl=t,this.broadcastState(),this.setState({...this.state}))}setVideo(t){const e=this.extractVideoId(t);if(!e)return;const s={type:"SET_VIDEO",payload:e};this.makeMove(s)}sync(t,e){const s={type:"SYNC_STATE",payload:{isPlaying:t,timestamp:e}};this.makeMove(s)}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}toggleGuestControl(t){const e={type:"TOGGLE_GUEST_CONTROL",payload:t};this.makeMove(e)}extractVideoId(t){const e=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const s of e){const e=t.match(s);if(e)return e[1]}return null}checkGameEnd(){return null}reset(){this.state={videoId:"",isPlaying:!1,timestamp:0,lastUpdate:Date.now(),allowGuestControl:!1},this.broadcastState(),this.setState({...this.state})}updatePlayers(t){}}class p extends h{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={strokes:[]},this.init()}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t,t(this.state)}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;"DRAW"===e.type?this.handleDraw(e.payload):"CLEAR"===e.type?this.handleClear():"REQUEST_SYNC"===e.type&&this.isHost&&this.broadcastState()}makeMove(t){this.isHost?("DRAW"===t.type&&this.handleDraw(t.payload),"CLEAR"===t.type&&this.handleClear()):this.sendAction(t)}handleDraw(t){this.isHost&&(this.state.strokes=[...this.state.strokes,t],this.broadcastState(),this.setState({...this.state}))}handleClear(){this.isHost&&(this.state.strokes=[],this.broadcastState(),this.setState({...this.state}))}draw(t){const e={type:"DRAW",payload:t};this.makeMove(e)}clear(){this.makeMove({type:"CLEAR"})}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}checkGameEnd(){return null}reset(){this.handleClear()}updatePlayers(t){}}const y=new Map;y.set("tictactoe",{id:"tictactoe",name:"Tic Tac Toe",description:"Classic 3x3 grid game. Get three in a row to win!",icon:s,minPlayers:1,maxPlayers:2,isAvailable:!0,createGame:(t,e,s,a,i)=>new l(t,e,s,a,i)}),y.set("caro",{id:"caro",name:"Caro (Gomoku)",description:"Get 5 in a row on a larger board. More strategic!",icon:a,minPlayers:1,maxPlayers:2,isAvailable:!0,createGame:(t,e,s,a,i)=>new d(t,e,s,a,i)}),y.set("chess",{id:"chess",name:"Chess",description:"Strategic board game. Checkmate your opponent!",icon:i,minPlayers:1,maxPlayers:2,isAvailable:!0,createGame:(t,e,s,a,i)=>new u(t,e,s,a,i)}),y.set("youtube",{id:"youtube",name:"YouTube Watch Party",description:"Watch YouTube videos together with friends!",icon:n,minPlayers:1,maxPlayers:100,isAvailable:!0,createGame:(t,e,s,a,i)=>new m(t,e,s,a,i)}),y.set("canvas",{id:"canvas",name:"Draw Together",description:"Collaborative whiteboard to draw with friends!",icon:r,minPlayers:1,maxPlayers:10,isAvailable:!0,createGame:(t,e,s,a,i)=>new p(t,e,s,a,i)});const S=t=>y.get(t),g=()=>Array.from(y.values());export{d as C,l as T,m as Y,u as a,p as b,S as c,g,o as u};
