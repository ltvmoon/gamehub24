import{B as t}from"./BaseGame-Bk_CJ4n7.js";import{h as e}from"./index-Dp6FX8_v.js";const s={RED:0,GREEN:1,YELLOW:2,BLUE:3},i={WAITING:0,PLAYING:1,ENDED:2},a={FINISHED:1,BOT:2},n=100,r=200,o=300,l=52,h={[s.RED]:0,[s.GREEN]:13,[s.YELLOW]:26,[s.BLUE]:39},u=[0,8,13,21,26,34,39,47],c=[s.RED,s.GREEN,s.YELLOW,s.BLUE],d=t=>t>=n&&t<r,f=t=>t>=0&&t<n,p=t=>t>=r&&t<o,y=t=>t===o,T=t=>t-r;const g=Object.freeze(Object.defineProperty({__proto__:null,default:class extends t{isGameOver(t){return t.gamePhase===i.ENDED}getInitState(){return{players:c.map((t,e)=>({id:this.players[e]?.id||null,username:this.players[e]?.username||`Player ${e+1}`,color:t,flags:0,tokens:this.createInitialTokens()})),currentPlayerIndex:0,diceValue:null,hasRolled:!1,canRollAgain:!1,gamePhase:i.WAITING,winner:null,lastMove:null,consecutiveSixes:0}}createInitialTokens(){return Array(4).fill(null).map((t,e)=>({id:e,position:n+e}))}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"ROLL_DICE":this.handleRollDice(e.playerId);break;case"MOVE_TOKEN":this.handleMoveToken(e.playerId,e.tokenId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex)}}handleStartGame(){if(this.state.gamePhase!==i.WAITING)return;this.state.players.filter(t=>null!==t.id).length<2||(this.state.players.forEach(t=>{t.tokens=this.createInitialTokens(),t.flags&=-2}),this.state.gamePhase=i.PLAYING,this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.winner=null,this.state.lastMove=null,this.state.consecutiveSixes=0,this.checkBotTurn())}findFirstActivePlayer(){for(let t=0;t<this.state.players.length;t++)if(null!==this.state.players[t].id)return t;return 0}handleRollDice(t){if(this.state.gamePhase!==i.PLAYING)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;let n;n=this.hasAnyTokenOnBoard(s)?Math.floor(6*Math.random())+1:Math.random()<.5?6:Math.floor(6*Math.random())+1,this.state.diceValue=n,this.state.hasRolled=!0,this.state.canRollAgain=!1,6===n?this.state.consecutiveSixes++:this.state.consecutiveSixes=0;const r=this.getMovableTokens(s,n);0===r.length?setTimeout(()=>{this.nextTurn(),this.checkBotTurn()},3e3):1!==r.length||e(s.flags,a.BOT)?this.checkBotTurn():setTimeout(()=>{this.handleMoveToken(t,r[0].id)},800)}handleMoveToken(t,e){if(this.state.gamePhase!==i.PLAYING)return;if(null===this.state.diceValue)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;const n=s.tokens.find(t=>t.id===e);if(!n)return;const r=this.state.diceValue,o=this.calculateNewPosition(n,s.color,r);if(null!==o){if(this.state.lastMove={playerId:t,tokenId:e,from:n.position,to:o},n.position=o,f(o)&&this.checkCapture(s.color,o),y(o)&&s.tokens.every(t=>y(t.position)))return s.flags|=a.FINISHED,this.state.winner=t,this.state.gamePhase=i.ENDED,void this.clearSavedState();6===r?(this.state.canRollAgain=!0,this.state.hasRolled=!1,this.state.diceValue=null):this.nextTurn(),this.checkBotTurn()}}getMovableTokens(t,e){return t.tokens.filter(s=>null!==this.calculateNewPosition(s,t.color,e))}calculateNewPosition(t,e,s){const i=t.position,a=h[e];if(d(i))return 6!==s?null:a;if(f(i)){const t=this.getStepsToFinishEntry(i,e);if(t<s){const e=s-t-1;return e>=6?null:5===e?o:r+e}if(t===s)return r;return(i+s)%l}if(p(i)){const t=T(i)+s;return t>5?null:5===t?o:r+t}return null}getStepsToFinishEntry(t,e){const s=(h[e]+l-1)%l;return t<=s?s-t:l-t+s}checkCapture(t,e){if(!u.includes(e))for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if(f(t.position)&&t.position===e){const e=s.tokens.filter(t=>d(t.position)).length;t.position=n+e}}nextTurn(){this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.consecutiveSixes=0;let t=this.state.currentPlayerIndex;do{t=(t+1)%this.state.players.length}while(null===this.state.players[t].id||e(this.state.players[t].flags,a.FINISHED));this.state.currentPlayerIndex=t}hasAnyTokenOnBoard(t){if(null===t.id)return!1;for(const e of t.tokens)if(f(e.position)||p(e.position))return!0;return!1}handleAddBot(t){if(this.state.gamePhase!==i.WAITING)return;if(t<0||t>=4)return;if(null!==this.state.players[t].id)return;const e=this.state.players[t];e.id=`BOT_${Date.now()}_${t}`,e.username=`Bot ${t+1}`,e.flags|=a.BOT}handleRemoveBot(t){if(this.state.gamePhase!==i.WAITING)return;if(t<0||t>=4)return;if(!e(this.state.players[t].flags,a.BOT))return;const s=this.state.players[t];s.id=null,s.username=`Player ${t+1}`,s.flags&=-3}checkBotTurn(){if(!this.isHost)return;if(this.state.gamePhase!==i.PLAYING)return;const t=this.state.players[this.state.currentPlayerIndex];e(t.flags,a.BOT)&&t.id&&setTimeout(()=>this.executeBotTurn(t.id),800)}executeBotTurn(t){if(this.state.gamePhase!==i.PLAYING)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id===t)if(this.state.hasRolled&&!this.state.canRollAgain){if(null!==this.state.diceValue){const s=this.getMovableTokens(e,this.state.diceValue);if(s.length>0){const i=this.pickBestToken(e,s,this.state.diceValue);this.handleMoveToken(t,i.id)}}}else this.handleRollDice(t)}pickBestToken(t,e,s){for(const a of e){const e=this.calculateNewPosition(a,t.color,s);if(null!==e&&y(e))return a}for(const a of e){const e=this.calculateNewPosition(a,t.color,s);if(null!==e&&f(e)&&!u.includes(e)&&this.canCaptureAt(t.color,e))return a}const i=e.find(t=>d(t.position));return i&&6===s?i:e.reduce((e,s)=>{const i=this.getTokenProgress(e,t.color);return this.getTokenProgress(s,t.color)>i?s:e})}canCaptureAt(t,e){for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if(f(t.position)&&t.position===e)return!0;return!1}getTokenProgress(t,e){const s=t.position;if(d(s))return 0;if(y(s))return 59;if(p(s))return l+T(s);if(f(s)){const t=h[e];return s>=t?s-t:l-t+s}return 0}requestRollDice(){const t={type:"ROLL_DICE",playerId:this.userId};this.makeAction(t)}requestMoveToken(t){const e={type:"MOVE_TOKEN",playerId:this.userId,tokenId:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeAction(e)}requestRemoveBot(t){const e={type:"REMOVE_BOT",slotIndex:t};this.makeAction(e)}requestNewGame(){this.makeAction({type:"RESET"})}reset(){this.state.players.forEach(t=>{t.tokens=this.createInitialTokens(),t.flags&=-2}),this.state.currentPlayerIndex=0,this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.gamePhase=i.WAITING,this.state.winner=null,this.state.lastMove=null,this.state.consecutiveSixes=0}updatePlayers(t){if(this.state.gamePhase!==i.WAITING)return;this.state.players.forEach((t,s)=>{e(t.flags,a.BOT)||(t.id=null,t.username=`Player ${s+1}`)});let s=0;for(let i=0;i<4;i++)e(this.state.players[i].flags,a.BOT)||s<t.length&&(this.state.players[i].id=t[s].id,this.state.players[i].username=t[s].username,s++)}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return this.state.players.filter(t=>null!==t.id).length>=2}getMovableTokensForCurrentPlayer(){if(null===this.state.diceValue)return[];const t=this.state.players[this.state.currentPlayerIndex];return this.getMovableTokens(t,this.state.diceValue)}isTokenMovable(t){return this.getMovableTokensForCurrentPlayer().some(e=>e.id===t)}},getFinishLanePos:T,isBoard:f,isFinishLane:p,isFinished:y,isHome:d},Symbol.toStringTag,{value:"Module"}));export{i as L,s as P,u as S,y as a,a as b,f as c,p as d,g as e,T as g,d as i};
