import{B as t}from"./BaseGame-IZyxFPA5.js";import{R as e,C as s,W as a}from"./types-zc5glPn-.js";import"./socket-DRbsQkF5.js";import"./index-D0eX7lY_.js";import"./react-vendor-BbNWoFff.js";import"./zustand-ClrqN2jy.js";class r extends t{getInitState(){return{board:this.createEmptyBoard(),players:[{id:this.players[0]?.id||null,username:this.players[0]?.username||"Player 1",color:"red",isBot:!1},{id:this.players[1]?.id||null,username:this.players[1]?.username||"Player 2",color:"yellow",isBot:!1}],currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:{},lastMove:null,winningCells:[]}}createEmptyBoard(){return Array(e).fill(null).map(()=>Array(s).fill(null))}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.col);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo()}}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players[0].id&&this.state.players[1].id&&(this.state.gamePhase="playing",this.state.currentPlayerIndex=0,this.state.board=this.createEmptyBoard(),this.state.moveHistory={},this.state.winner=null,this.state.lastMove=null,this.state.winningCells=[],this.syncState(),this.checkBotTurn())}handleMakeMove(t,e){if("playing"!==this.state.gamePhase)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;const a=this.getLowestEmptyRow(e);if(-1===a)return;this.saveHistory(),this.state.board[a][e]=s.color,this.state.lastMove={row:a,col:e};const r=this.checkWin(a,e,s.color);r.length>0?(this.state.winningCells=r,this.state.winner=t,this.state.gamePhase="ended",this.clearSavedState()):this.isBoardFull()?(this.state.winner="draw",this.state.gamePhase="ended",this.clearSavedState()):this.state.currentPlayerIndex=1-this.state.currentPlayerIndex,this.syncState(),this.checkBotTurn()}getLowestEmptyRow(t){for(let s=e-1;s>=0;s--)if(null===this.state.board[s][t])return s;return-1}isBoardFull(){return this.state.board[0].every(t=>null!==t)}checkWin(t,e,s){if(!s)return[];const r=[[0,1],[1,0],[1,1],[1,-1]];for(const[i,n]of r){const r=this.getConnectedCells(t,e,i,n,s);if(r.length>=a)return r}return[]}getConnectedCells(t,a,r,i,n){const o=[{row:t,col:a}];let l=t+r,h=a+i;for(;l>=0&&l<e&&h>=0&&h<s&&this.state.board[l][h]===n;)o.push({row:l,col:h}),l+=r,h+=i;for(l=t-r,h=a-i;l>=0&&l<e&&h>=0&&h<s&&this.state.board[l][h]===n;)o.push({row:l,col:h}),l-=r,h-=i;return o}saveHistory(){const t={board:this.state.board.map(t=>[...t]),currentPlayerIndex:this.state.currentPlayerIndex},e=`${Date.now()}_${Math.random().toString(36).substr(2,5)}`;this.state.moveHistory[e]=t;const s=Object.keys(this.state.moveHistory);if(s.length>50){const t=s.sort(),e=t.length-50;for(let s=0;s<e;s++)delete this.state.moveHistory[t[s]]}}handleRequestUndo(t,e){if("playing"!==this.state.gamePhase)return;if(0===Object.keys(this.state.moveHistory).length)return;if(this.state.undoRequest)return;const s=1-this.state.players.findIndex(e=>e.id===t),a=this.state.players[s];a?.isBot?this.applyUndo():(this.state.undoRequest={fromId:t,fromName:e},this.syncState())}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){const t=Object.keys(this.state.moveHistory).sort();if(0===t.length)return;const e=t[t.length-1],s=this.state.moveHistory[e];delete this.state.moveHistory[e],this.state.board=s.board,this.state.currentPlayerIndex=s.currentPlayerIndex,this.state.undoRequest=null,this.state.lastMove=null,this.state.winningCells=[],this.syncState()}handleDeclineUndo(){this.state.undoRequest=null,this.syncState()}handleAddBot(){"waiting"===this.state.gamePhase&&(this.state.players[1].id||(this.state.players[1]={id:`BOT_${Date.now()}`,username:"Bot",color:"yellow",isBot:!0},this.syncState()))}handleRemoveBot(){"waiting"===this.state.gamePhase&&this.state.players[1].isBot&&(this.state.players[1]={id:null,username:"Player 2",color:"yellow",isBot:!1},this.syncState())}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t.id),600)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;if(this.state.players[this.state.currentPlayerIndex].id!==t)return;const e=this.findBestMove();-1!==e&&this.handleMakeMove(t,e)}findBestMove(){const t=this.state.players[this.state.currentPlayerIndex].color,e="red"===t?"yellow":"red";for(let i=0;i<s;i++){const e=this.getLowestEmptyRowForBoard(this.state.board,i);if(-1===e)continue;const s=this.state.board.map(t=>[...t]);if(s[e][i]=t,this.checkWinForBoard(s,e,i,t))return i}for(let i=0;i<s;i++){const t=this.getLowestEmptyRowForBoard(this.state.board,i);if(-1===t)continue;const s=this.state.board.map(t=>[...t]);if(s[t][i]=e,this.checkWinForBoard(s,t,i,e))return i}let a=-1/0,r=-1;for(let i=0;i<s;i++){const s=this.getLowestEmptyRowForBoard(this.state.board,i);if(-1===s)continue;const n=this.state.board.map(t=>[...t]);n[s][i]=t;const o=this.minimax(n,4,-1/0,1/0,!1,t,e);o>a&&(a=o,r=i)}if(-1===r){const t=[3,2,4,1,5,0,6];for(const e of t)if(-1!==this.getLowestEmptyRowForBoard(this.state.board,e))return e}return r}minimax(t,a,r,i,n,o,l){if(0===a)return this.evaluateBoard(t,o,l);const h=n?o:l;for(let d=0;d<s;d++)for(let s=0;s<e;s++)if(null!==t[s][d]&&this.checkWinForBoard(t,s,d,t[s][d]))return t[s][d]===o?1e4:-1e4;if(this.isBoardFullForBoard(t))return 0;if(n){let e=-1/0;for(let n=0;n<s;n++){const s=this.getLowestEmptyRowForBoard(t,n);if(-1===s)continue;t[s][n]=h;const d=this.minimax(t,a-1,r,i,!1,o,l);if(t[s][n]=null,e=Math.max(e,d),i<=(r=Math.max(r,d)))break}return e===-1/0?0:e}{let e=1/0;for(let n=0;n<s;n++){const s=this.getLowestEmptyRowForBoard(t,n);if(-1===s)continue;t[s][n]=h;const d=this.minimax(t,a-1,r,i,!0,o,l);if(t[s][n]=null,e=Math.min(e,d),(i=Math.min(i,d))<=r)break}return e===1/0?0:e}}evaluateBoard(t,a,r){let i=0;const n=Math.floor(s/2);for(let s=0;s<e;s++)t[s][n]===a&&(i+=3),t[s][n]===r&&(i-=3);return i+=this.scoreWindows(t,a,r),i}scoreWindows(t,r,i){let n=0;for(let o=0;o<e;o++)for(let e=0;e<=s-a;e++){const s=[t[o][e],t[o][e+1],t[o][e+2],t[o][e+3]];n+=this.scoreWindow(s,r,i)}for(let o=0;o<s;o++)for(let s=0;s<=e-a;s++){const e=[t[s][o],t[s+1][o],t[s+2][o],t[s+3][o]];n+=this.scoreWindow(e,r,i)}for(let o=0;o<=e-a;o++)for(let e=0;e<=s-a;e++){const s=[t[o][e],t[o+1][e+1],t[o+2][e+2],t[o+3][e+3]];n+=this.scoreWindow(s,r,i)}for(let o=a-1;o<e;o++)for(let e=0;e<=s-a;e++){const s=[t[o][e],t[o-1][e+1],t[o-2][e+2],t[o-3][e+3]];n+=this.scoreWindow(s,r,i)}return n}scoreWindow(t,e,s){const a=t.filter(t=>t===e).length,r=t.filter(t=>t===s).length,i=t.filter(t=>null===t).length;return 4===a?100:3===a&&1===i?5:2===a&&2===i?2:3===r&&1===i?-4:0}getLowestEmptyRowForBoard(t,s){for(let a=e-1;a>=0;a--)if(null===t[a][s])return a;return-1}isBoardFullForBoard(t){return t[0].every(t=>null!==t)}checkWinForBoard(t,r,i,n){if(!n)return!1;const o=[[0,1],[1,0],[1,1],[1,-1]];for(const[l,h]of o){let o=1,d=r+l,c=i+h;for(;d>=0&&d<e&&c>=0&&c<s&&t[d][c]===n;)o++,d+=l,c+=h;for(d=r-l,c=i-h;d>=0&&d<e&&c>=0&&c<s&&t[d][c]===n;)o++,d-=l,c-=h;if(o>=a)return!0}return!1}requestMove(t){const e={type:"MAKE_MOVE",playerId:this.userId,col:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(){this.makeAction({type:"ADD_BOT"})}requestRemoveBot(){this.makeAction({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.find(t=>t.id===this.userId),e={type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"};this.makeAction(e)}acceptUndo(){this.makeAction({type:"ACCEPT_UNDO"})}declineUndo(){this.makeAction({type:"DECLINE_UNDO"})}requestNewGame(){this.makeAction({type:"RESET"})}reset(){this.state={...this.state,board:this.createEmptyBoard(),currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:{},lastMove:null,winningCells:[]},this.syncState()}updatePlayers(t){"waiting"===this.state.gamePhase?(this.state.players[0].id=t[0]?.id||null,this.state.players[0].username=t[0]?.username||"Player 1",t[1]?(this.state.players[1].id=t[1].id,this.state.players[1].username=t[1].username,this.state.players[1].isBot=!1):this.state.players[1].isBot||(this.state.players[1].id=null,this.state.players[1].username="Player 2"),this.syncState()):this.syncState()}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return null!==this.state.players[0].id&&null!==this.state.players[1].id}isColumnFull(t){return null!==this.state.board[0][t]}}export{r as default};
