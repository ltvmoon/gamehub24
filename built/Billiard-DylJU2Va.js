import{B as t}from"./BaseGame-BjLvdXwv.js";import{c as s,F as e,M as a,B as i,T as n,a as h,P as r,b as l,g as o,d as u}from"./types-DJ2IAAiI.js";import"./socket-DRbsQkF5.js";class d extends t{state;onStateChange;onFrameUpdate;animationFrameId=null;syncIntervalId=null;pocketedThisShot=[];constructor(t,s,e,a,i){super(t,s,e,a),this.state=this.createInitialState(i),this.init()}createInitialState(t){return{balls:s(),players:{1:{id:t[0]?.id||null,username:t[0]?.username||null,ballType:null},2:{id:t[1]?.id||null,username:t[1]?.username||null,ballType:null}},currentTurn:1,gamePhase:"waiting",winner:null,lastShot:null,isSimulating:!1,foul:!1,turnMessage:null}}init(){this.isHost&&(this.broadcastState(),this.syncIntervalId=setInterval(()=>{this.state.isSimulating&&this.broadcastState()},5e3))}onUpdate(t){this.onStateChange=t}onFrame(t){this.onFrameUpdate=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state),t.lastShot&&t.isSimulating&&!this.isHost&&this.runPhysicsLoop()}handleAction(t){const s=t.action;switch(s.type){case"SHOOT":this.isHost?this.handleShoot(s.angle,s.power,s.playerId):(this.state.lastShot={angle:s.angle,power:s.power,playerId:s.playerId},this.state.isSimulating=!0,this.applyShot(s.angle,s.power),this.runPhysicsLoop());break;case"RESET_GAME":this.isHost&&this.reset();break;case"START_GAME":this.isHost&&this.handleStartGame();break;case"ADD_BOT":this.isHost&&this.handleAddBot();break;case"REMOVE_BOT":this.isHost&&this.handleRemoveBot();break;case"SYNC_STATE":this.isHost||(this.state=s.state,this.onStateChange?.(this.state))}}makeMove(t){"SHOOT"===t.type&&this.handleShoot(t.angle,t.power,t.playerId)}handleShoot(t,s,e){if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;this.getPlayerSlot(e)===this.state.currentTurn&&(this.pocketedThisShot=[],this.state.lastShot={angle:t,power:s,playerId:e},this.state.isSimulating=!0,this.state.foul=!1,this.state.turnMessage=null,this.applyShot(t,s),this.sendAction({type:"SHOOT",angle:t,power:s,playerId:e}),this.runPhysicsLoop())}applyShot(t,s){const e=this.state.balls.find(t=>0===t.id);if(!e||e.pocketed)return;const a=s*u;e.vx=Math.cos(t)*a,e.vy=Math.sin(t)*a}runPhysicsLoop(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId);const t=()=>{const s=this.updatePhysics();this.onFrameUpdate?.(this.state.balls),s?(this.animationFrameId=null,this.onSimulationEnd()):this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}updatePhysics(){const t=this.state.balls.filter(t=>!t.pocketed);let s=!0;for(const e of t)e.x+=e.vx,e.y+=e.vy;for(let e=0;e<3;e++)for(let s=0;s<t.length;s++)for(let e=s+1;e<t.length;e++)this.handleBallCollision(t[s],t[e]);for(const i of t){i.vx*=e,i.vy*=e;Math.sqrt(i.vx*i.vx+i.vy*i.vy)<a?(i.vx=0,i.vy=0):s=!1,this.handleWallCollision(i)}return this.checkPockets(),s}handleWallCollision(t){const s=.7;t.x-i<0&&(t.x=i,t.vx=Math.abs(t.vx)*s),t.x+i>n&&(t.x=n-i,t.vx=-Math.abs(t.vx)*s),t.y-i<0&&(t.y=i,t.vy=Math.abs(t.vy)*s),t.y+i>h&&(t.y=h-i,t.vy=-Math.abs(t.vy)*s)}handleBallCollision(t,s){const e=s.x-t.x,a=s.y-t.y,n=e*e+a*a,h=2*i,r=h*h;if(n<=1e-4){const e=Math.random()*Math.PI*2,a=i;return t.x-=Math.cos(e)*a,t.y-=Math.sin(e)*a,s.x+=Math.cos(e)*a,void(s.y+=Math.sin(e)*a)}if(n>=r)return;const l=Math.sqrt(n),o=e/l,u=a/l,d=(h-l)/2;t.x-=d*o,t.y-=d*u,s.x+=d*o,s.y+=d*u;const c=(s.vx-t.vx)*o+(s.vy-t.vy)*u;if(c>0)return;const p=-1.99*c/2;t.vx-=p*o,t.vy-=p*u,s.vx+=p*o,s.vy+=p*u}checkPockets(){for(const t of this.state.balls)if(!t.pocketed)for(const s of r){const e=t.x-s.x,a=t.y-s.y;if(Math.sqrt(e*e+a*a)<l){t.pocketed=!0,t.vx=0,t.vy=0,this.pocketedThisShot.push(t),0===t.id?this.state.foul=!0:this.assignBallType(t);break}}}assignBallType(t){if("eight"===t.type||"cue"===t.type)return;const s=this.state.players[this.state.currentTurn],e=1===this.state.currentTurn?2:1,a=this.state.players[e];s.ballType||a.ballType||(s.ballType=t.type,a.ballType="solid"===t.type?"stripe":"solid")}onSimulationEnd(){if(this.state.isSimulating=!1,!this.isHost)return void this.onStateChange?.({...this.state});const t=this.checkGameEnd();if(t)return this.state.gamePhase="finished",t.winner&&(this.state.winner=parseInt(t.winner)),this.broadcastState(),this.broadcastGameEnd(t),void this.setState({...this.state});this.state.foul&&(this.respawnCueBall(),this.state.turnMessage="Foul! Cue ball pocketed.");this.checkContinueTurn()&&!this.state.foul||(this.state.currentTurn=1===this.state.currentTurn?2:1),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkContinueTurn(){const t=this.state.players[this.state.currentTurn].ballType;if(t){const s=this.pocketedThisShot.some(s=>s.type===t),e=0===this.state.balls.filter(s=>!s.pocketed&&s.type===t).length,a=this.pocketedThisShot.some(t=>8===t.id);return!(!e||!a)||s}if(this.pocketedThisShot.length>0){return this.pocketedThisShot.filter(t=>0!==t.id).length>0}return!1}respawnCueBall(){const t=this.state.balls.find(t=>0===t.id);t&&(t.pocketed=!1,t.x=.25*n,t.y=h/2,t.vx=0,t.vy=0)}checkGameEnd(){const t=this.state.balls.find(t=>8===t.id);if(!t?.pocketed)return null;const s=this.state.players[this.state.currentTurn].ballType;if(!s){return{winner:(1===this.state.currentTurn?2:1).toString()}}if(0===this.state.balls.filter(t=>!t.pocketed&&o(t.id)===s).length)return{winner:this.state.currentTurn.toString()};return{winner:(1===this.state.currentTurn?2:1).toString()}}reset(){this.stopSimulation(),this.state={...this.createInitialState([]),players:{1:{id:this.state.players[1].id,username:this.state.players[1].username,ballType:null},2:{id:this.state.players[2].id,username:this.state.players[2].username,ballType:null}},gamePhase:"waiting"},this.broadcastState(),this.setState({...this.state})}updatePlayers(t){this.state.players={1:{id:t[0]?.id||this.state.players[1].id,username:t[0]?.username||this.state.players[1].username,ballType:this.state.players[1].ballType},2:{id:t[1]?.id||this.state.players[2].id,username:t[1]?.username||this.state.players[2].username,ballType:this.state.players[2].ballType}},this.broadcastState(),this.setState({...this.state})}shoot(t,s){if(this.state.isSimulating)return;if("playing"!==this.state.gamePhase)return;const e={type:"SHOOT",angle:t,power:s,playerId:this.userId};this.isHost?this.handleShoot(t,s,this.userId):this.sendAction(e)}requestReset(){this.isHost?this.reset():this.sendAction({type:"RESET_GAME"})}addBot(){this.isHost&&"waiting"===this.state.gamePhase&&(this.state.players[2]={id:"BOT",username:"Bot",ballType:null},this.broadcastState(),this.setState({...this.state}))}removeBot(){this.isHost&&"waiting"===this.state.gamePhase&&"BOT"===this.state.players[2].id&&(this.state.players[2]={id:null,username:null,ballType:null},this.broadcastState(),this.setState({...this.state}))}handleAddBot(){this.addBot()}handleRemoveBot(){this.removeBot()}startGame(){this.isHost?this.handleStartGame():this.sendAction({type:"START_GAME"})}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players[1].id&&this.state.players[2].id&&(this.state.gamePhase="playing",this.state.balls=s(),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}canStartGame(){return!!this.state.players[1].id&&!!this.state.players[2].id&&"waiting"===this.state.gamePhase}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;"BOT"===this.state.players[this.state.currentTurn].id&&setTimeout(()=>this.makeBotMove(),800)}makeBotMove(){if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;const t=this.state.balls.find(t=>0===t.id);if(!t||t.pocketed)return;const s=this.state.balls.filter(t=>0!==t.id&&!t.pocketed);if(0===s.length)return;const e=s[0],a=Math.atan2(e.y-t.y,e.x-t.x),i=.5+.3*Math.random();this.handleShoot(a,i,"BOT")}getPlayerSlot(t){return this.state.players[1].id===t?1:this.state.players[2].id===t?2:null}getMySlot(){return this.getPlayerSlot(this.userId)}isMyTurn(){return this.getMySlot()===this.state.currentTurn&&"playing"===this.state.gamePhase}getCueBall(){return this.state.balls.find(t=>0===t.id&&!t.pocketed)}stopSimulation(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stopSimulation(),this.syncIntervalId&&clearInterval(this.syncIntervalId),super.destroy()}}export{d as default};
