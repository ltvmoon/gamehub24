import{b as t}from"./index-BiWvX6AI.js";import{B as s}from"./BaseGame-iDkECrzW.js";import{C as e}from"./chess-DTd62Tay.js";import"./react-vendor-CyPxdFQK.js";import"./socket-DRbsQkF5.js";import"./zustand-BbtpVoJv.js";const i=new e;class a extends s{getInitState(){return{fen:i.fen(),turn:"w",winner:null,isDraw:!1,check:!1,players:{white:this.players[0]||null,black:this.players[1]||null},gameOver:!1,history:[],lastMove:null,capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null,isBotLoading:!1}}onSocketGameAction(t){const s=t.action;if(console.log("[Chess] handleAction:",s,"isHost:",this.isHost),this.isHost)switch(s.type){case"MAKE_MOVE":this.makeMove(s);break;case"RESET_GAME":this.reset();break;case"NEW_GAME_REQUEST":this.handleNewGameRequest(s.playerId);break;case"NEW_GAME_RESPONSE":this.handleNewGameResponse(s.accepted)}}makeMove(t){const{from:s,to:a,promotion:o,playerId:r}=t;if(console.log("[Chess] makeMove called",{from:s,to:a,playerId:r,turn:this.state.turn}),console.log("[Chess] Players:",this.state.players),this.state.gameOver)return void console.log("[Chess] Game over, ignoring move");let h=null;if(this.state.players.white?.id===r?h="w":this.state.players.black?.id===r&&(h="b"),console.log("[Chess] Player color resolved:",h),null!==h&&this.state.turn===h)try{const t=new e(this.state.fen),r=t.move({from:s,to:a,promotion:o});r?(i.load(t.fen()),this.updateStateFromChess(r),this.broadcastState(),this.checkBotTurn()):console.log("[Chess] Move validation failed (move returned null)")}catch(n){console.error("Invalid move:",n,{from:s,to:a,promotion:o})}else console.log("[Chess] Invalid turn or player. Turn:",this.state.turn,"Color:",h)}updateStateFromChess(t){this.state.fen=i.fen(),this.state.turn=i.turn(),this.state.gameOver=i.isGameOver(),this.state.check=i.inCheck(),this.state.isDraw=i.isDraw(),this.state.lastMove={from:t.from,to:t.to},this.state.history.push(this.state.fen),this.state.gameOver?(i.isCheckmate()?this.state.winner="w"===i.turn()?"black":"white":this.state.winner=null,this.clearSavedState()):t.captured&&("w"===t.color?this.state.capturedPieces.white.push(t.captured):this.state.capturedPieces.black.push(t.captured))}reset(){i.reset(),this.state.fen=i.fen(),this.state.turn="w",this.state.winner=null,this.state.isDraw=!1,this.state.check=!1,this.state.gameOver=!1,this.state.history=[],this.state.lastMove=null,this.state.capturedPieces.white=[],this.state.capturedPieces.black=[],this.state.pendingUndoRequest=null,this.state.pendingNewGameRequest=null,this.state.isBotLoading=!1,this.checkBotTurn()}requestMove(t,s,e){const i={type:"MAKE_MOVE",from:t,to:s,promotion:e,playerId:this.userId};this.makeAction(i)}async requestReset(){const s=this.state.players.black?.isBot||this.state.players.white?.isBot;if(this.isHost||s||!this.state.players.white||!this.state.players.black)return void(await t.getState().confirm("You can't reset the game")&&this.reset());const e={type:"NEW_GAME_REQUEST",playerId:this.userId};this.makeAction(e)}handleNewGameRequest(t){this.state.pendingNewGameRequest=t}handleNewGameResponse(t){t?this.reset():this.state.pendingNewGameRequest=null}getPlayerColor(){return this.state.players.white?.id===this.userId?"w":this.state.players.black?.id===this.userId?"b":null}updatePlayers(t){this.state.players.white=t[0]||null,t[1]?this.state.players.black=t[1]:this.state.players.black?.isBot||(this.state.players.black=null)}stockfishWorker=null;isBotThinking=!1;async addBot(){if(this.isHost)if(this.state.players.black?this.state.players.white||(this.state.players.white={id:"BOT",username:"BOT",isHost:!1,isBot:!0}):this.state.players.black={id:"BOT",username:"BOT",isHost:!1,isBot:!0},this.state.isBotLoading=!0,this.stockfishWorker)this.state.isBotLoading=!1,this.checkBotTurn();else{const t=new Blob([`importScripts('${"https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"}');`],{type:"application/javascript"}),s=URL.createObjectURL(t);this.stockfishWorker=new Worker(s),this.stockfishWorker.onmessage=t=>{this.handleStockfishMessage(t.data)};const e=new Promise(t=>{this.onBotReady=t});this.stockfishWorker.postMessage("uci"),this.stockfishWorker.postMessage("isready"),await e}}removeBot(){this.isHost&&(this.state.players.black?.isBot?this.state.players.black=null:this.state.players.white?.isBot&&(this.state.players.white=null))}onBotReady;checkBotTurn(){if(!this.isHost)return;if(this.state.gameOver)return;const t="w"===this.state.turn?this.state.players.white:this.state.players.black;t?.isBot&&!this.isBotThinking&&this.makeBotMove()}makeBotMove(){!this.state.gameOver&&this.stockfishWorker&&(this.isBotThinking=!0,this.stockfishWorker.postMessage(`position fen ${this.state.fen}`),this.stockfishWorker.postMessage("go movetime 1000"))}handleStockfishMessage(t){if("readyok"===t&&(this.state.isBotLoading=!1,this.checkBotTurn(),this.onBotReady&&(this.onBotReady(),this.onBotReady=void 0)),t.startsWith("bestmove")){const s=t.split(" ")[1];if(s&&"(none)"!==s){const t=s.substring(0,2),e=s.substring(2,4),i=s.length>4?s.substring(4,5):void 0;this.makeAction({type:"MAKE_MOVE",from:t,to:e,promotion:i,playerId:"BOT"})}this.isBotThinking=!1}}destroy(){super.destroy(),this.stockfishWorker&&(this.stockfishWorker.terminate(),this.stockfishWorker=null)}}export{a as default};
