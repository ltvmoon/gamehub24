import{B as t}from"./BaseGame-k9e2yoZm.js";import{E as e,a as s,P as a}from"./types-B-DmnGr4.js";import"./socket-DRbsQkF5.js";import"./index-DXRPlG-o.js";import"./react-vendor-CUFzUArh.js";import"./zustand-D7bLx3wD.js";class i extends t{isGameOver(t){return t.gamePhase===e.ENDED}getInitState(){return{players:Array(5).fill(null).map((t,e)=>{const s=this.players[e];return{id:s?.id||null,username:s?.username||`Slot ${e+1}`,hand:[],isExploded:!1,isBot:!1,isHost:s?.id===this.userId}}),drawPile:[],discardPile:[],discardHistory:[],currentTurnIndex:0,attackStack:1,direction:1,gamePhase:e.WAITING,winner:null,alterCards:null,alterCount:0,favorFrom:null,favorTo:null,comboFrom:null,comboTo:null,comboCount:0,lastAction:null,newGameRequest:null,pendingAction:null}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"START_GAME":this.handleStartGame();break;case"DRAW_CARD":this.handleDrawCard(e.playerId);break;case"PLAY_CARD":this.handlePlayCard(e.playerId,e.cardIndex,e.targetPlayerId);break;case"PLAY_COMBO":this.handlePlayCombo(e.playerId,e.cardIndices,e.targetPlayerId,e.requestedCardType);break;case"DEFUSE":this.handleDefuse(e.playerId);break;case"INSERT_KITTEN":this.handleInsertKitten(e.playerId,e.index);break;case"GIVE_FAVOR":this.handleGiveFavor(e.playerId,e.cardIndex);break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"JOIN_SLOT":this.handleJoinSlot(e.slotIndex,e.playerId,e.playerName);break;case"REMOVE_PLAYER":this.handleRemovePlayer(e.slotIndex);break;case"NEW_GAME":case"ACCEPT_NEW_GAME":this.reset();break;case"REQUEST_NEW_GAME":this.handleNewGameRequest(e.playerId,e.playerName);break;case"DECLINE_NEW_GAME":this.state.newGameRequest=null;break;case"RESPOND_NOPE":this.handleRespondNope(e.playerId,e.response);break;case"REORDER_FUTURE":this.handleReorderFuture(e.playerId,e.newOrder)}}createDeck(){const t=[];let e=1;const a=(s,a)=>{for(let i=0;i<a;i++)t.push([s,e++])};return a(s.ATTACK,4),a(s.SKIP,4),a(s.FAVOR,4),a(s.SHUFFLE,4),a(s.SEE_THE_FUTURE,5),a(s.NOPE,5),a(s.CAT_1,4),a(s.CAT_2,4),a(s.CAT_3,4),a(s.CAT_4,4),a(s.CAT_5,4),a(s.REVERSE,4),a(s.TARGETED_ATTACK,3),a(s.ALTER_THE_FUTURE_3,4),a(s.ALTER_THE_FUTURE_5,1),this.shuffle(t)}shuffle(t){const e=[...t];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}handleStartGame(){if(this.state.gamePhase!==e.WAITING)return;const t=this.state.players.filter(t=>null!==t.id);if(t.length<2)return;let a=this.createDeck(),i=1e3;for(const e of t)e.hand=[[s.DEFUSE,i++],...a.splice(0,6)];for(let e=0;e<2;e++)a.push([s.DEFUSE,i++]);for(let e=0;e<t.length-1;e++)a.push([s.EXPLODING_KITTEN,i++]);this.state.drawPile=this.shuffle(a),this.state.gamePhase=e.PLAYING,this.state.direction=1,this.state.currentTurnIndex=this.state.players.findIndex(t=>null!==t.id),this.state.attackStack=1,this.state.discardPile=[],this.checkBotTurn()}handleDrawCard(t){if(this.state.gamePhase!==e.PLAYING)return;const a=this.state.players.findIndex(e=>e.id===t);if(a!==this.state.currentTurnIndex)return;if(0===this.state.drawPile.length)return;const i=this.state.drawPile.pop();if(i[0]===s.EXPLODING_KITTEN){this.state.gamePhase=e.DEFUSING;-1===this.state.players[a].hand.findIndex(t=>t[0]===s.DEFUSE)?this.explodePlayer(a):this.checkBotTurn()}else{this.state.players[a].hand.push(i);const e=Date.now();this.state.discardHistory.push({playerId:t,cards:[],timestamp:e}),this.state.lastAction={action:{type:"DRAW_CARD",playerId:t},playerId:t,timestamp:e,isNoped:!1},this.finishTurnAction()}}handlePlayCard(t,a,i){if(this.state.gamePhase!==e.PLAYING)return;const n=this.state.players.findIndex(e=>e.id===t);if(n!==this.state.currentTurnIndex)return;const r=this.state.players[n];if(a<0||a>=r.hand.length)return;const d=r.hand[a];if(d[0]===s.NOPE||d[0]===s.DEFUSE||d[0]===s.EXPLODING_KITTEN||d[0]>=s.CAT_1&&d[0]<=s.CAT_5)return;r.hand.splice(a,1),this.state.discardPile.push(d);const h=Date.now();let o=i;d[0]===s.ATTACK&&(o=this.getNextPlayerId(n)),this.state.discardHistory.push({playerId:t,cards:[d],timestamp:h,targetPlayerId:o}),this.startNopeWindow({type:"PLAY_CARD",playerId:t,cardIndex:a,targetPlayerId:o},t,h)}handlePlayCombo(t,a,i,n){if(this.state.gamePhase!==e.PLAYING)return;const r=this.state.players.findIndex(e=>e.id===t);if(r!==this.state.currentTurnIndex)return;const d=this.state.players[r];if(a.length<2)return;const h=Array.from(new Set(a)).filter(t=>t>=0&&t<d.hand.length).sort((t,e)=>e-t);if(h.length<2)return;const o=h.map(t=>d.hand[t]);if(o.some(t=>!t))return;const l=o[0][0];if(l===s.NOPE)return;if(!o.every(t=>t[0]===l))return;const c=[];for(const e of h)c.push(d.hand.splice(e,1)[0]);this.state.discardPile.push(...c);const p=Date.now();this.state.discardHistory.push({playerId:t,cards:c,timestamp:p,targetPlayerId:i}),this.startNopeWindow({type:"PLAY_COMBO",playerId:t,cardIndices:a,targetPlayerId:i,requestedCardType:n},t,p)}startNopeWindow(t,i,n){const r=this.state.discardPile[this.state.discardPile.length-1];this.state.pendingAction={action:t,playerId:i,timerStart:Date.now(),nopeCount:0,responses:{},nopeChain:[{playerId:i,cardType:r[0]}],entryTimestamp:n},this.state.players.forEach(t=>{t.id&&(!t.isExploded&&t.hand.some(t=>t[0]===s.NOPE)&&t.id!==i||(this.state.pendingAction.responses[t.id]="ALLOW"))});if(this.state.players.filter(t=>t.id&&!t.isExploded).every(t=>"ALLOW"===this.state.pendingAction.responses[t.id]))return void this.executePendingAction();this.state.gamePhase=e.NOPE_WINDOW;const d=this.state.pendingAction.timerStart;setTimeout(()=>{this.state.pendingAction&&this.state.pendingAction.timerStart===d&&this.executePendingAction()},a),this.checkBotTurn()}handleRespondNope(t,i){if(this.state.gamePhase===e.NOPE_WINDOW&&this.state.pendingAction)if("NOPE"===i){const e=this.state.players.findIndex(e=>e.id===t);if(-1===e)return;const i=this.state.players[e],n=i.hand.findIndex(t=>t[0]===s.NOPE);if(-1===n)return;const r=i.hand.splice(n,1)[0];this.state.discardPile.push(r),this.state.pendingAction.nopeCount++,this.state.pendingAction.nopeChain.push({playerId:t,cardType:s.NOPE}),this.state.pendingAction.timerStart=Date.now(),this.state.pendingAction.responses={[t]:"ALLOW"},this.state.players.forEach(e=>{e.id&&e.id!==t&&(!e.isExploded&&e.hand.some(t=>t[0]===s.NOPE)||(this.state.pendingAction.responses[e.id]="ALLOW"))});if(this.state.players.filter(t=>t.id&&!t.isExploded).every(t=>"ALLOW"===this.state.pendingAction.responses[t.id]))return void this.executePendingAction();const d=this.state.pendingAction.timerStart;setTimeout(()=>{this.state.pendingAction&&this.state.pendingAction.timerStart===d&&this.executePendingAction()},a),this.checkBotTurn()}else{this.state.pendingAction.responses[t]="ALLOW";this.state.players.filter(t=>t.id&&!t.isExploded).every(t=>"ALLOW"===this.state.pendingAction.responses[t.id])&&this.executePendingAction()}}executePendingAction(){if(!this.state.pendingAction)return;const{action:t,nopeCount:s,playerId:a,nopeChain:i,entryTimestamp:n}=this.state.pendingAction,r=s%2==1;if(this.state.gamePhase=e.PLAYING,this.state.pendingAction=null,n){const t=this.state.discardHistory.find(t=>t.timestamp===n);t&&(t.nopeChain=i,t.isNoped=r)}let d;if("PLAY_CARD"===t.type&&i.length>0&&(d=i[0].cardType),this.state.lastAction={action:t,playerId:a,timestamp:Date.now(),isNoped:r,cardType:d},!r)if("PLAY_CARD"===t.type){const e=this.state.discardPile[this.state.discardPile.length-1];this.executeCardAction(e,t.playerId,t.targetPlayerId)}else"PLAY_COMBO"===t.type&&this.executeComboAction(t.playerId,t.cardIndices.length,t.targetPlayerId,t.requestedCardType);this.checkBotTurn()}executeCardAction(t,a,i){const n=this.state.players.findIndex(t=>t.id===a);switch(t[0]){case s.ATTACK:this.state.attackStack=(this.state.attackStack>1?this.state.attackStack:0)+2,this.advanceTurn(!0);break;case s.SKIP:this.finishTurnAction();break;case s.SHUFFLE:this.state.drawPile=this.shuffle(this.state.drawPile);break;case s.SEE_THE_FUTURE:break;case s.FAVOR:if(i){const t=this.state.players.findIndex(t=>t.id===i);-1===t||t===n||this.state.players[t].isExploded||(this.state.gamePhase=e.FAVOR_GIVING,this.state.favorFrom=i,this.state.favorTo=a)}break;case s.REVERSE:this.state.direction*=-1,this.finishTurnAction();break;case s.TARGETED_ATTACK:if(i){const t=this.state.players.findIndex(t=>t.id===i);-1===t||t===n||this.state.players[t].isExploded||(this.state.attackStack=(this.state.attackStack>1?this.state.attackStack:0)+2,this.state.currentTurnIndex=t,this.checkBotTurn())}break;case s.ALTER_THE_FUTURE_3:this.state.alterCards=this.state.drawPile.slice(-3).reverse(),this.state.alterCount=3,this.state.gamePhase=e.ALTER_THE_FUTURE,this.checkBotTurn();break;case s.ALTER_THE_FUTURE_5:this.state.alterCards=this.state.drawPile.slice(-5).reverse(),this.state.alterCount=5,this.state.gamePhase=e.ALTER_THE_FUTURE,this.checkBotTurn()}}executeComboAction(t,e,s,a){const i=this.state.players.findIndex(e=>e.id===t),n=this.state.players[i],r=this.state.players.findIndex(t=>t.id===s);if(-1===r||r===i||this.state.players[r].isExploded)return;const d=this.state.players[r];if(2===e){if(d.hand.length>0){const t=Math.floor(Math.random()*d.hand.length),e=d.hand.splice(t,1)[0];e&&n.hand.push(e)}}else if(3===e&&void 0!==a){const t=d.hand.findIndex(t=>t[0]===a);if(-1!==t){const e=d.hand.splice(t,1)[0];e&&n.hand.push(e)}}}handleDefuse(t){if(this.state.gamePhase!==e.DEFUSING)return;const a=this.state.players.findIndex(e=>e.id===t);if(a!==this.state.currentTurnIndex)return;const i=this.state.players[a],n=i.hand.findIndex(t=>t[0]===s.DEFUSE);if(-1===n)return;const r=i.hand.splice(n,1)[0];this.state.discardPile.push(r);const d=Date.now();this.state.discardHistory.push({playerId:t,cards:[r],timestamp:d}),this.state.lastAction={action:{type:"DEFUSE",playerId:t},playerId:t,timestamp:d,isNoped:!1,cardType:s.DEFUSE},this.state.gamePhase=e.INSERTING_KITTEN,this.checkBotTurn()}handleInsertKitten(t,a){if(this.state.gamePhase!==e.INSERTING_KITTEN)return;if(this.state.players.findIndex(e=>e.id===t)!==this.state.currentTurnIndex)return;const i=Math.max(0,Math.min(a,this.state.drawPile.length));this.state.drawPile.splice(this.state.drawPile.length-i,0,[s.EXPLODING_KITTEN,999]),this.state.gamePhase=e.PLAYING,this.finishTurnAction()}handleGiveFavor(t,s){if(this.state.gamePhase!==e.FAVOR_GIVING)return;if(t!==this.state.favorFrom)return;const a=this.state.players.find(t=>t.id===this.state.favorFrom),i=this.state.players.find(t=>t.id===this.state.favorTo);if(a&&i&&s>=0&&s<a.hand.length){const t=a.hand.splice(s,1)[0];t&&i.hand.push(t),this.state.gamePhase=e.PLAYING,this.state.favorFrom=null,this.state.favorTo=null,this.checkBotTurn()}}handleReorderFuture(t,s){if(this.state.gamePhase!==e.ALTER_THE_FUTURE)return;if(this.state.players.findIndex(e=>e.id===t)!==this.state.currentTurnIndex)return;if(!this.state.alterCards)return;const a=this.state.alterCount;if(s.length!==a||!s.every((t,e,s)=>t>=0&&t<a&&s.indexOf(t)===e))return;const i=s.map(t=>this.state.alterCards[t]);this.state.drawPile.splice(this.state.drawPile.length-a,a);for(let e=i.length-1;e>=0;e--)this.state.drawPile.push(i[e]);this.state.alterCards=null,this.state.alterCount=0,this.state.lastAction={action:{type:"REORDER_FUTURE",playerId:t,newOrder:s},playerId:t,timestamp:Date.now(),isNoped:!1},this.state.gamePhase=e.PLAYING,this.checkBotTurn()}finishTurnAction(){this.state.attackStack--,this.state.attackStack<=0?this.advanceTurn():this.checkBotTurn()}advanceTurn(t=!1){const e=this.getNextPlayerIndex(this.state.currentTurnIndex);this.state.currentTurnIndex=e,t||(this.state.attackStack=1),this.checkBotTurn()}getNextPlayerIndex(t){const e=this.state.players.length;let s=t;do{s=(s+this.state.direction+e)%e}while(null===this.state.players[s].id||this.state.players[s].isExploded);return s}getNextPlayerId(t){const e=this.getNextPlayerIndex(t);return this.state.players[e].id}explodePlayer(t){const a=this.state.players[t];this.state.discardHistory.push({playerId:a.id,cards:[[s.EXPLODING_KITTEN,0]],timestamp:Date.now(),isNoped:!1}),this.state.lastAction={action:{type:"EXPLODE",playerId:a.id},playerId:a.id,timestamp:Date.now(),isNoped:!1,cardType:s.EXPLODING_KITTEN},this.state.players[t].isExploded=!0,this.state.players[t].hand=[];const i=this.state.players.filter(t=>null!==t.id&&!t.isExploded);1===i.length?(this.state.winner=i[0].id,this.state.gamePhase=e.ENDED,this.clearSavedState()):(this.state.gamePhase=e.PLAYING,this.advanceTurn())}checkBotTurn(){if(!this.isHost||this.state.gamePhase===e.ENDED)return;if(this.state.gamePhase===e.FAVOR_GIVING){const t=this.state.players.find(t=>t.id===this.state.favorFrom);return void(t?.isBot&&setTimeout(()=>this.makeBotFavor(t),1e3))}if(this.state.gamePhase===e.ALTER_THE_FUTURE){const t=this.state.players[this.state.currentTurnIndex];return void(t?.isBot&&this.state.alterCards&&setTimeout(()=>{if(this.state.gamePhase===e.ALTER_THE_FUTURE){const e=Array.from({length:this.state.alterCount},(t,e)=>e);this.handleReorderFuture(t.id,e)}},1500))}if(this.state.gamePhase===e.NOPE_WINDOW){if(!this.state.pendingAction)return;return void this.state.players.forEach(t=>{if(t.isBot&&!t.isExploded&&void 0===this.state.pendingAction.responses[t.id]){t.hand.some(t=>t[0]===s.NOPE)?setTimeout(()=>{this.state.gamePhase===e.NOPE_WINDOW&&(Math.random()<.2?this.handleRespondNope(t.id,"NOPE"):this.handleRespondNope(t.id,"ALLOW"))},1e3+2e3*Math.random()):setTimeout(()=>{this.state.gamePhase===e.NOPE_WINDOW&&this.handleRespondNope(t.id,"ALLOW")},500+1e3*Math.random())}})}const t=this.state.players[this.state.currentTurnIndex];t?.isBot&&!t.isExploded&&setTimeout(()=>this.makeBotMove(t),1500)}makeBotMove(t){if(!this.isHost||this.state.currentTurnIndex!==this.state.players.indexOf(t))return;if(this.state.gamePhase===e.DEFUSING)return void this.handleDefuse(t.id);if(this.state.gamePhase===e.INSERTING_KITTEN){const e=Math.floor(Math.random()*(this.state.drawPile.length+1));return void this.handleInsertKitten(t.id,e)}if(this.state.gamePhase!==e.PLAYING)return;const a=new Map;t.hand.forEach((t,e)=>{t[0]>=s.CAT_1&&t[0]<=s.CAT_5&&(a.has(t[0])||a.set(t[0],[]),a.get(t[0]).push(e))});for(const[e,n]of a.entries())if(n.length>=2&&Math.random()<.4){const e=n.length>=3&&Math.random()<.5?3:2,a=this.state.players.filter(e=>null!==e.id&&e.id!==t.id&&!e.isExploded);if(a.length>0){const i=a[Math.floor(Math.random()*a.length)].id,r=n.slice(0,e),d=3===e?[s.ATTACK,s.SKIP,s.FAVOR,s.SHUFFLE,s.SEE_THE_FUTURE,s.REVERSE,s.TARGETED_ATTACK,s.ALTER_THE_FUTURE_3][Math.floor(8*Math.random())]:void 0;return void this.handlePlayCombo(t.id,r,i,d)}}const i=t.hand.map((t,e)=>e).filter(e=>{const a=t.hand[e][0];return a!==s.DEFUSE&&(a!==s.EXPLODING_KITTEN&&(a!==s.NOPE&&!(a>=s.CAT_1&&a<=s.CAT_5)))});if(i.length>0&&Math.random()<.3){const e=i[Math.floor(Math.random()*i.length)],a=t.hand[e][0];let n;if(a===s.FAVOR||a===s.TARGETED_ATTACK){const e=this.state.players.filter(e=>null!==e.id&&e.id!==t.id&&!e.isExploded);if(e.length>0)n=e[Math.floor(Math.random()*e.length)].id;else if(a===s.TARGETED_ATTACK)return void this.handleDrawCard(t.id)}this.handlePlayCard(t.id,e,n)}else this.handleDrawCard(t.id)}makeBotFavor(t){if(t.hand.length>0){const e=Math.floor(Math.random()*t.hand.length);this.handleGiveFavor(t.id,e)}}handleAddBot(t){t<0||t>=5||this.state.gamePhase!==e.WAITING||null===this.state.players[t].id&&(this.state.players[t]={id:`BOT_${t}_${Date.now()}`,username:`Bot ${t+1}`,hand:[],isExploded:!1,isBot:!0,isHost:!1})}handleJoinSlot(t,s,a){t<0||t>=5||this.state.gamePhase!==e.WAITING||null===this.state.players[t].id&&(this.state.players.some(t=>t.id===s)||(this.state.players[t]={id:s,username:a,hand:[],isExploded:!1,isBot:!1,isHost:!1}))}handleRemovePlayer(t){if(t<0||t>=5||this.state.gamePhase!==e.WAITING)return;this.state.players[t].isBot&&(this.state.players[t]={id:null,username:`Slot ${t+1}`,hand:[],isExploded:!1,isBot:!1,isHost:!1})}requestDrawCard(){this.makeAction({type:"DRAW_CARD",playerId:this.userId})}requestPlayCard(t,e){this.makeAction({type:"PLAY_CARD",playerId:this.userId,cardIndex:t,targetPlayerId:e})}requestDefuse(){this.makeAction({type:"DEFUSE",playerId:this.userId})}requestInsertKitten(t){this.makeAction({type:"INSERT_KITTEN",playerId:this.userId,index:t})}requestGiveFavor(t){this.makeAction({type:"GIVE_FAVOR",playerId:this.userId,cardIndex:t})}requestPlayCombo(t,e,s){this.makeAction({type:"PLAY_COMBO",playerId:this.userId,cardIndices:t,targetPlayerId:e,requestedCardType:s})}requestAddBot(t){this.makeAction({type:"ADD_BOT",slotIndex:t})}requestJoinSlot(t,e){this.makeAction({type:"JOIN_SLOT",slotIndex:t,playerId:this.userId,playerName:e})}requestRemovePlayer(t){this.makeAction({type:"REMOVE_PLAYER",slotIndex:t})}requestStartGame(){this.makeAction({type:"START_GAME"})}requestRespondNope(t){this.makeAction({type:"RESPOND_NOPE",playerId:this.userId,response:t})}requestReorderFuture(t){this.makeAction({type:"REORDER_FUTURE",playerId:this.userId,newOrder:t})}requestNewGame(){this.isHost?this.onSocketGameAction({action:{type:"NEW_GAME"}}):this.sendSocketGameAction({type:"REQUEST_NEW_GAME",playerId:this.userId,playerName:this.state.players.find(t=>t.id===this.userId)?.username||"Player"})}acceptNewGame(){this.onSocketGameAction({action:{type:"ACCEPT_NEW_GAME"}})}declineNewGame(){this.onSocketGameAction({action:{type:"DECLINE_NEW_GAME"}})}handleNewGameRequest(t,e){this.state.newGameRequest={fromId:t,fromName:e}}reset(){const t=this.state.players.map(t=>({...t,hand:[],isExploded:!1}));this.state={...this.getInitState(),players:t}}}export{i as default};
