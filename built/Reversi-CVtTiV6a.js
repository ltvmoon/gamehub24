import{B as t}from"./BaseGame-Di8Z51TE.js";import"./socket-DRbsQkF5.js";import"./index-CZ7EuLwr.js";import"./react-vendor-B6_iA-Ai.js";import"./zustand-DzQBgWHa.js";const e=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];function s(t){return{board:t.board.map(t=>[...t]),currentPlayer:t.currentPlayer}}function a(t,e){const s=0===e?"black":"white",a=[];for(let r=0;r<8;r++)for(let e=0;e<8;e++)i(t,r,e,s).length>0&&a.push([r,e]);return a}function i(t,s,a,i){if(!i||null!==t[s][a])return[];const r="black"===i?"white":"black",n=[];for(const[o,l]of e){const e=[];let h=s+o,c=a+l;for(;h>=0&&h<8&&c>=0&&c<8&&t[h][c]===r;)e.push([h,c]),h+=o,c+=l;h>=0&&h<8&&c>=0&&c<8&&t[h][c]===i&&e.length>0&&n.push(...e)}return n}function r(t,e){const a=s(t),r=0===t.currentPlayer?"black":"white",[n,o]=e,l=i(a.board,n,o,r);a.board[n][o]=r;for(const[s,i]of l)a.board[s][i]=r;return a.currentPlayer=1-t.currentPlayer,a}function n(t){const e=a(t,0),s=a(t,1);return 0===e.length&&0===s.length}function o(t,e,s){return{state:t,parent:e,move:s,children:[],untriedMoves:a(t.board,t.currentPlayer),visits:0,wins:0}}function l(t,e){if(0===t.visits)return 1/0;return(e?t.wins:t.visits-t.wins)/t.visits+1.414*Math.sqrt(Math.log(t.parent.visits)/t.visits)}function h(t,e){const s=t.state.currentPlayer===e;let a=t.children[0],i=-1/0;for(const r of t.children){const t=l(r,s);t>i&&(a=r,i=t)}return a}function c(t){const e=Math.floor(Math.random()*t.untriedMoves.length),s=t.untriedMoves[e];t.untriedMoves.splice(e,1);const a=o(r(t.state,s),t,s);return t.children.push(a),a}function u(t,e){let i=s(t.state);for(;!n(i.board);){const t=a(i.board,i.currentPlayer);if(0===t.length){i.currentPlayer=1-i.currentPlayer;continue}i=r(i,t[Math.floor(Math.random()*t.length)])}const o=function(t){let e=0,s=0;for(let a=0;a<8;a++)for(let i=0;i<8;i++)"black"===t[a][i]&&e++,"white"===t[a][i]&&s++;return e>s?0:s>e?1:-1}(i.board);return-1===o?.5:o===e?1:0}function d(t,e){for(;null!==t;)t.visits++,t.wins+=e,t=t.parent}class p extends t{getInitState(){return{board:this.createInitialBoard(),players:{black:this.players[0],white:this.players[1]},turn:"black",winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null,flippedCells:[]}}createInitialBoard(){const t=Array(8).fill(null).map(()=>Array(8).fill(null));return t[3][3]="white",t[3][4]="black",t[4][3]="black",t[4][4]="white",t}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.row,e.col);break;case"PASS":this.handlePass(e.playerId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo()}}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players.black?.id&&this.state.players.white?.id&&(this.state.gamePhase="playing",this.state.turn="black",this.state.board=this.createInitialBoard(),this.state.moveHistory=[],this.state.winner=null,this.state.lastMove=null,this.syncState(),this.checkBotTurn())}handleMakeMove(t,e,s){if("playing"!==this.state.gamePhase)return;const a=this.state.players[this.state.turn];if(!a||a.id!=t)return;const i=this.state.turn,r=this.getFlips(e,s,i);if(0===r.length)return;this.saveHistory(),this.state.board[e][s]=i;for(const[n,o]of r)this.state.board[n][o]=i;this.state.lastMove={row:e,col:s},this.state.flippedCells=r.map(([t,e])=>({row:t,col:e})),this.state.turn="black"===i?"white":"black";if(0===this.getValidMoves(this.state.turn).length){0===this.getValidMoves(i).length?this.endGame():this.state.turn=i}this.syncState(),this.checkBotTurn()}handlePass(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.turn];if(!e||e.id!=t)return;this.getValidMoves(this.state.turn).length>0||(this.state.turn="black"===this.state.turn?"white":"black",this.syncState(),this.checkBotTurn())}endGame(){this.state.gamePhase="ended";let t=0,e=0;for(let s=0;s<8;s++)for(let a=0;a<8;a++)"black"===this.state.board[s][a]&&t++,"white"===this.state.board[s][a]&&e++;this.state.winner=t>e?this.state.players.black?.id||null:e>t?this.state.players.white?.id||null:"draw",this.broadcastGameEnd({winner:this.state.winner??void 0})}getValidMoves(t){const e=[];for(let s=0;s<8;s++)for(let a=0;a<8;a++)this.getFlips(s,a,t).length>0&&e.push([s,a]);return e}getFlips(t,s,a){if(!a||null!=this.state.board[t][s])return[];const i="black"===a?"white":"black",r=[];for(const[n,o]of e){const e=[];let l=t+n,h=s+o;for(;l>=0&&l<8&&h>=0&&h<8&&this.state.board[l][h]===i;)e.push([l,h]),l+=n,h+=o;l>=0&&l<8&&h>=0&&h<8&&this.state.board[l][h]===a&&e.length>0&&r.push(...e)}return r}saveHistory(){const t={board:this.state.board.map(t=>[...t]),turn:this.state.turn};this.state.moveHistory.push(t),this.state.moveHistory.length>5&&this.state.moveHistory.shift()}handleRequestUndo(t,e){if("playing"!==this.state.gamePhase)return;if(0===this.state.moveHistory.length)return;if(this.state.undoRequest)return;const s="black"===this.state.turn?"white":"black",a=this.state.players[s];a?.isBot?this.applyUndo():(this.state.undoRequest={fromId:t,fromName:e},this.syncState())}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){if(0===this.state.moveHistory.length)return;const t=this.state.moveHistory.pop();this.state.board=t.board,this.state.turn=t.turn,this.state.undoRequest=null,this.state.lastMove=null,this.syncState()}handleDeclineUndo(){this.state.undoRequest=null,this.syncState()}handleAddBot(){this.state.players.white?.id||(this.state.players.white={id:`BOT_${Date.now()}`,username:"Bot",isHost:!1,isBot:!0},this.syncState())}handleRemoveBot(){this.state.players.white?.isBot&&(this.state.players.white=null,this.syncState())}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.turn];t?.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t.id),800)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.turn];if(e?.id!=t)return;const s=this.getValidMoves(this.state.turn);if(0===s.length)return void this.handlePass(t);const i="black"===this.state.turn?0:1,r=function(t,e,s=500){const i={board:t.map(t=>[...t]),currentPlayer:e},r=a(i.board,e);if(0===r.length)return null;if(1===r.length)return r[0];const n=o(i,null,null),l=performance.now();for(;performance.now()-l<s;){let t=n;for(;0===t.untriedMoves.length&&t.children.length>0;)t=h(t,e);t.untriedMoves.length>0&&(t=c(t)),d(t,u(t,e))}let p=null,y=-1;for(const a of n.children)a.visits>y&&(y=a.visits,p=a.move);return p}(this.state.board,i,500);if(r)this.handleMakeMove(t,r[0],r[1]);else{const e=s[Math.floor(Math.random()*s.length)];this.handleMakeMove(t,e[0],e[1])}}requestMove(t,e){const s={type:"MAKE_MOVE",playerId:this.userId,row:t,col:e};this.makeAction(s)}requestPass(){const t={type:"PASS",playerId:this.userId};this.makeAction(t)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(){this.makeAction({type:"ADD_BOT"})}requestRemoveBot(){this.makeAction({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.black?.id===this.userId?this.state.players.black:this.state.players.white,e={type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"};this.makeAction(e)}acceptUndo(){this.makeAction({type:"ACCEPT_UNDO"})}declineUndo(){this.makeAction({type:"DECLINE_UNDO"})}requestNewGame(){this.makeAction({type:"RESET"})}reset(){this.state={...this.state,board:this.createInitialBoard(),turn:"black",winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null},this.syncState()}updatePlayers(t){"waiting"===this.state.gamePhase?(this.state.players.black=t[0],this.state.players.white=t[1],this.syncState()):this.syncState()}getMyColor(){return this.state.players.black?.id===this.userId?"black":this.state.players.white?.id===this.userId?"white":null}getMyPlayerIndex(){return"black"===this.getMyColor()?0:1}canStartGame(){return null!=this.state.players.black&&null!=this.state.players.white}getPieceCount(){let t=0,e=0;for(let s=0;s<8;s++)for(let a=0;a<8;a++)"black"===this.state.board[s][a]&&t++,"white"===this.state.board[s][a]&&e++;return{black:t,white:e}}}export{p as default};
