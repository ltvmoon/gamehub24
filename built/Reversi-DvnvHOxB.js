import{B as t}from"./BaseGame-CcmywW8C.js";import{R as e,a as s,b as n}from"./types-BukwI6ND.js";import{h as a}from"./index-Dmop2YmA.js";import"./socket-DRbsQkF5.js";import"./react-vendor-BZHK3qaO.js";import"./zustand-CJEMJLaT.js";const i=0x7e7e7e7e7e7e7e7en,r=0xffffffffffffffffn;function o(t,e){const s=~(t|e)&r;let n=0n;for(const a of[1n,7n,8n,9n])n|=h(t,e,s,a),n|=h(t,e,s,-a);return n}function h(t,e,s,n){let a=0n;if(1n===n?a=t>>1n&e&i:-1n===n?a=t<<1n&e&i:7n===n?a=t>>7n&e&i:-7n===n?a=t<<7n&e&i:9n===n?a=t>>9n&e&i:-9n===n?a=t<<9n&e&i:8n===n?a=t>>8n&e:-8n===n&&(a=t<<8n&e),0n===a)return 0n;for(let r=0;r<5;r++)1n===n?a|=a>>1n&e&i:-1n===n?a|=a<<1n&e&i:7n===n?a|=a>>7n&e&i:-7n===n?a|=a<<7n&e&i:9n===n?a|=a>>9n&e&i:-9n===n?a|=a<<9n&e&i:8n===n?a|=a>>8n&e:-8n===n&&(a|=a<<8n&e);return 1n===n?a>>1n&s&i:-1n===n?a<<1n&s&i:7n===n?a>>7n&s&i:-7n===n?a<<7n&s&i:9n===n?a>>9n&s&i:-9n===n?a<<9n&s&i:8n===n?a>>8n&s:-8n===n?a<<8n&s:0n}function l(t,e,s){let n=0n;for(const a of[1n,7n,8n,9n,-1n,-7n,-8n,-9n]){let r=0n,o=0n;for(1n===a?o=t>>1n&s&i:-1n===a?o=t<<1n&s&i:7n===a?o=t>>7n&s&i:-7n===a?o=t<<7n&s&i:9n===a?o=t>>9n&s&i:-9n===a?o=t<<9n&s&i:8n===a?o=t>>8n&s:-8n===a&&(o=t<<8n&s);0n!==o;){r|=o;let t=0n;if(1n===a?t=o>>1n:-1n===a?t=o<<1n:7n===a?t=o>>7n:-7n===a?t=o<<7n:9n===a?t=o>>9n:-9n===a?t=o<<9n:8n===a?t=o>>8n:-8n===a&&(t=o<<8n),0n!==(t&e)){n|=r;break}o=8n===a||-8n===a?t&s:t&s&i}}return n}function u(t){let e=0,s=t;for(;s>0n;)s&=s-1n,e++;return e}function c(t,e,s){const n=o(0===t.turn?t.bb:t.wb,0===t.turn?t.wb:t.bb),a=[];for(let i=0;i<64;i++)n>>BigInt(i)&1n&&a.push(i);return{state:t,parent:e,move:s,children:[],untriedMoves:a,visits:0,wins:0}}function d(t,e){if(0===t.visits)return 1/0;return(e?t.wins:t.visits-t.wins)/t.visits+1.414*Math.sqrt(Math.log(t.parent.visits)/t.visits)}function p(t,e){const s=t.state.turn===e;let n=t.children[0],a=-1/0;for(const i of t.children){const t=d(i,s);t>a&&(n=i,a=t)}return n}function f(t){const e=Math.floor(Math.random()*t.untriedMoves.length),s=t.untriedMoves[e];t.untriedMoves.splice(e,1);const n=c(function(t,e){const s=1n<<BigInt(e),n=0===t.turn?t.bb:t.wb,a=0===t.turn?t.wb:t.bb,i=l(s,n,a),o=n|s|i,h=a&~i&r;return{bb:0===t.turn?o:h,wb:0===t.turn?h:o,turn:1-t.turn}}(t.state,s),t,s);return t.children.push(n),n}function B(t,e){let s=t.bb,n=t.wb,a=t.turn;for(let h=0;h<60;h++){const t=0===a?s:n,e=0===a?n:s,i=o(t,e);if(0n===i){if(0n===o(e,t))break;a=1-a;continue}const h=[];for(let s=0;s<64;s++)i>>BigInt(s)&1n&&h.push(s);const u=h[Math.floor(Math.random()*h.length)];if(void 0===u)break;const c=1n<<BigInt(u),d=l(c,t,e),p=t|c|d,f=e&~d&r;s=0===a?p:f,n=0===a?f:p,a=1-a}const i=function(t,e){const s=u(t),n=u(e);return s>n?0:n>s?1:-1}(s,n);return-1===i?.5:i===e?1:0}function b(t,e){for(;null!==t;)t.visits++,t.wins+=e,t=t.parent}class y extends t{isGameOver(t){return t.gamePhase===e.ENDED}getInitState(){const{bb:t,wb:n}=this.getInitialBitboards();return{blackBoard:t.toString(16),whiteBoard:n.toString(16),players:{black:this.preparePlayer(this.players[0]),white:this.preparePlayer(this.players[1])},turn:s.BLACK,winner:null,gamePhase:e.WAITING,undoRequest:null,moveHistory:[],lastMove:null,flippedCells:[]}}preparePlayer(t){return t?{...t,flags:t.isBot?n.BOT:0}:null}getInitialBitboards(){return{bb:34628173824n,wb:68853694464n}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.row,e.col);break;case"PASS":this.handlePass(e.playerId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo()}}handleStartGame(){if(this.state.gamePhase!==e.WAITING)return;if(!this.state.players.black?.id||!this.state.players.white?.id)return;const{bb:t,wb:n}=this.getInitialBitboards();this.state.gamePhase=e.PLAYING,this.state.turn=s.BLACK,this.state.blackBoard=t.toString(16),this.state.whiteBoard=n.toString(16),this.state.moveHistory=[],this.state.winner=null,this.state.lastMove=null,this.state.flippedCells=[],this.checkBotTurn()}handleMakeMove(t,n,a){if(this.state.gamePhase!==e.PLAYING)return;const i=this.state.turn,h=i===s.BLACK?this.state.players.black:this.state.players.white;if(!h||h.id!==t)return;const u=8*n+a,c=1n<<BigInt(u),d=BigInt("0x"+this.state.blackBoard),p=BigInt("0x"+this.state.whiteBoard),f=i===s.BLACK?d:p,B=i===s.BLACK?p:d,b=l(c,f,B);if(0n===b)return;this.saveHistory();const y=f|c|b,g=B&~b&r;i===s.BLACK?(this.state.blackBoard=y.toString(16),this.state.whiteBoard=g.toString(16)):(this.state.blackBoard=g.toString(16),this.state.whiteBoard=y.toString(16)),this.state.lastMove=u,this.state.flippedCells=[];for(let e=0;e<64;e++)b>>BigInt(e)&1n&&this.state.flippedCells.push(e);const m=i===s.BLACK?s.WHITE:s.BLACK;this.state.turn=m,0n===o(g,y)&&(0n===o(y,g)?this.endGame():this.state.turn=i),this.checkBotTurn()}handlePass(t){if(this.state.gamePhase!==e.PLAYING)return;const n=this.state.turn,a=n===s.BLACK?this.state.players.black:this.state.players.white;if(!a||a.id!==t)return;const i=BigInt("0x"+this.state.blackBoard),r=BigInt("0x"+this.state.whiteBoard);0n===o(n===s.BLACK?i:r,n===s.BLACK?r:i)&&(this.state.turn=n===s.BLACK?s.WHITE:s.BLACK,this.checkBotTurn())}endGame(){this.state.gamePhase=e.ENDED;const t=this.getPieceCount();t.black>t.white?this.state.winner=this.state.players.black?.id||null:t.white>t.black?this.state.winner=this.state.players.white?.id||null:this.state.winner="draw",this.clearSavedState()}getValidMoves(t){const e=BigInt("0x"+this.state.blackBoard),n=BigInt("0x"+this.state.whiteBoard),a=o(t===s.BLACK?e:n,t===s.BLACK?n:e),i=[];for(let s=0;s<64;s++)a>>BigInt(s)&1n&&i.push([Math.floor(s/8),s%8]);return i}saveHistory(){const t={bb:this.state.blackBoard,wb:this.state.whiteBoard,t:this.state.turn};this.state.moveHistory.push(t),this.state.moveHistory.length>5&&this.state.moveHistory.shift()}handleRequestUndo(t,i){if(this.state.gamePhase!==e.PLAYING)return;if(0===this.state.moveHistory.length)return;if(this.state.undoRequest)return;const r=(this.state.turn===s.BLACK?s.WHITE:s.BLACK)===s.BLACK?this.state.players.black:this.state.players.white;r&&a(r.flags,n.BOT)?this.applyUndo():this.state.undoRequest={fromId:t,fromName:i}}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){if(0===this.state.moveHistory.length)return;const t=this.state.moveHistory.pop();this.state.blackBoard=t.bb,this.state.whiteBoard=t.wb,this.state.turn=t.t,this.state.undoRequest=null,this.state.lastMove=null,this.state.flippedCells=[]}handleDeclineUndo(){this.state.undoRequest=null}handleAddBot(){this.state.players.white?.id||(this.state.players.white={id:`BOT_${Date.now()}`,username:"Bot",isHost:!1,isBot:!0,flags:n.BOT})}handleRemoveBot(){this.state.players.white&&a(this.state.players.white.flags,n.BOT)&&(this.state.players.white=null)}checkBotTurn(){if(!this.isHost)return;if(this.state.gamePhase!==e.PLAYING)return;const t=this.state.turn===s.BLACK?this.state.players.black:this.state.players.white;t&&a(t.flags,n.BOT)&&t.id&&setTimeout(()=>this.makeBotMove(t.id),800)}makeBotMove(t){if(this.state.gamePhase!==e.PLAYING)return;const n=this.state.turn,a=n===s.BLACK?this.state.players.black:this.state.players.white;if(a?.id!=t)return;const i=this.getValidMoves(n);if(0===i.length)return void this.handlePass(t);const r=function(t,e,s,n=500){const a={bb:t,wb:e,turn:s},i=o(0===s?t:e,0===s?e:t);if(0n===i)return null;const r=[];for(let o=0;o<64;o++)i>>BigInt(o)&1n&&r.push(o);if(1===r.length)return[Math.floor(r[0]/8),r[0]%8];const h=c(a,null,null),l=performance.now();for(;performance.now()-l<n;){let t=h;for(;0===t.untriedMoves.length&&t.children.length>0;)t=p(t,s);t.untriedMoves.length>0&&(t=f(t)),b(t,B(t.state,s))}let u=null,d=-1;for(const o of h.children)o.visits>d&&(d=o.visits,u=o.move);return null!==u?[Math.floor(u/8),u%8]:null}(BigInt("0x"+this.state.blackBoard),BigInt("0x"+this.state.whiteBoard),n===s.BLACK?0:1,500);if(r)this.handleMakeMove(t,r[0],r[1]);else{const e=i[Math.floor(Math.random()*i.length)];this.handleMakeMove(t,e[0],e[1])}}requestMove(t,e){this.makeAction({type:"MAKE_MOVE",playerId:this.userId,row:t,col:e})}requestPass(){this.makeAction({type:"PASS",playerId:this.userId})}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(){this.makeAction({type:"ADD_BOT"})}requestRemoveBot(){this.makeAction({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.black?.id===this.userId?this.state.players.black:this.state.players.white;this.makeAction({type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"})}acceptUndo(){this.makeAction({type:"ACCEPT_UNDO"})}declineUndo(){this.makeAction({type:"DECLINE_UNDO"})}requestNewGame(){this.makeAction({type:"RESET"})}reset(){const{bb:t,wb:n}=this.getInitialBitboards();this.state.blackBoard=t.toString(16),this.state.whiteBoard=n.toString(16),this.state.turn=s.BLACK,this.state.winner=null,this.state.gamePhase=e.WAITING,this.state.undoRequest=null,this.state.moveHistory=[],this.state.lastMove=null,this.state.flippedCells=[]}updatePlayers(t){this.state.gamePhase===e.WAITING&&(this.state.players.black=this.preparePlayer(t[0]),this.state.players.white&&a(this.state.players.white.flags,n.BOT)||(this.state.players.white=this.preparePlayer(t[1])))}getMyColor(){return this.state.players.black?.id===this.userId?s.BLACK:this.state.players.white?.id===this.userId?s.WHITE:null}getMyPlayerIndex(){const t=this.getMyColor();return t===s.BLACK?0:t===s.WHITE?1:-1}canStartGame(){return null!=this.state.players.black&&null!=this.state.players.white}getPieceCount(){const t=BigInt("0x"+this.state.blackBoard),e=BigInt("0x"+this.state.whiteBoard);return{black:u(t),white:u(e)}}}export{y as default};
