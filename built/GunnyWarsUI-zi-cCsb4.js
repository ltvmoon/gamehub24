import{u as e,b as t,S as r,j as n,P as s,i as a}from"./index-BwFFTHxy.js";import{b as l,aH as o,U as i,X as c,bi as d,bj as u,bk as x,aa as f,bl as h,bm as g,aX as m,aZ as p,a_ as b,be as y,bf as v,bn as w,A as j,b1 as M,b4 as N,bo as k,bp as S,Y as C}from"./react-vendor-BqGe223k.js";import"./BaseGame-CsKbx1S6.js";import{G as T,e as A,m as I,g as R,d as L,F as E,o as O,P,k as D,W as Y,a as z,h as H,D as X,i as G}from"./constants-JoooQL59.js";import{u as B}from"./useGameState-B9NgJQ7q.js";import{u as F}from"./usePrevious-5VTlBPQq.js";import"./socket-DRbsQkF5.js";import"./zustand-B1murped.js";const _=({game:e,state:t,myTankInState:r,ts:s})=>{const[a,o]=l.useState(Date.now());l.useEffect(()=>{if(t.selectedMode!==T.CHAOS)return;const e=setInterval(()=>{o(Date.now())},100);return()=>clearInterval(e)},[t.selectedMode]);const i=r?.lastFireTime||0,c=t.selectedMode===T.CHAOS&&a-i<E,d=t.phase!==A.AIMING&&t.selectedMode!==T.CHAOS||c;return n.jsxs("button",{onClick:()=>e.fire(),disabled:d,className:"flex-[1.5] @md:flex-none @md:w-28 bg-linear-to-b from-red-500 to-red-700 hover:from-red-400 hover:to-red-600 disabled:from-gray-700 disabled:to-gray-800 text-white font-black text-xs tracking-widest rounded-lg shadow-lg active:scale-90 transition-all border-t border-red-300/30 flex flex-col items-center justify-center gap-0.5 group",children:[n.jsx("div",{className:"w-5 h-5 rounded-full border-2 border-white/20 flex items-center justify-center group-active:scale-110 transition-transform",children:n.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"})}),n.jsx("span",{children:s({en:"FIRE",vi:"BẮN"})})]})};let W=performance.now(),$=0;const U=({game:e})=>{const[t,r]=l.useState({hh:"12",mm:"00",icon:N});return l.useEffect(()=>{const t=setInterval(()=>{const t=(24*((Date.now()-e.state.gameStartTime)%X/X)*60+360)%1440,n=Math.floor(t/60),s=Math.floor(t%60);let a=N;a=n>=5&&n<8?k:n>=8&&n<17?N:n>=17&&n<20?S:C,r({hh:n.toString().padStart(2,"0"),mm:s.toString().padStart(2,"0"),icon:a})},1e3);return()=>clearInterval(t)},[]),n.jsxs("div",{className:"glass-blur px-2 py-1 rounded-sm flex items-center gap-2 ",children:[n.jsx("div",{className:"p-1.5 bg-gray-800/80 rounded-lg text-amber-400",children:n.jsx(t.icon,{size:18})}),n.jsx("div",{className:"flex flex-col",children:n.jsxs("span",{className:"font-mono font-bold text-lg text-gray-100 leading-none",children:[t.hh,":",t.mm]})})]})},q=({show:e,onClose:t,currentTank:r,game:a,ts:l})=>n.jsx(s,{children:n.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-200 "+(e?"opacity-100":"opacity-0 pointer-events-none"),children:n.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col shadow-2xl transition-transform duration-200 "+(e?"scale-100":"scale-95"),children:[n.jsxs("div",{className:"p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50",children:[n.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[n.jsx(x,{size:20,className:"text-blue-400"}),l({en:"Select Weapon",vi:"Chọn vũ khí"})]}),n.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-700 rounded-full transition-colors",children:n.jsx(c,{size:20})})]}),n.jsx("div",{className:"flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-3 no-scrollbar",children:O.map(e=>n.jsxs("button",{onClick:()=>{a.selectWeapon(e.type),t()},className:"flex flex-col gap-2 p-4 rounded-xl border-2 text-left transition-all hover:scale-[1.02] active:scale-95 "+(r?.weapon===e.type?"bg-blue-600/20 border-blue-500":"bg-gray-800/50 border-gray-700 hover:border-gray-600"),children:[n.jsxs("div",{className:"flex justify-between items-center",children:[n.jsx("span",{className:"font-bold text-lg",style:{color:e.color},children:e.name}),r?.weapon===e.type&&n.jsx("div",{className:"bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full uppercase tracking-tighter",children:l({en:"Selected",vi:"Đã chọn"})})]}),n.jsx("p",{className:"text-sm text-gray-400 leading-tight",children:l({en:e.description,vi:e.descriptionVi})}),n.jsxs("div",{className:"flex gap-4 mt-1 text-[10px] font-mono text-gray-500 uppercase",children:[n.jsxs("span",{children:[l({en:"Dmg",vi:"St"}),":"," ",n.jsx("b",{className:"text-gray-300",children:e.type===L.HEAL?`+${e.damage}`:e.damage})]}),n.jsxs("span",{children:[l({en:"Rad",vi:"Bk"}),":"," ",n.jsx("b",{className:"text-gray-300",children:e.radius})]})]})]},e.type))})]})})});function V({game:s}){const N=s,{ts:k}=e(),{confirm:S}=t(),[C]=B(N),[X,V]=l.useState({width:800,height:600}),[K,Z]=l.useState(!1),[J,Q]=l.useState(!0),ee=C.tanks.find(e=>e.playerId===N.userId),te=C.selectedMode===T.CHAOS?C.tanks.find(e=>e.playerId===N.userId):C.tanks[C.currentTurnIndex],re=te?N.getVisualTank(te):void 0,ne=C.selectedMode===T.CHAOS?!!ee:N.isMyTurn(),se=N.canStartGame();F(C.currentTurnIndex,(e,t)=>{C.phase===A.AIMING&&null!==e&&r.playTurnSwitch(ne)});const[ae,le]=l.useState(!1),[oe,ie]=l.useState(null),[ce,de]=l.useState(50),ue=l.useRef(null),xe=l.useRef(null);l.useEffect(()=>{ue.current=oe},[oe]),l.useEffect(()=>{xe.current=ce},[ce]);const fe=l.useRef(null),he=l.useRef(null),ge=l.useRef(null),me=l.useRef([]),pe=l.useRef(null),be=l.useRef(!0),ye=l.useRef(!0),ve=l.useRef({width:0,height:0});l.useEffect(()=>{ye.current=J},[J]);const we=l.useRef({x:0,y:0,vx:0,vy:0,zoom:.8,targetZoom:.8,mode:"FOLLOW_PLAYER"}),je=l.useRef({isDragging:!1,startX:0,startY:0,startCamX:0,startCamY:0,lastX:0,lastY:0,lastTime:0,startPinchDist:0,startZoom:1}),Me=l.useRef({left:!1,right:!1}),Ne=l.useRef(null),ke=l.useRef(new Map),Se=l.useRef(new Float32Array(20)),Ce=l.useRef(new Float32Array(30)),Te=l.useRef(new Float32Array(10)),Ae=l.useRef([]),Ie=l.useRef(null),Re=l.useRef(X);l.useEffect(()=>{Re.current=X},[X]),l.useEffect(()=>{if(0===me.current.length)for(let e=0;e<50;e++)me.current.push({x:2e3*Math.random(),y:1200*Math.random(),size:2*Math.random()+.5,alpha:.6*Math.random()+.2})},[]),l.useEffect(()=>()=>{pe.current&&cancelAnimationFrame(pe.current)},[]);const Le=l.useRef(!1);l.useEffect(()=>{if(C.phase===A.WAITING)return void(Le.current=!1);if(Le.current)return;Le.current=!0;const e=ge.current;if(!e)return;const t=N.initShaderRenderer(e);be.current=t,t?console.log("GPU terrain rendering enabled"):console.warn("GPU rendering unavailable, using CPU fallback")},[N,C.phase]),l.useEffect(()=>{const e=()=>{if(fe.current){const e=K?fe.current.clientHeight:.7*window.innerHeight;V({width:fe.current.clientWidth,height:e})}},t=new ResizeObserver(e);fe.current&&t.observe(fe.current),window.addEventListener("resize",e),e();const r=()=>{Z(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",r),()=>{t.disconnect(),window.removeEventListener("resize",e),document.removeEventListener("fullscreenchange",r)}},[C.phase,K]),l.useEffect(()=>{console.warn("useEffect loop");const e=()=>{const e=he.current;if(!e)return;const a=e.getContext("2d",{alpha:!0});if(!a)return;(()=>{const e=Re.current.width,t=Re.current.height,r=we.current.zoom,n=we.current.targetZoom;let s=r;Math.abs(n-r)>1e-4&&(s=r+.1*(n-r),we.current.zoom=s);const a=e/s,l=t/s,o=a/2,i=l/2;if(je.current.isDragging)we.current.mode="MANUAL";else if("MANUAL"===we.current.mode){if(we.current.x+=we.current.vx,we.current.y+=we.current.vy,we.current.vx*=.95,we.current.vy*=.95,Math.abs(s-r)>1e-4){const n=we.current.x+e/2/r,s=we.current.y+t/2/r;we.current.x=n-o,we.current.y=s-i}}else{let e=we.current.x,t=we.current.y;if(N.state.phase===A.IMPACT);else if("FOLLOW_PROJECTILE"===we.current.mode&&N.projectiles.length>0){const r=N.projectiles;if(r.length>0)e=r.reduce((e,t)=>e+t.x,0)/r.length-o,t=r.reduce((e,t)=>e+t.y,0)/r.length-i;else{const r=N.state.tanks[N.state.currentTurnIndex];r&&(e=r.x-o,t=r.y-i)}}else if("FOLLOW_PLAYER"===we.current.mode){const r=N.state.selectedMode===T.CHAOS?N.state.tanks.find(e=>e.playerId===N.userId):N.state.tanks[N.state.currentTurnIndex];if(r){const n=N.getVisualTank(r);e=n.x-o,t=n.y-i}}else if("FOLLOW_TANK"===we.current.mode&&Ie.current){const r=N.state.tanks.find(e=>e.id===Ie.current);if(r&&r.health>0){const n=N.getVisualTank(r);e=n.x-o,t=n.y-i;const s=50;n.x>=we.current.x+s&&n.x<=we.current.x+a-s&&n.y>=we.current.y+s&&n.y<=we.current.y+l-s&&(Ie.current=null,we.current.mode="MANUAL")}else Ie.current=null,we.current.mode="FOLLOW_PLAYER"}we.current.x+=.08*(e-we.current.x),we.current.y+=.08*(t-we.current.y)}const c=Math.max(0,Y-a);we.current.x=Math.max(0,Math.min(we.current.x,c));const d=z-l,u=-z;we.current.y=Math.max(u,Math.min(we.current.y,d))})();const{width:l,height:o}=Re.current,i=we.current.zoom,c=we.current.x,d=we.current.y,u=N.getTerrainShaderRenderer(),x=ye.current&&be.current&&u?.isReady();if(a.clearRect(0,0,l,o),!x){const e=a.createLinearGradient(0,0,0,o);e.addColorStop(0,"#020617"),e.addColorStop(1,"#172554"),a.fillStyle=e,a.fillRect(0,0,l,o),a.fillStyle="#ffffff";for(const t of me.current){const e=((t.x-.05*c)%l+l)%l,r=((t.y-.05*d)%o+o)%o;a.globalAlpha=t.alpha,a.beginPath(),a.arc(e,r,t.size,0,2*Math.PI),a.fill()}a.globalAlpha=1}if(a.save(),a.scale(i,i),a.translate(-c,-d),x&&u){const e=ge.current;if(e){ve.current.width===l&&ve.current.height===o&&e.width===l&&e.height===o||(e.width=l,e.height=o,ve.current={width:l,height:o},u.resize(l,o));const t=Ae.current;for(let e=t.length-1;e>=0;e--)t[e].life-=.05,t[e].life<=0&&t.splice(e,1);for(const e of N.projectiles){const r=t.find(t=>t.id===e.id);if(r)r.x=e.x,r.y=e.y,r.life=1;else{let r=[1,.9,.7];e.weapon===L.NUKE?r=[.8,.3,1]:e.weapon===L.HEAL&&(r=[.3,1,.5]),t.push({id:e.id,x:e.x,y:e.y,color:r,radius:200,life:1})}}if(N.particleCount>0){const e=N.particleData;for(let r=N.particleCount-1;r>=Math.max(0,N.particleCount-20);r--){const n=r*P;if(e[n+11]>.5){const s=`part-${r}`,a=t.find(e=>e.id===s);a?(a.life=1,a.x=e[n+0],a.y=e[n+1]):t.length<20&&t.push({id:s,x:e[n+0],y:e[n+1],color:[1.5*e[n+8],1.5*e[n+9],1.5*e[n+10]],radius:15*e[n+6],life:1})}}}t.sort((e,t)=>t.radius*t.life-e.radius*e.life);const r=Se.current,n=Ce.current,s=Te.current;let a=0;for(const e of t){if(a>=10)break;const t=2*a,l=3*a;r[t]=e.x,r[t+1]=e.y,n[l]=e.color[0]*e.life,n[l+1]=e.color[1]*e.life,n[l+2]=e.color[2]*e.life,s[a]=e.radius*(.5+.5*e.life),a++}u.setLights(r,n,s,a),u.uploadModifications(N.state.terrainMods,c,d,l,o,i),u.render(N.state.terrainSeed,c,d,l,o,i,Date.now()-N.state.gameStartTime)}}else{const e=N.getTerrainRenderer(),t=N.getTerrainMap();e&&t&&e.renderVisibleChunks(a,c,d,l,o,i,t)}const f=l/i,h=o/i,g=N.getParticleShaderRenderer();if(g&&g.isReady())g.render(N.particleData,N.particleCount,c,d,l,o,i);else{const e=50,t=N.particleData,r=N.particleCount;for(let n=0;n<r;n++){const r=n*P,s=t[r+0],l=t[r+1];if(s<c-e||s>c+f+e||l<d-e||l>d+h+e)continue;const o=t[r+4],i=t[r+6],u=t[r+11],x=Math.round(255*t[r+8]),g=Math.round(255*t[r+9]),m=Math.round(255*t[r+10]);a.save(),a.globalAlpha=o,u>.5&&(a.globalCompositeOperation="lighter"),a.fillStyle=`rgb(${x},${g},${m})`,a.beginPath(),a.arc(s,l,i,0,2*Math.PI),a.fill(),a.restore()}}const m=Date.now();for(const t of N.lightningStrikes){const e=m-t.startTime;if(e>1e3)continue;if(t.x<c-100||t.x>c+f+100)continue;const r=e/1e3,n=r<.1?r/.1:1-(r-.1)/.9;a.save();const s=d-50,l=20,o=(t.y-s)/l,i=[];let u=t.x;i.push({x:u,y:s});const x=t.x+t.y+t.startTime,h=e=>{const t=43758.5453*Math.sin(12.9898*x+78.233*e);return t-Math.floor(t)};for(let a=1;a<=l;a++){const e=60*(h(a)-.5)*(1-a/l);u=t.x+e,i.push({x:u,y:s+o*a})}a.globalCompositeOperation="lighter",a.strokeStyle=`rgba(34, 211, 238, ${.3*n})`,a.lineWidth=20,a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)a.lineTo(i[t].x,i[t].y);a.stroke(),a.strokeStyle=`rgba(165, 243, 252, ${.6*n})`,a.lineWidth=8,a.beginPath(),a.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)a.lineTo(i[t].x,i[t].y);a.stroke(),a.strokeStyle=`rgba(255, 255, 255, ${n})`,a.lineWidth=3,a.beginPath(),a.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)a.lineTo(i[t].x,i[t].y);a.stroke();for(let t=0;t<4;t++){const e=i[Math.floor(3+h(t+100)*(l-5))],r=h(t+200)>.5?1:-1,s=3+Math.floor(4*h(t+300));a.strokeStyle=`rgba(165, 243, 252, ${.4*n})`,a.lineWidth=2,a.beginPath(),a.moveTo(e.x,e.y);let c=e.x,d=e.y;for(let n=0;n<s;n++)c+=r*(15+20*h(10*t+n)),d+=.8*o,a.lineTo(c,d);a.stroke()}if(r<1){const e=1-r,n=a.createRadialGradient(t.x,t.y,0,t.x,t.y,200);n.addColorStop(0,`rgba(255, 255, 255, ${.8*e})`),n.addColorStop(.3,`rgba(34, 211, 238, ${.5*e})`),n.addColorStop(1,"rgba(34, 211, 238, 0)"),a.fillStyle=n,a.beginPath(),a.arc(t.x,t.y,10+90*r*2,0,2*Math.PI),a.fill()}a.restore()}const p=100,b=(e,t)=>Object.values(N.state.smokeZones).some(r=>{const n=e-r.x,s=t-r.y;return Math.sqrt(n*n+s*s)<r.radius}),y=N.state.tanks.find(e=>e.playerId===N.userId),v=y&&b(y.x,y.y);for(const r of N.state.tanks){if(r.health<=0)continue;const e=N.getVisualTank(r);if(e.x<c-p||e.x>c+f+p||e.y<d-p||e.y>d+h+p)continue;const n=e.playerId===N.userId;(n||v||!b(e.x,e.y))&&t(a,e,n?ue.current??e.angle:e.angle,i)}for(const t of N.projectiles){if(!t.active)continue;if(t.x<c-50||t.x>c+f+50||t.y<d-50||t.y>d+h+50)continue;a.save();const e=O.find(e=>e.type===t.weapon)?.color||"#38bdf8";a.beginPath(),a.arc(t.x,t.y,5,0,2*Math.PI),a.fillStyle=e,a.fill(),a.fillStyle="#fff",a.beginPath(),a.arc(t.x,t.y,2,0,2*Math.PI),a.fill(),a.restore()}for(const t of Object.values(N.state.smokeZones)){if(t.x+t.radius<c||t.x-t.radius>c+f||t.y+t.radius<d||t.y-t.radius>d+h)continue;a.save();const e=.001*Date.now(),r=.8,n=e=>{const t=43758.5453*Math.sin(12.9898*e+78.233);return t-Math.floor(t)},s=1e3*t.x+t.y,l=a.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius);l.addColorStop(0,`rgba(80, 90, 105, ${.6*r})`),l.addColorStop(.5,`rgba(70, 80, 95, ${.5*r})`),l.addColorStop(1,"rgba(60, 70, 85, 0)"),a.fillStyle=l,a.beginPath(),a.arc(t.x,t.y,t.radius,0,2*Math.PI),a.fill();const o=6+Math.floor(3*n(s));for(let i=0;i<o;i++){const l=s+123.7*i,o=n(l)*Math.PI*2+.2*Math.sin(.5*e+10*n(l+1)),c=.15+.55*n(l+2),d=t.radius*c,u=10*Math.sin(.6*e+15*n(l+3)),x=10*Math.cos(.5*e+15*n(l+4)),f=t.x+Math.cos(o)*d+u,h=t.y+Math.sin(o)*d+x,g=t.radius*(.25+.2*n(l+5)),m=r*(.4+.3*n(l+6)),p=a.createRadialGradient(f,h,0,f,h,g);p.addColorStop(0,`rgba(95, 105, 120, ${m})`),p.addColorStop(1,"rgba(75, 85, 100, 0)"),a.fillStyle=p,a.beginPath(),a.arc(f,h,g,0,2*Math.PI),a.fill()}a.restore()}const w=N.state.selectedMode===T.CHAOS?N.state.tanks.find(e=>e.playerId===N.userId):N.state.tanks[N.state.currentTurnIndex];if(w&&N.state.phase===A.AIMING){const e=N.getVisualTank(w),t=N.isMyTurn();r(a,e,t?ue.current??w.angle:w.angle,t?xe.current??w.power:w.power)}a.restore(),n(a,c,d,i,l,o),s(a)},t=(e,t,r,n)=>{e.save(),e.translate(t.x,t.y),e.fillStyle=t.color,e.beginPath(),e.arc(0,-10,15,0,Math.PI,!0),e.fillRect(-15,-10,30,10),e.fill(),e.fillStyle="#1e293b",e.fillRect(-18,-5,36,8),e.fillStyle="#475569";for(let a=-15;a<15;a+=6)e.beginPath(),e.arc(a+3,-1,2,0,2*Math.PI),e.fill();e.save(),e.translate(0,-10);const s=r*Math.PI/180;if(e.rotate(-s),e.fillStyle="#e2e8f0",e.fillRect(0,-3,25,6),e.restore(),e.save(),e.scale(1/n,1/n),e.translate(0,-40*n),e.fillStyle="#ffffff",e.font="bold 12px Arial",e.textAlign="center",e.fillText(t.name,0,-10),e.fillStyle="#334155",e.fillRect(-20,0,40,6),e.fillStyle=t.health>30?"#4ade80":"#ef4444",e.fillRect(-19,1,t.health/t.maxHealth*38,4),e.translate(0,8),e.fillStyle="#334155",e.fillRect(-20,0,40,4),N.state.selectedMode===T.CHAOS){const r=Date.now()-t.lastFireTime,n=Math.min(1,r/E);e.fillStyle=n>=1?"#facc15":"#64748b",e.fillRect(-19,1,38*n,2)}else if(e.fillStyle="#f59e0b",e.fillRect(-19,1,t.fuel/D*38,2),N.state.tanks[N.state.currentTurnIndex]?.id===t.id){e.beginPath(),e.moveTo(0,-15),e.lineTo(-6,-23),e.lineTo(6,-23),e.fillStyle="#facc15",e.fill();const r=R[t.weapon];r&&(e.fillStyle=r.color,e.font="bold 12px Arial",e.textAlign="center",e.fillText(r.name,0,-35))}(t.disabledTurns??0)>0&&(e.fillStyle="#06b6d4",e.font="bold 14px Arial",e.textAlign="center",e.fillText("⚡ DISABLED",0,-50)),e.restore(),e.restore()},r=(e,t,r,n)=>{e.beginPath(),e.moveTo(t.x,t.y-10);const s=r*Math.PI/180,a=n/100*H;let l=Math.cos(s)*a,o=-Math.sin(s)*a,i=t.x,c=t.y-10;for(let d=0;d<25;d++)i+=3*l,c+=3*o,o+=3*G,l+=3*N.state.wind,e.lineTo(i,c);e.strokeStyle="rgba(255, 255, 255, 0.4)",e.lineWidth=2,e.setLineDash([8,6]),e.stroke(),e.setLineDash([])},n=(e,t,r,n,s,l)=>{ke.current.clear();const o=s/n,i=l/n,c=t+20,d=t+o-20,u=r+20,x=r+i-20;for(const f of N.state.tanks){if(f.health<=0)continue;const h=N.getVisualTank(f);if(h.x>=c&&h.x<=d&&h.y>=u&&h.y<=x)continue;let g=0,m=0;h.x<c?g=c-h.x:h.x>d&&(g=h.x-d),h.y<u?m=u-h.y:h.y>x&&(m=h.y-x);const p=Math.sqrt(g*g+m*m),b=t+o/2,y=r+i/2,v=h.x-b,w=h.y-y,j=Math.atan2(w,v),M=Math.max(25,Math.min(s-25,(h.x-t)*n)),k=Math.max(25,Math.min(l-25,(h.y-r)*n));e.save(),e.translate(M,k),e.save(),e.rotate(j),e.fillStyle=h.color||"#ef4444",e.beginPath(),e.moveTo(10,0),e.lineTo(-10,7),e.lineTo(-10,-7),e.fill(),e.restore(),e.fillStyle="#fff",e.font="bold 12px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(`${a(Math.round(p))}m`,0,20),e.restore(),ke.current.set(h.id,{x:M,y:k,radius:25})}},s=e=>{e.fillStyle="#fff",e.font="bold 12px monospace",e.textAlign="left",e.textBaseline="top",e.fillText(`${$.toFixed(0)} FPS`,0,0)};return pe.current=requestAnimationFrame(function t(){const r=performance.now();let n=r-W;if(W=r,N.update(),N.state.selectedMode===T.CHAOS){const e=Me.current.left,t=Me.current.right,r=N.state.tanks.find(e=>e.playerId===N.userId);r&&(e&&-1!==Ne.current?(Ne.current=-1,r.isMoving=!0,r.moveDir=-1,N.moveStart(-1),we.current.mode="FOLLOW_PLAYER"):t&&1!==Ne.current?(Ne.current=1,r.isMoving=!0,r.moveDir=1,N.moveStart(1),we.current.mode="FOLLOW_PLAYER"):e||t||null===Ne.current||(Ne.current=null,r.isMoving=!1,r.moveDir=void 0,N.moveStop()))}$+=.1*(1e3/n-$),e(),pe.current=requestAnimationFrame(t)}),()=>{pe.current&&cancelAnimationFrame(pe.current)}},[]),l.useEffect(()=>{const e=e=>{"ArrowLeft"===e.key&&(Me.current.left=!0),"ArrowRight"===e.key&&(Me.current.right=!0);const t=N.state.tanks.find(e=>e.playerId===N.userId),r=N.state.selectedMode===T.CHAOS?!!t:N.isMyTurn(),n=!(N.state.phase!==A.AIMING&&N.state.selectedMode!==T.CHAOS||N.state.selectedMode===T.CHAOS&&!(Date.now()-(t?.lastFireTime||0)>=E));" "===e.key&&r&&n&&(e.preventDefault(),N.fire())},t=e=>{"ArrowLeft"===e.key&&(Me.current.left=!1),"ArrowRight"===e.key&&(Me.current.right=!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[N]);const Ee=l.useCallback(e=>{if(-1===e&&(Me.current.left=!0),1===e&&(Me.current.right=!0),N.state.selectedMode!==T.CHAOS){const t=N.getMyTank();!t||t.isMoving&&t.moveDir===e||N.moveStart(e)}we.current.mode="FOLLOW_PLAYER"},[N]),Oe=l.useCallback(e=>{if(-1===e&&(Me.current.left=!1),1===e&&(Me.current.right=!1),N.state.selectedMode!==T.CHAOS){const t=N.getMyTank();t&&t.isMoving&&t.moveDir===e&&N.moveStop()}},[N]);l.useEffect(()=>{const e=e=>{e.repeat||("ArrowLeft"===e.key&&Ee(-1),"ArrowRight"===e.key&&Ee(1))},t=e=>{"ArrowLeft"===e.key&&Oe(-1),"ArrowRight"===e.key&&Oe(1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[N,Ee,Oe]),l.useEffect(()=>{C.phase===A.PROJECTILE_MOVING||C.phase===A.FIRING||C.phase===A.IMPACT?we.current.mode="FOLLOW_PROJECTILE":C.phase===A.AIMING&&(we.current.mode="FOLLOW_PLAYER")},[C.phase]);const Pe=()=>{je.current.isDragging=!1},De=e=>{const t=we.current.targetZoom,r="in"===e?Math.min(t+.25,2.5):Math.max(t-.25,.4);we.current.targetZoom=r};return C.phase===A.WAITING?n.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gray-950 text-white p-4",children:[n.jsx("h1",{className:"text-4xl font-black mb-8 bg-linear-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text",children:"GunnyWars"}),n.jsxs("div",{className:"bg-gray-900 rounded-xl p-6 border border-gray-800 w-full max-w-md",children:[n.jsxs("h2",{className:"text-lg font-bold mb-4",children:[k({en:"Players",vi:"Người chơi"}),n.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(",k({en:"Max: ",vi:"Tối đa: "}),I,")"]})]}),n.jsxs("div",{className:"space-y-3",children:[C.players.map((e,t)=>n.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-800 rounded-lg",children:[e.isBot?n.jsx(o,{size:18,className:"text-red-400"}):n.jsx(i,{size:18,className:0===t?"text-blue-400":"text-emerald-400"}),n.jsx("span",{className:"font-medium",children:e.username||k({en:"Waiting...",vi:"Đang đợi..."})}),0===t&&n.jsx("span",{className:"ml-auto text-xs text-gray-500",children:k({en:"Host",vi:"Chủ phòng"})}),e.isBot&&N.isHost&&n.jsx("button",{onClick:()=>N.requestRemoveBot(),className:"ml-auto text-red-400 hover:text-red-300 transition-colors p-2 bg-red-400/20 rounded-lg",children:n.jsx(c,{size:16})})]},(e.id||"bot")+t)),N.isHost&&C.players.length<I&&n.jsxs("button",{onClick:()=>N.requestAddBot(),className:"w-full p-3 border border-dashed border-green-500/50 rounded-xl text-green-500 hover:border-green-500/80 hover:bg-green-500/10 transition-all flex items-center justify-center gap-2",children:[n.jsx(o,{size:18}),k({en:"Add Bot",vi:"Thêm Bot"})]})]}),n.jsxs("div",{className:"mt-6 space-y-4",children:[n.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-widest px-1",children:k({en:"Game Mode",vi:"Chế độ chơi"})}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("button",{onClick:()=>N.isHost&&N.selectMode(T.TURN_BASED),disabled:!N.isHost,className:`flex flex-col items-center gap-3 p-4 rounded-2xl border transition-all ${C.selectedMode!==T.TURN_BASED&&C.selectedMode?"bg-white/5 border-white/5 text-gray-500 hover:border-white/10":"bg-green-500/10 border-green-500/50 text-green-400 shadow-[0_0_20px_rgba(34,197,94,0.1)]"} ${N.isHost?"cursor-pointer active:scale-95":"cursor-default"}`,children:[n.jsx("div",{className:"p-2 rounded-xl "+(C.selectedMode!==T.TURN_BASED&&C.selectedMode?"bg-white/5":"bg-green-500/20"),children:n.jsx(d,{size:20})}),n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"font-bold text-sm",children:k({en:"Turn-based",vi:"Theo lượt"})}),n.jsx("div",{className:"text-[10px] opacity-60 font-medium",children:k({en:"Strategy",vi:"Chiến thuật"})})]})]}),n.jsxs("button",{onClick:()=>N.isHost&&N.selectMode(T.CHAOS),disabled:!N.isHost,className:`flex flex-col items-center gap-3 p-4 rounded-2xl border transition-all ${C.selectedMode===T.CHAOS?"bg-orange-500/10 border-orange-500/50 text-orange-400 shadow-[0_0_20px_rgba(249,115,22,0.1)]":"bg-white/5 border-white/5 text-gray-500 hover:border-white/10"} ${N.isHost?"cursor-pointer active:scale-95":"cursor-default"}`,children:[n.jsx("div",{className:"p-2 rounded-xl "+(C.selectedMode===T.CHAOS?"bg-orange-500/20":"bg-white/5"),children:n.jsx(u,{size:20})}),n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"font-bold text-sm",children:k({en:"Chaos Mode",vi:"Tự do"})}),n.jsx("div",{className:"text-[10px] opacity-60 font-medium",children:k({en:"Real-time",vi:"Hỗn loạn"})})]})]})]})]}),n.jsxs("button",{onClick:()=>le(!0),className:"mt-4 w-full py-3 rounded-xl font-bold text-md flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 transition-all",children:[n.jsx(x,{size:16}),k({en:"Weapons",vi:"Kho vũ khí"})]}),N.isHost&&n.jsxs("div",{className:"mt-4",children:[n.jsxs("button",{onClick:()=>N.startGame(),disabled:!se,className:`w-full py-4 rounded-2xl font-black text-lg flex items-center justify-center gap-3 transition-all active:scale-[0.98] shadow-lg ${C.selectedMode===T.CHAOS?"bg-linear-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 shadow-orange-500/20":"bg-linear-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 shadow-green-500/20"} disabled:opacity-30 disabled:grayscale disabled:cursor-not-allowed text-white`,children:[n.jsx(f,{size:24,fill:"currentColor"}),n.jsx("span",{className:"uppercase tracking-widest",children:C.selectedMode!==T.TURN_BASED||se?k({en:"Start Game",vi:"Bắt đầu"}):k({en:"Need 2+ players",vi:"Cần 2+ người chơi"})})]}),!se&&n.jsx("p",{className:"text-center text-[10px] text-gray-500 mt-3 font-medium uppercase tracking-tighter",children:C.selectedMode===T.CHAOS?k({en:"Press start to explore",vi:"Nhấn bắt đầu để khám phá"}):k({en:"Requires 2+ players or bots to start",vi:"Cần tối thiểu 2 người hoặc bot để bắt đầu"})})]})]}),n.jsx(q,{show:ae,onClose:()=>le(!1),currentTank:re,game:N,ts:k})]}):n.jsxs("div",{className:"w-full h-full flex flex-col font-sans bg-gray-950 text-gray-100 select-none overflow-hidden",children:[n.jsxs("div",{ref:fe,className:"flex-1 min-h-0 relative cursor-grab active:cursor-grabbing overflow-hidden touch-none "+(K?"":"h-[60vh]!"),onMouseDown:e=>{je.current.isDragging=!0,je.current.startX=e.clientX,je.current.startY=e.clientY,je.current.startCamX=we.current.x,je.current.startCamY=we.current.y,je.current.lastX=e.clientX,je.current.lastY=e.clientY,je.current.lastTime=performance.now(),we.current.vx=0,we.current.vy=0},onMouseMove:e=>{if(je.current.isDragging){const t=performance.now(),r=Math.max(1,t-je.current.lastTime),n=we.current.zoom,s=(e.clientX-je.current.startX)/n,a=(e.clientY-je.current.startY)/n,l=(je.current.lastX-e.clientX)/n*(16/r),o=(je.current.lastY-e.clientY)/n*(16/r);we.current.vx=.4*we.current.vx+.6*l,we.current.vy=.4*we.current.vy+.6*o,we.current.x=je.current.startCamX-s,we.current.y=je.current.startCamY-a,je.current.lastX=e.clientX,je.current.lastY=e.clientY,je.current.lastTime=t}},onMouseUp:Pe,onMouseLeave:Pe,onTouchStart:e=>{const t=e.touches[0];je.current.isDragging=!0,je.current.startX=t.clientX,je.current.startY=t.clientY,je.current.startCamX=we.current.x,je.current.startCamY=we.current.y,je.current.lastX=t.clientX,je.current.lastY=t.clientY,je.current.lastTime=performance.now(),we.current.vx=0,we.current.vy=0},onTouchMove:e=>{if(je.current.isDragging){const t=performance.now(),r=Math.max(1,t-je.current.lastTime),n=e.touches[0],s=we.current.zoom,a=(n.clientX-je.current.startX)/s,l=(n.clientY-je.current.startY)/s,o=(je.current.lastX-n.clientX)/s*(16/r),i=(je.current.lastY-n.clientY)/s*(16/r);we.current.vx=.4*we.current.vx+.6*o,we.current.vy=.4*we.current.vy+.6*i,we.current.x=je.current.startCamX-a,we.current.y=je.current.startCamY-l,je.current.lastX=n.clientX,je.current.lastY=n.clientY,je.current.lastTime=t}},onTouchEnd:e=>{if(0===e.touches.length)je.current.isDragging=!1;else{const t=e.touches[0];je.current.isDragging=!0,je.current.startX=t.clientX,je.current.startY=t.clientY,je.current.startCamX=we.current.x,je.current.startCamY=we.current.y}},children:[n.jsx("canvas",{ref:ge,width:X.width,height:X.height,className:"absolute inset-0 block",style:{zIndex:0}}),n.jsx("canvas",{ref:he,width:X.width,height:X.height,className:"absolute inset-0 block",onClick:e=>{if(Math.sqrt(Math.pow(e.clientX-je.current.startX,2)+Math.pow(e.clientY-je.current.startY,2))>5)return;const t=he.current;if(!t)return;const r=t.getBoundingClientRect(),n=e.clientX-r.left,s=e.clientY-r.top;for(const[a,l]of ke.current){const e=n-l.x,t=s-l.y;if(Math.sqrt(e*e+t*t)<=l.radius)return Ie.current=a,void(we.current.mode="FOLLOW_TANK")}},onTouchEnd:e=>{if(Math.sqrt(Math.pow((e.changedTouches[0]?.clientX||0)-je.current.startX,2)+Math.pow((e.changedTouches[0]?.clientY||0)-je.current.startY,2))>10)return;const t=he.current;if(!t||!e.changedTouches[0])return;const r=e.changedTouches[0],n=t.getBoundingClientRect(),s=r.clientX-n.left,a=r.clientY-n.top;for(const[l,o]of ke.current){const e=s-o.x,t=a-o.y;if(Math.sqrt(e*e+t*t)<=o.radius)return Ie.current=l,void(we.current.mode="FOLLOW_TANK")}},style:{zIndex:1}}),n.jsx("div",{style:{width:X.width,height:X.height}}),n.jsxs("div",{className:"absolute top-0 left-0 pointer-events-none z-20",children:[n.jsx(U,{game:N}),n.jsxs("div",{className:"glass-blur px-2 py-1 rounded-sm flex items-center gap-2 ",children:[n.jsx("div",{className:"p-1.5 bg-gray-800/80 rounded-lg",children:n.jsx(h,{size:18})}),n.jsx("div",{className:"flex flex-col",children:n.jsxs("span",{className:"font-mono font-bold text-lg leading-none "+(C.wind>=0?"text-green-400":"text-red-400"),children:[Math.abs(Math.round(100*C.wind))," ",C.wind>=0?"→":"←"]})})]})]}),n.jsxs("div",{className:"absolute bottom-4 right-4 flex flex-row gap-1 z-20 opacity-30 hover:opacity-100 transition-all duration-300",children:[n.jsx("button",{onClick:async()=>{await S(k({en:"Return to main menu?",vi:"Quay lại màn hình menu?"}),k({en:"Back to Menu",vi:"Quay lại Menu"}))&&N.requestReset()},className:"bg-red-800/80 hover:bg-red-700 p-2 rounded-full border border-red-600 text-red-200 shadow-lg glass-blur transition-transform active:scale-95",title:"Exit to Menu",children:n.jsx(g,{size:18})}),N.isHost&&n.jsx("button",{onClick:async()=>{await S(k({en:"Map will be randomly regenerated",vi:"Bản đồ sẽ được tạo mới ngẫu nhiên"}),k({en:"Regenerate map?",vi:"Tạo map mới?"}))&&N.requestRegenerateMap()},className:"bg-purple-800/80 hover:bg-purple-700 p-2 rounded-full border border-purple-600 text-purple-200 shadow-lg glass-blur transition-transform active:scale-95",title:"Regenerate Map",children:n.jsx(m,{size:18})}),n.jsx("button",{onClick:()=>Q(!J),className:"px-3 py-2 rounded-full border text-xs font-bold shadow-lg glass-blur transition-all active:scale-95 "+(J?"bg-green-800/80 hover:bg-green-700 border-green-600 text-green-200":"bg-amber-800/80 hover:bg-amber-700 border-amber-600 text-amber-200"),children:J?"GPU":"CPU"}),n.jsx("button",{onClick:()=>De("in"),className:"bg-gray-800/80 hover:bg-gray-700 p-2 rounded-full border border-gray-600 text-white shadow-lg glass-blur transition-transform active:scale-95",children:n.jsx(p,{size:18})}),n.jsx("button",{onClick:()=>De("out"),className:"bg-gray-800/80 hover:bg-gray-700 p-2 rounded-full border border-gray-600 text-white shadow-lg glass-blur transition-transform active:scale-95",children:n.jsx(b,{size:18})}),n.jsx("button",{onClick:async()=>{document.fullscreenElement?(await document.exitFullscreen(),Z(!1)):(await(fe.current?.parentElement?.requestFullscreen()),Z(!0))},className:"bg-gray-800/80 hover:bg-gray-700 p-2 rounded-full border border-gray-600 text-white shadow-lg glass-blur transition-transform active:scale-95",children:K?n.jsx(y,{size:18}):n.jsx(v,{size:18})})]}),n.jsxs("div",{className:"absolute top-4 right-4 text-gray-500 text-xs flex items-center gap-2 pointer-events-none opacity-50",children:[n.jsx(w,{size:14})," ",k({en:"Drag to pan camera",vi:"Kéo để di chuyển camera"})]}),C.phase===A.GAME_OVER&&n.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-50",children:[n.jsxs("h1",{className:"text-5xl @md:text-7xl font-black mb-6 bg-linear-to-r from-yellow-400 via-pink-500 to-purple-600 text-transparent bg-clip-text",children:[C.winner," ",k({en:"WINS",vi:"THẮNG"})]}),n.jsxs("button",{onClick:()=>N.requestReset(),className:"px-10 py-4 bg-white text-black font-black text-xl tracking-widest hover:scale-105 transition-transform flex items-center gap-2",children:[n.jsx(m,{size:24}),k({en:"PLAY AGAIN",vi:"CHƠI LẠI"})]})]})]}),n.jsx("div",{className:"bg-gray-900 border-t border-gray-800 p-2 @md:p-3 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-10 shrink-0 select-none",children:n.jsx("div",{className:"max-w-7xl mx-auto flex flex-col gap-2",children:n.jsxs("div",{className:"flex flex-wrap items-stretch gap-2",children:[n.jsxs("div",{className:"flex-1 flex gap-2 min-w-[280px]",children:[n.jsxs("div",{className:"flex-1 min-w-[120px] glass-blur rounded-lg p-2 border border-gray-700 flex flex-col justify-center items-center gap-0.5 cursor-pointer hover:bg-gray-700/50 transition-colors "+(ne?"":"opacity-60"),onClick:()=>{re&&(Ie.current=re.id,we.current.mode="FOLLOW_TANK")},children:[n.jsxs("div",{className:"flex items-center gap-1.5 overflow-hidden w-full justify-center",children:[re?.isBot?n.jsx(o,{size:14,style:{color:re?.color||"#f87171"}}):n.jsx(i,{size:14,style:{color:re?.color||(ne?"#60a5fa":"#f87171")}}),n.jsx("span",{className:"font-black uppercase tracking-tighter text-[10px] @md:text-xs truncate",style:{color:re?.color||(ne?"#60a5fa":"#f87171")},children:te?.name||(re?.isBot?"Bot":k({en:"Guest",vi:"Khách"}))})]}),C.selectedMode===T.TURN_BASED&&ne&&n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 rounded-full animate-pulse bg-blue-500"}),n.jsx("span",{className:"text-[9px] font-bold text-blue-400 uppercase tracking-widest leading-none",children:k({en:"Your Turn",vi:"Lượt bạn"})})]})]}),n.jsxs("div",{className:"flex items-stretch gap-1 "+(!ne||C.phase!==A.AIMING&&C.selectedMode!==T.CHAOS?"opacity-30 pointer-events-none grayscale":""),children:[n.jsx("button",{className:"w-12 bg-gray-800 hover:bg-gray-700 active:bg-blue-600 active:text-white rounded-lg border border-gray-700 flex items-center justify-center transition-all",onMouseDown:()=>Ee(-1),onMouseUp:()=>Oe(-1),onMouseLeave:()=>Oe(-1),onTouchStart:e=>{e.preventDefault(),Ee(-1)},onTouchEnd:e=>{e.preventDefault(),Oe(-1)},children:n.jsx(j,{size:20})}),n.jsx("button",{className:"w-12 bg-gray-800 hover:bg-gray-700 active:bg-blue-600 active:text-white rounded-lg border border-gray-700 flex items-center justify-center transition-all",onMouseDown:()=>Ee(1),onMouseUp:()=>Oe(1),onMouseLeave:()=>Oe(1),onTouchStart:e=>{e.preventDefault(),Ee(1)},onTouchEnd:e=>{e.preventDefault(),Oe(1)},children:n.jsx(M,{size:20})})]})]}),n.jsxs("div",{className:"flex-[1.5] flex flex-col justify-center gap-1.5 min-w-[300px] "+(!ne||C.phase!==A.AIMING&&C.selectedMode!==T.CHAOS?"opacity-30 pointer-events-none grayscale":""),children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-[9px] font-black text-gray-500 w-8 tracking-tighter uppercase",children:k({en:"Angle",vi:"Góc"})}),n.jsx("input",{type:"range",min:"0",max:"180",value:180-(oe??re?.angle??0),onChange:e=>ie(180-parseInt(e.target.value)),onMouseUp:()=>{null!==oe&&(N.commitAngle(oe),ie(null))},onTouchEnd:()=>{null!==oe&&(N.commitAngle(oe),ie(null))},className:"flex-1 h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"}),n.jsxs("span",{className:"text-xs font-mono font-bold text-blue-400 w-10 text-right",children:[Math.round(oe??re?.angle??0),"°"]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-[9px] font-black text-gray-500 w-8 tracking-tighter uppercase",children:k({en:"Power",vi:"Lực"})}),n.jsx("input",{type:"range",min:"0",max:"100",value:ce??re?.power??0,onChange:e=>de(parseInt(e.target.value)),onMouseUp:()=>{null!==ce&&(N.commitPower(ce),de(null))},onTouchEnd:()=>{null!==ce&&(N.commitPower(ce),de(null))},className:"flex-1 h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500"}),n.jsx("span",{className:"text-xs font-mono font-bold text-red-400 w-10 text-right",children:Math.round(ce??re?.power??0)})]})]}),n.jsxs("div",{className:"flex flex-1 gap-2 min-w-[180px]",children:[n.jsxs("button",{onClick:()=>le(!0),className:"flex-1 @md:flex-none @md:w-32 flex flex-col items-center justify-center rounded-lg border-2 transition-all p-1.5 hover:scale-105 active:scale-95 "+(!ne||C.phase!==A.AIMING&&C.selectedMode!==T.CHAOS?"opacity-30 pointer-events-none grayscale":""),style:{backgroundColor:`${R[re?.weapon??L.BASIC].color}15`,borderColor:R[re?.weapon??L.BASIC].color},children:[n.jsx(x,{size:14,style:{color:R[re?.weapon??L.BASIC].color},className:"mb-0.5"}),n.jsx("span",{className:"text-[10px] font-black uppercase truncate w-full text-center",style:{color:R[re?.weapon??L.BASIC].color},children:R[re?.weapon??L.BASIC].name})]}),n.jsx(_,{game:N,state:C,myTankInState:ee,ts:k})]})]})})}),n.jsx(q,{show:ae,onClose:()=>le(!1),currentTank:re,game:N,ts:k})]})}export{V as default};
