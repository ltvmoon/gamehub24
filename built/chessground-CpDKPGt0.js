const e=["white","black"],t=["a","b","c","d","e","f","g","h"],o=["1","2","3","4","5","6","7","8"],n=[...o].reverse(),r=Array.prototype.concat(...t.map(e=>o.map(t=>e+t))),i=e=>r[8*e[0]+e[1]],s=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],a=r.map(s);const c=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},l=e=>"white"===e?"black":"white",d=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},u=(e,t)=>e.role===t.role&&e.color===t.color,p=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],h=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},f=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},g=(e,t)=>{e.style.visibility=t?"visible":"hidden"},m=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},v=e=>2===e.button,b=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function w(e,t,o){const n=s(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}const y=(e,t)=>Math.abs(e-t),k=(e,t,o,n)=>{const r=y(e,o),i=y(t,n);return 1===r&&2===i||2===r&&1===i},C=(e,t,o,n)=>y(e,o)===y(t,n),M=(e,t,o,n)=>e===o||t===n,P=(e,t,o,n)=>C(e,t,o,n)||M(e,t,o,n);function x(e,t,o){const n=e.get(t);if(!n)return[];const r=s(t),c=n.role,l="pawn"===c?(d=n.color,(e,t,o,n)=>y(e,o)<2&&("white"===d?n===t+1||t<=1&&n===t+2&&e===o:n===t-1||t>=6&&n===t-2&&e===o)):"knight"===c?k:"bishop"===c?C:"rook"===c?M:"queen"===c?P:((e,t,o)=>(n,r,i,s)=>y(n,i)<2&&y(r,s)<2||o&&r===s&&r===("white"===e?0:7)&&(4===n&&(2===i&&t.includes(0)||6===i&&t.includes(7))||t.includes(i)))(n.color,function(e,t){const o="white"===t?"1":"8",n=[];for(const[r,i]of e)r[1]===o&&i.color===t&&"rook"===i.role&&n.push(s(r)[0]);return n}(e,n.color),o);var d;return a.filter(e=>(r[0]!==e[0]||r[1]!==e[1])&&l(r[0],r[1],e[0],e[1])).map(i)}function S(e,...t){e&&setTimeout(()=>e(...t),1)}function A(e){e.premovable.current&&(e.premovable.current=void 0,S(e.premovable.events.unset))}function K(e){const t=e.predroppable;t.current&&(t.current=void 0,S(t.events.unset))}function O(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const a=r&&r.color!==n.color?r:void 0;return o===e.selected&&L(e),S(e.events.move,t,o,a),function(e,t,o){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||"king"!==n.role)return!1;const r=s(t),a=s(o);if(0!==r[1]&&7!==r[1]||r[1]!==a[1])return!1;4!==r[0]||e.pieces.has(o)||(6===a[0]?o=i([7,a[1]]):2===a[0]&&(o=i([0,a[1]])));const c=e.pieces.get(o);return!(!c||c.color!==n.color||"rook"!==c.role||(e.pieces.delete(t),e.pieces.delete(o),r[0]<a[0]?(e.pieces.set(i([6,a[1]]),n),e.pieces.set(i([5,a[1]]),c)):(e.pieces.set(i([2,a[1]]),n),e.pieces.set(i([3,a[1]]),c)),0))}(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,S(e.events.change),a||!0}function q(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return S(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,S(e.events.change),e.movable.dests=void 0,e.turnColor=l(e.turnColor),!0}function W(e,t,o){const n=O(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),n}function E(e,t,o){if(N(e,t,o)){const n=W(e,t,o);if(n){const r=e.hold.stop();L(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(i.captured=n),S(e.movable.events.after,t,o,i),!0}}else if(function(e,t,o){var n,r;const i=null!==(r=null===(n=e.premovable.customDests)||void 0===n?void 0:n.get(t))&&void 0!==r?r:x(e.pieces,t,e.premovable.castle);return t!==o&&j(e,t)&&i.includes(o)}(e,t,o))return function(e,t,o,n){K(e),e.premovable.current=[t,o],S(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),L(e),!0;return L(e),!1}function T(e,t,o,n){const r=e.pieces.get(t);r&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),q(e,r,o,n),S(e.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==n.role||"1"!==o[1]&&"8"!==o[1])&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){A(e),e.predroppable.current={role:t,key:o},S(e.predroppable.events.set,t,o)}(e,r.role,o):(A(e),K(e)),e.pieces.delete(t),L(e)}function $(e,t,o){if(S(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return L(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&E(e,e.selected,t))return void(e.stats.dragged=!1)}(e.selectable.enabled||e.draggable.enabled)&&(H(e,t)||j(e,t))&&(D(e,t),e.hold.start())}function D(e,t){e.selected=t,j(e,t)?e.premovable.customDests||(e.premovable.dests=x(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function L(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function H(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}const N=(e,t,o)=>{var n,r;return t!==o&&H(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))};function j(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function z(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(N(e,o,n)){const t=W(e,o,n);if(t){const i={premove:!0};!0!==t&&(i.captured=t),S(e.movable.events.after,o,n,i),r=!0}}return A(e),r}function R(e){A(e),K(e),L(e)}function B(e){e.movable.color=e.movable.dests=e.animation.current=void 0,R(e)}function F(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?i([n,r]):void 0}const I=e=>"white"===e.orientation,V="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",G={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},X={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Y(e){"start"===e&&(e=V);const t=new Map;let o=7,n=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{const e=t.get(i([n-1,o]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)n+=e-48;else{const e=r.toLowerCase();t.set(i([n,o]),{role:G[e],color:r===e?"black":"white"}),++n}}}return t}function Z(e,t){t.animation&&(Q(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function _(e,t){var o,n,r;if((null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.drawable)||void 0===n?void 0:n.autoShapes)&&(e.drawable.autoShapes=[]),Q(e,t),t.fen&&(e.pieces=Y(t.fen),e.drawable.shapes=(null===(r=t.drawable)||void 0===r?void 0:r.shapes)||[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&D(e,e.selected),Z(e,t),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",o="e"+t,n=e.movable.dests.get(o),r=e.pieces.get(o);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(o,n.filter(e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t))))}}function Q(e,t){for(const o in t)"__proto__"!==o&&"constructor"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&U(e[o])&&U(t[o])?Q(e[o],t[o]):e[o]=t[o])}function U(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}const J=(e,t)=>t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),i=function(e,t){const o=new Map,n=[],i=new Map,s=[],a=[],c=new Map;let l,d,p;for(const[r,u]of e)c.set(r,te(r,u));for(const h of r)l=t.pieces.get(h),d=c.get(h),l?d?u(l,d.piece)||(s.push(d),a.push(te(h,l))):a.push(te(h,l)):d&&s.push(d);for(const r of a)d=oe(r,s.filter(e=>u(r.piece,e.piece))),d&&(p=[d.pos[0]-r.pos[0],d.pos[1]-r.pos[1]],o.set(r.key,p.concat(p)),n.push(d.key));for(const r of s)n.includes(r.key)||i.set(r.key,r.piece);return{anims:o,fadings:i}}(o,t);if(i.anims.size||i.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},e||ne(t,performance.now())}else t.dom.redraw();return n}(e,t):ee(e,t);function ee(e,t){const o=e(t);return t.dom.redraw(),o}const te=(e,t)=>({key:e,pos:s(e),piece:t}),oe=(e,t)=>t.sort((t,o)=>d(e.pos,t.pos)-d(e.pos,o.pos))[0];function ne(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=re(n);for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame((t=performance.now())=>ne(e,t))}}const re=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,ie=["green","red","blue","yellow"];function se(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?L(e):R(e);const o=m(t),n=F(o,I(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:ue(t),snapToValidMove:e.drawable.defaultSnapToValidMove},ae(e))}function ae(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const o=F(t.pos,I(e),e.dom.bounds());o||(t.snapToValidMove=!1);const n=t.snapToValidMove?function(e,t,o,n){const r=s(e),c=a.filter(e=>P(r[0],r[1],e[0],e[1])||k(r[0],r[1],e[0],e[1])),l=c.map(e=>w(i(e),o,n)).map(e=>d(t,e)),[,u]=l.reduce((e,t,o)=>e[0]<t?e:[t,o],[l[0],0]);return i(c[u])}(t.orig,t.pos,I(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),ae(e)}})}function ce(e,t){e.drawable.current&&(e.drawable.current.pos=m(t))}function le(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter(e=>!o(e)));n&&n.brush===t.brush||e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush});pe(e)}(e.drawable,t),de(e))}function de(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ue(e){var t;const o=(e.shiftKey||e.ctrlKey)&&v(e),n=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return ie[(o?1:0)+(n?2:0)]}function pe(e){e.onChange&&e.onChange(e.shapes)}function he(e,t){if(!e.trustAllEvents&&!t.isTrusted)return;if(void 0!==t.buttons&&t.buttons>1)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=m(t),r=F(n,I(e),o);if(!r)return;const i=e.pieces.get(r),a=e.selected;var c;if(a||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(c=e).drawable.shapes.length&&(c.drawable.shapes=[],c.dom.redraw(),pe(c.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||i||a||function(e,t){const o=I(e),n=e.dom.bounds(),r=Math.pow(n.width/8,2);for(const i of e.pieces.keys()){const e=w(i,o,n);if(d(e,t)<=r)return!0}return!1}(e,n)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&N(e,e.selected,r)?J(e=>$(e,r),e):$(e,r);const f=e.selected===r,v=we(e,r);if(i&&v&&f&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:i,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:v,previouslySelected:a,originTarget:t.target,keyHasChanged:!1},v.cgDragging=!0,v.classList.add("dragging");const c=e.dom.elements.ghost;c&&(c.className=`ghost ${i.color} ${i.role}`,h(c,p(o)(s(r),I(e))),g(c,!0)),fe(e)}else l&&A(e),u&&K(e);e.dom.redraw()}function fe(e){requestAnimationFrame(()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&u(n,o.piece)){if(!o.started&&d(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),o.element=e}const t=e.dom.bounds();h(o.element,[o.pos[0]-t.left-t.width/16,o.pos[1]-t.top-t.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==F(o.pos,I(e),t))}}else ve(e);fe(e)})}function ge(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=m(t))}function me(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);A(e),K(e);const n=F(m(t)||o.pos,I(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?T(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,E(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),S(e.events.change)),(o.orig!==o.previouslySelected&&!o.keyHasChanged||o.orig!==n&&n)&&e.selectable.enabled||L(e),be(e),e.draggable.current=void 0,e.dom.redraw()}function ve(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,L(e),be(e),e.dom.redraw())}function be(e){const t=e.dom.elements;t.ghost&&g(t.ghost,!1)}function we(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function ye(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function ke(e,o){function r(){!function(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(t){t.orientation&&t.orientation!==e.orientation&&r(),Z(e,t),(t.fen?J:ee)(e=>_(e,t),e)},state:e,getFen:()=>{return o=e.pieces,n.map(e=>t.map(t=>{const n=o.get(t+e);if(n){let e=X[n.role];return"white"===n.color&&(e=e.toUpperCase()),n.promoted&&(e+="~"),e}return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString());var o},toggleOrientation:r,setPieces(t){J(e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t),e)},selectSquare(t,o){t?J(e=>$(e,t,o),e):e.selected&&(L(e),e.dom.redraw())},move(t,o){J(e=>O(e,t,o),e)},newPiece(t,o){J(e=>q(e,t,o),e)},playPremove(){if(e.premovable.current){if(J(z,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&q(e,{role:o.role,color:e.movable.color},o.key)&&(S(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0);return K(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){ee(A,e)},cancelPredrop(){ee(K,e)},cancelMove(){ee(e=>{R(e),ve(e)},e)},stop(){ee(e=>{B(e),ve(e)},e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{ye(e,2),setTimeout(()=>ye(e,void 0),120)},120)}(e,t)},setAutoShapes(t){ee(e=>e.drawable.autoShapes=t,e)},setShapes(t){ee(e=>e.drawable.shapes=t,e)},getKeyAtDomPos:t=>F(t,I(e),e.dom.bounds()),redrawAll:o,dragNewPiece(t,o,n){!function(e,t,o,n){const r="a0";e.pieces.set(r,t),e.dom.redraw();const i=m(o);e.draggable.current={orig:r,piece:t,origPos:i,pos:i,started:!0,element:()=>we(e,r),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},fe(e)}(e,t,o,n)},destroy(){B(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}const Ce={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Me(e,t,o){var n;const r=e.drawable,i=r.current,a=i&&i.mouseSq?i:void 0,c=new Map,l=e.dom.bounds(),d=r.autoShapes.filter(e=>!e.piece);for(const f of r.shapes.concat(d).concat(a?[a]:[])){if(!f.dest)continue;const t=null!==(n=c.get(f.dest))&&void 0!==n?n:new Set,o=He(qe(s(f.orig),e.orientation),l),r=He(qe(s(f.dest),e.orientation),l);t.add(Ne(o,r)),c.set(f.dest,t)}const u=r.shapes.concat(d).map(e=>({shape:e,current:!1,hash:Pe(e,We(e.dest,c),!1,l)}));a&&u.push({shape:a,current:!0,hash:Pe(a,We(a.dest,c),!0,l)});const p=u.map(e=>e.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;const h=t.querySelector("defs");!function(e,t,o){var n;const r=new Map;let i;for(const c of t.filter(e=>e.shape.dest&&e.shape.brush))i=$e(e.brushes[c.shape.brush],c.shape.modifiers),(null===(n=c.shape.modifiers)||void 0===n?void 0:n.hilite)&&r.set(Ae(i).key,Ae(i)),r.set(i.key,i);const s=new Set;let a=o.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[c,l]of r.entries())s.has(c)||o.appendChild(Ke(l))}(r,u,h),function(e,t,o,n){const r=new Map;for(const i of e)r.set(i.hash,!1);for(const i of[t,o]){const e=[];let t,o=i.firstElementChild;for(;o;)t=o.getAttribute("cgHash"),r.has(t)?r.set(t,!0):e.push(o),o=o.nextElementSibling;for(const n of e)i.removeChild(n)}for(const i of e.filter(e=>!r.get(e.hash)))for(const e of n(i))e.isCustom?o.appendChild(e.el):t.appendChild(e.el)}(u,t.querySelector("g"),o.querySelector("g"),t=>function(e,{shape:t,current:o,hash:n},r,i,a){var c,l;const d=He(qe(s(t.orig),e.orientation),a),u=t.dest?He(qe(s(t.dest),e.orientation),a):d,p=t.brush&&$e(r[t.brush],t.modifiers),h=i.get(t.dest),f=[];if(p){const e=Te(Ee("g"),{cgHash:n});f.push({el:e}),d[0]!==u[0]||d[1]!==u[1]?e.appendChild(function(e,t,o,n,r,i){var s;function a(s){var a;const c=function(e){return(e?20:10)/64}(i&&!r),l=n[0]-o[0],d=n[1]-o[1],u=Math.atan2(d,l),p=Math.cos(u)*c,h=Math.sin(u)*c;return Te(Ee("line"),{stroke:s?Ae(t).color:t.color,"stroke-width":De(t,r)+(s?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${s?Ae(t).key:t.key})`,opacity:(null===(a=e.modifiers)||void 0===a?void 0:a.hilite)?1:Le(t,r),x1:o[0],y1:o[1],x2:n[0]-p,y2:n[1]-h})}if(!(null===(s=e.modifiers)||void 0===s?void 0:s.hilite))return a(!1);const c=Ee("g"),l=Te(Ee("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(function(e,t){const o={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return Te(Ee("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}(o,n)),l.appendChild(a(!0)),c.appendChild(l),c.appendChild(a(!1)),c}(t,p,d,u,o,We(t.dest,i))):e.appendChild(function(e,t,o,n){const r=[3/64,4/64],i=(n.width+n.height)/(4*Math.max(n.width,n.height));return Te(Ee("circle"),{stroke:e.color,"stroke-width":r[o?0:1],fill:"none",opacity:Le(e,o),cx:t[0],cy:t[1],r:i-r[1]/2})}(r[t.brush],d,o,a))}if(t.label){const e=t.label;null!==(c=e.fill)&&void 0!==c||(e.fill=t.brush&&r[t.brush].color);const o=t.brush?void 0:"tr";f.push({el:Oe(e,n,d,u,h,o),isCustom:!0})}if(t.customSvg){const e=null!==(l=t.customSvg.center)&&void 0!==l?l:"orig",[o,r]="label"===e?je(d,u,h).map(e=>e-.5):"dest"===e?u:d,i=Te(Ee("g"),{transform:`translate(${o},${r})`,cgHash:n});i.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,f.push({el:i,isCustom:!0})}return f}(e,t,r.brushes,c,l))}function Pe({orig:e,dest:t,brush:o,piece:n,modifiers:r,customSvg:i,label:s},a,c,l){var d,u,p;return[l.width,l.height,c,e,t,o,a&&"-",n&&xe(n),r&&(p=r,[p.lineWidth,p.hilite&&"*"].filter(e=>e).join(",")),i&&`custom-${Se(i.html)},${null!==(u=null===(d=i.center)||void 0===d?void 0:d[0])&&void 0!==u?u:"o"}`,s&&`label-${Se(s.text)}`].filter(e=>e).join(",")}function xe(e){return[e.color,e.role,e.scale].filter(e=>e).join(",")}function Se(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return t.toString()}function Ae(e){return["#ffffff","#fff","white"].includes(e.color)?Ce.hilitePrimary:Ce.hiliteWhite}function Ke(e){const t=Te(Ee("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(Te(Ee("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Oe(e,t,o,n,r,i){var s;const a=.4*.75**e.text.length,c=je(o,n,r),l="tr"===i?.4:0,d=Te(Ee("g"),{transform:`translate(${c[0]+l},${c[1]-l})`,cgHash:t});d.appendChild(Te(Ee("circle"),{r:.2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:null!==(s=e.fill)&&void 0!==s?s:"#666",stroke:"white"}));const u=Te(Ee("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return u.innerHTML=e.text,d.appendChild(u),d}function qe(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function We(e,t){return!0===(e&&t.has(e)&&t.get(e).size>1)}function Ee(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Te(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function $e(e,t){return t?{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(e=>e).join("")}:e}function De(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Le(e,t){return(e.opacity||1)*(t?.9:1)}function He(e,t){const o=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*n]}function Ne(e,t,o=!0){const n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return o?(Math.round(8*n/Math.PI)+16)%16:n}function je(e,t,o){let n=function(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((e,t)=>e+t*t,0))}(e,t);const r=Ne(e,t,!1);if(o&&(n-=33/64,o.size>1)){n-=10/64;const r=Ne(e,t);(o.has((r+1)%16)||o.has((r+15)%16))&&1&r&&(n-=.4)}return[e[0]-Math.cos(r)*n,e[1]-Math.sin(r)*n].map(e=>e+.5)}function ze(n,r){n.innerHTML="",n.classList.add("cg-wrap");for(const t of e)n.classList.toggle("orientation-"+t,r.orientation===t);n.classList.toggle("manipulable",!r.viewOnly);const i=b("cg-container");n.appendChild(i);const s=b("cg-board");let a,c,l,d;if(i.appendChild(s),r.drawable.visible&&(a=Te(Ee("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),a.appendChild(function(){const e=Ee("defs"),t=Te(Ee("filter"),{id:"cg-filter-blur"});return t.appendChild(Te(Ee("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}()),a.appendChild(Ee("g")),c=Te(Ee("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),c.appendChild(Ee("g")),l=b("cg-auto-pieces"),i.appendChild(a),i.appendChild(c),i.appendChild(l)),r.coordinates){const e="black"===r.orientation?" black":"",n="left"===r.ranksPosition?" left":"";if(r.coordinatesOnSquares){const s="white"===r.orientation?e=>e+1:e=>8-e;t.forEach((t,r)=>i.appendChild(Re(o.map(e=>t+e),"squares rank"+s(r)+e+n)))}else i.appendChild(Re(o,"ranks"+e+n)),i.appendChild(Re(t,"files"+e))}return r.draggable.enabled&&r.draggable.showGhost&&(d=b("piece","ghost"),g(d,!1),i.appendChild(d)),{board:s,container:i,wrap:n,ghost:d,svg:a,customSvg:c,autoPieces:l}}function Re(e,t){const o=b("coords",t);let n;for(const r of e)n=b("coord"),n.textContent=r,o.appendChild(n);return o}function Be(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}const Fe=e=>t=>{e.draggable.current?ve(e):e.drawable.current?de(e):t.shiftKey||v(t)?e.drawable.enabled&&se(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;A(e),K(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=m(t),r=n&&F(n,I(e),e.dom.bounds());r&&T(e,"a0",r)}e.dom.redraw()}(e,t):he(e,t))},Ie=(e,t,o)=>n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)};function Ve(e){const t=I(e),o=p(e.dom.bounds()),n=e.dom.elements.board,r=e.pieces,i=e.animation.current,a=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,l=e.draggable.current,d=function(e){var t,o,n;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const a of e.lastMove)Ue(r,a,"last-move");e.check&&e.highlight.check&&Ue(r,e.check,"check");if(e.selected&&(Ue(r,e.selected,"selected"),e.movable.showDests)){const i=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(i)for(const t of i)Ue(r,t,"move-dest"+(e.pieces.has(t)?" oc":""));const s=null!==(n=null===(o=e.premovable.customDests)||void 0===o?void 0:o.get(e.selected))&&void 0!==n?n:e.premovable.dests;if(s)for(const t of s)Ue(r,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const i=e.premovable.current;if(i)for(const a of i)Ue(r,a,"current-premove");else e.predroppable.current&&Ue(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const a of s.keys)Ue(r,a,"exploding"+s.stage);e.highlight.custom&&e.highlight.custom.forEach((e,t)=>{Ue(r,t,e)});return r}(e),u=new Set,f=new Set,g=new Map,m=new Map;let v,w,y,k,C,M,P,x,S,A;for(w=n.firstChild;w;){if(v=w.cgKey,Xe(w))if(y=r.get(v),C=a.get(v),M=c.get(v),k=w.cgPiece,!w.cgDragging||l&&l.orig===v||(w.classList.remove("dragging"),h(w,o(s(v),t)),w.cgDragging=!1),!M&&w.cgFading&&(w.cgFading=!1,w.classList.remove("fading")),y){if(C&&w.cgAnimating&&k===Qe(y)){const e=s(v);e[0]+=C[2],e[1]+=C[3],w.classList.add("anim"),h(w,o(e,t))}else w.cgAnimating&&(w.cgAnimating=!1,w.classList.remove("anim"),h(w,o(s(v),t)),e.addPieceZIndex&&(w.style.zIndex=_e(s(v),t)));k!==Qe(y)||M&&w.cgFading?M&&k===Qe(M)?(w.classList.add("fading"),w.cgFading=!0):Je(g,k,w):u.add(v)}else Je(g,k,w);else if(Ye(w)){const e=w.className;d.get(v)===e?f.add(v):Je(m,e,w)}w=w.nextSibling}for(const[p,K]of d)if(!f.has(p)){S=m.get(K),A=S&&S.pop();const e=o(s(p),t);if(A)A.cgKey=p,h(A,e);else{const t=b("square",K);t.cgKey=p,h(t,e),n.insertBefore(t,n.firstChild)}}for(const[p,K]of r)if(C=a.get(p),!u.has(p))if(P=g.get(Qe(K)),x=P&&P.pop(),x){x.cgKey=p,x.cgFading&&(x.classList.remove("fading"),x.cgFading=!1);const n=s(p);e.addPieceZIndex&&(x.style.zIndex=_e(n,t)),C&&(x.cgAnimating=!0,x.classList.add("anim"),n[0]+=C[2],n[1]+=C[3]),h(x,o(n,t))}else{const r=Qe(K),i=b("piece",r),a=s(p);i.cgPiece=r,i.cgKey=p,C&&(i.cgAnimating=!0,a[0]+=C[2],a[1]+=C[3]),h(i,o(a,t)),e.addPieceZIndex&&(i.style.zIndex=_e(a,t)),n.appendChild(i)}for(const s of g.values())Ze(e,s);for(const s of m.values())Ze(e,s)}function Ge(e){var t,o;const n=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,i=n.height/n.width,s=8*Math.floor(n.width*window.devicePixelRatio/8)/window.devicePixelRatio,a=s*i;r.style.width=s+"px",r.style.height=a+"px",e.dom.bounds.clear(),null===(t=e.addDimensionsCssVarsTo)||void 0===t||t.style.setProperty("---cg-width",s+"px"),null===(o=e.addDimensionsCssVarsTo)||void 0===o||o.style.setProperty("---cg-height",a+"px")}const Xe=e=>"PIECE"===e.tagName,Ye=e=>"SQUARE"===e.tagName;function Ze(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function _e(e,t){const o=e[1];return`${t?10-o:3+o}`}const Qe=e=>`${e.color} ${e.role}`;function Ue(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function Je(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function et(e,t){!function(e,t,o){const n=new Map,r=[];for(const a of e)n.set(a.hash,!1);let i,s=t.firstElementChild;for(;s;)i=s.getAttribute("cgHash"),n.has(i)?n.set(i,!0):r.push(s),s=s.nextElementSibling;for(const a of r)t.removeChild(a);for(const a of e)n.get(a.hash)||t.appendChild(o(a))}(e.drawable.autoShapes.filter(e=>e.piece).map(e=>({shape:e,hash:tt(e),current:!1})),t,t=>function(e,{shape:t,hash:o},n){var r,i,a;const c=t.orig,l=null===(r=t.piece)||void 0===r?void 0:r.role,d=null===(i=t.piece)||void 0===i?void 0:i.color,u=null===(a=t.piece)||void 0===a?void 0:a.scale,h=b("piece",`${l} ${d}`);return h.setAttribute("cgHash",o),h.cgKey=c,h.cgScale=u,f(h,p(n)(s(c),I(e)),u),h}(e,t,e.dom.bounds()))}const tt=e=>{var t,o,n;return[e.orig,null===(t=e.piece)||void 0===t?void 0:t.role,null===(o=e.piece)||void 0===o?void 0:o.color,null===(n=e.piece)||void 0===n?void 0:n.scale].join(",")};function ot(e,t){const o={pieces:Y(V),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:c()};function n(){const t="dom"in o?o.dom.unbind:void 0,n=ze(e,o),r=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}(()=>n.board.getBoundingClientRect()),i=e=>{Ve(c),n.autoPieces&&et(c,n.autoPieces),!e&&n.svg&&Me(c,n.svg,n.customSvg)},a=()=>{Ge(c),function(e){const t=I(e),o=p(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(Xe(n)&&!n.cgAnimating||Ye(n))&&h(n,o(s(n.cgKey),t)),n=n.nextSibling}(c),n.autoPieces&&function(e){var t;const o=I(e),n=p(e.dom.bounds());let r=null===(t=e.dom.elements.autoPieces)||void 0===t?void 0:t.firstChild;for(;r;)f(r,n(s(r.cgKey),o),r.cgScale),r=r.nextSibling}(c)},c=o;return c.dom={elements:n,bounds:r,redraw:nt(i),redrawNow:i,unbind:t},c.drawable.prevSvgHash="",Ge(c),i(!1),function(e,t){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",e=>e.preventDefault()),e.viewOnly)return;const n=Fe(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1})}(c,a),t||(c.dom.unbind=function(e,t){const o=[];if("ResizeObserver"in window||o.push(Be(document.body,"chessground.resize",t)),!e.viewOnly){const t=Ie(e,ge,ce),n=Ie(e,me,le);for(const e of["touchmove","mousemove"])o.push(Be(document,e,t));for(const e of["touchend","mouseup"])o.push(Be(document,e,n));const r=()=>e.dom.bounds.clear();o.push(Be(document,"scroll",r,{capture:!0,passive:!0})),o.push(Be(window,"resize",r,{passive:!0}))}return()=>o.forEach(e=>e())}(c,a)),c.events.insert&&c.events.insert(n),c}return _(o,t||{}),ke(n(),n)}function nt(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}export{ot as C};
