import{B as t}from"./BaseGame-BjLvdXwv.js";import{R as e,C as s,W as a}from"./types-zc5glPn-.js";import"./socket-DRbsQkF5.js";class i extends t{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={board:this.createEmptyBoard(),players:[{id:i[0]?.id||null,username:i[0]?.username||"Player 1",color:"red",isBot:!1},{id:i[1]?.id||null,username:i[1]?.username||"Player 2",color:"yellow",isBot:!1}],currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null,winningCells:[]},this.init()}createEmptyBoard(){return Array(e).fill(null).map(()=>Array(s).fill(null))}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.col);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo();break;case"REQUEST_SYNC":this.broadcastState()}}makeMove(t){this.isHost?this.handleAction({action:t}):this.sendAction(t)}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players[0].id&&this.state.players[1].id&&(this.state.gamePhase="playing",this.state.currentPlayerIndex=0,this.state.board=this.createEmptyBoard(),this.state.moveHistory=[],this.state.winner=null,this.state.lastMove=null,this.state.winningCells=[],this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}handleMakeMove(t,e){if("playing"!==this.state.gamePhase)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;const a=this.getLowestEmptyRow(e);if(-1===a)return;this.saveHistory(),this.state.board[a][e]=s.color,this.state.lastMove={row:a,col:e};const i=this.checkWin(a,e,s.color);i.length>0?(this.state.winningCells=i,this.state.winner=t,this.state.gamePhase="ended",this.broadcastGameEnd({winner:t})):this.isBoardFull()?(this.state.winner="draw",this.state.gamePhase="ended",this.broadcastGameEnd({isDraw:!0})):this.state.currentPlayerIndex=1-this.state.currentPlayerIndex,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}getLowestEmptyRow(t){for(let s=e-1;s>=0;s--)if(null===this.state.board[s][t])return s;return-1}isBoardFull(){return this.state.board[0].every(t=>null!==t)}checkWin(t,e,s){if(!s)return[];const i=[[0,1],[1,0],[1,1],[1,-1]];for(const[r,o]of i){const i=this.getConnectedCells(t,e,r,o,s);if(i.length>=a)return i}return[]}getConnectedCells(t,a,i,r,o){const n=[{row:t,col:a}];let h=t+i,l=a+r;for(;h>=0&&h<e&&l>=0&&l<s&&this.state.board[h][l]===o;)n.push({row:h,col:l}),h+=i,l+=r;for(h=t-i,l=a-r;h>=0&&h<e&&l>=0&&l<s&&this.state.board[h][l]===o;)n.push({row:h,col:l}),h-=i,l-=r;return n}saveHistory(){const t={board:this.state.board.map(t=>[...t]),currentPlayerIndex:this.state.currentPlayerIndex};this.state.moveHistory.push(t),this.state.moveHistory.length>10&&this.state.moveHistory.shift()}handleRequestUndo(t,e){if("playing"!==this.state.gamePhase)return;if(0===this.state.moveHistory.length)return;if(this.state.undoRequest)return;const s=1-this.state.players.findIndex(e=>e.id===t),a=this.state.players[s];a?.isBot?this.applyUndo():(this.state.undoRequest={fromId:t,fromName:e},this.broadcastState(),this.setState({...this.state}))}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){if(0===this.state.moveHistory.length)return;const t=this.state.moveHistory.pop();this.state.board=t.board,this.state.currentPlayerIndex=t.currentPlayerIndex,this.state.undoRequest=null,this.state.lastMove=null,this.state.winningCells=[],this.broadcastState(),this.setState({...this.state})}handleDeclineUndo(){this.state.undoRequest=null,this.broadcastState(),this.setState({...this.state})}handleAddBot(){"waiting"===this.state.gamePhase&&(this.state.players[1].id||(this.state.players[1]={id:`BOT_${Date.now()}`,username:"Bot",color:"yellow",isBot:!0},this.broadcastState(),this.setState({...this.state})))}handleRemoveBot(){"waiting"===this.state.gamePhase&&this.state.players[1].isBot&&(this.state.players[1]={id:null,username:"Player 2",color:"yellow",isBot:!1},this.broadcastState(),this.setState({...this.state}))}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t.id),600)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;if(this.state.players[this.state.currentPlayerIndex].id!==t)return;const e=this.findBestMove();-1!==e&&this.handleMakeMove(t,e)}findBestMove(){const t=this.state.players[this.state.currentPlayerIndex].color,e="red"===t?"yellow":"red";for(let r=0;r<s;r++){const e=this.getLowestEmptyRowForBoard(this.state.board,r);if(-1===e)continue;const s=this.state.board.map(t=>[...t]);if(s[e][r]=t,this.checkWinForBoard(s,e,r,t))return r}for(let r=0;r<s;r++){const t=this.getLowestEmptyRowForBoard(this.state.board,r);if(-1===t)continue;const s=this.state.board.map(t=>[...t]);if(s[t][r]=e,this.checkWinForBoard(s,t,r,e))return r}let a=-1/0,i=-1;for(let r=0;r<s;r++){const s=this.getLowestEmptyRowForBoard(this.state.board,r);if(-1===s)continue;const o=this.state.board.map(t=>[...t]);o[s][r]=t;const n=this.minimax(o,4,-1/0,1/0,!1,t,e);n>a&&(a=n,i=r)}if(-1===i){const t=[3,2,4,1,5,0,6];for(const e of t)if(-1!==this.getLowestEmptyRowForBoard(this.state.board,e))return e}return i}minimax(t,a,i,r,o,n,h){if(0===a)return this.evaluateBoard(t,n,h);const l=o?n:h;for(let d=0;d<s;d++)for(let s=0;s<e;s++)if(null!==t[s][d]&&this.checkWinForBoard(t,s,d,t[s][d]))return t[s][d]===n?1e4:-1e4;if(this.isBoardFullForBoard(t))return 0;if(o){let e=-1/0;for(let o=0;o<s;o++){const s=this.getLowestEmptyRowForBoard(t,o);if(-1===s)continue;t[s][o]=l;const d=this.minimax(t,a-1,i,r,!1,n,h);if(t[s][o]=null,e=Math.max(e,d),r<=(i=Math.max(i,d)))break}return e===-1/0?0:e}{let e=1/0;for(let o=0;o<s;o++){const s=this.getLowestEmptyRowForBoard(t,o);if(-1===s)continue;t[s][o]=l;const d=this.minimax(t,a-1,i,r,!0,n,h);if(t[s][o]=null,e=Math.min(e,d),(r=Math.min(r,d))<=i)break}return e===1/0?0:e}}evaluateBoard(t,a,i){let r=0;const o=Math.floor(s/2);for(let s=0;s<e;s++)t[s][o]===a&&(r+=3),t[s][o]===i&&(r-=3);return r+=this.scoreWindows(t,a,i),r}scoreWindows(t,i,r){let o=0;for(let n=0;n<e;n++)for(let e=0;e<=s-a;e++){const s=[t[n][e],t[n][e+1],t[n][e+2],t[n][e+3]];o+=this.scoreWindow(s,i,r)}for(let n=0;n<s;n++)for(let s=0;s<=e-a;s++){const e=[t[s][n],t[s+1][n],t[s+2][n],t[s+3][n]];o+=this.scoreWindow(e,i,r)}for(let n=0;n<=e-a;n++)for(let e=0;e<=s-a;e++){const s=[t[n][e],t[n+1][e+1],t[n+2][e+2],t[n+3][e+3]];o+=this.scoreWindow(s,i,r)}for(let n=a-1;n<e;n++)for(let e=0;e<=s-a;e++){const s=[t[n][e],t[n-1][e+1],t[n-2][e+2],t[n-3][e+3]];o+=this.scoreWindow(s,i,r)}return o}scoreWindow(t,e,s){const a=t.filter(t=>t===e).length,i=t.filter(t=>t===s).length,r=t.filter(t=>null===t).length;return 4===a?100:3===a&&1===r?5:2===a&&2===r?2:3===i&&1===r?-4:0}getLowestEmptyRowForBoard(t,s){for(let a=e-1;a>=0;a--)if(null===t[a][s])return a;return-1}isBoardFullForBoard(t){return t[0].every(t=>null!==t)}checkWinForBoard(t,i,r,o){if(!o)return!1;const n=[[0,1],[1,0],[1,1],[1,-1]];for(const[h,l]of n){let n=1,d=i+h,c=r+l;for(;d>=0&&d<e&&c>=0&&c<s&&t[d][c]===o;)n++,d+=h,c+=l;for(d=i-h,c=r-l;d>=0&&d<e&&c>=0&&c<s&&t[d][c]===o;)n++,d-=h,c-=l;if(n>=a)return!0}return!1}requestMove(t){const e={type:"MAKE_MOVE",playerId:this.userId,col:t};this.makeMove(e)}requestStartGame(){this.makeMove({type:"START_GAME"})}requestAddBot(){this.makeMove({type:"ADD_BOT"})}requestRemoveBot(){this.makeMove({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.find(t=>t.id===this.userId),e={type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"};this.makeMove(e)}acceptUndo(){this.makeMove({type:"ACCEPT_UNDO"})}declineUndo(){this.makeMove({type:"DECLINE_UNDO"})}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}requestNewGame(){this.makeMove({type:"RESET"})}reset(){this.state={...this.state,board:this.createEmptyBoard(),currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null,winningCells:[]},this.broadcastState(),this.setState({...this.state})}checkGameEnd(){return this.state.winner?{winner:"draw"===this.state.winner?void 0:this.state.winner,isDraw:"draw"===this.state.winner}:null}updatePlayers(t){if("waiting"===this.state.gamePhase){for(let e=0;e<Math.min(t.length,2);e++)this.state.players[e].isBot||(this.state.players[e].id=t[e]?.id||null,this.state.players[e].username=t[e]?.username||`Player ${e+1}`);this.broadcastState(),this.setState({...this.state})}}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return null!==this.state.players[0].id&&null!==this.state.players[1].id}isColumnFull(t){return null!==this.state.board[0][t]}getPreviewRow(t){return this.getLowestEmptyRow(t)}}export{i as default};
