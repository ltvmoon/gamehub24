import{B as e}from"./BaseGame-D8z93T-B.js";import{I as t,T as s,a as r,b as i,c as n}from"./constants-HSy5Gk2x.js";import"./socket-DRbsQkF5.js";import"./index-7ewwbQld.js";import"./react-vendor-BLBa7-IT.js";import"./zustand-BEg5S8SY.js";class o extends e{gameName="parabox";getInitState(){return{levels:JSON.parse(JSON.stringify(t)),players:{},winners:[]}}init(){this.ensurePlayerState(this.userId)}updatePlayers(e){if(super.updatePlayers(e),this.ensurePlayerState(this.userId),this.isHost){e.forEach(e=>this.ensurePlayerState(e.id));const t=new Set(e.map(e=>e.id));Object.keys(this.state.players).forEach(e=>{t.has(e)||delete this.state.players[e]})}}onSocketGameState(e){super.onSocketGameState(e),this.players.some(e=>e.id===this.userId)&&this.ensurePlayerState(this.userId)}resolveLevelId(e){return e.split("#")[0]}isPlayerAt(e,t,s,r){return Object.values(this.state.players).some(i=>i.currentLevelId===e&&i.pos.x===t&&i.pos.y===s&&i.id!==r)}ensurePlayerState(e){const t=this.players.find(t=>t.id===e);t&&(this.state.players[e]||(this.state.players[e]={id:e,username:t.username||"Unknown",pos:{x:3,y:5},currentLevelId:"root",levelStack:[]}))}onSocketGameAction({action:e}){if(!this.isHost)return;const t=e,s=t.playerId;this.ensurePlayerState(s),"MOVE"===t.type&&t.direction?this.handleMove(s,t.direction):"RESET"===t.type&&this.handleReset(s)}handleReset(e){const s={};this.players.forEach(e=>{s[e.id]={id:e.id,username:e.username||"Unknown",pos:{x:3,y:5},currentLevelId:"root",levelStack:[]}}),this.setState({levels:JSON.parse(JSON.stringify(t)),players:s,winners:[]})}checkBlockedMove(e,t){return!this.handleMove(e,t,!0)}handleMove(e,t,i=!1){const n=this.state.players[e],o=this.state.levels[n.currentLevelId];if(!o)return!1;let l=0,a=0;"up"===t&&(a=-1),"down"===t&&(a=1),"left"===t&&(l=-1),"right"===t&&(l=1);const h=n.pos.x+l,d=n.pos.y+a;if(this.isPlayerAt(n.currentLevelId,h,d,e))return!1;if(h<0||h>=o.width||d<0||d>=o.height){if(n.levelStack.length>0){const o=n.levelStack[n.levelStack.length-1],h=this.state.levels[o.levelId],d=o.pos.x+l,y=o.pos.y+a;if(this.isPlayerAt(o.levelId,d,y,e))return!1;if(d<0||d>=h.width||y<0||y>=h.height||h.grid[y][d]===s)return!1;if(h.grid[y][d]===r){if(!this.tryPerformPush(o.levelId,{x:d,y:y},t,n.levelStack.slice(0,-1),i))return!1}return i||(n.currentLevelId=o.levelId,n.levelStack.pop(),n.pos={x:d,y:y}),!0}return!1}const y=o.grid[d][h];if(y===s)return!1;if(y===r){const e=o.boxContents?.[`${h},${d}`];if(this.tryPerformPush(n.currentLevelId,{x:h,y:d},t,n.levelStack,i))return i||(n.pos={x:h,y:d}),!0;if(e&&this.isEdgeEnterable(this.resolveLevelId(e),t)){const s=this.resolveLevelId(e),o=this.state.levels[s],l=this.getEntryPos(s,t),a=o.grid[l.y][l.x];let y=!1;if(this.isWalkableForBox(a))y=!0;else if(a===r){this.tryPerformPush(s,l,t,[{levelId:n.currentLevelId,pos:{x:h,y:d}},...n.levelStack],i)&&(y=!0)}if(y)return i||(n.levelStack.push({levelId:n.currentLevelId,pos:{x:h,y:d}}),n.currentLevelId=s,n.pos=l),!0}return!1}return i||(n.pos={x:h,y:d},this.checkWinCondition()),!0}checkWinCondition(){let e=!0;for(const t of Object.values(this.state.levels)){for(let s=0;s<t.height;s++){for(let r=0;r<t.width;r++)if(t.grid[s][r]===i){e=!1;break}if(!e)break}if(!e)break}e&&0===this.state.winners.length&&(this.state.winners=this.players.map(e=>e.id))}isWalkableForBox(e){return e===n||e===i}getBaseTile(e,s,r){const o=this.resolveLevelId(e);return t[o].grid[r][s]===i?i:n}isEdgeEnterable(e,t){const r=this.state.levels[e];return"up"===t?r.grid[r.height-1].some(e=>e!==s):"down"===t?r.grid[0].some(e=>e!==s):"left"===t?r.grid.some(e=>e[r.width-1]!==s):"right"===t&&r.grid.some(e=>e[0]!==s)}getEntryPos(e,t){const r=this.state.levels[e];let i=0,n=0;const o=Math.floor(r.width/2),l=Math.floor(r.height/2);if("up"===t?(i=o,n=r.height-1):"down"===t?(i=o,n=0):"left"===t?(i=r.width-1,n=l):"right"===t&&(i=0,n=l),r.grid[n][i]===s){let e=i,o=n,l=1/0;const a="up"===t||"down"===t?r.width:r.height;for(let h=0;h<a;h++){const a="up"===t||"down"===t?h:i,d="left"===t||"right"===t?h:n;if(r.grid[d][a]!==s){const t=Math.abs(a-i)+Math.abs(d-n);t<l&&(l=t,e=a,o=d)}}return{x:e,y:o}}return{x:i,y:n}}tryPerformPush(e,t,s,i,n=!1){const o=this.state.levels[this.resolveLevelId(e)];if(!o)return!1;let l=0,a=0;"up"===s&&(a=-1),"down"===s&&(a=1),"left"===s&&(l=-1),"right"===s&&(l=1);const h=t.x+l,d=t.y+a,y=o.boxContents?.[`${t.x},${t.y}`];if(h<0||h>=o.width||d<0||d>=o.height){if(0===i.length)return!1;const h=i[i.length-1],d=h.pos.x+l,u=h.pos.y+a,c=this.state.levels[h.levelId];if(this.isPlayerAt(h.levelId,d,u))return!1;if(d<0||d>=c.width||u<0||u>=c.height){const r=this.tryPerformPush(e,t,s,i.slice(0,-1),n);return r&&!n&&(o.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete o.boxContents[`${t.x},${t.y}`]),r}const x=c.grid[u][d];return(this.isWalkableForBox(x)||!(x!==r||!this.tryPerformPush(h.levelId,{x:d,y:u},s,i.slice(0,-1),n)))&&(n||(o.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete o.boxContents[`${t.x},${t.y}`],c.grid[u][d]=r,y&&(c.boxContents||(c.boxContents={}),c.boxContents[`${d},${u}`]=y)),!0)}const u=o.grid[d][h];if(this.isPlayerAt(e,h,d))return!1;if(this.isWalkableForBox(u))return n||(o.grid[d][h]=r,o.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&(o.boxContents||(o.boxContents={}),delete o.boxContents[`${t.x},${t.y}`],o.boxContents[`${h},${d}`]=y)),!0;if(u===r){if(this.tryPerformPush(e,{x:h,y:d},s,i,n))return n||(o.grid[d][h]=r,o.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&(o.boxContents||(o.boxContents={}),delete o.boxContents[`${t.x},${t.y}`],o.boxContents[`${h},${d}`]=y)),!0;const l=o.boxContents?.[`${h},${d}`];if(l&&this.isEdgeEnterable(this.resolveLevelId(l),s)){const a=this.resolveLevelId(l),u=this.state.levels[a],c=this.getEntryPos(a,s);let x=!1;if(this.isPlayerAt(a,c.x,c.y)?x=!1:this.isWalkableForBox(u.grid[c.y][c.x])?x=!0:u.grid[c.y][c.x]===r&&(x=this.tryPerformPush(a,c,s,[{levelId:e,pos:{x:h,y:d}},...i],n)),x)return n||(o.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete o.boxContents[`${t.x},${t.y}`],u.grid[c.y][c.x]=r,y&&(u.boxContents||(u.boxContents={}),u.boxContents[`${c.x},${c.y}`]=y)),!0}}return!1}}export{o as default};
