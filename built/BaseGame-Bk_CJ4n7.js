import"./socket-DRbsQkF5.js";import{S as t,e}from"./index-Dp6FX8_v.js";var s=Symbol.for("immer-nothing"),n=Symbol.for("immer-draftable"),o=Symbol.for("immer-state");function i(t,...e){throw new Error(`[Immer] minified error nr: ${t}. Full error at: https://bit.ly/3cXEKWf`)}var a=Object,r=a.getPrototypeOf,c="constructor",h="prototype",l="configurable",u="enumerable",d="writable",f="value",p=t=>!!t&&!!t[o];function _(t){return!!t&&(S(t)||w(t)||!!t[n]||!!t[c]?.[n]||I(t)||z(t))}var m=a[h][c].toString(),g=new WeakMap;function S(t){if(!t||!O(t))return!1;const e=r(t);if(null===e||e===a[h])return!0;const s=a.hasOwnProperty.call(e,c)&&e[c];if(s===Object)return!0;if(!M(s))return!1;let n=g.get(s);return void 0===n&&(n=Function.toString.call(s),g.set(s,n)),n===m}function y(t,e,s=!0){if(0===v(t)){(s?Reflect.ownKeys(t):a.keys(t)).forEach(s=>{e(s,t[s],t)})}else t.forEach((s,n)=>e(n,s,t))}function v(t){const e=t[o];return e?e.type_:w(t)?1:I(t)?2:z(t)?3:0}var P=(t,e,s=v(t))=>2===s?t.has(e):a[h].hasOwnProperty.call(t,e),k=(t,e,s=v(t))=>2===s?t.get(e):t[e],b=(t,e,s,n=v(t))=>{2===n?t.set(e,s):3===n?t.add(s):t[e]=s};var w=Array.isArray,I=t=>t instanceof Map,z=t=>t instanceof Set,O=t=>"object"==typeof t,M=t=>"function"==typeof t,R=t=>"boolean"==typeof t;var A=t=>t.copy_||t.base_,G=t=>t.modified_?t.copy_:t.base_;function N(t,e){if(I(t))return new Map(t);if(z(t))return new Set(t);if(w(t))return Array[h].slice.call(t);const s=S(t);if(!0===e||"class_only"===e&&!s){const e=a.getOwnPropertyDescriptors(t);delete e[o];let s=Reflect.ownKeys(e);for(let n=0;n<s.length;n++){const o=s[n],i=e[o];!1===i[d]&&(i[d]=!0,i[l]=!0),(i.get||i.set)&&(e[o]={[l]:!0,[d]:!0,[u]:i[u],[f]:t[o]})}return a.create(r(t),e)}{const e=r(t);if(null!==e&&s)return{...t};const n=a.create(e);return a.assign(n,t)}}function F(t,e=!1){return L(t)||p(t)||!_(t)||(v(t)>1&&a.defineProperties(t,{set:E,add:E,clear:E,delete:E}),a.freeze(t),e&&y(t,(t,e)=>{F(e,!0)},!1)),t}var E={[f]:function(){i(2)}};function L(t){return null===t||!O(t)||a.isFrozen(t)}var U="MapSet",q="Patches",H="ArrayMethods",D={};function j(t){const e=D[t];return e||i(0),e}var x,C=t=>!!D[t],V=()=>x;function $(t,e){e&&(t.patchPlugin_=j(q),t.patches_=[],t.inversePatches_=[],t.patchListener_=e)}function J(t){K(t),t.drafts_.forEach(B),t.drafts_=null}function K(t){t===x&&(x=t.parent_)}var W=t=>x={drafts_:[],parent_:x,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0,handledSet_:new Set,processedForPatches_:new Set,mapSetPlugin_:C(U)?j(U):void 0,arrayMethodsPlugin_:C(H)?j(H):void 0};function B(t){const e=t[o];0===e.type_||1===e.type_?e.revoke_():e.revoked_=!0}function T(t,e){e.unfinalizedDrafts_=e.drafts_.length;const n=e.drafts_[0];if(void 0!==t&&t!==n){n[o].modified_&&(J(e),i(4)),_(t)&&(t=X(e,t));const{patchPlugin_:s}=e;s&&s.generateReplacementPatches_(n[o].base_,t,e)}else t=X(e,n);return function(t,e,s=!1){!t.parent_&&t.immer_.autoFreeze_&&t.canAutoFreeze_&&F(e,s)}(e,t,!0),J(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),t!==s?t:void 0}function X(t,e){if(L(e))return e;const s=e[o];if(!s){return st(e,t.handledSet_,t)}if(!Y(s,t))return e;if(!s.modified_)return s.base_;if(!s.finalized_){const{callbacks_:e}=s;if(e)for(;e.length>0;){e.pop()(t)}et(s,t)}return s.copy_}function Q(t){t.finalized_=!0,t.scope_.unfinalizedDrafts_--}var Y=(t,e)=>t.scope_===e,Z=[];function tt(t,e,s,n){const o=A(t),i=t.type_;if(void 0!==n){if(k(o,n,i)===e)return void b(o,n,s,i)}if(!t.draftLocations_){const e=t.draftLocations_=new Map;y(o,(t,s)=>{if(p(s)){const n=e.get(s)||[];n.push(t),e.set(s,n)}})}const a=t.draftLocations_.get(e)??Z;for(const r of a)b(o,r,s,i)}function et(t,e){if(t.modified_&&!t.finalized_&&(3===t.type_||1===t.type_&&t.allIndicesReassigned_||(t.assigned_?.size??0)>0)){const{patchPlugin_:s}=e;if(s){const n=s.getPath(t);n&&s.generatePatches_(t,n,e)}Q(t)}}function st(t,e,s){return!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||p(t)||e.has(t)||!_(t)||L(t)||(e.add(t),y(t,(n,i)=>{if(p(i)){const e=i[o];if(Y(e,s)){const s=G(e);b(t,n,s,t.type_),Q(e)}}else _(i)&&st(i,e,s)})),t}var nt={get(t,e){if(e===o)return t;let s=t.scope_.arrayMethodsPlugin_;const n=1===t.type_&&"string"==typeof e;if(n&&s?.isArrayOperationMethod(e))return s.createMethodInterceptor(t,e);const i=A(t);if(!P(i,e,t.type_))return function(t,e,s){const n=at(e,s);return n?f in n?n[f]:n.get?.call(t.draft_):void 0}(t,i,e);const a=i[e];if(t.finalized_||!_(a))return a;if(n&&t.operationMethod&&s?.isMutatingArrayMethod(t.operationMethod)&&function(t){const e=+t;return Number.isInteger(e)&&String(e)===t}(e))return a;if(a===it(t.base_,e)){ct(t);const s=1===t.type_?+e:e,n=ht(t.scope_,a,t,s);return t.copy_[s]=n}return a},has:(t,e)=>e in A(t),ownKeys:t=>Reflect.ownKeys(A(t)),set(t,e,s){const n=at(A(t),e);if(n?.set)return n.set.call(t.draft_,s),!0;if(!t.modified_){const n=it(A(t),e),r=n?.[o];if(r&&r.base_===s)return t.copy_[e]=s,t.assigned_.set(e,!1),!0;if(((i=s)===(a=n)?0!==i||1/i==1/a:i!=i&&a!=a)&&(void 0!==s||P(t.base_,e,t.type_)))return!0;ct(t),rt(t)}var i,a;return t.copy_[e]===s&&(void 0!==s||e in t.copy_)||Number.isNaN(s)&&Number.isNaN(t.copy_[e])||(t.copy_[e]=s,t.assigned_.set(e,!0),function(t,e,s){const{scope_:n}=t;if(p(s)){const i=s[o];Y(i,n)&&i.callbacks_.push(function(){ct(t);const n=G(i);tt(t,s,n,e)})}else _(s)&&t.callbacks_.push(function(){const o=A(t);3===t.type_?o.has(s)&&st(s,n.handledSet_,n):k(o,e,t.type_)===s&&n.drafts_.length>1&&!0===(t.assigned_.get(e)??!1)&&t.copy_&&st(k(t.copy_,e,t.type_),n.handledSet_,n)})}(t,e,s)),!0},deleteProperty:(t,e)=>(ct(t),void 0!==it(t.base_,e)||e in t.base_?(t.assigned_.set(e,!1),rt(t)):t.assigned_.delete(e),t.copy_&&delete t.copy_[e],!0),getOwnPropertyDescriptor(t,e){const s=A(t),n=Reflect.getOwnPropertyDescriptor(s,e);return n?{[d]:!0,[l]:1!==t.type_||"length"!==e,[u]:n[u],[f]:s[e]}:n},defineProperty(){i(11)},getPrototypeOf:t=>r(t.base_),setPrototypeOf(){i(12)}},ot={};for(let mt in nt){let t=nt[mt];ot[mt]=function(){const e=arguments;return e[0]=e[0][0],t.apply(this,e)}}function it(t,e){const s=t[o];return(s?A(s):t)[e]}function at(t,e){if(!(e in t))return;let s=r(t);for(;s;){const t=Object.getOwnPropertyDescriptor(s,e);if(t)return t;s=r(s)}}function rt(t){t.modified_||(t.modified_=!0,t.parent_&&rt(t.parent_))}function ct(t){t.copy_||(t.assigned_=new Map,t.copy_=N(t.base_,t.scope_.immer_.useStrictShallowCopy_))}ot.deleteProperty=function(t,e){return ot.set.call(this,t,e,void 0)},ot.set=function(t,e,s){return nt.set.call(this,t[0],e,s,t[0])};function ht(t,e,s,n){const[o,i]=I(e)?j(U).proxyMap_(e,s):z(e)?j(U).proxySet_(e,s):function(t,e){const s=w(t),n={type_:s?1:0,scope_:e?e.scope_:V(),modified_:!1,finalized_:!1,assigned_:void 0,parent_:e,base_:t,draft_:null,copy_:null,revoke_:null,isManual_:!1,callbacks_:void 0};let o=n,i=nt;s&&(o=[n],i=ot);const{revoke:a,proxy:r}=Proxy.revocable(o,i);return n.draft_=r,n.revoke_=a,[r,n]}(e,s);return(s?.scope_??V()).drafts_.push(o),i.callbacks_=s?.callbacks_??[],i.key_=n,s&&void 0!==n?function(t,e,s){t.callbacks_.push(function(n){const o=e;if(!o||!Y(o,n))return;n.mapSetPlugin_?.fixSetContents(o);const i=G(o);tt(t,o.draft_??o,i,s),et(o,n)})}(s,i,n):i.callbacks_.push(function(t){t.mapSetPlugin_?.fixSetContents(i);const{patchPlugin_:e}=t;i.modified_&&e&&e.generatePatches_(i,[],t)}),o}function lt(t){if(!_(t)||L(t))return t;const e=t[o];let s,n=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,s=N(t,e.scope_.immer_.useStrictShallowCopy_),n=e.scope_.immer_.shouldUseStrictIteration()}else s=N(t,!0);return y(s,(t,e)=>{b(s,t,lt(e))},n),e&&(e.finalized_=!1),s}var ut=new class{constructor(t){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!1,this.produce=(t,e,n)=>{if(M(t)&&!M(e)){const s=e;e=t;const n=this;return function(t=s,...o){return n.produce(t,t=>e.call(this,t,...o))}}let o;if(M(e)||i(6),void 0===n||M(n)||i(7),_(t)){const s=W(this),i=ht(s,t,void 0);let a=!0;try{o=e(i),a=!1}finally{a?J(s):K(s)}return $(s,n),T(o,s)}if(!t||!O(t)){if(o=e(t),void 0===o&&(o=t),o===s&&(o=void 0),this.autoFreeze_&&F(o,!0),n){const e=[],s=[];j(q).generateReplacementPatches_(t,o,{patches_:e,inversePatches_:s}),n(e,s)}return o}i(1)},this.produceWithPatches=(t,e)=>{if(M(t))return(e,...s)=>this.produceWithPatches(e,e=>t(e,...s));let s,n;return[this.produce(t,e,(t,e)=>{s=t,n=e}),s,n]},R(t?.autoFreeze)&&this.setAutoFreeze(t.autoFreeze),R(t?.useStrictShallowCopy)&&this.setUseStrictShallowCopy(t.useStrictShallowCopy),R(t?.useStrictIteration)&&this.setUseStrictIteration(t.useStrictIteration)}createDraft(t){_(t)||i(8),p(t)&&(t=function(t){p(t)||i(10);return lt(t)}(t));const e=W(this),s=ht(e,t,void 0);return s[o].isManual_=!0,K(e),s}finishDraft(t,e){const s=t&&t[o];s&&s.isManual_||i(9);const{scope_:n}=s;return $(n,e),T(void 0,n)}setAutoFreeze(t){this.autoFreeze_=t}setUseStrictShallowCopy(t){this.useStrictShallowCopy_=t}setUseStrictIteration(t){this.useStrictIteration_=t}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(t,e){let s;for(s=e.length-1;s>=0;s--){const n=e[s];if(0===n.path.length&&"replace"===n.op){t=n.value;break}}s>-1&&(e=e.slice(s+1));const n=j(q).applyPatches_;return p(t)?n(t,e):this.produce(t,t=>n(t,e))}},dt=ut.produce;ut.setAutoFreeze.bind(ut)(!1);class ft{room;roomId;socket;isHost;userId;players;_state;stateListeners=[];updateScheduled=!1;get state(){return this._state}set state(t){this.setState(t)}autoBroadcast=!0;stateVersion=0;pendingPatches=new Map;hasPendingPatch=!1;lastSnapshot=null;gameName="unknown";setGameName(t){this.gameName=t}_wasGameOver=!1;isGameOver(t){return!1}getState(){if(!this.state)throw new Error("Game state is not initialized");return this.state}constructor(t,e,s,n){this.room=t,this.roomId=t.id,this.players=t.players,this.socket=e,this.isHost=s,this.userId=n;const o=this.getInitState();this._state=this.setState(o),this.socket.on("game:action",this.onSocketGameAction.bind(this)),this.isHost&&this.socket.on("game:request_sync",this.onRequestSync.bind(this)),this.isHost||(this.socket.on("game:state",this.onSocketGameState.bind(this)),this.socket.on("game:state:patch",this.onSocketGameStatePatch.bind(this)),queueMicrotask(()=>{this.requestSync()})),this.init()}init(){}makeAction(t){this.isHost?(this.onSocketGameAction({action:t}),this.hasSomeoneElseInRoom()&&this.socket.emit("game:action",{roomId:this.roomId,action:t})):this.sendSocketGameAction(t)}sendSocketGameAction(t){this.hasSomeoneElseInRoom()?this.socket.emit("game:action",{roomId:this.roomId,action:t}):this.onSocketGameAction({action:t})}updatePlayers(t){this.players=t,this.syncState(!1)}onStateUpdate(e){!this.lastSnapshot||!this.hasPendingPatch||this.hasPendingPatch&&0===this.pendingPatches.size?this.lastSnapshot=JSON.parse(JSON.stringify(e)):this.pendingPatches.size>0&&(this.lastSnapshot=dt(this.lastSnapshot,t=>{for(const{path:e,value:s}of this.pendingPatches.values())_t(t,e,s)}),this.lastSnapshot&&(this.lastSnapshot=Array.isArray(this.lastSnapshot)?[...this.lastSnapshot]:{...this.lastSnapshot}));const s=this.isGameOver(e);!this._wasGameOver&&s&&t.playGameOver(),this._wasGameOver=s,this.stateListeners.forEach(t=>t(this.lastSnapshot))}get snapshot(){return this.lastSnapshot||this.state}scheduleUpdate(){this.updateScheduled||(this.updateScheduled=!0,queueMicrotask(()=>{try{this.onStateUpdate(this.state),this.isHost&&this.autoBroadcast?this.broadcastState():this.updateLastSynced()}finally{this.updateScheduled=!1}}))}syncState(t=!0){t&&(this.lastSnapshot=null),this.onStateUpdate(this.state),this.broadcastState(t)}setState(t){return this._state="object"==typeof t&&null!==t?function(t,e){const s=new WeakMap;return function t(n,o=[]){if(s.has(n))return s.get(n);const i=new Proxy(n,{get(e,s,n){const i=Reflect.get(e,s,n);return"object"==typeof i&&null!==i?t(i,[...o,String(s)]):i},set(t,s,n,i){const a=Reflect.get(t,s,i),r=Reflect.set(t,s,n,i);return a!==n&&e([...o,String(s)],n,a),r},deleteProperty(t,s){const n=Reflect.get(t,s),i=Reflect.deleteProperty(t,s);return i&&e([...o,String(s)],void 0,n),i}});return s.set(n,i),i}(t)}(t,(t,e)=>{this.recordPatch(t,e),this.scheduleUpdate()}):t,this.hasPendingPatch=!0,this.pendingPatches.clear(),this.lastSnapshot=JSON.parse(JSON.stringify(t)),this.scheduleUpdate(),this._state}recordPatch(t,e){this.hasPendingPatch=!0;const s=t.join(".");this.pendingPatches.set(s,{path:t,value:void 0===e?pt:e})}onUpdate(t){return this.stateListeners.push(t),()=>{this.stateListeners=this.stateListeners.filter(e=>e!==t)}}hasSomeoneElseInRoom(){const t=e.getState().currentRoom;return(t?.spectators?.length||0)+(t?.players?.length||0)>1}broadcastState(t=!1){if(!this.isHost)return;if(!t&&!this.hasPendingPatch)return;this.stateVersion++;if(this.hasSomeoneElseInRoom())if(console.log(this.pendingPatches),!t&&this.hasPendingPatch&&this.pendingPatches.size>0){const t={};for(const[e,{value:s}]of this.pendingPatches.entries())t[e]=s;this.socket.emit("game:state:patch",{roomId:this.roomId,patch:t,version:this.stateVersion})}else{const t=this.getState();console.log("send full state",t),this.socket.emit("game:state",{roomId:this.roomId,state:{...t},version:this.stateVersion})}this.updateLastSynced()}updateLastSynced(){this.pendingPatches.clear(),this.hasPendingPatch=!1,this.isHost&&this.saveStateToStorage()}requestSync(){this.socket.emit("game:request_sync",{roomId:this.roomId})}onRequestSync(t){if(this.isHost)if(t.requesterSocketId){const e=this.getState();console.log("onRequestSync -> send state",e),this.socket.emit("game:state:direct",{roomId:this.roomId,targetUser:t.targetUser,targetSocketId:t.requesterSocketId,state:{...e},version:this.stateVersion})}else this.syncState(!0)}onSocketGameState(t){this.isHost||t.roomId&&t.roomId!==this.roomId||("number"==typeof t.version&&(console.log("updated state version",this.stateVersion,t.version),this.stateVersion=t.version),console.log("onSocketGameState",t.state),this.setState(t.state))}onSocketGameStatePatch(t){if(!this.isHost){if("number"==typeof t.version&&t.version!==this.stateVersion+1)return console.warn(`Packet loss detected! Expected version ${this.stateVersion+1} but got ${t.version}. Requesting sync...`,t),void this.requestSync();console.log("onSocketGameStatePatch",t.patch);for(const[e,s]of Object.entries(t.patch))_t(this.state,e.split("."),s);"number"==typeof t.version&&(this.stateVersion=t.version)}}saveStateToStorage(){if(this.isHost&&"unknown"!==this.gameName)try{const t=`saved_game_${this.gameName}`,e={state:this.getState(),timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("Failed to save game state:",t)}}clearSavedState(){if(this.isHost&&"unknown"!==this.gameName)try{localStorage.removeItem(`saved_game_${this.gameName}`)}catch(t){console.error("Failed to clear game state:",t)}}destroy(){this.socket.off("game:state"),this.socket.off("game:state:patch"),this.socket.off("game:action"),this.isHost&&this.socket.off("game:request_sync"),this.stateListeners.length=0}}const pt="__$$DELETED$$__";function _t(t,e,s){if(!e||0===e.length)return;let n=t;for(let i=0;i<e.length-1;i++){const t=e[i];t in n&&null!==n[t]&&"object"==typeof n[t]||(n[t]={}),n=n[t]}const o=e[e.length-1];s===pt?delete n[o]:n[o]=s}export{ft as B};
