import{B as t}from"./BaseGame-BjLvdXwv.js";import"./socket-DRbsQkF5.js";const e=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];function s(t){return{board:t.board.map(t=>[...t]),currentPlayer:t.currentPlayer}}function a(t,e){const s=0===e?"black":"white",a=[];for(let i=0;i<8;i++)for(let e=0;e<8;e++)r(t,i,e,s).length>0&&a.push([i,e]);return a}function r(t,s,a,r){if(!r||null!==t[s][a])return[];const i="black"===r?"white":"black",n=[];for(const[o,h]of e){const e=[];let l=s+o,d=a+h;for(;l>=0&&l<8&&d>=0&&d<8&&t[l][d]===i;)e.push([l,d]),l+=o,d+=h;l>=0&&l<8&&d>=0&&d<8&&t[l][d]===r&&e.length>0&&n.push(...e)}return n}function i(t,e){const a=s(t),i=0===t.currentPlayer?"black":"white",[n,o]=e,h=r(a.board,n,o,i);a.board[n][o]=i;for(const[s,r]of h)a.board[s][r]=i;return a.currentPlayer=1-t.currentPlayer,a}function n(t){const e=a(t,0),s=a(t,1);return 0===e.length&&0===s.length}function o(t,e,s){return{state:t,parent:e,move:s,children:[],untriedMoves:a(t.board,t.currentPlayer),visits:0,wins:0}}function h(t,e){if(0===t.visits)return 1/0;return(e?t.wins:t.visits-t.wins)/t.visits+1.414*Math.sqrt(Math.log(t.parent.visits)/t.visits)}function l(t,e){const s=t.state.currentPlayer===e;let a=t.children[0],r=-1/0;for(const i of t.children){const t=h(i,s);t>r&&(a=i,r=t)}return a}function d(t){const e=Math.floor(Math.random()*t.untriedMoves.length),s=t.untriedMoves[e];t.untriedMoves.splice(e,1);const a=o(i(t.state,s),t,s);return t.children.push(a),a}function c(t,e){let r=s(t.state);for(;!n(r.board);){const t=a(r.board,r.currentPlayer);if(0===t.length){r.currentPlayer=1-r.currentPlayer;continue}r=i(r,t[Math.floor(Math.random()*t.length)])}const o=function(t){let e=0,s=0;for(let a=0;a<8;a++)for(let r=0;r<8;r++)"black"===t[a][r]&&e++,"white"===t[a][r]&&s++;return e>s?0:s>e?1:-1}(r.board);return-1===o?.5:o===e?1:0}function u(t,e){for(;null!==t;)t.visits++,t.wins+=e,t=t.parent}class y extends t{state;onStateChange;constructor(t,e,s,a,r){super(t,e,s,a),this.state={board:this.createInitialBoard(),players:[{id:r[0]?.id||null,username:r[0]?.username||"Player 1",color:"black",isBot:!1},{id:r[1]?.id||null,username:r[1]?.username||"Player 2",color:"white",isBot:!1}],currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null,flippedCells:[]},this.init()}createInitialBoard(){const t=Array(8).fill(null).map(()=>Array(8).fill(null));return t[3][3]="white",t[3][4]="black",t[4][3]="black",t[4][4]="white",t}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.row,e.col);break;case"PASS":this.handlePass(e.playerId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo();break;case"REQUEST_SYNC":this.broadcastState()}}makeMove(t){this.isHost?this.handleAction({action:t}):this.sendAction(t)}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players[0].id&&this.state.players[1].id&&(this.state.gamePhase="playing",this.state.currentPlayerIndex=0,this.state.board=this.createInitialBoard(),this.state.moveHistory=[],this.state.winner=null,this.state.lastMove=null,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}handleMakeMove(t,e,s){if("playing"!==this.state.gamePhase)return;const a=this.state.players[this.state.currentPlayerIndex];if(a.id!==t)return;const r=this.getFlips(e,s,a.color);if(0===r.length)return;this.saveHistory(),this.state.board[e][s]=a.color;for(const[n,o]of r)this.state.board[n][o]=a.color;this.state.lastMove={row:e,col:s},this.state.flippedCells=r.map(([t,e])=>({row:t,col:e})),this.state.currentPlayerIndex=1-this.state.currentPlayerIndex;const i=this.state.players[this.state.currentPlayerIndex];if(0===this.getValidMoves(i.color).length){0===this.getValidMoves(a.color).length?this.endGame():this.state.currentPlayerIndex=1-this.state.currentPlayerIndex}this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}handlePass(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id!==t)return;this.getValidMoves(e.color).length>0||(this.state.currentPlayerIndex=1-this.state.currentPlayerIndex,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}endGame(){this.state.gamePhase="ended";let t=0,e=0;for(let s=0;s<8;s++)for(let a=0;a<8;a++)"black"===this.state.board[s][a]&&t++,"white"===this.state.board[s][a]&&e++;this.state.winner=t>e?this.state.players[0].id:e>t?this.state.players[1].id:"draw",this.broadcastGameEnd({winner:this.state.winner??void 0})}getValidMoves(t){const e=[];for(let s=0;s<8;s++)for(let a=0;a<8;a++)this.getFlips(s,a,t).length>0&&e.push([s,a]);return e}getFlips(t,s,a){if(!a||null!==this.state.board[t][s])return[];const r="black"===a?"white":"black",i=[];for(const[n,o]of e){const e=[];let h=t+n,l=s+o;for(;h>=0&&h<8&&l>=0&&l<8&&this.state.board[h][l]===r;)e.push([h,l]),h+=n,l+=o;h>=0&&h<8&&l>=0&&l<8&&this.state.board[h][l]===a&&e.length>0&&i.push(...e)}return i}saveHistory(){const t={board:this.state.board.map(t=>[...t]),currentPlayerIndex:this.state.currentPlayerIndex};this.state.moveHistory.push(t),this.state.moveHistory.length>10&&this.state.moveHistory.shift()}handleRequestUndo(t,e){if("playing"!==this.state.gamePhase)return;if(0===this.state.moveHistory.length)return;if(this.state.undoRequest)return;const s=1-this.state.players.findIndex(e=>e.id===t),a=this.state.players[s];a?.isBot?this.applyUndo():(this.state.undoRequest={fromId:t,fromName:e},this.broadcastState(),this.setState({...this.state}))}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){if(0===this.state.moveHistory.length)return;const t=this.state.moveHistory.pop();this.state.board=t.board,this.state.currentPlayerIndex=t.currentPlayerIndex,this.state.undoRequest=null,this.state.lastMove=null,this.broadcastState(),this.setState({...this.state})}handleDeclineUndo(){this.state.undoRequest=null,this.broadcastState(),this.setState({...this.state})}handleAddBot(){"waiting"===this.state.gamePhase&&(this.state.players[1].id||(this.state.players[1]={id:`BOT_${Date.now()}`,username:"Bot",color:"white",isBot:!0},this.broadcastState(),this.setState({...this.state})))}handleRemoveBot(){"waiting"===this.state.gamePhase&&this.state.players[1].isBot&&(this.state.players[1]={id:null,username:"Player 2",color:"white",isBot:!1},this.broadcastState(),this.setState({...this.state}))}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t.id),800)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id!==t)return;const s=this.getValidMoves(e.color);if(0===s.length)return void this.handlePass(t);const r="black"===e.color?0:1,i=function(t,e,s=500){const r={board:t.map(t=>[...t]),currentPlayer:e},i=a(r.board,e);if(0===i.length)return null;if(1===i.length)return i[0];const n=o(r,null,null),h=performance.now();for(;performance.now()-h<s;){let t=n;for(;0===t.untriedMoves.length&&t.children.length>0;)t=l(t,e);t.untriedMoves.length>0&&(t=d(t)),u(t,c(t,e))}let y=null,p=-1;for(const a of n.children)a.visits>p&&(p=a.visits,y=a.move);return y}(this.state.board,r,500);if(i)this.handleMakeMove(t,i[0],i[1]);else{const e=s[Math.floor(Math.random()*s.length)];this.handleMakeMove(t,e[0],e[1])}}requestMove(t,e){const s={type:"MAKE_MOVE",playerId:this.userId,row:t,col:e};this.makeMove(s)}requestPass(){const t={type:"PASS",playerId:this.userId};this.makeMove(t)}requestStartGame(){this.makeMove({type:"START_GAME"})}requestAddBot(){this.makeMove({type:"ADD_BOT"})}requestRemoveBot(){this.makeMove({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.find(t=>t.id===this.userId),e={type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"};this.makeMove(e)}acceptUndo(){this.makeMove({type:"ACCEPT_UNDO"})}declineUndo(){this.makeMove({type:"DECLINE_UNDO"})}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}requestNewGame(){this.makeMove({type:"RESET"})}reset(){this.state={...this.state,board:this.createInitialBoard(),currentPlayerIndex:0,winner:null,gamePhase:"waiting",undoRequest:null,moveHistory:[],lastMove:null},this.broadcastState(),this.setState({...this.state})}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}updatePlayers(t){"waiting"===this.state.gamePhase&&(this.state.players[0].id=t[0]?.id||null,this.state.players[0].username=t[0]?.username||"Player 1",t[1]?(this.state.players[1].id=t[1].id,this.state.players[1].username=t[1].username,this.state.players[1].isBot=!1):this.state.players[1].isBot||(this.state.players[1].id=null,this.state.players[1].username="Player 2"),this.broadcastState(),this.setState({...this.state}))}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return null!==this.state.players[0].id&&null!==this.state.players[1].id}getPieceCount(){let t=0,e=0;for(let s=0;s<8;s++)for(let a=0;a<8;a++)"black"===this.state.board[s][a]&&t++,"white"===this.state.board[s][a]&&e++;return{black:t,white:e}}}export{y as default};
