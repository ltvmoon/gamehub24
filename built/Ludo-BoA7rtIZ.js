import{B as t}from"./BaseGame-BjLvdXwv.js";import{T as e,S as s,F as i,B as a,a as n}from"./types-DkjE4TWX.js";import"./socket-DRbsQkF5.js";const o=["red","green","yellow","blue"];class r extends t{state;onStateChange;constructor(t,e,s,i,a){super(t,e,s,i),this.state={players:o.map((t,e)=>({id:a[e]?.id||null,username:a[e]?.username||`Player ${e+1}`,color:t,isBot:!1,tokens:this.createInitialTokens(),hasFinished:!1})),currentPlayerIndex:0,diceValue:null,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,lastMove:null,consecutiveSixes:0},this.init()}createInitialTokens(){return Array(e).fill(null).map((t,e)=>({id:e,position:{type:"home",index:e}}))}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost)switch(e.type){case"ROLL_DICE":this.handleRollDice(e.playerId);break;case"MOVE_TOKEN":this.handleMoveToken(e.playerId,e.tokenId);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex);break;case"REQUEST_SYNC":this.broadcastState()}}makeMove(t){this.isHost?this.handleAction({action:t}):this.sendAction(t)}handleStartGame(){if("waiting"!==this.state.gamePhase)return;this.state.players.filter(t=>null!==t.id).length<2||(this.state.players.forEach(t=>{t.tokens=this.createInitialTokens(),t.hasFinished=!1}),this.state.gamePhase="playing",this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.winner=null,this.state.lastMove=null,this.state.consecutiveSixes=0,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}findFirstActivePlayer(){for(let t=0;t<this.state.players.length;t++)if(null!==this.state.players[t].id)return t;return 0}handleRollDice(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id!==t)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;let s;s=this.hasAnyTokenOnBoard(e)?Math.floor(6*Math.random())+1:Math.random()<.5?6:Math.floor(6*Math.random())+1,this.state.diceValue=s,this.state.hasRolled=!0,this.state.canRollAgain=!1,6===s?this.state.consecutiveSixes++:this.state.consecutiveSixes=0;const i=this.getMovableTokens(e,s);this.broadcastState(),this.setState({...this.state}),0===i.length?setTimeout(()=>{this.nextTurn(),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()},3e3):1!==i.length||e.isBot?this.checkBotTurn():setTimeout(()=>{this.handleMoveToken(t,i[0].id)},800)}handleMoveToken(t,e){if("playing"!==this.state.gamePhase)return;if(null===this.state.diceValue)return;const s=this.state.players[this.state.currentPlayerIndex];if(s.id!==t)return;const i=s.tokens.find(t=>t.id===e);if(!i)return;const a=this.state.diceValue,n=this.calculateNewPosition(i,s.color,a);if(n){if(this.state.lastMove={playerId:t,tokenId:e,from:{...i.position},to:n},i.position=n,"board"===n.type&&this.checkCapture(s.color,n.position),"finished"===n.type&&s.tokens.every(t=>"finished"===t.position.type))return s.hasFinished=!0,this.state.winner=t,this.state.gamePhase="ended",this.broadcastGameEnd({winner:t}),this.broadcastState(),void this.setState({...this.state});6===a?(this.state.canRollAgain=!0,this.state.hasRolled=!1,this.state.diceValue=null):this.nextTurn(),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}}getMovableTokens(t,e){return t.tokens.filter(s=>null!==this.calculateNewPosition(s,t.color,e))}calculateNewPosition(t,e,n){const o=t.position,r=s[e];if("home"===o.type)return 6!==n?null:{type:"board",position:r};if("board"===o.type){let t=o.position,s=this.getStepsToFinishEntry(o.position,e);if(s<n){const t=n-s-1;return t>=i?null:t===i-1?{type:"finished"}:{type:"finish",position:t}}return s===n?{type:"finish",position:0}:(t=(o.position+n)%a,{type:"board",position:t})}if("finish"===o.type){const t=o.position+n;return t>i-1?null:t===i-1?{type:"finished"}:{type:"finish",position:t}}return null}getStepsToFinishEntry(t,e){const i=(s[e]+a-1)%a;return t<=i?i-t:a-t+i}checkCapture(t,e){if(!n.includes(e))for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if("board"===t.position.type&&t.position.position===e){const e=s.tokens.filter(t=>"home"===t.position.type).length;t.position={type:"home",index:e}}}nextTurn(){this.state.diceValue=null,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.consecutiveSixes=0;let t=this.state.currentPlayerIndex;do{t=(t+1)%this.state.players.length}while(null===this.state.players[t].id||this.state.players[t].hasFinished);this.state.currentPlayerIndex=t}hasAnyTokenOnBoard(t){if(null===t.id)return!1;for(const e of t.tokens)if("board"===e.position.type||"finish"===e.position.type)return!0;return!1}handleAddBot(t){"waiting"===this.state.gamePhase&&(t<0||t>=4||null===this.state.players[t].id&&(this.state.players[t]={...this.state.players[t],id:`BOT_${Date.now()}_${t}`,username:`Bot ${t+1}`,isBot:!0},this.broadcastState(),this.setState({...this.state})))}handleRemoveBot(t){"waiting"===this.state.gamePhase&&(t<0||t>=4||this.state.players[t].isBot&&(this.state.players[t]={...this.state.players[t],id:null,username:`Player ${t+1}`,isBot:!1},this.broadcastState(),this.setState({...this.state})))}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.executeBotTurn(t.id),800)}executeBotTurn(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];if(e.id===t)if(this.state.hasRolled&&!this.state.canRollAgain){if(null!==this.state.diceValue){const s=this.getMovableTokens(e,this.state.diceValue);if(s.length>0){const i=this.pickBestToken(e,s,this.state.diceValue);this.handleMoveToken(t,i.id)}}}else this.handleRollDice(t)}pickBestToken(t,e,s){for(const a of e){const e=this.calculateNewPosition(a,t.color,s);if("finished"===e?.type)return a}for(const a of e){const e=this.calculateNewPosition(a,t.color,s);if("board"===e?.type&&!n.includes(e.position)&&this.canCaptureAt(t.color,e.position))return a}const i=e.find(t=>"home"===t.position.type);return i&&6===s?i:e.reduce((e,s)=>{const i=this.getTokenProgress(e,t.color);return this.getTokenProgress(s,t.color)>i?s:e})}canCaptureAt(t,e){for(const s of this.state.players)if(s.color!==t)for(const t of s.tokens)if("board"===t.position.type&&t.position.position===e)return!0;return!1}getTokenProgress(t,e){const n=t.position;if("home"===n.type)return 0;if("finished"===n.type)return a+i+1;if("finish"===n.type)return a+n.position;if("board"===n.type){const t=s[e];return n.position>=t?n.position-t:a-t+n.position}return 0}requestRollDice(){const t={type:"ROLL_DICE",playerId:this.userId};this.makeMove(t)}requestMoveToken(t){const e={type:"MOVE_TOKEN",playerId:this.userId,tokenId:t};this.makeMove(e)}requestStartGame(){this.makeMove({type:"START_GAME"})}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeMove(e)}requestRemoveBot(t){const e={type:"REMOVE_BOT",slotIndex:t};this.makeMove(e)}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}requestNewGame(){this.makeMove({type:"RESET"})}reset(){this.state={...this.state,players:this.state.players.map(t=>({...t,tokens:this.createInitialTokens(),hasFinished:!1})),currentPlayerIndex:0,diceValue:null,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,lastMove:null,consecutiveSixes:0},this.broadcastState(),this.setState({...this.state})}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}updatePlayers(t){if("waiting"===this.state.gamePhase){for(let e=0;e<Math.min(t.length,4);e++)this.state.players[e].isBot||(this.state.players[e].id=t[e]?.id||null,this.state.players[e].username=t[e]?.username||`Player ${e+1}`);this.broadcastState(),this.setState({...this.state})}}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return this.state.players.filter(t=>null!==t.id).length>=2}getMovableTokensForCurrentPlayer(){if(null===this.state.diceValue)return[];const t=this.state.players[this.state.currentPlayerIndex];return this.getMovableTokens(t,this.state.diceValue)}isTokenMovable(t){return this.getMovableTokensForCurrentPlayer().some(e=>e.id===t)}}export{r as default};
