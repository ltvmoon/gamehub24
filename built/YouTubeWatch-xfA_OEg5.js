import{B as t}from"./BaseGame-BjLvdXwv.js";import"./socket-DRbsQkF5.js";class s extends t{state;onStateChange;players=[];constructor(t,s,e,a,i){super(t,s,e,a),this.state={videoId:"",isPlaying:!1,timestamp:0,lastUpdate:Date.now(),allowGuestControl:!1},this.init()}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t,t(this.state)}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const s=t.action;"SET_VIDEO"===s.type?this.handleSetVideo(s.payload):"SYNC_STATE"===s.type?this.isHost&&this.state.allowGuestControl&&this.players.includes(s.playerId)&&this.handleSyncState(s.payload):"REQUEST_SYNC"===s.type?this.isHost&&this.broadcastState():"TOGGLE_GUEST_CONTROL"===s.type&&this.isHost&&this.handleToggleGuestControl(s.payload)}makeMove(t){this.isHost?("SET_VIDEO"===t.type&&this.handleSetVideo(t.payload),"SYNC_STATE"===t.type&&this.handleSyncState(t.payload),"TOGGLE_GUEST_CONTROL"===t.type&&this.handleToggleGuestControl(t.payload)):this.sendAction(t)}handleSetVideo(t){this.isHost&&(this.state.videoId=t,this.state.isPlaying=!0,this.state.timestamp=0,this.state.lastUpdate=Date.now(),this.broadcastState(),this.setState({...this.state}))}handleSyncState(t){this.isHost&&(this.state.isPlaying=t.isPlaying,this.state.timestamp=t.timestamp,this.state.lastUpdate=Date.now(),this.broadcastState(),this.setState({...this.state}))}handleToggleGuestControl(t){this.isHost&&(this.state.allowGuestControl=t,this.broadcastState(),this.setState({...this.state}))}setVideo(t){const s=this.extractVideoId(t);if(!s)return;const e={type:"SET_VIDEO",payload:s};this.makeMove(e)}sync(t,s){const e={type:"SYNC_STATE",payload:{isPlaying:t,timestamp:s}};this.makeMove(e)}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}toggleGuestControl(t){const s={type:"TOGGLE_GUEST_CONTROL",payload:t};this.makeMove(s)}extractVideoId(t){const s=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const e of s){const s=t.match(e);if(s)return s[1]}return null}checkGameEnd(){return null}reset(){this.state={videoId:"",isPlaying:!1,timestamp:0,lastUpdate:Date.now(),allowGuestControl:!1},this.broadcastState(),this.setState({...this.state})}updatePlayers(t){this.players=t.map(t=>t.id)}}export{s as default};
