import{b as e,a as t,j as n}from"./index-Dgl20RHv.js";import{l as r,P as o,ac as s,x as a}from"./react-vendor-DqvDgvkG.js";import"./socket-DRbsQkF5.js";import"./zustand-DHxpPrWm.js";const l=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"],i=[{label:"S",value:3},{label:"M",value:7},{label:"L",value:15}];function c({game:c,currentUserId:d}){const u=c,h=r.useRef(null),[m,x]=r.useState(u.getState()),[f,g]=r.useState(!1),[p,v]=r.useState(l[6]),[w,b]=r.useState(5),[k,j]=r.useState([]),[y,C]=r.useState(!1),{confirm:N}=e(),{ti:S,ts:T}=t(),R=r.useRef(new Set),M=r.useRef(new Set),E=r.useRef([]),P=r.useRef(!1),I=r.useRef(m),X=r.useRef(0),$=r.useRef(!1);r.useEffect(()=>{I.current=m},[m]);const U=(e,t)=>{const n=h.current;if(!n)return;const r=n.getContext("2d");r&&(r.clearRect(0,0,n.width,n.height),I.current.strokes.forEach(n=>{if(n.points.length<2)return;let o=n.points.length;n.id===e&&void 0!==t&&(o=Math.max(2,t)),r.strokeStyle=n.color,r.lineWidth=n.width,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(n.points[0].x,n.points[0].y);for(let e=1;e<o;e++)r.lineTo(n.points[e].x,n.points[e].y);r.stroke()}))},q=e=>new Promise(t=>{const n=h.current;if(!n||e.points.length<2)return void t();if(!n.getContext("2d"))return void t();const r=Math.max(e.duration||500,200),o=e.points.length,s=performance.now(),a=n=>{const l=n-s,i=Math.min(l/r,1),c=Math.floor(i*o);U(e.id,c),i<1?requestAnimationFrame(a):t()};requestAnimationFrame(a)});r.useEffect(()=>{const e=setTimeout(()=>{$.current=!0},500);return u.onUpdate(e=>{if(!$.current)return e.strokes.forEach(e=>{R.current.add(e.id),M.current.add(e.id)}),void x(e);e.strokes.filter(e=>!R.current.has(e.id)&&e.playerId!==d).forEach(e=>{E.current.push(e),R.current.add(e.id)}),e.strokes.forEach(e=>{e.playerId===d&&R.current.add(e.id)}),x(e),setTimeout(()=>(async()=>{if(!P.current&&0!==E.current.length){for(P.current=!0;E.current.length>0;){const e=E.current.shift();M.current.has(e.id)||(M.current.add(e.id),await q(e))}P.current=!1,U()}})(),0)}),x(u.getState()),u.requestSync(),()=>clearTimeout(e)},[u,d]),r.useEffect(()=>{P.current||U()},[m.strokes]);const z=e=>{const t=h.current,n=t.getBoundingClientRect(),r=e.clientX-n.left,o=e.clientY-n.top;return{x:r*(t.width/n.width),y:o*(t.height/n.height)}},D=()=>{if(!f||k.length<2)return g(!1),void j([]);const e=performance.now()-X.current,t={id:`${d??""}_${Date.now()}`,playerId:d??"",points:k,color:p,width:w,duration:e};M.current.add(t.id),u.draw(t),g(!1),j([])},J=e=>{const t=h.current,n=t.getBoundingClientRect(),r=e.touches[0]||e.changedTouches[0],o=r.clientX-n.left,s=r.clientY-n.top;return{x:o*(t.width/n.width),y:s*(t.height/n.height)}};return n.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[n.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[n.jsx("button",{onClick:()=>C(!0),className:"md:hidden w-8 h-8 rounded-full border-2 border-white",style:{backgroundColor:p},title:T({en:"Pick color",vi:"Chọn màu"})}),n.jsx(o,{className:"w-4 h-4 text-slate-400 hidden md:block"}),n.jsx("div",{className:"hidden md:flex items-center gap-1.5",children:l.map(e=>n.jsx("button",{onClick:()=>v(e),className:"w-8 h-8 rounded-full border-2 transition-all "+(p===e?"border-white scale-110":"border-slate-600 hover:scale-105"),style:{backgroundColor:e},title:e},e))}),n.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),i.map(e=>n.jsx("button",{onClick:()=>b(e.value),className:"w-7 h-7 md:w-8 md:h-8 rounded-lg border-2 transition-all flex items-center justify-center text-xs font-bold "+(w===e.value?"border-white bg-slate-600 text-white":"border-slate-600 bg-slate-700 text-slate-400 hover:border-slate-500"),title:`Stroke size: ${e.label}`,children:e.label},e.value)),n.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),n.jsx("button",{onClick:()=>u.undo(),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-yellow-400",title:T({en:"Undo last stroke",vi:"Hoàn tác nét vẽ"}),children:n.jsx(s,{className:"w-4 h-4"})}),n.jsx("button",{onClick:async()=>{await N(T({en:"Clear canvas for everyone",vi:"Xóa canvas cho tất cả"}),T({en:"Clear canvas?",vi:"Xóa canvas?"}))&&u.clear()},className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:T({en:"Clear canvas",vi:"Xóa canvas"}),children:n.jsx(a,{className:"w-4 h-4"})})]}),n.jsx("canvas",{ref:h,width:800,height:600,onMouseDown:e=>{g(!0),X.current=performance.now();const t=z(e);j([t])},onMouseMove:e=>{if(!f)return;const t=z(e);j(e=>[...e,t]);const n=h.current.getContext("2d");k.length>0&&(n.strokeStyle=p,n.lineWidth=w,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(k[k.length-1].x,k[k.length-1].y),n.lineTo(t.x,t.y),n.stroke())},onMouseUp:D,onMouseLeave:D,onTouchStart:e=>{g(!0),X.current=performance.now();const t=J(e);j([t])},onTouchMove:e=>{if(!f)return;const t=J(e);j(e=>[...e,t]);const n=h.current.getContext("2d");k.length>0&&(n.strokeStyle=p,n.lineWidth=w,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(k[k.length-1].x,k[k.length-1].y),n.lineTo(t.x,t.y),n.stroke())},onTouchEnd:()=>{if(!f||k.length<2)return g(!1),void j([]);const e=performance.now()-X.current,t={id:`${d??""}_${Date.now()}`,playerId:d??"",points:k,color:p,width:w,duration:e};M.current.add(t.id),u.draw(t),g(!1),j([])},className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none shadow-lg",style:{aspectRatio:"4/3",minHeight:"200px"}}),n.jsxs("div",{className:"text-xs text-slate-500",children:[m.strokes.length," ",S({en:"strokes",vi:"nét vẽ"})]}),y&&n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>C(!1),children:n.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 shadow-xl",onClick:e=>e.stopPropagation(),children:[n.jsx("h3",{className:"text-sm font-medium text-slate-300 mb-3 text-center",children:S({en:"Pick a color",vi:"Chọn màu"})}),n.jsx("div",{className:"grid grid-cols-4 gap-3",children:l.map(e=>n.jsx("button",{onClick:()=>{v(e),C(!1)},className:"w-12 h-12 rounded-full border-3 transition-all "+(p===e?"border-white scale-110 ring-2 ring-white/50":"border-slate-600"),style:{backgroundColor:e}},e))})]})})]})}export{c as default};
