import{B as t}from"./BaseGame--ikFMc2v.js";import{s as e,b as a,c as s}from"./helper-CQgxB6Hs.js";import"./socket-DRbsQkF5.js";import"./index-DZL8eqPD.js";import"./react-vendor-dLL3GPIb.js";import"./zustand-DYnM1nWq.js";const r=[{color:[0,255,255],label:"C"},{color:[255,0,255],label:"M"},{color:[255,255,0],label:"Y"},{color:[0,0,0],label:"K"},{color:[255,255,255],label:"W"}],o=[.3,.5,.7];class i extends t{roundTimer=null;getInitState(){return{phase:"waiting",round:0,maxRounds:5,targetColor:[0,0,0],availableCards:[],playerData:{},roundStartTime:0,answerCardIds:[]}}isGameOver(t){return"summary"===t.phase&&t.round>=t.maxRounds}onSocketGameAction({action:t}){if(!this.isHost)return;const e=t;switch(e.type){case"START_GAME":this.startGame();break;case"DROP_CARD":this.handleDropCard(e.playerId,e.cardId);break;case"REMOVE_CARD":this.handleRemoveCard(e.playerId,e.cardId);break;case"NEXT_ROUND":this.startRound();break;case"RESET_GAME":this.resetGame()}}startGame(){const t={};for(const e of this.players)t[e.id]={cardsInZone:[],finishedAt:null,score:0};this.state.playerData=t,this.state.round=0,this.startRound()}startRound(){if(this.state.round++,this.state.round>this.state.maxRounds)return void(this.state.phase="summary");const t=function(){const t=[];let e=0;for(const a of r)for(const s of o)t.push({id:e++,color:a.color,opacity:s,label:a.label});return t}(),s=Math.random()<.5?2:3,i=e(t),n=i.filter(t=>!(255===t.color[0]&&255===t.color[1]&&255===t.color[2]))[0],l=i.filter(t=>t.id!==n.id),d=[n,...l.slice(0,s-1)],c=a(d),h=e(t),u=h.filter(t=>d.some(e=>e.color[0]===t.color[0]&&e.color[1]===t.color[1]&&e.color[2]===t.color[2]&&e.opacity===t.opacity)).map(t=>t.id);for(const e of Object.keys(this.state.playerData))this.state.playerData[e].cardsInZone=[],this.state.playerData[e].finishedAt=null;for(const e of this.players)this.state.playerData[e.id]||(this.state.playerData[e.id]={cardsInZone:[],finishedAt:null,score:0});this.state.targetColor=c,this.state.availableCards=h,this.state.answerCardIds=u,this.state.roundStartTime=Date.now(),this.state.phase="playing"}handleDropCard(t,e){if("playing"!==this.state.phase)return;const a=this.state.playerData[t];a&&null===a.finishedAt&&(a.cardsInZone.includes(e)||(a.cardsInZone.push(e),this.evaluatePlayer(t)))}handleRemoveCard(t,e){if("playing"!==this.state.phase)return;const a=this.state.playerData[t];if(!a||null!==a.finishedAt)return;const s=a.cardsInZone.indexOf(e);-1!==s&&a.cardsInZone.splice(s,1),this.evaluatePlayer(t)}evaluatePlayer(t){const e=this.state.playerData[t];if(!e)return;if(0===e.cardsInZone.length)return;const r=e.cardsInZone.map(t=>this.state.availableCards.find(e=>e.id===t)).filter(Boolean),o=a(r);if(s(o,this.state.targetColor)>=100){e.finishedAt=Date.now();const t=e.finishedAt-this.state.roundStartTime,a=Math.max(100,Math.round(1e3-t/100));e.score+=a,this.checkRoundEnd()}}checkRoundEnd(){Object.values(this.state.playerData).every(t=>null!==t.finishedAt)&&(this.roundTimer&&clearTimeout(this.roundTimer),this.roundTimer=setTimeout(()=>{this.state.round,this.state.maxRounds,this.state.phase="summary"},1500))}resetGame(){const t=this.getInitState();Object.assign(this.state,t)}destroy(){this.roundTimer&&clearTimeout(this.roundTimer),super.destroy()}}export{i as default};
