import{B as t}from"./BaseGame-BjLvdXwv.js";import"./socket-DRbsQkF5.js";const e=50;class s extends t{state;onStateChange;constructor(t,e,s,n,i){super(t,e,s,n),this.state={board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:{X:i[0]?.id||null,O:i[1]?.id||null},gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null},this.init()}init(){this.isHost&&(this.broadcastState(),this.checkBotTurn())}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.makeMove(e);break;case"UNDO_REQUEST":this.handleUndoRequest(e.playerId);break;case"UNDO_RESPONSE":this.handleUndoResponse(e.accepted);break;case"SWITCH_TURN":this.handleSwitchTurn();break;case"RESET_GAME":this.reset()}}makeMove(t){const{row:e,col:s,playerId:n}=t;if(this.state.gameOver)return;const i=`${e},${s}`;if(this.state.board[i])return;const a=this.getPlayerSymbolInternal(n);if(!a||a!==this.state.currentTurn)return;this.state.board[i]=a,this.state.history.push(i),this.state.pendingUndoRequest=null;const r=this.checkWin(e,s,a);r?(this.state.winner=a,this.state.winningLine=r,this.state.gameOver=!0,this.broadcastGameEnd({winner:a})):this.state.currentTurn="X"===a?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkGameEnd(){return this.state.gameOver?{winner:this.state.winner||void 0}:null}reset(){this.state={board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:this.state.players,gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null},this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}updatePlayers(t){const e=t[0]?.id||null;let s=t[1]?.id||null;"BOT"!==this.state.players.O||s||(s="BOT"),this.state.players={X:e,O:s},this.broadcastState(),this.setState({...this.state})}checkWin(t,s,n){const i=[[0,1],[1,0],[1,1],[1,-1]];for(const[a,r]of i){const i=[[t,s]];let h=t+a,o=s+r;for(;h>=0&&h<e&&o>=0&&o<e&&this.state.board[`${h},${o}`]===n;)i.push([h,o]),h+=a,o+=r;for(h=t-a,o=s-r;h>=0&&h<e&&o>=0&&o<e&&this.state.board[`${h},${o}`]===n;)i.push([h,o]),h-=a,o-=r;if(i.length>=5)return i}return null}getPlayerSymbolInternal(t){return this.state.players.X===t?"X":this.state.players.O===t?"O":null}getPlayerSymbol(){return this.getPlayerSymbolInternal(this.userId)}requestMove(t,e){const s={type:"MAKE_MOVE",row:t,col:e,playerId:this.userId};this.isHost?this.makeMove(s):this.sendAction(s)}requestUndo(){const t={type:"UNDO_REQUEST",playerId:this.userId};this.isHost?this.handleUndoRequest(this.userId):this.sendAction(t)}responseUndo(t){const e={type:"UNDO_RESPONSE",accepted:t};this.isHost?this.handleUndoResponse(t):this.sendAction(e)}switchTurn(){this.isHost?this.handleSwitchTurn():this.sendAction({type:"SWITCH_TURN"})}requestReset(){this.isHost?this.reset():this.sendAction({type:"RESET_GAME"})}handleUndoRequest(t){if(0===this.state.history.length)return;const e=this.state.history[this.state.history.length-1];this.state.board[e]===this.getPlayerSymbolInternal(t)&&(this.state.pendingUndoRequest=t,this.broadcastState(),this.setState({...this.state}))}handleUndoResponse(t){if(t){const t=this.state.history.pop();t&&(delete this.state.board[t],this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.state.gameOver=!1,this.state.winner=null,this.state.winningLine=null),this.state.pendingUndoRequest=null}else this.state.pendingUndoRequest=null;this.broadcastState(),this.setState({...this.state})}handleSwitchTurn(){this.state.gameOver||this.state.history.length>0||(this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}))}addBot(){this.isHost&&(this.state.players.O="BOT",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}checkBotTurn(){if(!this.isHost)return;"BOT"!==("X"===this.state.currentTurn?this.state.players.X:this.state.players.O)||this.state.gameOver||setTimeout(()=>this.makeBotMove(),600)}makeBotMove(){if(this.state.gameOver)return;const t=this.getBestMove();t&&this.makeMove({type:"MAKE_MOVE",row:t.row,col:t.col,playerId:"BOT"})}getBestMove(){const t=this.getCandidateMoves();if(0===t.length)return{row:Math.floor(25),col:Math.floor(25)};let e=-1/0,s=[];for(const n of t){const{row:t,col:i}=n,a=this.evaluateMove(t,i,"O","X");a>e?(e=a,s=[n]):a===e&&s.push(n)}if(s.length>0){return s[Math.floor(Math.random()*s.length)]}return null}getCandidateMoves(){const t=new Set,s=Object.keys(this.state.board);if(0===s.length)return[];const n=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const i of s){const[s,a]=i.split(",").map(Number);for(const[i,r]of n){const n=s+i,h=a+r;n>=0&&n<e&&h>=0&&h<e&&!this.state.board[`${n},${h}`]&&t.add(`${n},${h}`)}}return Array.from(t).map(t=>{const[e,s]=t.split(",").map(Number);return{row:e,col:s}})}evaluateMove(t,e,s,n){let i=0;const a=[[0,1],[1,0],[1,1],[1,-1]];for(const[r,h]of a)i+=this.evaluateLine(t,e,r,h,s,!0),i+=this.evaluateLine(t,e,r,h,n,!1);return i}evaluateLine(t,s,n,i,a,r){let h=0,o=0,l=t+n,u=s+i;for(;this.state.board[`${l},${u}`]===a;)h++,l+=n,u+=i;for(l>=0&&l<e&&u>=0&&u<e&&!this.state.board[`${l},${u}`]&&o++,l=t-n,u=s-i;this.state.board[`${l},${u}`]===a;)h++,l-=n,u-=i;l>=0&&l<e&&u>=0&&u<e&&!this.state.board[`${l},${u}`]&&o++;const c=h+1;if(c>=5)return 1e5;if(4===c){if(2===o)return 1e4;if(1===o)return r?1e3:2e3}if(3===c){if(2===o)return r?500:1e3;if(1===o)return 100}return 2===c&&2===o?10:c}}export{s as default};
