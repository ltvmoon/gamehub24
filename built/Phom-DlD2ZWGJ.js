import{B as t}from"./BaseGame-DNUNIW8N.js";import{S as e,R as s,e as a,d as r}from"./types-BxbibcNM.js";import"./socket-DRbsQkF5.js";import"./index-DeW22Zn2.js";import"./react-vendor-BeKtp5AY.js";import"./zustand-C88HNARu.js";class n extends t{isGameOver(t){return"ended"===t.gamePhase}getInitState(){return{players:Array(4).fill(null).map((t,e)=>{const s=this.players[e];return{id:s?.id||null,username:s?.username||`Slot ${e+1}`,hand:[],eatenCards:[],phoms:[],discardPile:[],isBot:!1,isHost:s?.id===this.userId,isDealer:!1,rank:null,score:0,isMom:!1,showedPhom:!1}}),deck:[],drawPile:[],currentTurnIndex:0,lastDiscardedCard:null,lastDiscardedBy:null,roundNumber:1,turnPhase:"drawing",winner:null,gamePhase:"waiting",newGameRequest:null,sentCards:[],discardHistory:[]}}onSocketGameAction(t){const e=t.action;if(this.isHost){switch(e.type){case"DRAW":this.handleDraw(e.playerId);break;case"EAT":this.handleEat(e.playerId);break;case"DISCARD":this.handleDiscard(e.playerId,e.card);break;case"START_GAME":this.handleStartGame();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"JOIN_SLOT":this.handleJoinSlot(e.slotIndex,e.playerId,e.playerName);break;case"REMOVE_PLAYER":this.handleRemovePlayer(e.slotIndex);break;case"NEW_GAME":case"ACCEPT_NEW_GAME":this.reset();break;case"REQUEST_NEW_GAME":this.handleNewGameRequest(e.playerId,e.playerName);break;case"DECLINE_NEW_GAME":this.state.newGameRequest=null}this.checkBotTurn()}}createDeck(){const t=[];for(const r of[e.SPADE,e.CLUB,e.DIAMOND,e.HEART])for(const e of Object.values(s))t.push(a(e,r));return t}shuffleDeck(t){const e=[...t];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}dealCards(){const t=this.shuffleDeck(this.createDeck()),e=this.state.currentTurnIndex;let s=0;for(let a=0;a<4;a++){const r=this.state.players[a];if(null!==r.id){const n=a===e?10:9;r.hand=t.slice(s,s+n),r.isDealer=a===e,s+=n,this.sortHand(r.hand)}}this.state.drawPile=t.slice(s),this.state.turnPhase="discarding"}sortHand(t){t.sort((t,e)=>{const s=r(t),a=r(e);return s.rank!==a.rank?s.rank-a.rank:s.suit-a.suit})}handleDraw(t){if("playing"!==this.state.gamePhase||"drawing"!==this.state.turnPhase)return;const e=this.state.players.findIndex(e=>e.id===t);if(e!==this.state.currentTurnIndex)return;if(0===this.state.drawPile.length)return void this.autoResolveShowing();const s=this.state.drawPile.shift();this.state.players[e].hand.push(s),this.sortHand(this.state.players[e].hand),this.checkU(t)||(this.state.turnPhase="discarding",this.checkBotTurn())}handleEat(t){if("playing"!==this.state.gamePhase||"drawing"!==this.state.turnPhase)return;const e=this.state.players.findIndex(e=>e.id===t);if(e!==this.state.currentTurnIndex||!this.state.lastDiscardedCard)return;const s=this.state.players[e],a=this.state.lastDiscardedCard;this.canFormPhom(s.hand,a)&&(s.hand.push(a),s.eatenCards.push(a),this.state.lastDiscardedCard=null,this.state.lastDiscardedBy=null,this.checkU(t)||(this.state.turnPhase="discarding",this.checkBotTurn()))}handleDiscard(t,e){if("playing"!==this.state.gamePhase||"discarding"!==this.state.turnPhase)return;const s=this.state.players.findIndex(e=>e.id===t);if(s!==this.state.currentTurnIndex)return;const a=this.state.players[s],r=a.hand.indexOf(e);-1!==r&&(a.hand.splice(r,1),a.discardPile.push(e),this.state.lastDiscardedCard=e,this.state.lastDiscardedBy=t,this.state.discardHistory.push({card:e,playerId:t,playerName:a.username}),this.checkU(t)||this.advanceTurn())}advanceTurn(){let t=(this.state.currentTurnIndex+1)%4;for(;null===this.state.players[t].id;)t=(t+1)%4;this.state.currentTurnIndex=t,this.state.turnPhase="drawing",this.state.players[t].isDealer&&this.state.roundNumber<4&&this.state.roundNumber++,this.checkBotTurn()}endGame(t){const e=this.state.players.filter(t=>null!==t.id);if(t){const s=e.find(e=>e.id===t);if(s){const t=this.findBestPartition(s.hand);s.phoms=t;const e=new Set(t.flatMap(t=>t.cards));s.hand=s.hand.filter(t=>!e.has(t)),s.showedPhom=!0}for(const a of e){if(a.id===t)continue;const e=this.findBestPartition(a.hand);a.phoms=e;const s=new Set(e.flatMap(t=>t.cards));a.hand=a.hand.filter(t=>!s.has(t)),a.isMom=0===e.length&&0===a.eatenCards.length,a.showedPhom=!0}}this.state.players.forEach(e=>{e.id&&(e.id===t?(e.score=0,e.isMom=!1):(e.score=this.calculateHandScore(e),e.isMom=0===e.phoms.length&&0===e.eatenCards.length))});const s=this.state.players.filter(t=>null!==t.id).sort((e,s)=>{if(t){if(e.id===t)return-1;if(s.id===t)return 1}return e.isMom&&!s.isMom?1:!e.isMom&&s.isMom?-1:e.score-s.score});s.forEach((t,e)=>{t.rank=e+1}),this.state.winner=t||s[0].id,this.state.gamePhase="ended"}calculateHandScore(t){return t.hand.reduce((t,e)=>t+(r(e).rank+1),0)}findBestPartition(t){let e=[],s=0;const a=(t,r,n)=>{if(n>s&&(s=n,e=r.map(t=>({...t,cards:[...t.cards]}))),t.length<3)return;const i=this.findPhoms(t),h=new Set,d=i.filter(t=>{const e=[...t.cards].sort().join(",");return!h.has(e)&&(h.add(e),!0)});for(const e of d){const s=this.removeCards(t,e.cards);a(s,[...r,e],n+e.cards.length)}};return a([...t].sort(),[],0),e}autoResolveShowing(){const t=this.state.players.filter(t=>null!==t.id);for(const s of t){const t=this.findBestPartition(s.hand);s.phoms=t;const e=new Set(t.flatMap(t=>t.cards));s.hand=s.hand.filter(t=>!e.has(t)),s.isMom=0===t.length&&0===s.eatenCards.length,s.showedPhom=!0}const e=[];for(const s of t)for(const a of[...s.hand]){let r=!1;for(const n of t)if(n.id!==s.id&&!r)for(let t=0;t<n.phoms.length;t++){const i=n.phoms[t],h=[...i.cards,a];if(this.findPhoms(h).some(t=>t.cards.length===h.length)){const h=s.hand.indexOf(a);-1!==h&&s.hand.splice(h,1),i.cards.push(a),this.sortHand(i.cards),e.push({fromId:s.id,card:a,toId:n.id,toPhomIndex:t}),r=!0;break}}}this.state.sentCards=e,this.endGame()}canFormPhom(t,e){const s=[...t,e];return this.findPhoms(s).some(t=>t.cards.includes(e))}findPhoms(t){const e=[],s={};t.forEach(t=>{const{rank:e}=r(t);s[e]||(s[e]=[]),s[e].push(t)}),Object.values(s).forEach(t=>{t.length>=3&&e.push({type:"kind",cards:t}),t.length});const a={};return t.forEach(t=>{const{suit:e}=r(t);a[e]||(a[e]=[]),a[e].push(t)}),Object.values(a).forEach(t=>{const s=[...t].sort((t,e)=>r(t).rank-r(e).rank);for(let a=0;a<s.length;a++){let t=[s[a]];for(let n=a+1;n<s.length;n++)if(r(s[n]).rank===r(t[t.length-1]).rank+1)t.push(s[n]),t.length>=3&&e.push({type:"straight",cards:[...t]});else if(r(s[n]).rank>r(t[t.length-1]).rank+1)break}}),e}checkU(t){const e=this.state.players.find(e=>e.id===t);return!!e&&(!!this.canPartitionIntoPhoms(e.hand)&&(this.endGame(t),!0))}canPartitionIntoPhoms(t){if(0===t.length)return!0;if(t.length<3)return!1;const e=[...t].sort((t,e)=>t-e),s=e[0],a=this.findAllPhomsContainingCard(e,s);for(const r of a){const t=this.removeCards(e,r.cards);if(this.canPartitionIntoPhoms(t))return!0}return!1}findAllPhomsContainingCard(t,e){return this.findPhoms(t).filter(t=>t.cards.includes(e))}removeCards(t,e){let s=[...t];for(const a of e){const t=s.indexOf(a);-1!==t&&s.splice(t,1)}return s}handleStartGame(){if("waiting"!==this.state.gamePhase)return;if(!(this.state.players.filter(t=>null!==t.id).length<2)){for(this.state.currentTurnIndex=Math.floor(4*Math.random());null===this.state.players[this.state.currentTurnIndex].id;)this.state.currentTurnIndex=(this.state.currentTurnIndex+1)%4;this.dealCards(),this.state.gamePhase="playing",this.state.roundNumber=1,this.checkBotTurn()}}handleAddBot(t){t<0||t>=4||null!==this.state.players[t].id||(this.state.players[t]={id:`BOT_${t}_${Date.now()}`,username:`Bot ${t+1}`,hand:[],eatenCards:[],phoms:[],discardPile:[],isBot:!0,isHost:!1,isDealer:!1,rank:null,score:0,isMom:!1,showedPhom:!1})}handleJoinSlot(t,e,s){t<0||t>=4||null!==this.state.players[t].id||this.state.players.some(t=>t.id===e)||(this.state.players[t]={id:e,username:s,hand:[],eatenCards:[],phoms:[],discardPile:[],isBot:!1,isHost:e===this.userId,isDealer:!1,rank:null,score:0,isMom:!1,showedPhom:!1})}handleRemovePlayer(t){t<0||t>=4||"waiting"!==this.state.gamePhase||(this.state.players[t]={id:null,username:`Slot ${t+1}`,hand:[],eatenCards:[],phoms:[],discardPile:[],isBot:!1,isHost:!1,isDealer:!1,rank:null,score:0,isMom:!1,showedPhom:!1})}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentTurnIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t),1e3)}makeBotMove(t){if("playing"===this.state.gamePhase)if("drawing"===this.state.turnPhase)this.state.lastDiscardedCard&&this.canFormPhom(t.hand,this.state.lastDiscardedCard)?this.handleEat(t.id):this.handleDraw(t.id);else if("discarding"===this.state.turnPhase){const e=this.findPhoms(t.hand),s=new Set(e.flatMap(t=>t.cards)),a=t.hand.filter(t=>!s.has(t));let n;if(a.length>0)a.sort((t,e)=>r(e).rank-r(t).rank),n=a[0];else{n=[...t.hand].sort((t,e)=>r(e).rank-r(t).rank)[0]}this.handleDiscard(t.id,n)}}handleNewGameRequest(t,e){this.isHost?this.reset():this.state.newGameRequest={fromId:t,fromName:e}}reset(){const t=this.state.players.map(t=>({...t,hand:[],eatenCards:[],phoms:[],discardPile:[],isDealer:!1,rank:null,score:0,isMom:!1,showedPhom:!1}));this.state={...this.getInitState(),players:t},this.state.sentCards=[]}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}updatePlayers(t){for(let e=0;e<4;e++){const s=this.state.players[e];if(!s.isBot){const a=t.find(t=>t.id===s.id);a?s.username=a.username:(s.id=null,s.username=`Slot ${e+1}`,s.hand=[],s.eatenCards=[],s.phoms=[],s.discardPile=[])}}}requestDraw(){this.makeAction({type:"DRAW",playerId:this.userId})}requestEat(){this.makeAction({type:"EAT",playerId:this.userId})}requestDiscard(t){this.makeAction({type:"DISCARD",playerId:this.userId,card:t})}requestAddBot(t){this.makeAction({type:"ADD_BOT",slotIndex:t})}requestJoinSlot(t,e){this.makeAction({type:"JOIN_SLOT",slotIndex:t,playerId:this.userId,playerName:e})}requestRemovePlayer(t){this.makeAction({type:"REMOVE_PLAYER",slotIndex:t})}requestStartGame(){this.makeAction({type:"START_GAME"})}requestNewGame(){this.makeAction({type:"REQUEST_NEW_GAME",playerId:this.userId,playerName:""})}acceptNewGame(){this.isHost&&this.onSocketGameAction({action:{type:"ACCEPT_NEW_GAME"}})}declineNewGame(){this.isHost&&this.onSocketGameAction({action:{type:"DECLINE_NEW_GAME"}})}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}getUserId(){return this.userId}canStartGame(){if("waiting"!==this.state.gamePhase)return!1;return this.state.players.filter(t=>null!==t.id).length>=2}canFormPhomPublic(t,e){return this.canFormPhom(t,e)}getPhomsPublic(t){return this.findBestPartition(t)}getDiscardSuggestionsPublic(t){const e=this.findPhoms(t),s=new Set(e.flatMap(t=>t.cards));return t.filter(t=>!s.has(t)).sort((t,e)=>r(e).rank-r(t).rank)}}export{n as default};
