import{u as e,b as t,S as s,j as r}from"./index-BwFFTHxy.js";import{b as n,j as l,be as o,bf as i,aa as a,bg as c,bh as d,A as u,b1 as h}from"./react-vendor-BqGe223k.js";import{DIFFICULTY_CONFIG as x}from"./Maze-DAJ3hWQ5.js";import{u as m}from"./useGameState-B9NgJQ7q.js";import{u as f}from"./usePrevious-5VTlBPQq.js";import"./socket-DRbsQkF5.js";import"./zustand-B1murped.js";import"./BaseGame-CsKbx1S6.js";import"./random-Ddp3Jbui.js";const g=(e,t,s)=>{const r=window.devicePixelRatio||1;e.width=t*r,e.height=s*r,e.style.width=`${t}px`,e.style.height=`${s}px`;const n=e.getContext("2d");return n&&n.scale(r,r),n},p=({game:p})=>{const w=p,[v]=m(w),b=n.useRef(null),y=n.useRef(null),j=n.useRef(null),N=n.useRef({}),{ts:E}=e(),{confirm:T}=t(),I="PLAYING"===v.status&&!v.winners.includes(w.userId);f(`${v.status}-${v.level}`,(e,t)=>{"WAITING"!==v.status&&null!==e&&s.playTurnSwitch(I)});const[P,k]=n.useState(30),S=n.useMemo(()=>w.userId?v.players[w.userId]:void 0,[w.userId,v.players]),L=n.useMemo(()=>w.getMazeGrid(),[v.config,v.seed,w]);n.useEffect(()=>{const e=()=>{if(!j.current)return;const{rows:e,cols:t}=v.config,s=Math.min(window.innerWidth-32,800),r=window.innerHeight-180-32,n=Math.floor(s/t),l=Math.floor(r/e);let o=Math.min(n,l);o=Math.max(10,Math.min(o,40)),k(o)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[v.config.rows,v.config.cols]);const[R,z]=n.useState(!1);n.useEffect(()=>{const e=()=>{z(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e)}},[]);const A=n.useRef(void 0),[G,M]=n.useState(!1),[D,F]=n.useState(new Set),C=n.useRef(new Set);n.useEffect(()=>{const e=new Set;F(e),C.current=e},[v.seed,v.level,v.status,w]),n.useEffect(()=>{if(!S)return;const e=Date.now();if(!(S.moveEnd&&e<S.moveEnd&&S.currentPath&&S.currentPath.length>=2)){const e=`${S.x},${S.y}`;C.current.has(e)||(C.current.add(e),F(new Set(C.current)))}},[S?.x,S?.y,S?.moveEnd,S?.currentPath,G]),n.useEffect(()=>{const e=y.current;if(!e)return;const{rows:t,cols:s}=v.config,r=s*P,n=t*P,l=g(e,r,n);l&&(l.clearRect(0,0,r,n),S&&(l.fillStyle=S.color+"33",D.forEach(e=>{const[t,s]=e.split(",").map(Number);l.fillRect(t*P,s*P,P,P)})))},[D,v.config.rows,v.config.cols,P,S]),n.useEffect(()=>{const e=b.current;if(!e||!L)return;const{rows:t,cols:s}=v.config,r=s*P,n=t*P,l=g(e,r,n);if(l){l.clearRect(0,0,r,n),l.fillStyle="rgba(34, 197, 94, 0.2)",l.fillRect((s-1)*P,(t-1)*P,P,P),l.fillStyle="rgba(59, 130, 246, 0.2)",l.fillRect(0,0,P,P),l.lineWidth=3;for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=L?.[e]?.[t];if(s?.portalTo){const r=t*P+P/2,n=e*P+P/2;l.beginPath(),l.arc(r,n,.35*P,0,2*Math.PI),l.fillStyle=s.portalTo.color+"40",l.fill(),l.beginPath(),l.arc(r,n,.25*P,0,2*Math.PI),l.strokeStyle=s.portalTo.color,l.stroke(),l.beginPath(),l.arc(r,n,.1*P,0,2*Math.PI),l.fillStyle=s.portalTo.color,l.fill()}}l.strokeStyle="#4b5563",l.lineWidth=2,l.lineCap="round",l.beginPath();for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=L[e][t],r=t*P,n=e*P;s.walls.top&&(l.moveTo(r,n),l.lineTo(r+P,n)),s.walls.right&&(l.moveTo(r+P,n),l.lineTo(r+P,n+P)),s.walls.bottom&&(l.moveTo(r,n+P),l.lineTo(r+P,n+P)),s.walls.left&&(l.moveTo(r,n),l.lineTo(r,n+P))}l.stroke()}},[L,v.config.rows,v.config.cols,P]),n.useEffect(()=>{const e=e=>{if("PLAYING"!==v.status)return;let t=null;"ArrowUp"===e.key&&(t="UP"),"ArrowDown"===e.key&&(t="DOWN"),"ArrowLeft"===e.key&&(t="LEFT"),"ArrowRight"===e.key&&(t="RIGHT")," "===e.key&&O(),t&&(e.preventDefault(),W(t))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[v.status,w]),n.useEffect(()=>{let e=!1;const t=()=>{const s=Date.now();if(Object.values(v.players).forEach(e=>{const t=N.current[e.id];if(!t)return;let r=e.x,n=e.y;if(!!e.moveStart&&!!e.moveEnd&&!!e.currentPath&&e.currentPath.length>=2&&s<e.moveEnd){const t=e.moveEnd-e.moveStart,l=s-e.moveStart,o=Math.max(0,Math.min(l/t,1)),i=e.currentPath,a=i.length-1,c=o*a,d=Math.floor(c),u=c-d;if(d<a){const e=i[d],t=i[d+1];r=e.x+(t.x-e.x)*u,n=e.y+(t.y-e.y)*u}if(e.id===w.userId){let e=!1;for(let t=0;t<=d&&t<i.length;t++){const s=i[t],r=`${s.x},${s.y}`;C.current.has(r)||(C.current.add(r),e=!0)}e&&F(new Set(C.current))}}t.style.left=r*P+.15*P+"px",t.style.top=n*P+.15*P+"px",t.style.width=.7*P+"px",t.style.height=.7*P+"px"}),w.userId&&v.players[w.userId]){const t=v.players[w.userId],r=!!(t.moveEnd&&s<t.moveEnd);r!==e&&(e=r,M(r))}A.current=requestAnimationFrame(t)};return A.current=requestAnimationFrame(t),()=>{A.current&&cancelAnimationFrame(A.current)}},[v.players,P,w.userId]);const H=e=>{const t=v.winners.indexOf(e);return-1===t?void 0:t+1},O=()=>{w.userId&&w.makeAction({type:"TELEPORT",playerId:w.userId})},W=e=>{w.userId&&w.makeAction({type:"MOVE",direction:e,playerId:w.userId})};return r.jsxs("div",{className:"flex flex-col items-center justify-center min-h-full @md:p-4 p-2 overflow-hidden pb-16!",ref:j,children:[r.jsx("div",{className:"flex flex-col w-full max-w-2xl bg-gray-800 @md:p-4 p-2 rounded-xl shadow-lg gap-4 z-10 shrink-0",children:r.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[r.jsxs("div",{className:"flex flex-col",children:[r.jsxs("span",{className:"text-sm text-gray-400",children:["Level ",v.level," ",r.jsx("span",{className:"text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded-full",children:v.config.difficulty})]}),r.jsxs("div",{className:"flex gap-1 mt-2",children:[w.isHost&&r.jsx("button",{onClick:async()=>{await T(E({en:"Current progress will be lost",vi:"Tiến trình hiện tại sẽ mất"}),E({en:"Reset Game?",vi:"Chơi lại?"}))&&w.makeAction({type:"RESET_GAME"})},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:"Reset Game",children:r.jsx(l,{size:18})}),r.jsx("button",{onClick:()=>{j.current&&(document.fullscreenElement?document.exitFullscreen():j.current.requestFullscreen().catch(e=>{console.error(`Error attempting to enable fullscreen: ${e.message}`)}))},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:R?"Exit Fullscreen":"Fullscreen",children:R?r.jsx(o,{size:18}):r.jsx(i,{size:18})})]})]}),r.jsx("div",{className:"flex flex-col flex-wrap gap-0",children:Object.values(v.players).map(e=>r.jsxs("div",{className:"flex items-center gap-2 p-1.5 px-3 bg-gray-900/50 rounded-lg border border-gray-700/50",children:[r.jsx("div",{className:"w-3 h-3 rounded-full border border-white/20 shrink-0",style:{backgroundColor:e.color}}),r.jsxs("div",{className:"truncate font-medium text-sm text-gray-300 max-w-[100px]",children:[e.username||e.id.slice(0,8),e.id===w.userId&&r.jsxs("span",{className:"text-blue-400 ml-1",children:["(",E({en:"You",vi:"Bạn"}),")"]})]}),H(e.id)&&r.jsxs("span",{className:"text-xs font-bold bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded ml-1",children:["#",H(e.id)]})]},e.id))})]})}),r.jsxs("div",{className:"relative shadow-2xl rounded-lg border border-gray-700 select-none bg-[#1a1a1a] mt-4 shrink-0 transition-all duration-300",style:{width:v.config.cols*P,height:v.config.rows*P},children:[r.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-lg",children:[r.jsx("canvas",{ref:y,className:"absolute inset-0 z-0",style:{width:"100%",height:"100%"}}),r.jsx("canvas",{ref:b,className:"absolute inset-0 z-10",style:{width:"100%",height:"100%"}}),Object.values(v.players).map(e=>r.jsx("div",{ref:t=>{N.current[e.id]=t},className:"absolute rounded-full shadow-sm flex items-center justify-center border-2 border-white",style:{width:.7*P+"px",height:.7*P+"px",backgroundColor:e.color,zIndex:e.id===w.userId?20:10},children:H(e.id)&&r.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-md",children:["#",H(e.id)]})},e.id)),"WAITING"===v.status&&r.jsxs("div",{className:"absolute inset-0 bg-black/40 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[r.jsx("div",{className:"text-white text-3xl font-bold",children:w.isHost?E({en:"Setup Game",vi:"Cài đặt Game"}):E({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})}),w.isHost&&r.jsxs("div",{className:"flex flex-col gap-4 items-center animate-in fade-in zoom-in duration-300",children:[r.jsx("div",{className:"flex bg-gray-800 rounded-lg p-1.5 ring-1 ring-gray-700",children:Object.keys(x).map(e=>r.jsx("button",{onClick:()=>{return t=e,void w.makeAction({type:"UPDATE_SETTINGS",difficulty:t});var t},className:"px-4 py-2 text-sm font-bold rounded-md transition-all "+(v.config.difficulty===e?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"),children:e},e))}),r.jsxs("button",{onClick:()=>{w.makeAction({type:"START_GAME"})},className:"flex items-center gap-2 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all hover:-translate-y-0.5",children:[r.jsx(a,{size:24,fill:"currentColor"})," ",E({en:"Start Game",vi:"Chơi"})]})]})]}),"FINISHED"===v.status&&r.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[r.jsxs("div",{className:"text-green-400 text-4xl font-bold drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]",children:[E({en:"Level Complete!",vi:"Xong Level"})," ",v.level]}),S&&H(S.id)&&r.jsxs("div",{className:"text-white text-xl",children:[E({en:"You finished",vi:"Bạn về đích"})," ",r.jsxs("span",{className:"font-bold text-yellow-400",children:["#",H(S.id)]})]}),w.isHost?r.jsxs("button",{onClick:()=>{w.makeAction({type:"NEXT_LEVEL"})},className:"flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all hover:-translate-y-0.5",children:[E({en:"Next Level",vi:"Level tiếp theo"})," ",r.jsx(a,{size:24,fill:"currentColor"})]}):r.jsx("div",{children:E({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})})]})]}),(()=>{const e=G;if("PLAYING"!==v.status||!S||e||H(S.id))return null;const t=(()=>{if(!S||!L)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const{x:e,y:t}=S;if(t<0||e<0||t>=v.config.rows||e>=v.config.cols)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const s=L[t][e];return{UP:!s.walls.top,DOWN:!s.walls.bottom,LEFT:!s.walls.left,RIGHT:!s.walls.right}})(),s=40,n=S.x*P+P/2,o=S.y*P+P/2,i=v.config.cols*P,a=v.config.rows*P,x=t.LEFT?60:20,m=t.RIGHT?60:20,f=t.UP?60:20,g=t.DOWN?60:20,p=Math.max(x,Math.min(i-m,n)),w=Math.max(f,Math.min(a-g,o)),b=(e,t)=>({width:"40px",height:"40px",left:p+e-20+"px",top:w+t-20+"px"}),y="absolute flex items-center justify-center bg-white/10 hover:bg-white/40 rounded-full glass-blur transition-all hover:scale-110 active:scale-95 z-30 border border-white/10 shadow-lg ring-1 ring-black/20 opacity-50";return r.jsxs(r.Fragment,{children:[t.UP&&r.jsx("button",{onPointerDown:e=>{e.stopPropagation(),W("UP")},className:y,style:b(0,-40),children:r.jsx(c,{size:24,className:"text-white drop-shadow-md"})}),t.DOWN&&r.jsx("button",{onPointerDown:e=>{e.stopPropagation(),W("DOWN")},className:y,style:b(0,s),children:r.jsx(d,{size:24,className:"text-white drop-shadow-md"})}),t.LEFT&&r.jsx("button",{onPointerDown:e=>{e.stopPropagation(),W("LEFT")},className:y,style:b(-40,0),children:r.jsx(u,{size:24,className:"text-white drop-shadow-md"})}),t.RIGHT&&r.jsx("button",{onPointerDown:e=>{e.stopPropagation(),W("RIGHT")},className:y,style:b(s,0),children:r.jsx(h,{size:24,className:"text-white drop-shadow-md"})}),L?.[S.y]?.[S.x]?.portalTo&&r.jsx("button",{onPointerDown:e=>{e.stopPropagation(),O()},className:"absolute flex items-center justify-center bg-purple-500/80 hover:bg-purple-400 rounded-full glass-blur transition-all hover:scale-110 active:scale-95 z-40 border border-white/20 shadow-[0_0_15px_rgba(168,85,247,0.5)] animate-pulse opacity-50",style:{width:"40px",height:"40px",left:p-20+"px",top:w-20+"px"},children:r.jsx(l,{size:24,className:"text-white drop-shadow-md animate-spin",style:{animationDirection:"reverse"}})})]})})()]}),r.jsx("div",{className:"mt-4 text-gray-500 text-sm",children:E({vi:"Về đích đầu tiên để dành chiến thắng",en:"First to the finish wins!"})})]})};export{p as default};
