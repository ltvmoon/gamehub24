import"./socket-DRbsQkF5.js";import{c as t}from"./index-Di-nc6fj.js";var e=Symbol.for("immer-nothing"),s=Symbol.for("immer-draftable"),i=Symbol.for("immer-state");function o(t,...e){throw new Error(`[Immer] minified error nr: ${t}. Full error at: https://bit.ly/3cXEKWf`)}var n=Object,r=n.getPrototypeOf,a="constructor",c="prototype",h="configurable",u="enumerable",f="writable",l="value",d=t=>!!t&&!!t[i];function _(t){return!!t&&(m(t)||P(t)||!!t[s]||!!t[a]?.[s]||I(t)||w(t))}var p=n[c][a].toString(),y=new WeakMap;function m(t){if(!t||!z(t))return!1;const e=r(t);if(null===e||e===n[c])return!0;const s=n.hasOwnProperty.call(e,a)&&e[a];if(s===Object)return!0;if(!O(s))return!1;let i=y.get(s);return void 0===i&&(i=Function.toString.call(s),y.set(s,i)),i===p}function S(t,e,s=!0){if(0===g(t)){(s?Reflect.ownKeys(t):n.keys(t)).forEach(s=>{e(s,t[s],t)})}else t.forEach((s,i)=>e(i,s,t))}function g(t){const e=t[i];return e?e.type_:P(t)?1:I(t)?2:w(t)?3:0}var v=(t,e,s=g(t))=>2===s?t.has(e):n[c].hasOwnProperty.call(t,e),b=(t,e,s=g(t))=>2===s?t.get(e):t[e],k=(t,e,s,i=g(t))=>{2===i?t.set(e,s):3===i?t.add(s):t[e]=s};var P=Array.isArray,I=t=>t instanceof Map,w=t=>t instanceof Set,z=t=>"object"==typeof t,O=t=>"function"==typeof t,A=t=>"boolean"==typeof t;var N=t=>t.copy_||t.base_,E=t=>t.modified_?t.copy_:t.base_;function M(t,e){if(I(t))return new Map(t);if(w(t))return new Set(t);if(P(t))return Array[c].slice.call(t);const s=m(t);if(!0===e||"class_only"===e&&!s){const e=n.getOwnPropertyDescriptors(t);delete e[i];let s=Reflect.ownKeys(e);for(let i=0;i<s.length;i++){const o=s[i],n=e[o];!1===n[f]&&(n[f]=!0,n[h]=!0),(n.get||n.set)&&(e[o]={[h]:!0,[f]:!0,[u]:n[u],[l]:t[o]})}return n.create(r(t),e)}{const e=r(t);if(null!==e&&s)return{...t};const i=n.create(e);return n.assign(i,t)}}function F(t,e=!1){return H(t)||d(t)||!_(t)||(g(t)>1&&n.defineProperties(t,{set:L,add:L,clear:L,delete:L}),n.freeze(t),e&&S(t,(t,e)=>{F(e,!0)},!1)),t}var L={[l]:function(){o(2)}};function H(t){return null===t||!z(t)||n.isFrozen(t)}var R="MapSet",D="Patches",j="ArrayMethods",q={};function C(t){const e=q[t];return e||o(0),e}var G,V=t=>!!q[t],x=()=>G;function $(t,e){e&&(t.patchPlugin_=C(D),t.patches_=[],t.inversePatches_=[],t.patchListener_=e)}function U(t){J(t),t.drafts_.forEach(W),t.drafts_=null}function J(t){t===G&&(G=t.parent_)}var K=t=>G={drafts_:[],parent_:G,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0,handledSet_:new Set,processedForPatches_:new Set,mapSetPlugin_:V(R)?C(R):void 0,arrayMethodsPlugin_:V(j)?C(j):void 0};function W(t){const e=t[i];0===e.type_||1===e.type_?e.revoke_():e.revoked_=!0}function T(t,s){s.unfinalizedDrafts_=s.drafts_.length;const n=s.drafts_[0];if(void 0!==t&&t!==n){n[i].modified_&&(U(s),o(4)),_(t)&&(t=B(s,t));const{patchPlugin_:e}=s;e&&e.generateReplacementPatches_(n[i].base_,t,s)}else t=B(s,n);return function(t,e,s=!1){!t.parent_&&t.immer_.autoFreeze_&&t.canAutoFreeze_&&F(e,s)}(s,t,!0),U(s),s.patches_&&s.patchListener_(s.patches_,s.inversePatches_),t!==e?t:void 0}function B(t,e){if(H(e))return e;const s=e[i];if(!s){return et(e,t.handledSet_,t)}if(!Q(s,t))return e;if(!s.modified_)return s.base_;if(!s.finalized_){const{callbacks_:e}=s;if(e)for(;e.length>0;){e.pop()(t)}tt(s,t)}return s.copy_}function X(t){t.finalized_=!0,t.scope_.unfinalizedDrafts_--}var Q=(t,e)=>t.scope_===e,Y=[];function Z(t,e,s,i){const o=N(t),n=t.type_;if(void 0!==i){if(b(o,i,n)===e)return void k(o,i,s,n)}if(!t.draftLocations_){const e=t.draftLocations_=new Map;S(o,(t,s)=>{if(d(s)){const i=e.get(s)||[];i.push(t),e.set(s,i)}})}const r=t.draftLocations_.get(e)??Y;for(const a of r)k(o,a,s,n)}function tt(t,e){if(t.modified_&&!t.finalized_&&(3===t.type_||1===t.type_&&t.allIndicesReassigned_||(t.assigned_?.size??0)>0)){const{patchPlugin_:s}=e;if(s){const i=s.getPath(t);i&&s.generatePatches_(t,i,e)}X(t)}}function et(t,e,s){return!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||d(t)||e.has(t)||!_(t)||H(t)||(e.add(t),S(t,(o,n)=>{if(d(n)){const e=n[i];if(Q(e,s)){const s=E(e);k(t,o,s,t.type_),X(e)}}else _(n)&&et(n,e,s)})),t}var st={get(t,e){if(e===i)return t;let s=t.scope_.arrayMethodsPlugin_;const o=1===t.type_&&"string"==typeof e;if(o&&s?.isArrayOperationMethod(e))return s.createMethodInterceptor(t,e);const n=N(t);if(!v(n,e,t.type_))return function(t,e,s){const i=nt(e,s);return i?l in i?i[l]:i.get?.call(t.draft_):void 0}(t,n,e);const r=n[e];if(t.finalized_||!_(r))return r;if(o&&t.operationMethod&&s?.isMutatingArrayMethod(t.operationMethod)&&function(t){const e=+t;return Number.isInteger(e)&&String(e)===t}(e))return r;if(r===ot(t.base_,e)){at(t);const s=1===t.type_?+e:e,i=ct(t.scope_,r,t,s);return t.copy_[s]=i}return r},has:(t,e)=>e in N(t),ownKeys:t=>Reflect.ownKeys(N(t)),set(t,e,s){const o=nt(N(t),e);if(o?.set)return o.set.call(t.draft_,s),!0;if(!t.modified_){const o=ot(N(t),e),a=o?.[i];if(a&&a.base_===s)return t.copy_[e]=s,t.assigned_.set(e,!1),!0;if(((n=s)===(r=o)?0!==n||1/n==1/r:n!=n&&r!=r)&&(void 0!==s||v(t.base_,e,t.type_)))return!0;at(t),rt(t)}var n,r;return t.copy_[e]===s&&(void 0!==s||e in t.copy_)||Number.isNaN(s)&&Number.isNaN(t.copy_[e])||(t.copy_[e]=s,t.assigned_.set(e,!0),function(t,e,s){const{scope_:o}=t;if(d(s)){const n=s[i];Q(n,o)&&n.callbacks_.push(function(){at(t);const i=E(n);Z(t,s,i,e)})}else _(s)&&t.callbacks_.push(function(){const i=N(t);3===t.type_?i.has(s)&&et(s,o.handledSet_,o):b(i,e,t.type_)===s&&o.drafts_.length>1&&!0===(t.assigned_.get(e)??!1)&&t.copy_&&et(b(t.copy_,e,t.type_),o.handledSet_,o)})}(t,e,s)),!0},deleteProperty:(t,e)=>(at(t),void 0!==ot(t.base_,e)||e in t.base_?(t.assigned_.set(e,!1),rt(t)):t.assigned_.delete(e),t.copy_&&delete t.copy_[e],!0),getOwnPropertyDescriptor(t,e){const s=N(t),i=Reflect.getOwnPropertyDescriptor(s,e);return i?{[f]:!0,[h]:1!==t.type_||"length"!==e,[u]:i[u],[l]:s[e]}:i},defineProperty(){o(11)},getPrototypeOf:t=>r(t.base_),setPrototypeOf(){o(12)}},it={};for(let mt in st){let t=st[mt];it[mt]=function(){const e=arguments;return e[0]=e[0][0],t.apply(this,e)}}function ot(t,e){const s=t[i];return(s?N(s):t)[e]}function nt(t,e){if(!(e in t))return;let s=r(t);for(;s;){const t=Object.getOwnPropertyDescriptor(s,e);if(t)return t;s=r(s)}}function rt(t){t.modified_||(t.modified_=!0,t.parent_&&rt(t.parent_))}function at(t){t.copy_||(t.assigned_=new Map,t.copy_=M(t.base_,t.scope_.immer_.useStrictShallowCopy_))}it.deleteProperty=function(t,e){return it.set.call(this,t,e,void 0)},it.set=function(t,e,s){return st.set.call(this,t[0],e,s,t[0])};function ct(t,e,s,i){const[o,n]=I(e)?C(R).proxyMap_(e,s):w(e)?C(R).proxySet_(e,s):function(t,e){const s=P(t),i={type_:s?1:0,scope_:e?e.scope_:x(),modified_:!1,finalized_:!1,assigned_:void 0,parent_:e,base_:t,draft_:null,copy_:null,revoke_:null,isManual_:!1,callbacks_:void 0};let o=i,n=st;s&&(o=[i],n=it);const{revoke:r,proxy:a}=Proxy.revocable(o,n);return i.draft_=a,i.revoke_=r,[a,i]}(e,s);return(s?.scope_??x()).drafts_.push(o),n.callbacks_=s?.callbacks_??[],n.key_=i,s&&void 0!==i?function(t,e,s){t.callbacks_.push(function(i){const o=e;if(!o||!Q(o,i))return;i.mapSetPlugin_?.fixSetContents(o);const n=E(o);Z(t,o.draft_??o,n,s),tt(o,i)})}(s,n,i):n.callbacks_.push(function(t){t.mapSetPlugin_?.fixSetContents(n);const{patchPlugin_:e}=t;n.modified_&&e&&e.generatePatches_(n,[],t)}),o}function ht(t){if(!_(t)||H(t))return t;const e=t[i];let s,o=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,s=M(t,e.scope_.immer_.useStrictShallowCopy_),o=e.scope_.immer_.shouldUseStrictIteration()}else s=M(t,!0);return S(s,(t,e)=>{k(s,t,ht(e))},o),e&&(e.finalized_=!1),s}var ut=new class{constructor(t){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!1,this.produce=(t,s,i)=>{if(O(t)&&!O(s)){const e=s;s=t;const i=this;return function(t=e,...o){return i.produce(t,t=>s.call(this,t,...o))}}let n;if(O(s)||o(6),void 0===i||O(i)||o(7),_(t)){const e=K(this),o=ct(e,t,void 0);let r=!0;try{n=s(o),r=!1}finally{r?U(e):J(e)}return $(e,i),T(n,e)}if(!t||!z(t)){if(n=s(t),void 0===n&&(n=t),n===e&&(n=void 0),this.autoFreeze_&&F(n,!0),i){const e=[],s=[];C(D).generateReplacementPatches_(t,n,{patches_:e,inversePatches_:s}),i(e,s)}return n}o(1)},this.produceWithPatches=(t,e)=>{if(O(t))return(e,...s)=>this.produceWithPatches(e,e=>t(e,...s));let s,i;return[this.produce(t,e,(t,e)=>{s=t,i=e}),s,i]},A(t?.autoFreeze)&&this.setAutoFreeze(t.autoFreeze),A(t?.useStrictShallowCopy)&&this.setUseStrictShallowCopy(t.useStrictShallowCopy),A(t?.useStrictIteration)&&this.setUseStrictIteration(t.useStrictIteration)}createDraft(t){_(t)||o(8),d(t)&&(t=function(t){d(t)||o(10);return ht(t)}(t));const e=K(this),s=ct(e,t,void 0);return s[i].isManual_=!0,J(e),s}finishDraft(t,e){const s=t&&t[i];s&&s.isManual_||o(9);const{scope_:n}=s;return $(n,e),T(void 0,n)}setAutoFreeze(t){this.autoFreeze_=t}setUseStrictShallowCopy(t){this.useStrictShallowCopy_=t}setUseStrictIteration(t){this.useStrictIteration_=t}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(t,e){let s;for(s=e.length-1;s>=0;s--){const i=e[s];if(0===i.path.length&&"replace"===i.op){t=i.value;break}}s>-1&&(e=e.slice(s+1));const i=C(D).applyPatches_;return d(t)?i(t,e):this.produce(t,t=>i(t,e))}},ft=ut.produce;ut.setAutoFreeze.bind(ut)(!1);class lt{roomId;socket;isHost;userId;players;state;stateListeners=[];lastSyncedState;lastSyncedHash;isOptimizationEnabled=!0;stateVersion=0;constructor(t,e,s,i,o=[]){this.roomId=t,this.socket=e,this.isHost=s,this.userId=i,this.players=o,this.state=this.getInitState(),this.lastSyncedState=JSON.parse(JSON.stringify(this.state)),this.lastSyncedHash=dt(this.state),this.socket.on("game:action",this.onSocketGameAction.bind(this)),this.isHost||(this.socket.on("game:state",this.onSocketGameState.bind(this)),this.socket.on("game:state:patch",this.onSocketGameStatePatch.bind(this)),this.requestSync()),this.isHost&&this.socket.on("game:request_sync",this.onRequestSync.bind(this)),this.init()}init(){}makeAction(t){this.isHost?this.onSocketGameAction({action:t}):this.sendSocketGameAction(t)}updatePlayers(t){this.players=t,console.log(t),this.syncState()}setOptimization(t){this.isOptimizationEnabled=t,console.log("State optimization "+(t?"enabled":"disabled"))}gameName="unknown";setGameName(t){this.gameName=t}getState(){if(!this.state)throw new Error("Game state is not initialized");return this.state}notifyListeners(t){this.stateListeners.forEach(e=>e({...t}))}syncState(t=!1){this.notifyListeners(this.state),this.broadcastState(t)}setState(t){this.state=t,this.notifyListeners(t),this.broadcastState()}onUpdate(t){return this.stateListeners.push(t),()=>{this.stateListeners=this.stateListeners.filter(e=>e!==t)}}hasSomeoneElseInRoom(){const e=t.getState().currentRoom;return(e?.spectators?.length||0)+(e?.players?.length||0)>1}broadcastState(t=!1){if(this.isHost){const e=this.getState(),s=dt(e);if(this.isOptimizationEnabled&&!t&&this.lastSyncedHash===s)return;if(this.stateVersion++,this.isOptimizationEnabled&&!t&&this.lastSyncedState){const t=pt(this.lastSyncedState,e);if(t&&Object.keys(t).length>0)return this.hasSomeoneElseInRoom()&&this.socket.emit("game:state:patch",{roomId:this.roomId,patch:t,version:this.stateVersion}),void this.updateLastSynced(e,s)}this.hasSomeoneElseInRoom()&&this.socket.emit("game:state",{roomId:this.roomId,state:{...e},version:this.stateVersion}),this.updateLastSynced(e,s)}}updateLastSynced(t,e){this.lastSyncedState=JSON.parse(JSON.stringify(t)),this.lastSyncedHash=e,this.saveStateToStorage()}requestSync(){this.socket.emit("game:request_sync",{roomId:this.roomId})}sendSocketGameAction(t){this.hasSomeoneElseInRoom()?this.socket.emit("game:action",{roomId:this.roomId,action:t}):this.onSocketGameAction({action:t})}onSocketGameState(t){this.isHost||t.roomId&&t.roomId!==this.roomId||("number"==typeof t.version&&(console.log("updated state version",this.stateVersion,t.version),this.stateVersion=t.version),this.setState(t.state))}onSocketGameStatePatch(t){if(!this.isHost){if("number"==typeof t.version&&t.version!==this.stateVersion+1)return console.warn(`Packet loss detected! Expected version ${this.stateVersion+1} but got ${t.version}. Requesting sync...`),void this.requestSync();const e=ft(this.state,e=>{yt(e,t.patch)});"number"==typeof t.version&&(this.stateVersion=t.version),this.setState(e)}}onRequestSync(t){if(this.isHost)if(t.requesterSocketId){const e=this.getState();this.socket.emit("game:state:direct",{roomId:this.roomId,targetSocketId:t.requesterSocketId,state:{...e},version:this.stateVersion})}else this.syncState(!0)}saveStateToStorage(){if(this.isHost&&"unknown"!==this.gameName)try{const t=`saved_game_${this.gameName}`,e={state:this.getState(),timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("Failed to save game state:",t)}}clearSavedState(){if(this.isHost&&"unknown"!==this.gameName)try{localStorage.removeItem(`saved_game_${this.gameName}`)}catch(t){console.error("Failed to clear game state:",t)}}destroy(){this.socket.off("game:state"),this.socket.off("game:state:patch"),this.socket.off("game:action"),this.isHost&&this.socket.off("game:request_sync")}}function dt(t){try{const e=JSON.stringify(t);let s=0;for(let t=0;t<e.length;t++){s=(s<<5)-s+e.charCodeAt(t),s&=s}return s.toString(36)}catch(e){return Date.now().toString()}}const _t="__$$DELETED$$__";function pt(t,e){if(t===e)return;if(null===t||null===e)return e;if(typeof t!=typeof e)return e;if("object"!=typeof e)return e;const s={};let i=!1;for(const o in e){if(!(o in t)){if(void 0===e[o])continue;s[o]=e[o],i=!0;continue}const n=pt(t[o],e[o]);void 0!==n&&(s[o]=n,i=!0)}for(const o in t)o in e||(s[o]=_t,i=!0);return Array.isArray(t)&&Array.isArray(e)&&t.length!==e.length&&(s.length=e.length,i=!0),i?s:void 0}function yt(t,e){if(e&&"object"==typeof e)for(const s in e){const i=e[s];i===_t?delete t[s]:t[s]&&"object"==typeof t[s]&&i&&"object"==typeof i&&!Array.isArray(i)?yt(t[s],i):t[s]=i}}export{lt as B};
