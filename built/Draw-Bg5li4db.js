import{B as t}from"./BaseGame-B7FOWFqv.js";import{g as s}from"./words-Oxz6SOGi.js";import"./socket-DRbsQkF5.js";import"./index-BRLirKDd.js";import"./react-vendor-DrrN8YCO.js";import"./zustand-CxtZ_hFH.js";function e(t,s){if(!t||!s)return 0;const e=t.trim().toLowerCase(),i=s.trim().toLowerCase();if(e===i)return 100;const a=function(t,s){const e=[];for(let i=0;i<=s.length;i++)e[i]=[i];for(let i=0;i<=t.length;i++)e[0][i]=i;for(let i=1;i<=s.length;i++)for(let a=1;a<=t.length;a++)s.charAt(i-1)===t.charAt(a-1)?e[i][a]=e[i-1][a-1]:e[i][a]=Math.min(e[i-1][a-1]+1,Math.min(e[i][a-1]+1,e[i-1][a]+1));return e[s.length][t.length]}(e,i),r=Math.max(e.length,i.length);if(0===r)return 100;const o=(r-a)/r*100;return Math.round(10*o)/10}class i extends t{roundTimeout=null;currentRoundDuration=6e4;getInitState(){return{mode:"FREE",strokes:[],scores:{},guesses:[],messages:[],wordLanguage:"vi"}}onSocketGameAction(t){const s=t.action;switch(s.type){case"DRAW":this.handleDraw(s.payload);break;case"CLEAR":this.handleClear();break;case"UNDO":this.handleUndo(s.payload);break;case"START_GARTIC":this.handleStartGartic();break;case"CHOOSE_WORD":this.handleChooseWord(s.payload);break;case"SUBMIT_GUESS":this.handleSubmitGuess(s.payload);break;case"NEXT_ROUND":this.handleNextRound();break;case"SEND_MESSAGE":this.handleSendMessage(s.payload);break;case"REROLL_OPTIONS":this.handleRerollOptions(s.payload);break;case"PAUSE_GAME":this.handlePauseGame();break;case"BUY_HINT":this.handleBuyHint(s.payload);break;case"SELECT_DIFFICULTY":this.handleSelectDifficulty(s.payload)}}makeAction(t){if(this.isHost)this.onSocketGameAction({action:t});else{if("DRAW"===t.type)this.state.strokes=[...this.state.strokes,t.payload];else if("CLEAR"===t.type)("FREE"===this.state.mode||this.state.gartic&&this.state.gartic.drawerId===this.userId)&&(this.state.strokes=[]);else if("UNDO"===t.type){const s=t.payload;let e=-1;for(let t=this.state.strokes.length-1;t>=0;t--)if(this.state.strokes[t].playerId===s){e=t;break}-1!==e&&(this.state.strokes=this.state.strokes.filter((t,s)=>s!==e))}this.players.find(t=>t.id===this.userId)&&this.sendSocketGameAction(t)}}handleDraw(t){if(this.isHost){if("GARTIC"===this.state.mode){if("DRAWING"!==this.state.gartic?.status)return;if(this.state.gartic.isPaused)return;if(this.state.gartic?.drawerId!==t.playerId)return}this.state.strokes=[...this.state.strokes,t]}}handleClear(){this.isHost&&(this.state.strokes=[])}handleUndo(t){if(!this.isHost)return;let s=-1;for(let e=this.state.strokes.length-1;e>=0;e--)if(this.state.strokes[e].playerId===t){s=e;break}-1!==s&&(this.state.strokes=this.state.strokes.filter((t,e)=>e!==s))}handleStartGartic(){this.isHost&&(this.state.mode="GARTIC",this.state.scores={},this.players.forEach(t=>this.state.scores[t.id]=0),this.state.messages=[],this.state.wordLanguage="vi",this.startNewRound())}handleChooseWord(t){this.isHost&&this.state.gartic&&"CHOOSING_WORD"===this.state.gartic.status&&(this.state.gartic.word=t,this.state.gartic.maskedWord=t.replace(/\S/g,"_"),this.state.gartic.status="DRAWING",this.currentRoundDuration=6e4,this.state.gartic.roundEndTime=Date.now()+this.currentRoundDuration,this.state.strokes=[],this.addSystemMessage({en:"Drawer has chosen a word! Start guessing!",vi:"Người vẽ đã chọn từ! Bắt đầu đoán!"},"INFO"),this.roundTimeout&&clearTimeout(this.roundTimeout),this.roundTimeout=setTimeout(()=>{this.endRound({en:"Time's up!",vi:"Hết thời gian!"})},this.currentRoundDuration))}handleSubmitGuess(t){if(!this.isHost)return;const{playerId:s,text:i}=t;if("GARTIC"!==this.state.mode||!this.state.gartic||"DRAWING"!==this.state.gartic.status)return void this.addChatMessage(s,i);if(this.state.gartic.isPaused)return void this.addChatMessage(s,i);const a=this.players.find(t=>t.id===s);if(!a)return;if(s===this.state.gartic.drawerId)return void this.addChatMessage(s,i);if(this.state.guesses.includes(s))return void this.addChatMessage(s,i);const r=i.trim().toLowerCase(),o=this.state.gartic.word.toLowerCase();if(r===o){this.state.guesses.push(s);const t=this.state.guesses.length;let e=0;e=1===t?10:2===t?8:3===t?6:4,this.state.scores[s]=(this.state.scores[s]||0)+e;const i=this.state.gartic.drawerId;this.state.scores[i]=(this.state.scores[i]||0)+2,this.addSystemMessage({en:`${a.username} guessed correctly!`,vi:`${a.username} đoán đúng!`},"SUCCESS");const r=this.players.length-1;this.state.guesses.length>=r&&r>0&&this.endRound({en:"Everyone guessed correctly!",vi:"Mọi người đều đoán đúng!"})}else{const t=e(r,o);this.addChatMessage(s,i,t)}}handleNextRound(){this.isHost&&this.startNewRound()}handleSendMessage(t){this.isHost&&this.addChatMessage(t.playerId,t.text)}handleRerollOptions(t){if(!this.isHost)return;if("CHOOSING_WORD"!==this.state.gartic?.status)return;this.state.wordLanguage=t.language;const e=this.state.wordDifficulty||"easy",i=s(e,3,t.language);this.state.wordOptions=i}handleSelectDifficulty(t){if(!this.isHost)return;if("CHOOSING_WORD"!==this.state.gartic?.status)return;this.state.wordDifficulty=t.difficulty;const e=this.state.wordLanguage||"vi",i=s(t.difficulty,3,e);this.state.wordOptions=i}handlePauseGame(){if(this.isHost&&this.state.gartic&&("DRAWING"===this.state.gartic.status||"CHOOSING_WORD"===this.state.gartic.status))if(this.state.gartic.isPaused){this.state.gartic.isPaused=!1;const t=this.state.gartic.pausedRemainingTime||0;this.state.gartic.roundEndTime=Date.now()+t,this.state.gartic.pausedRemainingTime=void 0,this.roundTimeout&&clearTimeout(this.roundTimeout),"CHOOSING_WORD"===this.state.gartic.status?this.roundTimeout=setTimeout(()=>{"CHOOSING_WORD"===this.state.gartic?.status&&this.handleChooseWord(this.state.wordOptions?.[0]||"apple")},t):this.roundTimeout=setTimeout(()=>{this.endRound({en:"Time's up!",vi:"Hết thời gian!"})},t)}else{this.state.gartic.isPaused=!0;const t=Math.max(0,this.state.gartic.roundEndTime-Date.now());this.state.gartic.pausedRemainingTime=t,this.roundTimeout&&clearTimeout(this.roundTimeout)}}handleBuyHint(t){if(!this.isHost)return;if(!this.state.gartic||"DRAWING"!==this.state.gartic.status)return;if(this.state.guesses.includes(t))return;if(this.state.gartic.drawerId===t)return;const s=this.state.scores[t]||0;this.state.scores[t]=s-2;const e=this.state.gartic.word,i=this.state.gartic.playerHints[t]||[],a=[];for(let r=0;r<e.length;r++)" "===e[r]||i.includes(r)||a.push(r);if(a.length>0){const s=a[Math.floor(Math.random()*a.length)];i.push(s),this.state.gartic.playerHints[t]=i;const e=this.players.find(s=>s.id===t);this.addSystemMessage({en:`${e?.username} used a hint!`,vi:`${e?.username} đã sử dụng gợi ý!`},"INFO")}}startNewRound(){let t=0;if(this.state.gartic){const s=this.state.gartic.drawerId;t=(this.players.findIndex(t=>t.id===s)+1)%this.players.length}const e=this.players[t];if(!e)return;const i=this.state.wordDifficulty||"easy",a=this.state.wordLanguage||"vi",r=s(i,3,a);this.state.wordOptions=r,this.state.guesses=[],this.state.gartic={drawerId:e.id,word:"",status:"CHOOSING_WORD",roundEndTime:Date.now()+15e3,maskedWord:"",isPaused:!1,playerHints:{}},this.addSystemMessage({en:`Round starting! ${e.username} is choosing a word.`,vi:`Vòng mới bắt đầu! ${e.username} đang chọn từ.`},"INFO"),this.roundTimeout&&clearTimeout(this.roundTimeout),this.roundTimeout=setTimeout(()=>{"CHOOSING_WORD"===this.state.gartic?.status&&this.handleChooseWord(this.state.wordOptions?.[0]||"apple")},15e3)}endRound(t){this.roundTimeout&&clearTimeout(this.roundTimeout),this.state.gartic&&(this.state.gartic.status="ROUND_END",this.state.gartic.maskedWord=this.state.gartic.word,this.state.gartic.roundEndTime=Date.now()+5e3,this.addSystemMessage({en:`Round Ended: ${t.en}. The word was: ${this.state.gartic.word}`,vi:`Vòng kết thúc: ${t.vi}. Từ cần đoán là: ${this.state.gartic.word}`},"WARNING"),this.roundTimeout=setTimeout(()=>{this.startNewRound()},5e3))}addChatMessage(t,s,e){const i={id:Date.now().toString()+Math.random(),senderId:t,content:s,type:"CHAT",similarity:e,timestamp:Date.now()};this.state.messages=[...this.state.messages,i].slice(-50)}addSystemMessage(t,s="INFO"){const e={id:Date.now().toString()+Math.random(),senderId:"SYSTEM",content:t,type:"SYSTEM",subType:s,timestamp:Date.now()};this.state.messages=[...this.state.messages,e].slice(-50)}startGartic(){this.makeAction({type:"START_GARTIC"})}chooseWord(t){this.makeAction({type:"CHOOSE_WORD",payload:t})}submitGuess(t){this.makeAction({type:"SUBMIT_GUESS",payload:{playerId:this.userId,text:t}})}draw(t){this.makeAction({type:"DRAW",payload:t})}clear(){this.makeAction({type:"CLEAR"})}undo(){this.makeAction({type:"UNDO",payload:this.userId})}rerollOptions(t){this.makeAction({type:"REROLL_OPTIONS",payload:{language:t}})}pauseGame(){this.makeAction({type:"PAUSE_GAME"})}buyHint(){this.makeAction({type:"BUY_HINT",payload:this.userId})}selectDifficulty(t){this.makeAction({type:"SELECT_DIFFICULTY",payload:{difficulty:t}})}}export{i as default};
