import{c as e,j as t}from"./index-BrrJSH2n.js";import{j as r,P as n,a1 as o,s}from"./react-vendor-BZRLljed.js";import"./socket-DRbsQkF5.js";import"./zustand-B3oBTGP0.js";const l=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"],a=[{label:"S",value:3},{label:"M",value:7},{label:"L",value:15}];function i({game:i,currentUserId:c}){const d=i,u=r.useRef(null),[h,m]=r.useState(d.getState()),[x,f]=r.useState(!1),[g,p]=r.useState(l[6]),[w,b]=r.useState(5),[v,k]=r.useState([]),[j,y]=r.useState(!1),{confirm:C}=e(),N=r.useRef(new Set),S=r.useRef(new Set),T=r.useRef([]),R=r.useRef(!1),M=r.useRef(h),E=r.useRef(0),P=r.useRef(!1);r.useEffect(()=>{M.current=h},[h]);const I=(e,t)=>{const r=u.current;if(!r)return;const n=r.getContext("2d");n&&(n.clearRect(0,0,r.width,r.height),M.current.strokes.forEach(r=>{if(r.points.length<2)return;let o=r.points.length;r.id===e&&void 0!==t&&(o=Math.max(2,t)),n.strokeStyle=r.color,n.lineWidth=r.width,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(r.points[0].x,r.points[0].y);for(let e=1;e<o;e++)n.lineTo(r.points[e].x,r.points[e].y);n.stroke()}))},$=e=>new Promise(t=>{const r=u.current;if(!r||e.points.length<2)return void t();if(!r.getContext("2d"))return void t();const n=Math.max(e.duration||500,200),o=e.points.length,s=performance.now(),l=r=>{const a=r-s,i=Math.min(a/n,1),c=Math.floor(i*o);I(e.id,c),i<1?requestAnimationFrame(l):t()};requestAnimationFrame(l)});r.useEffect(()=>{const e=setTimeout(()=>{P.current=!0},500);return d.onUpdate(e=>{if(!P.current)return e.strokes.forEach(e=>{N.current.add(e.id),S.current.add(e.id)}),void m(e);e.strokes.filter(e=>!N.current.has(e.id)&&e.playerId!==c).forEach(e=>{T.current.push(e),N.current.add(e.id)}),e.strokes.forEach(e=>{e.playerId===c&&N.current.add(e.id)}),m(e),setTimeout(()=>(async()=>{if(!R.current&&0!==T.current.length){for(R.current=!0;T.current.length>0;){const e=T.current.shift();S.current.has(e.id)||(S.current.add(e.id),await $(e))}R.current=!1,I()}})(),0)}),m(d.getState()),d.requestSync(),()=>clearTimeout(e)},[d,c]),r.useEffect(()=>{R.current||I()},[h.strokes]);const U=e=>{const t=u.current,r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top;return{x:n*(t.width/r.width),y:o*(t.height/r.height)}},q=()=>{if(!x||v.length<2)return f(!1),void k([]);const e=performance.now()-E.current,t={id:`${c??""}_${Date.now()}`,playerId:c??"",points:v,color:g,width:w,duration:e};S.current.add(t.id),d.draw(t),f(!1),k([])},z=e=>{const t=u.current,r=t.getBoundingClientRect(),n=e.touches[0]||e.changedTouches[0],o=n.clientX-r.left,s=n.clientY-r.top;return{x:o*(t.width/r.width),y:s*(t.height/r.height)}};return t.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[t.jsx("button",{onClick:()=>y(!0),className:"md:hidden w-8 h-8 rounded-full border-2 border-white",style:{backgroundColor:g},title:"Pick color"}),t.jsx(n,{className:"w-4 h-4 text-slate-400 hidden md:block"}),t.jsx("div",{className:"hidden md:flex items-center gap-1.5",children:l.map(e=>t.jsx("button",{onClick:()=>p(e),className:"w-8 h-8 rounded-full border-2 transition-all "+(g===e?"border-white scale-110":"border-slate-600 hover:scale-105"),style:{backgroundColor:e},title:e},e))}),t.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),a.map(e=>t.jsx("button",{onClick:()=>b(e.value),className:"w-7 h-7 md:w-8 md:h-8 rounded-lg border-2 transition-all flex items-center justify-center text-xs font-bold "+(w===e.value?"border-white bg-slate-600 text-white":"border-slate-600 bg-slate-700 text-slate-400 hover:border-slate-500"),title:`Stroke size: ${e.label}`,children:e.label},e.value)),t.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),t.jsx("button",{onClick:()=>d.undo(),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-yellow-400",title:"Undo last stroke",children:t.jsx(o,{className:"w-4 h-4"})}),t.jsx("button",{onClick:async()=>{await C("Clear canvas for everyone","Clear canvas?")&&d.clear()},className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:"Clear canvas",children:t.jsx(s,{className:"w-4 h-4"})})]}),t.jsx("canvas",{ref:u,width:800,height:600,onMouseDown:e=>{f(!0),E.current=performance.now();const t=U(e);k([t])},onMouseMove:e=>{if(!x)return;const t=U(e);k(e=>[...e,t]);const r=u.current.getContext("2d");v.length>0&&(r.strokeStyle=g,r.lineWidth=w,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(v[v.length-1].x,v[v.length-1].y),r.lineTo(t.x,t.y),r.stroke())},onMouseUp:q,onMouseLeave:q,onTouchStart:e=>{f(!0),E.current=performance.now();const t=z(e);k([t])},onTouchMove:e=>{if(!x)return;const t=z(e);k(e=>[...e,t]);const r=u.current.getContext("2d");v.length>0&&(r.strokeStyle=g,r.lineWidth=w,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(v[v.length-1].x,v[v.length-1].y),r.lineTo(t.x,t.y),r.stroke())},onTouchEnd:()=>{if(!x||v.length<2)return f(!1),void k([]);const e=performance.now()-E.current,t={id:`${c??""}_${Date.now()}`,playerId:c??"",points:v,color:g,width:w,duration:e};S.current.add(t.id),d.draw(t),f(!1),k([])},className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none shadow-lg",style:{aspectRatio:"4/3",minHeight:"200px"}}),t.jsxs("div",{className:"text-xs text-slate-500",children:[h.strokes.length," strokes"]}),j&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>y(!1),children:t.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 shadow-xl",onClick:e=>e.stopPropagation(),children:[t.jsx("h3",{className:"text-sm font-medium text-slate-300 mb-3 text-center",children:"Pick a color"}),t.jsx("div",{className:"grid grid-cols-4 gap-3",children:l.map(e=>t.jsx("button",{onClick:()=>{p(e),y(!1)},className:"w-12 h-12 rounded-full border-3 transition-all "+(g===e?"border-white scale-110 ring-2 ring-white/50":"border-slate-600"),style:{backgroundColor:e}},e))})]})})]})}export{i as default};
