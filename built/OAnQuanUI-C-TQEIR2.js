import{b as e,u as t,S as n,j as s}from"./index-Dmop2YmA.js";import{b as r,c as i,R as a,x as l,a5 as o,a7 as c,aL as u,as as d,X as h}from"./react-vendor-BZHK3qaO.js";import{simulateOAnQuanMove as m}from"./OAnQuan-DxDSV9YI.js";import{u as x}from"./useGameState-VbZvHg5d.js";import{u as g}from"./usePrevious-DsjY7COx.js";import"./socket-DRbsQkF5.js";import"./zustand-CJEMJLaT.js";import"./BaseGame-CcmywW8C.js";const p=e=>{if(!e)return{x:0,y:0};const t=e.getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}},f=({game:a,currentUserId:f})=>{const w=a,{confirm:j}=e(),{ti:N,ts:q}=t(),[S,C]=r.useState(()=>[...w.snapshot.board]),[R,k]=r.useState(!1),[P,I]=r.useState({count:0}),[M,T]=r.useState(null),[B,H]=r.useState(null),[z,$]=r.useState(!1),G=r.useRef(void 0),Q=r.useRef([]),A=r.useRef(S),O=r.useRef([]),L=r.useRef([]),W=r.useRef([]),E=r.useRef(null),V=r.useRef(null);r.useEffect(()=>{A.current=S},[S]);const F=r.useCallback(async e=>{if(0===Q.current.length)return k(!1),void(E.current&&(e(E.current),C(E.current.board),E.current=null));k(!0),W.current=O.current.map(e=>p(e));const t=Q.current.shift();t&&(await K(t.move),e(t.state),C(t.state.board),A.current=t.state.board,F(e))},[w]),_=r.useCallback((e,t)=>{e.lastMove&&e.lastMove!==G.current?(Q.current.push({move:e.lastMove,state:e}),G.current=e.lastMove,R||F(t)):R||0!==Q.current.length?E.current=e:(t(e),C(e.board))},[R,F]),[U]=x(w,_),D=U.currentTurn===f&&"playing"===U.gamePhase;g(U.currentTurn,(e,t)=>{"playing"===U.gamePhase&&null!==e&&n.playTurnSwitch(D)});const K=async e=>{const t=[...A.current],{steps:n}=m(t,e.squareId,e.direction);let s=0,r=e.squareId;for(const a of n)if("sow"===a.type){const e=W.current[r]||p(O.current[r]),t=W.current[a.squareId]||p(O.current[a.squareId]);if(i.flushSync(()=>{I({count:s})}),V.current){V.current.style.opacity="1";const n=V.current.animate([{left:`${e.x}px`,top:`${e.y}px`,transform:"translate(-50%, -50%)"},{left:`${t.x}px`,top:`${t.y}px`,transform:"translate(-50%, -50%)"}],{duration:300,easing:"linear",fill:"forwards"});await n.finished}else await new Promise(e=>setTimeout(e,300));V.current&&(V.current.style.opacity="0");const n=[...A.current];n[a.squareId]+=1,s--,C(n),A.current=n,H(a.squareId),r=a.squareId}else if("pickup"===a.type){const e=[...A.current];s=a.amount,e[a.squareId]=0,C(e),A.current=e,r=a.squareId,await new Promise(e=>setTimeout(e,150))}else if("capture"===a.type){const t=w.state.players.findIndex(t=>t.id===e.player);if(-1!==t&&L.current[t]){const e=W.current[a.squareId]||p(O.current[a.squareId]),n=p(L.current[t]),s=[...A.current];if(s[a.squareId]=0,i.flushSync(()=>{C(s),A.current=s,I({count:a.amount}),H(a.squareId)}),V.current){V.current.style.opacity="1";const t=V.current.animate([{left:`${e.x}px`,top:`${e.y}px`,transform:"translate(-50%, -50%)"},{left:`${n.x}px`,top:`${n.y}px`,transform:"translate(-50%, -50%)"}],{duration:500,easing:"ease-in",fill:"forwards"});await t.finished,V.current.style.opacity="0"}else await new Promise(e=>setTimeout(e,300));H(null)}else{const e=[...A.current];e[a.squareId]=0,C(e),A.current=e,await new Promise(e=>setTimeout(e,300))}}},X=e=>{if(!D||R)return;if(0===e||6===e)return;if(0===w.state.board[e])return;const t=0===w.getMyPlayerIndex()?[7,11]:[1,5];e<t[0]||e>t[1]||T(M===e?null:e)},Y=e=>{null!==M&&(w.requestMove(M,e),T(null))},J=w.getMyPlayerIndex(),Z=U.players[0],ee=U.players[1],te=e=>{const t=U.players[e];if(!t)return N({en:"Waiting for player...",vi:"Chờ người chơi tham gia..."});let n=t.username;return t.id===f&&(n+=N({en:" (You)",vi:" (Bạn)"})),n};return s.jsxs("div",{className:"flex flex-col items-center justify-center p-4 w-full max-w-4xl mx-auto touch-none @md:min-h-[500px] pb-16!",children:[i.createPortal(s.jsx("div",{ref:V,className:"fixed z-100 pointer-events-none",style:{opacity:0,width:"40px",height:"40px",left:0,top:0},children:s.jsx("div",{className:"w-full h-full relative",children:s.jsx(v,{count:P.count})})}),document.body),s.jsxs("div",{className:"flex flex-col items-center",children:[s.jsx("div",{className:"text-xl font-bold bg-slate-700 px-4 py-1 rounded-full mb-2",children:"waiting"===U.gamePhase?U.players.length<2?N({en:"Wait for player to join...",vi:"Chờ người chơi tham gia..."}):N({en:"Wait for host to start game...",vi:"Chờ chủ phòng bắt đầu game..."}):U.winner?N({en:"GAME OVER",vi:"KẾT THÚC"}):null}),U.winner&&s.jsxs("div",{className:"text-green-400 font-bold animate-pulse mb-4",children:[N({en:"Winner: ",vi:"Người thắng: "}),U.players.find(e=>e.id===U.winner)?.username]})]}),w.isHost&&s.jsxs("div",{className:"mb-2 flex gap-4 flex-wrap justify-center",children:["waiting"===U.gamePhase&&U.players.length>=2&&s.jsxs("button",{onClick:()=>w.requestStartGame(),className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow",children:[s.jsx(l,{size:16})," ",N({en:"Start Game",vi:"Bắt đầu"})]}),"waiting"!==U.gamePhase&&s.jsxs("button",{onClick:async()=>{(U.winner||await j(q({en:"Are you sure you want to reset the game?",vi:"Bạn có chắc chắn muốn chơi lại không?"}),q({en:"Reset Game",vi:"Chơi lại"})))&&(w.requestResetGame(),H(null),T(null))},className:"flex items-center gap-2 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded shadow",children:[s.jsx(o,{size:16})," ",N({en:"Reset Game",vi:"Chơi lại"})]})]}),s.jsxs("div",{className:"flex flex-col items-center gap-2 justify-center",children:[s.jsxs("div",{ref:e=>{L.current[0]=e},className:"p-2 rounded border-2 "+(U.currentTurn===Z?.id?"bg-yellow-600 border-yellow-400 animate-bounce":"bg-slate-700/50 border-transparent"),children:[s.jsx("div",{className:"text-lg",children:te(0)}),s.jsx("div",{className:"text-2xl font-mono text-yellow-300 text-center",children:U.playerScores[Z?.id]||0})]}),s.jsxs("div",{className:"relative bg-amber-100 p-2 @md:p-4 rounded-xl select-none overflow-x-auto max-w-full",children:[s.jsxs("div",{className:"flex flex-row items-center gap-2 justify-center",children:[s.jsx(y,{count:S[0],onClick:()=>{},isMandarin:!0,forwardRef:e=>O.current[0]=e,left:!0}),s.jsxs("div",{className:"flex flex-col @md:gap-2 gap-1",children:[s.jsx("div",{className:"flex @md:gap-2 gap-1",children:[11,10,9,8,7].map(e=>s.jsx(b,{idx:e,count:S[e],playerOwner:0,isSelectable:D&&0===J&&!R&&S[e]>0,isSelected:M===e,isHighlighted:B===e,onClick:()=>X(e),forwardRef:t=>O.current[e]=t},e))}),s.jsx("div",{className:"flex @md:gap-2 gap-1",children:[1,2,3,4,5].map(e=>s.jsx(b,{idx:e,count:S[e],playerOwner:1,isSelectable:D&&1===J&&!R&&S[e]>0,isSelected:M===e,isHighlighted:B===e,onClick:()=>X(e),forwardRef:t=>O.current[e]=t},e))})]}),s.jsx(y,{count:S[6],onClick:()=>{},isMandarin:!0,forwardRef:e=>O.current[6]=e,isHighlighted:6===B})]}),null!==M&&s.jsxs("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 z-10 rounded-xl gap-2",onClick:()=>T(null),children:[s.jsx("button",{onClick:()=>Y("left"),className:"p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors",children:s.jsx(c,{size:32})}),s.jsx("button",{onClick:()=>Y("right"),className:"p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors",children:s.jsx(u,{size:32})})]})]}),s.jsxs("div",{ref:e=>{L.current[1]=e},className:"p-2 rounded border-2 "+(U.currentTurn===ee?.id?"bg-yellow-600 border-yellow-400 animate-bounce":"bg-slate-700/50 border-transparent"),children:[s.jsx("div",{className:"text-lg",children:te(1)}),s.jsx("div",{className:"text-2xl font-mono text-yellow-300 text-center",children:U.playerScores[ee?.id]||0}),w.isHost&&"waiting"===U.gamePhase&&s.jsxs("div",{className:"flex items-center justify-center gap-2 mt-1",children:[U.players.length<2&&s.jsx("button",{onClick:()=>w.requestAddBot(U.players.length),className:"px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs flex items-center gap-1",children:"+Bot"}),U.players.length>=2&&U.players[1]?.isBot&&s.jsxs("button",{onClick:()=>w.requestRemoveBot(1),className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs flex items-center gap-1",children:["- ",N({en:"Remove Bot",vi:"Xóa Bot"})]})]})]})]}),s.jsx("button",{onClick:()=>$(!0),className:"absolute bottom-2 right-2 p-3 bg-slate-700 hover:bg-slate-600 rounded-full text-yellow-500 transition-colors z-20",title:q({en:"Rules",vi:"Luật chơi"}),children:s.jsx(d,{size:20})}),z&&i.createPortal(s.jsx("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/80 p-4",children:s.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl max-w-lg w-full shadow-2xl relative",children:[s.jsxs("div",{className:"flex justify-between p-4 pr-2",children:[s.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[s.jsx(d,{className:"w-6 h-6 text-yellow-500"}),N({en:"Game Rules: O An Quan",vi:"Luật Chơi: Ô Ăn Quan"})]}),s.jsx("button",{onClick:()=>$(!1),className:"p-2 hover:bg-white/10 rounded-full transition-colors text-slate-400 hover:text-white",children:s.jsx(h,{className:"w-5 h-5"})})]}),s.jsx("div",{className:"p-4 pt-0 space-y-4 text-slate-300 leading-relaxed max-h-[80vh] overflow-y-auto",children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("p",{children:N({en:"O An Quan (Mandarin Square Capturing) is a traditional Vietnamese board game for two players. The goal is to capture as many stones as possible.",vi:"Ô Ăn Quan là trò chơi dân gian Việt Nam dành cho 2 người. Mục tiêu là ăn được càng nhiều quân càng tốt."})}),s.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:N({en:"Setup",vi:"Thiết lập"})}),s.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[s.jsx("li",{children:N({en:"Board: 10 'Rice Fields' (squares) and 2 'Mandarin Squares' (semicircles at ends).",vi:"Bàn cờ: 10 ô 'Ruộng' và 2 ô 'Quan' (bán nguyệt ở hai đầu)."})}),s.jsx("li",{children:N({en:"Stones: 5 small stones in each Rice Field. 1 big stone (worth 10) in each Mandarin Square.",vi:"Quân: 5 quân dân ở mỗi ruộng. 1 quân quan (giá trị 10) ở mỗi ô quan."})})]}),s.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:N({en:"How to Play",vi:"Cách chơi"})}),s.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[s.jsx("li",{children:N({en:"Players take turns. Valid moves must start from a Rice Field on your side (Player 1: Top, Player 2: Bottom).",vi:"Người chơi lần lượt đi. Nước đi phải bắt đầu từ ô Ruộng phía mình (P1: Trên, P2: Dưới)."})}),s.jsx("li",{children:N({en:"Choose a square with stones and a direction (Left or Right).",vi:"Chọn một ô có quân và hướng đi (Trái hoặc Phải)."})}),s.jsx("li",{children:N({en:"Stones are distributed one by one into subsequent squares.",vi:"Các quân sẽ được rải lần lượt vào từng ô tiếp theo."})}),s.jsx("li",{children:N({en:"If the last stone lands in a square with stones, pick them all up and continue distributing.",vi:"Nếu quân cuối cùng rơi vào ô có quân, bốc hết quân ở đó lên và tiếp tục rải."})}),s.jsx("li",{children:N({en:"If the last stone lands in an empty square, and the next square has stones, you CAPTURE those stones.",vi:"Nếu quân cuối rơi vào ô trống, và ô kế tiếp có quân, bạn sẽ ĂN số quân đó."})}),s.jsx("li",{children:N({en:"Turn ends when the last stone lands in an empty square followed by another empty square, or hits a Mandarin square.",vi:"Lượt đi kết thúc khi quân cuối rơi vào ô mà ô kế tiếp cũng trống, hoặc rơi vào ô Quan."})})]}),s.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:N({en:"Winning",vi:"Chiến thắng"})}),s.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[s.jsx("li",{children:N({en:"Game ends when both Mandarin Squares are empty.",vi:"Trò chơi hết khi 2 ô Quan đều trống."})}),s.jsx("li",{children:N({en:"Remaining stones on player's side belong to them.",vi:"Số quân còn lại trong ruộng của ai thuộc về người đó."})}),s.jsx("li",{children:N({en:"Player with the highest score wins.",vi:"Người có tổng điểm cao nhất sẽ thắng."})})]})]})})]})}),document.body)]})},b=a.memo(({count:e,isSelectable:t,isSelected:n,isHighlighted:r,onClick:i,forwardRef:a})=>s.jsxs("div",{ref:a,onClick:i,className:`\n                w-10 h-10 @md:w-16 @md:h-16 flex items-center justify-center rounded-lg border-2 relative transition-all\n                ${n?"border-yellow-400 ring-2 ring-yellow-400 bg-amber-200 z-10":t?"border-green-500 ring-2 ring-green-400/50 bg-green-50 cursor-pointer hover:bg-green-100 hover:scale-105 z-0":"border-amber-700 bg-amber-50 cursor-default opacity-90"}\n            `,children:[s.jsx(v,{count:e,isHighlighted:r}),s.jsx("div",{className:"absolute bottom-0 right-0 text-[10px] text-amber-900 p-0.5",children:e})]}),(e,t)=>e.count===t.count&&e.isSelectable===t.isSelectable&&e.isSelected===t.isSelected&&e.isHighlighted===t.isHighlighted&&e.playerOwner===t.playerOwner),y=a.memo(({count:e,forwardRef:t,left:n,isHighlighted:r})=>s.jsxs("div",{ref:t,className:`\n             w-16 h-24 @md:w-20 @md:h-32 flex flex-col items-center justify-center ${n?"rounded-l-full":"rounded-r-full"} border-2 border-amber-900\n             bg-amber-400 text-white font-bold text-xl relative shadow-inner\n        `,children:[s.jsx("div",{className:"text-white drop-shadow-md z-1",children:s.jsx(v,{count:e,isBig:!0,isHighlighted:r})}),s.jsx("div",{className:"absolute bottom-2 text-xs opacity-70 text-amber-900",children:e})]}),(e,t)=>e.count===t.count&&e.isHighlighted===t.isHighlighted&&e.left===t.left),v=a.memo(({count:e,isBig:t,isHighlighted:n})=>{const r=Math.min(e,30),i=Array.from({length:r});return s.jsx("div",{className:"flex flex-wrap justify-center items-center content-center w-full h-full p-1 gap-0.5 "+(n?"scale-110 bg-green-400/50 rounded-lg shadow-[0_0_10px_rgba(74,222,128,0.8)]":"transition-transform duration-200"),children:i.map((n,r)=>s.jsx("div",{className:`\n                    rounded-full shadow-sm border border-black/10\n                    ${t&&r<Math.floor(e/10)?"w-4 h-4 bg-red-500":"w-2 h-2 @md:w-2.5 @md:h-2.5 bg-slate-700"}\n                 `},r))})});export{f as default};
