import{t}from"./index-D69VEbX5.js";import{B as s}from"./BaseGame-CZt47sds.js";import{c as e,F as i,M as a,B as n,T as h,a as r,P as l,b as o,g as u,d as c}from"./types-BG1nVOgd.js";import"./react-vendor-BYtLKAeB.js";import"./socket-DRbsQkF5.js";import"./zustand-BLoNJECv.js";class d extends s{onFrameUpdate;animationFrameId=null;syncIntervalId=null;pocketedThisShot=[];getInitState(){return{balls:e(),players:{1:{id:this.players[0]?.id||null,username:this.players[0]?.username||null,ballType:null},2:{id:this.players[1]?.id||null,username:this.players[1]?.username||null,ballType:null}},currentTurn:1,gamePhase:"waiting",winner:null,lastShot:null,isSimulating:!1,foul:!1,turnMessage:null}}init(){super.init(),this.isHost&&(this.syncIntervalId=setInterval(()=>{this.state.isSimulating&&this.broadcastState()},5e3))}onFrame(t){this.onFrameUpdate=t}setState(t){super.setState(t),t.lastShot&&t.isSimulating&&!this.isHost&&this.runPhysicsLoop()}onSocketGameAction(t){const s=t.action;switch(s.type){case"SHOOT":this.isHost?this.handleShoot(s.angle,s.power,s.playerId):(this.state.lastShot={angle:s.angle,power:s.power,playerId:s.playerId},this.state.isSimulating=!0,this.applyShot(s.angle,s.power),this.runPhysicsLoop());break;case"RESET_GAME":this.isHost&&this.reset();break;case"START_GAME":this.isHost&&this.handleStartGame();break;case"ADD_BOT":this.isHost&&this.handleAddBot();break;case"REMOVE_BOT":this.isHost&&this.handleRemoveBot()}}handleShoot(t,s,e){if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;this.getPlayerSlot(e)===this.state.currentTurn&&(this.pocketedThisShot=[],this.state.lastShot={angle:t,power:s,playerId:e},this.state.isSimulating=!0,this.state.foul=!1,this.state.turnMessage=null,this.applyShot(t,s),this.sendSocketGameAction({type:"SHOOT",angle:t,power:s,playerId:e}),this.runPhysicsLoop())}applyShot(t,s){const e=this.state.balls.find(t=>0===t.id);if(!e||e.pocketed)return;const i=s*c;e.vx=Math.cos(t)*i,e.vy=Math.sin(t)*i}lastPhysicsTime=0;physicsAccumulator=0;PHYSICS_TIMESTEP=1e3/60;runPhysicsLoop(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.lastPhysicsTime=performance.now(),this.physicsAccumulator=0;const t=s=>{const e=s-this.lastPhysicsTime;this.lastPhysicsTime=s;const i=Math.min(e,5*this.PHYSICS_TIMESTEP);this.physicsAccumulator+=i;let a=!1,n=!1;for(;this.physicsAccumulator>=this.PHYSICS_TIMESTEP;)if(a=this.updatePhysics(),n=!0,this.physicsAccumulator-=this.PHYSICS_TIMESTEP,a){this.physicsAccumulator=0;break}this.onFrameUpdate?.(this.state.balls),n&&a?(this.animationFrameId=null,this.onSimulationEnd()):this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}PHYSICS_SUBSTEPS=8;updatePhysics(){const t=this.state.balls.filter(t=>!t.pocketed);let s=!0;const e=1/this.PHYSICS_SUBSTEPS;for(let i=0;i<this.PHYSICS_SUBSTEPS;i++){for(const s of t)s.pocketed||(s.x+=s.vx*e,s.y+=s.vy*e);for(let s=0;s<t.length;s++){const e=t[s];if(!e.pocketed)for(let i=s+1;i<t.length;i++){const s=t[i];s.pocketed||this.handleBallCollision(e,s)}}for(const s of t)s.pocketed||this.handleWallCollision(s);this.checkPockets()}for(const n of t){if(n.pocketed)continue;n.vx*=i,n.vy*=i;Math.sqrt(n.vx*n.vx+n.vy*n.vy)<a?(n.vx=0,n.vy=0):s=!1}return s}handleWallCollision(t){const s=.7;t.x-n<0&&(t.x=n,t.vx=Math.abs(t.vx)*s),t.x+n>h&&(t.x=h-n,t.vx=-Math.abs(t.vx)*s),t.y-n<0&&(t.y=n,t.vy=Math.abs(t.vy)*s),t.y+n>r&&(t.y=r-n,t.vy=-Math.abs(t.vy)*s)}handleBallCollision(t,s){const e=s.x-t.x,i=s.y-t.y,a=e*e+i*i,h=2*n,r=h*h;if(a<=1e-4){const e=Math.random()*Math.PI*2,i=n;return t.x-=Math.cos(e)*i,t.y-=Math.sin(e)*i,s.x+=Math.cos(e)*i,void(s.y+=Math.sin(e)*i)}if(a>=r)return;const l=Math.sqrt(a),o=e/l,u=i/l,c=(h-l)/2;t.x-=c*o,t.y-=c*u,s.x+=c*o,s.y+=c*u;const d=(s.vx-t.vx)*o+(s.vy-t.vy)*u;if(d>0)return;const p=-1.99*d/2;t.vx-=p*o,t.vy-=p*u,s.vx+=p*o,s.vy+=p*u}checkPockets(){for(const t of this.state.balls)if(!t.pocketed)for(const s of l){const e=t.x-s.x,i=t.y-s.y;if(Math.sqrt(e*e+i*i)<o){t.pocketed=!0,t.vx=0,t.vy=0,this.pocketedThisShot.push(t),0===t.id?this.state.foul=!0:this.assignBallType(t);break}}}assignBallType(t){if("eight"===t.type||"cue"===t.type)return;const s=this.state.players[this.state.currentTurn],e=1===this.state.currentTurn?2:1,i=this.state.players[e];s.ballType||i.ballType||(s.ballType=t.type,i.ballType="solid"===t.type?"stripe":"solid")}onSimulationEnd(){if(this.state.isSimulating=!1,!this.isHost)return void this.notifyListeners(this.state);const s=this.checkGameEnd();if(s)return this.state.gamePhase="finished",s.winner&&(this.state.winner=parseInt(s.winner)),this.syncState(),void this.broadcastGameEnd(s);this.state.foul&&(this.respawnCueBall(),this.state.turnMessage=t({en:"Foul! Cue ball pocketed.",vi:"Lỗi! Bóng trắng vào lỗ."}));this.checkContinueTurn()&&!this.state.foul||(this.state.currentTurn=1===this.state.currentTurn?2:1),this.syncState(),this.checkBotTurn()}checkContinueTurn(){const t=this.state.players[this.state.currentTurn].ballType;if(t){const s=this.pocketedThisShot.some(s=>s.type===t),e=0===this.state.balls.filter(s=>!s.pocketed&&s.type===t).length,i=this.pocketedThisShot.some(t=>8===t.id);return!(!e||!i)||s}if(this.pocketedThisShot.length>0){return this.pocketedThisShot.filter(t=>0!==t.id).length>0}return!1}respawnCueBall(){const t=this.state.balls.find(t=>0===t.id);t&&(t.pocketed=!1,t.x=.25*h,t.y=r/2,t.vx=0,t.vy=0)}checkGameEnd(){const t=this.state.balls.find(t=>8===t.id);if(!t?.pocketed)return null;const s=this.state.players[this.state.currentTurn].ballType;if(!s){return{winner:(1===this.state.currentTurn?2:1).toString()}}if(0===this.state.balls.filter(t=>!t.pocketed&&u(t.id)===s).length)return{winner:this.state.currentTurn.toString()};return{winner:(1===this.state.currentTurn?2:1).toString()}}reset(){this.stopSimulation(),this.state={...this.getInitState(),players:{1:{id:this.state.players[1].id,username:this.state.players[1].username,ballType:null},2:{id:this.state.players[2].id,username:this.state.players[2].username,ballType:null}},gamePhase:"waiting"},this.syncState()}updatePlayers(t){this.state.players[1].id=t[0]?.id||null,this.state.players[1].username=t[0]?.username||null,t[1]?(this.state.players[2].id=t[1].id,this.state.players[2].username=t[1].username):"BOT"!==this.state.players[2].id&&(this.state.players[2].id=null,this.state.players[2].username=null),this.syncState()}shoot(t,s){if(this.state.isSimulating)return;if("playing"!==this.state.gamePhase)return;const e={type:"SHOOT",angle:t,power:s,playerId:this.userId};this.isHost?this.handleShoot(t,s,this.userId):this.sendSocketGameAction(e)}requestReset(){this.isHost?this.reset():this.sendSocketGameAction({type:"RESET_GAME"})}addBot(){this.isHost&&"waiting"===this.state.gamePhase&&(this.state.players[2]={id:"BOT",username:"Bot",ballType:null},this.syncState())}removeBot(){this.isHost&&"waiting"===this.state.gamePhase&&"BOT"===this.state.players[2].id&&(this.state.players[2]={id:null,username:null,ballType:null},this.syncState())}handleAddBot(){this.addBot()}handleRemoveBot(){this.removeBot()}startGame(){this.isHost?this.handleStartGame():this.sendSocketGameAction({type:"START_GAME"})}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players[1].id&&this.state.players[2].id&&(this.state.gamePhase="playing",this.state.balls=e(),this.syncState(),this.checkBotTurn())}canStartGame(){return!!this.state.players[1].id&&!!this.state.players[2].id&&"waiting"===this.state.gamePhase}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;"BOT"===this.state.players[this.state.currentTurn].id&&setTimeout(()=>this.makeBotMove(),800)}makeBotMove(){if("playing"!==this.state.gamePhase)return;if(this.state.isSimulating)return;const t=this.state.balls.find(t=>0===t.id);if(!t||t.pocketed)return;const s=this.state.balls.filter(t=>0!==t.id&&!t.pocketed);if(0===s.length)return;const e=s[0],i=Math.atan2(e.y-t.y,e.x-t.x),a=.5+.3*Math.random();this.handleShoot(i,a,"BOT")}getPlayerSlot(t){return this.state.players[1].id===t?1:this.state.players[2].id===t?2:null}getMySlot(){return this.getPlayerSlot(this.userId)}isMyTurn(){return this.getMySlot()===this.state.currentTurn&&"playing"===this.state.gamePhase}getCueBall(){return this.state.balls.find(t=>0===t.id&&!t.pocketed)}stopSimulation(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stopSimulation(),this.syncIntervalId&&clearInterval(this.syncIntervalId),super.destroy()}}export{d as default};
