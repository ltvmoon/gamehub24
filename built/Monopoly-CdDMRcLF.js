import{B as e}from"./BaseGame-DNUNIW8N.js";import{G as t,C as s,a,S as i,P as n,L as r,T as o,B as d,b as h,c as l,M as c,J as u,d as p}from"./types-DRtpISWp.js";import{g as y}from"./index-DeW22Zn2.js";import"./socket-DRbsQkF5.js";import"./react-vendor-BeKtp5AY.js";import"./zustand-C88HNARu.js";class m extends e{isGameOver(e){return e.gamePhase===t.ENDED}chanceCards=[...s].sort(()=>Math.random()-.5);chestCards=[...a].sort(()=>Math.random()-.5);getOutOfJailCards=new Map;getInitState(){const e=[];for(let t=0;t<4;t++){const s=this.players[t];e.push({id:s?.id||null,username:s?.username||`Player ${t+1}`,color:n[t],position:0,money:i,jailTurns:0,flags:0,moneyHistory:[i]})}return{players:e,currentPlayerIndex:0,properties:[],diceValues:null,doublesCount:0,hasRolled:!1,canRollAgain:!1,gamePhase:t.WAITING,winner:null,pendingAction:null,lastAction:null,logs:{},tradeOffers:[]}}notifyAndBroadcast(){this.state.players.forEach(e=>{e.moneyHistory||(e.moneyHistory=[]),0!==e.moneyHistory.length&&e.moneyHistory[e.moneyHistory.length-1]===e.money||(e.moneyHistory.push(e.money),e.moneyHistory.length>20&&e.moneyHistory.shift())}),this.setState(this.state),this.broadcastState()}handleOfferTrade(e,t,s,a){if(!this.isHost)return;if(this.state.tradeOffers.length>=20)return this.addLog({en:"Too many active trade offers. Please cancel or reject some first.",vi:"Quá nhiều lời mời giao dịch. Vui lòng hủy hoặc từ chối bớt."},r.ALERT),void this.notifyAndBroadcast();const i=this.state.properties.find(e=>e.spaceId===s);if(!i)return;const n=i.ownerId===e,l=i.ownerId===t;if(!n&&!l)return;if(a<0)return;const c={id:Math.random().toString(36).substr(2,9),fromPlayerId:e,toPlayerId:t,propertyId:s,price:a,status:o.PENDING};this.state.tradeOffers.push(c);const u=this.state.players.find(t=>t.id===e),p=this.state.players.find(e=>e.id===t),m=d[s];n?this.addLog({en:`${u?.username} offered to sell ${y(m?.name)} to ${p?.username} for ${a}đ`,vi:`${u?.username} đề nghị bán ${y(m?.name)} cho ${p?.username} với giá ${a}đ`},r.INFO):this.addLog({en:`${u?.username} offered to buy ${y(m?.name)} from ${p?.username} for ${a}đ`,vi:`${u?.username} đề nghị mua ${y(m?.name)} từ ${p?.username} với giá ${a}đ`},r.INFO),this.notifyAndBroadcast(),p&&p.flags&h.BOT&&this.botEvaluateTrade(c)}handleRespondTrade(e,t,s){if(!this.isHost)return;const a=this.state.tradeOffers.findIndex(t=>t.id===e);if(-1===a)return;const i=this.state.tradeOffers[a],n=this.state.properties.find(e=>e.spaceId===i.propertyId),h=d[i.propertyId];if(!t||!n){i.status=o.DECLINED;const t=this.state.players.find(e=>e.id===i.toPlayerId),a=this.state.players.find(e=>e.id===i.fromPlayerId);return s&&(i.responseMessage={en:s,vi:s}),this.addLog({en:`${t?.username} declined the trade offer from ${a?.username}`,vi:`${t?.username} từ chối lời mời giao dịch từ ${a?.username}`},r.INFO),this.notifyAndBroadcast(),void setTimeout(()=>{const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&this.state.tradeOffers[t].status===o.DECLINED&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())},8e3)}{const e=n.ownerId===i.fromPlayerId,t=e?i.toPlayerId:i.fromPlayerId,s=e?i.fromPlayerId:i.toPlayerId,d=this.state.players.find(e=>e.id===t),l=this.state.players.find(e=>e.id===s);if(!d||!l)return;if(d.money<i.price)return this.addLog({en:`Trade failed: ${d.username} cannot afford ${i.price}đ`,vi:`Giao dịch thất bại: ${d.username} không đủ ${i.price}đ`},r.ALERT),this.state.tradeOffers.splice(a,1),void this.notifyAndBroadcast();d.money-=i.price,l.money+=i.price,n.ownerId=d.id,i.status=o.ACCEPTED,this.addLog({en:`Trade successful! ${d.username} bought ${y(h?.name)} from ${l.username} for ${i.price}đ`,vi:`Giao dịch thành công! ${d.username} mua ${y(h?.name)} từ ${l.username} giá ${i.price}đ`},r.ACTION)}this.state.tradeOffers.splice(a,1),this.notifyAndBroadcast()}handleCancelTrade(e){if(!this.isHost)return;const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())}botEvaluateTrade(e){setTimeout(()=>{const t=this.state.tradeOffers.find(t=>t.id===e.id);if(!t||t.status!==o.PENDING)return;const s=this.state.players.find(e=>e.id===t.toPlayerId);if(!(s&&s.flags&h.BOT))return;const a=d[t.propertyId];if(!a)return;const i=this.state.properties.find(e=>e.spaceId===t.propertyId),n=i?.ownerId===s.id;let c=0;a.type!==l.PROPERTY&&a.type!==l.RAILROAD&&a.type!==l.UTILITY||(c=a.price);const u=d.filter(e=>e.type===l.PROPERTY&&a.type===l.PROPERTY&&e.color===a.color),p=this.state.properties.filter(e=>e.ownerId===s.id&&u.some(t=>t.id===e.spaceId)).length;u.length>0&&(p>=u.length-1?c*=2.5:p>0&&(c*=1.5));if(n){const e=1.2*c;this.addLog({en:`${s.username} thinks ${y(a?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${y(a?.name)} đáng giá ${e}đ`},r.INFO),t.price>=e?this.handleRespondTrade(t.id,!0):(t.responseMessage={en:`I want at least ${e.toLocaleString()}đ`,vi:`Tôi muốn ít nhất ${e.toLocaleString()}đ`},this.handleRespondTrade(t.id,!1))}else{const e=1*c,i=s.money>=t.price,n=t.price<=e;this.addLog({en:`${s.username} thinks ${y(a?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${y(a?.name)} đáng giá ${e}đ`},r.INFO),i&&n?this.handleRespondTrade(t.id,!0):(t.responseMessage=i?{en:`I only pay up to ${e.toLocaleString()}đ`,vi:`Tôi chỉ trả tối đa ${e.toLocaleString()}đ`}:{en:"I don't have enough money",vi:"Tôi không đủ tiền"},this.handleRespondTrade(t.id,!1))}},2e3)}handleSellHouse(e,t){if(!this.isHost)return;const s=d[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||a.houses<=0||s.type!==l.PROPERTY||!s.houseCost)return;a.houses--;const i=Math.floor(.5*s.houseCost),n=this.state.players.find(t=>t.id===e);n&&(n.money+=i,this.addLog({en:`${n.username} sold a house on ${y(s?.name)} for ${i}đ`,vi:`${n.username} bán 1 nhà trên ${y(s?.name)} được ${i}đ`},r.ACTION)),this.notifyAndBroadcast()}handleMortgage(e,t){if(!this.isHost)return;const s=d[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||a.mortgaged||a.houses>0||s.type!==l.PROPERTY&&s.type!==l.RAILROAD&&s.type!==l.UTILITY)return;const i=Math.floor(.5*s.price);a.mortgaged=!0;const n=this.state.players.find(t=>t.id===e);n&&(n.money+=i,this.addLog({en:`${n.username} mortgaged ${y(s?.name)} for ${i}đ`,vi:`${n.username} thế chấp ${y(s?.name)} được ${i}đ`},r.ACTION)),this.notifyAndBroadcast()}handleUnmortgage(e,t){if(!this.isHost)return;const s=d[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||!a.mortgaged||s.type!==l.PROPERTY&&s.type!==l.RAILROAD&&s.type!==l.UTILITY)return;const i=Math.floor(.5*s.price),n=i+Math.floor(.1*i),o=this.state.players.find(t=>t.id===e);!o||o.money<n||(o.money-=n,a.mortgaged=!1,this.addLog({en:`${o.username} unmortgaged ${y(s?.name)} for ${n}đ`,vi:`${o.username} chuộc ${y(s?.name)} giá ${n}đ`},r.ACTION),this.notifyAndBroadcast())}onSocketGameAction(e){const t=e.action;switch(t.type){case"START_GAME":this.handleStartGame();break;case"ROLL_DICE":this.handleRollDice(t.playerId);break;case"BUY_PROPERTY":this.handleBuyProperty(t.playerId,t.spaceId);break;case"DECLINE_PROPERTY":this.handleDeclineProperty(t.playerId);break;case"BUILD_HOUSE":this.handleBuildHouse(t.playerId,t.spaceId);break;case"PAY_RENT":this.handlePayRent(t.playerId);break;case"PAY_TAX":this.handlePayTax(t.playerId);break;case"USE_CARD":this.handleUseCard(t.playerId);break;case"PAY_JAIL_FINE":this.handlePayJailFine(t.playerId);break;case"END_TURN":this.handleEndTurn(t.playerId);break;case"ADD_BOT":this.handleAddBot(t.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(t.slotIndex);break;case"OFFER_TRADE":this.handleOfferTrade(t.fromPlayerId,t.toPlayerId,t.spaceId,t.price);break;case"RESPOND_TRADE":this.handleRespondTrade(t.offerId,t.accepted,t.message);break;case"CANCEL_TRADE":this.handleCancelTrade(t.offerId);break;case"SELL_HOUSE":this.handleSellHouse(t.playerId,t.spaceId);break;case"MORTGAGE":this.handleMortgage(t.playerId,t.spaceId);break;case"UNMORTGAGE":this.handleUnmortgage(t.playerId,t.spaceId);break;case"RESET_GAME":this.reset()}}addLog(e,t=r.INFO){const s={id:Math.random().toString(36).substr(2,9),message:e,type:t,timestamp:Date.now()};this.state.logs[s.id]=s;const a=Object.keys(this.state.logs);if(a.length>30){const e=a.sort((e,t)=>(this.state.logs[e]?.timestamp||0)-(this.state.logs[t]?.timestamp||0)),t=a.length-30;for(let s=0;s<t;s++)delete this.state.logs[e[s]]}this.state.lastAction=e}handleStartGame(){if(!this.isHost)return;if(this.state.gamePhase!==t.WAITING)return;this.state.players.filter(e=>null!==e.id).length<2||(this.state.gamePhase=t.PLAYING,this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.lastAction={en:"Game started!",vi:"Trò chơi bắt đầu!"},this.state.logs={},this.addLog({en:"Game started!",vi:"Trò chơi bắt đầu!"},r.INFO),this.notifyAndBroadcast(),this.checkBotTurn())}findFirstActivePlayer(){for(let e=0;e<this.state.players.length;e++)if(this.state.players[e].id&&!(this.state.players[e].flags&h.BANKRUPT))return e;return 0}handleRollDice(e){if(!this.isHost)return;if(this.state.gamePhase!==t.PLAYING)return;const s=this.state.players[this.state.currentPlayerIndex];if(!s||s.id!==e)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;if(this.state.pendingAction)return;const a=Math.floor(6*Math.random())+1,i=Math.floor(6*Math.random())+1;this.state.diceValues=[a,i],this.state.hasRolled=!0,this.addLog({en:"Rolling...",vi:"Đang đổ xí ngầu..."},r.INFO),this.notifyAndBroadcast(),setTimeout(()=>{this.processDiceResult(e,a,i)},1200)}processDiceResult(e,t,s){const a=this.state.players.find(t=>t.id===e);if(!a)return;const i=t+s,n=t===s;if(n){if(this.state.doublesCount++,this.state.doublesCount>=3)return this.sendToJail(a),this.addLog({en:`${a.username} rolled 3 doubles, goes to jail!`,vi:`${a.username} đổ 3 lần đôi, phải vào tù!`},r.ALERT),this.endTurn(),void this.notifyAndBroadcast();this.state.canRollAgain=!0}else this.state.canRollAgain=!1;a.flags&h.IN_JAIL?n?(a.flags&=-2,a.jailTurns=0,this.addLog({en:`${a.username} rolled doubles and escapes jail!`,vi:`${a.username} đổ đôi và được ra tù!`},r.ACTION),this.movePlayer(a,i)):(a.jailTurns++,a.jailTurns>=c?(a.money-=u,a.flags&=-2,a.jailTurns=0,this.addLog({en:`${a.username} paid ${u}đ and leaves jail`,vi:`${a.username} trả ${u}đ để ra tù`},r.ACTION),this.movePlayer(a,i)):(this.state.lastAction={en:`${a.username} stays in jail (turn ${a.jailTurns}/${c})`,vi:`${a.username} ở trong tù (lượt ${a.jailTurns}/${c})`},this.state.canRollAgain=!1)):this.movePlayer(a,i),this.notifyAndBroadcast(),this.state.pendingAction||this.checkBotTurn()}movePlayer(e,t){const s=e.position,a=(e.position+t)%40;a<s&&t>0&&(e.money+=p,this.addLog({en:`${e.username} passed GO, collects ${p}đ`,vi:`${e.username} đi qua KHỞI HÀNH, nhận ${p}đ`},r.INFO)),e.position=a,this.handleLanding(e)}handleLanding(e){const t=d[e.position];if(t)switch(t.type){case l.GO:this.addLog({en:`${e.username} landed on GO`,vi:`${e.username} vào ô KHỞI HÀNH`},r.INFO);break;case l.PROPERTY:case l.RAILROAD:case l.UTILITY:this.handlePropertyLanding(e,t.id);break;case l.TAX:{const s=t;this.state.pendingAction={type:"PAY_TAX",amount:s.taxAmount||0},this.addLog({en:`${e.username} must pay ${s.taxAmount}đ tax`,vi:`${e.username} phải nộp thuế ${s.taxAmount}đ`},r.ALERT)}break;case l.CHANCE:this.drawCard(e,"chance");break;case l.CHEST:this.drawCard(e,"chest");break;case l.JAIL:this.addLog({en:`${e.username} is just visiting jail`,vi:`${e.username} thăm nuôi tù`},r.INFO);break;case l.PARKING:this.addLog({en:`${e.username} landed on Free Parking`,vi:`${e.username} vào Bãi Đỗ Xe`},r.INFO);break;case l.GOTOJAIL:this.sendToJail(e),this.addLog({en:`${e.username} goes to jail!`,vi:`${e.username} vào tù!`},r.ALERT)}}handlePropertyLanding(e,t){const s=d[t],a=this.state.properties.find(e=>e.spaceId===t);if(a)if(a.ownerId!==e.id)if(a.mortgaged)this.addLog({en:`${e.username} landed on ${y(s.name)} which is mortgaged. No rent!`,vi:`${e.username} vào ${y(s.name)} đang thế chấp. Không cần trả tiền thuê!`},r.INFO);else{const s=this.calculateRent(t,a),i=this.state.players.find(e=>e.id===a.ownerId);!i||i.flags&h.BANKRUPT||(this.state.pendingAction={type:"PAY_RENT",amount:s,toPlayerId:a.ownerId},this.addLog({en:`${e.username} owes ${s}đ rent to ${i.username}`,vi:`${e.username} trả ${s}đ tiền thuê cho ${i.username}`},r.ALERT))}else this.addLog({en:`${e.username} landed on their own property`,vi:`${e.username} vào nhà mình`},r.INFO);else(s.type===l.PROPERTY||s.type===l.RAILROAD||s.type===l.UTILITY)&&s.price&&e.money>=s.price?(this.state.pendingAction={type:"BUY_DECISION",spaceId:t},this.addLog({en:`${e.username} can buy ${y(s?.name)} for ${s.price}đ`,vi:`${e.username} có thể mua ${y(s?.name)} giá ${s.price}đ`},r.ACTION)):this.addLog({en:`${e.username} cannot afford ${y(s?.name)}`,vi:`${e.username} không đủ tiền mua ${y(s?.name)}`},r.ALERT)}calculateRent(e,t){const s=d[e];if(!s)return 0;if(s.type===l.RAILROAD){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&d[e.spaceId]?.type===l.RAILROAD).length;return(s.baseRent||250)*e}if(s.type===l.UTILITY){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&d[e.spaceId]?.type===l.UTILITY).length,a=(this.state.diceValues?.[0]||1)+(this.state.diceValues?.[1]||1);return s.baseRent+(2===e?10*a:4*a)}if(s.type!==l.PROPERTY||!s.rent)return 0;const a=d.filter(e=>e.type===l.PROPERTY&&e.color===s.color),i=a.filter(e=>this.state.properties.some(s=>s.spaceId===e.id&&s.ownerId===t.ownerId)).length===a.length,n=t.houses;return n>0&&n<=5?s.rent[n]:i?2*s.rent[0]:s.rent[0]}drawCard(e,t){const s="chance"===t?this.chanceCards:this.chestCards,a=s.shift();a&&("GET_OUT_JAIL"!==a.action.type&&s.push(a),this.state.pendingAction={type:"CARD",cardId:a.id},this.addLog({en:`${e.username} draws: ${y(a.text)}`,vi:`${e.username} rút thẻ: ${y(a.text)}`},r.ACTION))}sendToJail(e){e.position=10,e.flags|=h.IN_JAIL,e.jailTurns=0,this.state.canRollAgain=!1}handleBuyProperty(e,t){if(!this.isHost)return;const s=this.state.players[this.state.currentPlayerIndex];if(!s||s.id!==e)return;const a=this.state.pendingAction;if(!a||"BUY_DECISION"!==a.type||a.spaceId!==t)return;const i=d[t];!i||i.type!==l.PROPERTY&&i.type!==l.RAILROAD&&i.type!==l.UTILITY||s.money<i.price||(s.money-=i.price,this.state.properties.push({spaceId:t,ownerId:s.id,houses:0,mortgaged:!1}),this.state.pendingAction=null,this.addLog({en:`${s.username} bought ${y(i?.name)} for ${i.price}đ`,vi:`${s.username} đã mua ${y(i?.name)} với giá ${i.price}đ`},r.ACTION),this.notifyAndBroadcast(),this.checkBotTurn())}handleDeclineProperty(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;if(!this.state.pendingAction||"BUY_DECISION"!==this.state.pendingAction.type)return;const s=d[this.state.pendingAction.spaceId];this.state.pendingAction=null,this.addLog({en:`${t.username} declined to buy ${y(s?.name)}`,vi:`${t.username} không mua ${y(s?.name)}`},r.INFO),this.notifyAndBroadcast(),this.checkBotTurn()}canBuildHouse(e,t){const s=this.state.players.find(t=>t.id===e);if(!s)return{allowed:!1,reason:{en:"Player not found",vi:"Không tìm thấy người chơi"}};const a=d[t],i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!a||!i||a.type!==l.PROPERTY||!a.houseCost)return{allowed:!1,reason:{en:"Cannot build here",vi:"Không thể xây ở đây"}};if(i.houses>=5)return{allowed:!1,reason:{en:"Max level reached",vi:"Đã đạt cấp tối đa"}};if(s.money<a.houseCost)return{allowed:!1,reason:{en:"Not enough money",vi:"Không đủ tiền"}};if(i.mortgaged)return{allowed:!1,reason:{en:"Property is mortgaged",vi:"Tài sản đang thế chấp"}};const n=d.filter(e=>e.type===l.PROPERTY&&e.color===a.color),r=this.state.properties.filter(t=>n.some(e=>e.id===t.spaceId)&&t.ownerId===e);if(r.length!==n.length)return{allowed:!1,reason:{en:"Must own full color set",vi:"Phải sở hữu đủ bộ màu"}};const o=Math.min(...r.map(e=>e.houses));return i.houses>o?{allowed:!1,reason:{en:"Must build evenly",vi:"Phải xây đều các ô"}}:{allowed:!0}}handleBuildHouse(e,t){if(!this.isHost)return;if(!this.canBuildHouse(e,t).allowed)return;const s=this.state.players.find(t=>t.id===e),a=d[t];if(a.type!==l.PROPERTY||!a.houseCost)return;const i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);s.money-=a.houseCost,i.houses++;const n=5===i.houses?"hotel":"house",o=5===i.houses?"khách sạn":"nhà";this.addLog({en:`${s.username} built a ${n} on ${y(a?.name)}`,vi:`${s.username} xây ${o} trên ${y(a?.name)}`},r.ACTION),this.notifyAndBroadcast()}handlePayRent(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;if(!s||"PAY_RENT"!==s.type)return;const a=this.state.players.find(e=>e.id===s.toPlayerId);a&&(t.money>=s.amount?(t.money-=s.amount,a.money+=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ rent to ${a.username}`,vi:`${t.username} trả ${s.amount}đ thuê cho ${a.username}`},r.ACTION)):this.handleBankruptcy(t,a),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handlePayTax(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;s&&"PAY_TAX"===s.type&&(t.money>=s.amount?(t.money-=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ tax`,vi:`${t.username} đóng thuế ${s.amount}đ`},r.ACTION)):this.handleBankruptcy(t,null),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handleUseCard(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const i=this.state.pendingAction;if(!i||"CARD"!==i.type)return;const n=[...s,...a].find(e=>e.id===i.cardId);if(this.state.pendingAction=null,n){switch(n.action.type){case"COLLECT":t.money+=n.action.amount;break;case"PAY":t.money>=n.action.amount?t.money-=n.action.amount:this.handleBankruptcy(t,null);break;case"MOVE":const e=t.position;t.position=n.action.position,t.position<e&&(t.money+=p),this.handleLanding(t);break;case"MOVE_RELATIVE":const s=(t.position+n.action.spaces+40)%40;t.position=s,this.handleLanding(t);break;case"GO_TO_JAIL":this.sendToJail(t);break;case"GET_OUT_JAIL":const a=this.getOutOfJailCards.get(t.id)||0;this.getOutOfJailCards.set(t.id,a+1);break;case"PAY_EACH_PLAYER":{const e=this.state.players.filter(e=>e.id&&!(e.flags&h.BANKRUPT)&&e.id!==t.id),s=n.action.amount,a=s*e.length;t.money>=a&&(t.money-=a,e.forEach(e=>e.money+=s));break}case"COLLECT_FROM_EACH":{const e=this.state.players.filter(e=>e.id&&!(e.flags&h.BANKRUPT)&&e.id!==t.id),s=n.action.amount;e.forEach(e=>{e.money>=s&&(e.money-=s,t.money+=s)});break}case"REPAIRS":{const e=this.state.properties.filter(e=>e.ownerId===t.id),s=n.action.perHouse,a=n.action.perHotel;let i=0;e.forEach(e=>{5===e.houses?i+=a:i+=e.houses*s}),t.money>=i?t.money-=i:this.handleBankruptcy(t,null);break}}this.addLog({en:`${t.username}: ${y(n.text)}`,vi:`${t.username}: ${y(n.text)}`},r.INFO),this.notifyAndBroadcast(),this.checkBotTurn()}}handlePayJailFine(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!(t&&t.id===e&&t.flags&h.IN_JAIL))return;const s=this.getOutOfJailCards.get(e)||0;s>0?(this.getOutOfJailCards.set(e,s-1),t.flags&=-2,t.jailTurns=0,this.addLog({en:`${t.username} used Get Out of Jail Free card`,vi:`${t.username} dùng thẻ Ra tù miễn phí`},r.ACTION)):t.money>=u&&(t.money-=u,t.flags&=-2,t.jailTurns=0,this.addLog({en:`${t.username} paid ${u}đ to leave jail`,vi:`${t.username} trả ${u}đ để ra tù`},r.ACTION)),this.notifyAndBroadcast()}handleBankruptcy(e,s){e.flags|=h.BANKRUPT,this.addLog({en:`${e.username} is bankrupt!`,vi:`${e.username} phá sản!`},r.ALERT),this.state.properties=this.state.properties.map(t=>t.ownerId===e.id?s?{...t,ownerId:s.id,houses:0}:null:t).filter(Boolean),s&&e.money>0&&(s.money+=e.money),e.money=0;const a=this.state.players.filter(e=>e.id&&!(e.flags&h.BANKRUPT));if(1===a.length)this.state.gamePhase=t.ENDED,this.state.winner=a[0].id,this.addLog({en:`${a[0].username} wins!`,vi:`${a[0].username} chiến thắng!`},r.ALERT);else{const t=this.state.players[this.state.currentPlayerIndex];t?.id===e.id&&this.endTurn()}}handleEndTurn(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];t&&t.id===e&&(this.state.pendingAction||this.state.hasRolled&&(!this.state.canRollAgain||t.flags&h.IN_JAIL)&&this.endTurn())}endTurn(){this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.doublesCount=0,this.state.diceValues=null,this.state.pendingAction=null;let e=(this.state.currentPlayerIndex+1)%4,t=0;for(;t<4;){const s=this.state.players[e];if(s&&s.id&&!(s.flags&h.BANKRUPT))break;e=(e+1)%4,t++}this.state.currentPlayerIndex=e;const s=this.state.players[e];this.addLog({en:`${s?.username}'s turn`,vi:`Lượt của ${s?.username}`},r.INFO),this.notifyAndBroadcast(),this.checkBotTurn()}handleAddBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(this.state.players[e].id)return;const t=`bot-${e}-${Date.now()}`,s=[...this.state.players];s[e]={...s[e],id:t,username:`Bot ${e+1}`,flags:s[e].flags|h.BOT},this.state.players=s,this.notifyAndBroadcast()}handleRemoveBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(!(this.state.players[e].flags&h.BOT))return;const t=[...this.state.players];t[e]={...t[e],id:null,username:`Player ${e+1}`,flags:-5&t[e].flags},this.state.players=t,this.notifyAndBroadcast()}checkBotTurn(){if(!this.isHost)return;if(this.state.gamePhase!==t.PLAYING)return;const e=this.state.players[this.state.currentPlayerIndex];e?.flags&h.BOT&&(e.flags&h.BANKRUPT?this.endTurn():setTimeout(()=>this.executeBotTurn(e),1e3))}executeBotTurn(e){if(!this.isHost||this.state.gamePhase!==t.PLAYING)return;const i=this.state.players.find(t=>t.id===e.id);if(!i||i.flags&h.BANKRUPT)return;const n=e=>{let t=i.money;if(t>=e)return;const s=this.state.properties.filter(e=>e.ownerId===i.id),a=s.filter(e=>e.houses>0);for(const n of a){if(t>=e)break;for(;n.houses>0&&t<e;){const e=d[n.spaceId];this.handleSellHouse(i.id,n.spaceId),t+=e.type===l.PROPERTY&&e.houseCost?e.houseCost/2:0}}if(t<e){const a=s.filter(e=>!e.mortgaged&&0===e.houses);a.sort((e,t)=>{const s=d[e.spaceId],a=d[t.spaceId],i=s.type!==l.PROPERTY&&s.type!==l.RAILROAD&&s.type!==l.UTILITY||!s.price?0:s.price;return(a.type!==l.PROPERTY&&a.type!==l.RAILROAD&&a.type!==l.UTILITY||!a.price?0:a.price)-i});for(const s of a){if(t>=e)break;const a=d[s.spaceId];this.handleMortgage(i.id,s.spaceId),t+=a.type!==l.PROPERTY&&a.type!==l.RAILROAD&&a.type!==l.UTILITY||!a.price?0:a.price/2}}};if(this.state.pendingAction)switch(this.state.pendingAction.type){case"BUY_DECISION":const e=d[this.state.pendingAction.spaceId],t=1e3;return void((e.type===l.PROPERTY||e.type===l.RAILROAD||e.type===l.UTILITY)&&e.price&&i.money>=e.price+t?this.handleBuyProperty(i.id,this.state.pendingAction.spaceId):this.handleDeclineProperty(i.id));case"PAY_RENT":return n(this.state.pendingAction.amount),void this.handlePayRent(i.id);case"PAY_TAX":return n(this.state.pendingAction.amount),void this.handlePayTax(i.id);case"CARD":{const e=[...s,...a].find(e=>e.id===this.state.pendingAction.cardId);if(!e)return void this.handleUseCard(i.id);if("PAY"===e.action.type)n(e.action.amount);else if("PAY_EACH_PLAYER"===e.action.type){const t=this.state.players.filter(e=>e.id&&!(e.flags&h.BANKRUPT)&&e.id!==i.id).length;n(e.action.amount*t)}this.handleUseCard(i.id)}return}if(i.flags&h.IN_JAIL&&i.money>=u+500&&!this.state.hasRolled)return this.handlePayJailFine(i.id),void setTimeout(()=>this.executeBotTurn(i),500);if(!this.state.hasRolled||this.state.canRollAgain)return this.handleRollDice(i.id),void setTimeout(()=>this.executeBotTurn(i),1500);const r=this.state.properties.filter(e=>e.ownerId===i.id);for(const t of r){const e=d[t.spaceId];if(e&&e.type===l.PROPERTY&&e.houseCost&&void 0!==e.color&&t.houses<5&&!t.mortgaged){const s=d.filter(t=>t.type===l.PROPERTY&&t.color===e.color),a=r.filter(e=>s.some(t=>t.id===e.spaceId)),n=this.canBuildHouse(i.id,t.spaceId);if(a.length===s.length&&e.type===l.PROPERTY&&e.houseCost&&i.money>=e.houseCost+3e3&&n.allowed)return this.handleBuildHouse(i.id,t.spaceId),void setTimeout(()=>this.executeBotTurn(i),500)}}this.state.pendingAction||this.state.canRollAgain||this.handleEndTurn(i.id)}requestRollDice(){this.makeAction({type:"ROLL_DICE",playerId:this.userId})}requestBuyProperty(e){this.makeAction({type:"BUY_PROPERTY",playerId:this.userId,spaceId:e})}requestDeclineProperty(){this.makeAction({type:"DECLINE_PROPERTY",playerId:this.userId})}requestBuildHouse(e){this.makeAction({type:"BUILD_HOUSE",playerId:this.userId,spaceId:e})}requestPayRent(){this.makeAction({type:"PAY_RENT",playerId:this.userId})}requestPayTax(){this.makeAction({type:"PAY_TAX",playerId:this.userId})}requestUseCard(){this.makeAction({type:"USE_CARD",playerId:this.userId})}requestPayJailFine(){this.makeAction({type:"PAY_JAIL_FINE",playerId:this.userId})}requestEndTurn(){this.makeAction({type:"END_TURN",playerId:this.userId})}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(e){this.makeAction({type:"ADD_BOT",slotIndex:e})}requestRemoveBot(e){this.makeAction({type:"REMOVE_BOT",slotIndex:e})}requestOfferTrade(e,t,s){this.makeAction({type:"OFFER_TRADE",fromPlayerId:this.userId,toPlayerId:e,spaceId:t,price:s})}requestRespondTrade(e,t,s){this.makeAction({type:"RESPOND_TRADE",offerId:e,accepted:t,message:s})}requestResetGame(){this.isHost&&this.makeAction({type:"RESET_GAME"})}requestCancelTrade(e){this.makeAction({type:"CANCEL_TRADE",offerId:e})}requestSellHouse(e){this.makeAction({type:"SELL_HOUSE",playerId:this.userId,spaceId:e})}requestMortgage(e){this.makeAction({type:"MORTGAGE",playerId:this.userId,spaceId:e})}requestUnmortgage(e){this.makeAction({type:"UNMORTGAGE",playerId:this.userId,spaceId:e})}reset(){this.state.players.forEach(e=>{e.id&&(e.position=0,e.money=i,e.flags=e.flags&h.BOT,e.jailTurns=0,e.moneyHistory=[i])}),this.state.properties=[],this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValues=null,this.state.doublesCount=0,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.gamePhase=t.WAITING,this.state.winner=null,this.state.pendingAction=null,this.state.logs={},this.addLog({en:"Game reset!",vi:"Trò chơi được đặt lại!"},r.INFO),this.getOutOfJailCards.clear(),this.chanceCards=[...s].sort(()=>Math.random()-.5),this.chestCards=[...a].sort(()=>Math.random()-.5),this.notifyAndBroadcast()}updatePlayers(e){this.state.players.forEach((e,t)=>{e.flags&h.BOT||(e.id=null,e.username=`Player ${t+1}`)});let t=0;for(let s=0;s<4&&!(t>=e.length);s++)this.state.players[s].flags&h.BOT||(this.state.players[s].id=e[t].id,this.state.players[s].username=e[t].username,t++)}getMyPlayerIndex(){return this.state.players.findIndex(e=>e.id===this.userId)}canStartGame(){return this.state.players.filter(e=>null!==e.id).length>=2}getPlayerProperties(e){return this.state.properties.filter(t=>t.ownerId===e)}}export{m as default};
