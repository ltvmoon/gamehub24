import{S as t,f as s,t as e}from"./index-7ewwbQld.js";import{B as a}from"./BaseGame-D8z93T-B.js";import{G as i,c as n,F as h,M as r,B as l,T as o,a as u,P as c,b as y,d as p,g as d,e as m}from"./types-B48lfkkO.js";import"./react-vendor-BLBa7-IT.js";import"./socket-DRbsQkF5.js";import"./zustand-BEg5S8SY.js";class S extends a{isGameOver(t){return t.gamePhase===i.FINISHED}onFrameUpdate;animationFrameId=null;syncIntervalId=null;pocketedThisShot=[];getInitState(){return{balls:n(),players:{1:{id:this.players[0]?.id||null,username:this.players[0]?.username||null,ballType:null},2:{id:this.players[1]?.id||null,username:this.players[1]?.username||null,ballType:null}},currentTurn:1,gamePhase:i.WAITING,winner:null,lastShot:null,isSimulating:!1,foul:!1,turnMessage:null}}init(){super.init(),this.autoBroadcast=!1,this.isHost&&(this.syncIntervalId=setInterval(()=>{this.state.isSimulating&&(this.roundBalls(),this.broadcastState(!0))},1e4))}onFrame(t){this.onFrameUpdate=t}setState(t){return super.setState(t),t.lastShot&&t.isSimulating&&!this.isHost&&this.runPhysicsLoop(),this.state}onSocketGameAction(t){const s=t.action;switch(s.type){case"SHOOT":this.isHost?this.handleShoot(s.angle,s.power,s.playerId):(this.state.lastShot={angle:s.angle,power:s.power,playerId:s.playerId},this.state.isSimulating=!0,this.applyShot(s.angle,s.power),this.onStateUpdate(this.state),this.runPhysicsLoop());break;case"RESET_GAME":this.reset();break;case"START_GAME":this.handleStartGame();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot()}}handleShoot(t,s,e){if(this.state.gamePhase!==i.PLAYING)return;if(this.state.isSimulating)return;this.getPlayerSlot(e)===this.state.currentTurn&&(this.pocketedThisShot=[],this.state.lastShot={angle:t,power:s,playerId:e},this.state.isSimulating=!0,this.state.foul=!1,this.state.turnMessage=null,this.onStateUpdate(this.state),this.applyShot(t,s),this.sendSocketGameAction({type:"SHOOT",angle:t,power:s,playerId:e}),this.runPhysicsLoop())}applyShot(e,a){const i=this.state.balls.find(t=>0===t.id);if(!i||i.pocketed)return;const n=a*m;i.vx=Math.cos(e)*n,i.vy=Math.sin(e)*n,t.play(s.SOFT_SHOT)}lastPhysicsTime=0;physicsAccumulator=0;PHYSICS_TIMESTEP=1e3/60;runPhysicsLoop(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.lastPhysicsTime=performance.now(),this.physicsAccumulator=0;const t=s=>{const e=s-this.lastPhysicsTime;this.lastPhysicsTime=s;const a=Math.min(e,5*this.PHYSICS_TIMESTEP);this.physicsAccumulator+=a;let i=!1,n=!1;for(;this.physicsAccumulator>=this.PHYSICS_TIMESTEP;)if(i=this.updatePhysics(),n=!0,this.physicsAccumulator-=this.PHYSICS_TIMESTEP,i){this.physicsAccumulator=0;break}this.onFrameUpdate?.(this.state.balls),n&&i?(this.animationFrameId=null,this.onSimulationEnd()):this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}PHYSICS_SUBSTEPS=8;updatePhysics(){const t=this.state.balls.filter(t=>!t.pocketed);let s=!0;const e=1/this.PHYSICS_SUBSTEPS;for(let a=0;a<this.PHYSICS_SUBSTEPS;a++){for(const s of t)s.pocketed||(s.x+=s.vx*e,s.y+=s.vy*e);for(let s=0;s<t.length;s++){const e=t[s];if(!e.pocketed)for(let a=s+1;a<t.length;a++){const s=t[a];s.pocketed||this.handleBallCollision(e,s)}}for(const s of t)s.pocketed||this.handleWallCollision(s);this.checkPockets()}for(const a of t){if(a.pocketed)continue;a.vx*=h,a.vy*=h;Math.sqrt(a.vx*a.vx+a.vy*a.vy)<r?(a.vx=0,a.vy=0):s=!1}return s}handleWallCollision(t){const s=.7;t.x-l<0&&(t.x=l,t.vx=Math.abs(t.vx)*s),t.x+l>o&&(t.x=o-l,t.vx=-Math.abs(t.vx)*s),t.y-l<0&&(t.y=l,t.vy=Math.abs(t.vy)*s),t.y+l>u&&(t.y=u-l,t.vy=-Math.abs(t.vy)*s)}handleBallCollision(t,s){const e=s.x-t.x,a=s.y-t.y,i=e*e+a*a,n=2*l,h=n*n;if(i<=1e-4){const e=Math.random()*Math.PI*2,a=l;return t.x-=Math.cos(e)*a,t.y-=Math.sin(e)*a,s.x+=Math.cos(e)*a,void(s.y+=Math.sin(e)*a)}if(i>=h)return;const r=Math.sqrt(i),o=e/r,u=a/r,c=(n-r)/2;t.x-=c*o,t.y-=c*u,s.x+=c*o,s.y+=c*u;const y=(s.vx-t.vx)*o+(s.vy-t.vy)*u;if(y>0)return;const p=-1.99*y/2;t.vx-=p*o,t.vy-=p*u,s.vx+=p*o,s.vy+=p*u}checkPockets(){for(const e of this.state.balls)if(!e.pocketed)for(const a of c){const i=e.x-a.x,n=e.y-a.y;if(Math.sqrt(i*i+n*n)<y){e.pocketed=!0,e.vx=0,e.vy=0,t.play(s.EAT),this.pocketedThisShot.push(e),0===e.id?this.state.foul=!0:this.assignBallType(e);break}}}assignBallType(t){if(t.type===p.EIGHT||t.type===p.CUE)return;const s=this.state.players[this.state.currentTurn],e=1===this.state.currentTurn?2:1,a=this.state.players[e];s.ballType||a.ballType||(s.ballType=t.type,a.ballType=t.type===p.SOLID?p.STRIPE:p.SOLID)}onSimulationEnd(){if(this.state.isSimulating=!1,this.onStateUpdate(this.state),t.play(s.NOTIFY),!this.isHost)return;const a=this.checkGameEnd();if(a)return this.state.gamePhase=i.FINISHED,a.winner&&(this.state.winner=parseInt(a.winner)),this.syncState(),void this.clearSavedState();this.state.foul&&(this.respawnCueBall(),this.state.turnMessage=e({en:"Foul! Cue ball pocketed.",vi:"Lỗi! Bóng trắng vào lỗ."}));this.checkContinueTurn()&&!this.state.foul||(this.state.currentTurn=1===this.state.currentTurn?2:1),this.roundBalls(),this.syncState(),this.checkBotTurn()}roundBalls(){const t=t=>Math.round(100*t)/100;for(const s of this.state.balls)s.x=t(s.x),s.y=t(s.y),s.vx=t(s.vx),s.vy=t(s.vy)}checkContinueTurn(){const t=this.state.players[this.state.currentTurn].ballType;if(t){const s=this.pocketedThisShot.some(s=>s.type===t),e=0===this.state.balls.filter(s=>!s.pocketed&&s.type===t).length,a=this.pocketedThisShot.some(t=>8===t.id);return!(!e||!a)||s}if(this.pocketedThisShot.length>0){return this.pocketedThisShot.filter(t=>0!==t.id).length>0}return!1}respawnCueBall(){const t=this.state.balls.find(t=>0===t.id);t&&(t.pocketed=!1,t.x=.25*o,t.y=u/2,t.vx=0,t.vy=0)}checkGameEnd(){const t=this.state.balls.find(t=>8===t.id);if(!t?.pocketed)return null;const s=this.state.players[this.state.currentTurn].ballType;if(!s){return{winner:(1===this.state.currentTurn?2:1).toString()}}if(0===this.state.balls.filter(t=>!t.pocketed&&d(t.id)===s).length)return{winner:this.state.currentTurn.toString()};return{winner:(1===this.state.currentTurn?2:1).toString()}}reset(){this.stopSimulation();const t=this.getInitState();this.state.balls=t.balls,this.state.players[1].ballType=null,this.state.players[2].ballType=null,this.state.currentTurn=t.currentTurn,this.state.gamePhase=i.WAITING,this.state.winner=null,this.state.lastShot=null,this.state.isSimulating=!1,this.state.foul=!1,this.state.turnMessage=null,this.syncState()}updatePlayers(t){this.state.players[1].id=t[0]?.id||null,this.state.players[1].username=t[0]?.username||null,t[1]?(this.state.players[2].id=t[1].id,this.state.players[2].username=t[1].username):"BOT"!==this.state.players[2].id&&(this.state.players[2].id=null,this.state.players[2].username=null),this.syncState()}shoot(t,s){if(this.state.isSimulating)return;if(this.state.gamePhase!==i.PLAYING)return;const e={type:"SHOOT",angle:t,power:s,playerId:this.userId};this.isHost?this.handleShoot(t,s,this.userId):this.sendSocketGameAction(e)}requestReset(){this.isHost?this.reset():this.sendSocketGameAction({type:"RESET_GAME"})}addBot(){this.isHost&&this.state.gamePhase===i.WAITING&&(this.state.players[2].id="BOT",this.state.players[2].username="Bot",this.state.players[2].ballType=null,this.syncState())}removeBot(){this.isHost&&this.state.gamePhase===i.WAITING&&"BOT"===this.state.players[2].id&&(this.state.players[2].id=null,this.state.players[2].username=null,this.state.players[2].ballType=null,this.syncState())}handleAddBot(){this.addBot()}handleRemoveBot(){this.removeBot()}startGame(){this.isHost?this.handleStartGame():this.sendSocketGameAction({type:"START_GAME"})}handleStartGame(){this.state.gamePhase===i.WAITING&&this.state.players[1].id&&this.state.players[2].id&&(this.state.gamePhase=i.PLAYING,this.state.balls=n(),this.syncState(),this.checkBotTurn())}canStartGame(){return!!this.state.players[1].id&&!!this.state.players[2].id&&this.state.gamePhase===i.WAITING}checkBotTurn(){if(!this.isHost)return;if(this.state.gamePhase!==i.PLAYING)return;if(this.state.isSimulating)return;"BOT"===this.state.players[this.state.currentTurn].id&&this.makeBotMove()}makeBotMove(){if(this.state.gamePhase!==i.PLAYING)return;if(this.state.isSimulating)return;const t=this.state.balls.find(t=>0===t.id);if(!t||t.pocketed)return;const s=this.state.balls.filter(t=>0!==t.id&&!t.pocketed);if(0===s.length)return;const e=s[0],a=Math.atan2(e.y-t.y,e.x-t.x),n=.5+.3*Math.random();this.handleShoot(a,n,"BOT")}getPlayerSlot(t){return this.state.players[1].id===t?1:this.state.players[2].id===t?2:null}getMySlot(){return this.getPlayerSlot(this.userId)}isMyTurn(){return this.getMySlot()===this.state.currentTurn&&this.state.gamePhase===i.PLAYING}getCueBall(){return this.state.balls.find(t=>0===t.id&&!t.pocketed)}stopSimulation(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stopSimulation(),this.syncIntervalId&&clearInterval(this.syncIntervalId),super.destroy()}}export{S as default};
