import"./socket-DRbsQkF5.js";import{c as t}from"./index-D_jybrTI.js";class e{roomId;socket;isHost;userId;players;state;stateListeners=[];constructor(t,e,s,a,o=[]){this.roomId=t,this.socket=e,this.isHost=s,this.userId=a,this.players=o,this.state=this.getInitState(),this.isHost||this.socket.on("game:state",this.onSocketGameState.bind(this)),this.socket.on("game:action",this.onSocketGameAction.bind(this)),this.init()}init(){}makeAction(t){this.isHost?this.onSocketGameAction({action:t}):this.sendSocketGameAction(t)}updatePlayers(t){this.players=t,console.log(t),this.syncState()}gameName="unknown";setGameName(t){this.gameName=t}getState(){if(!this.state)throw new Error("Game state is not initialized");return this.state}notifyListeners(t){this.stateListeners.forEach(e=>e({...t}))}syncState(){this.notifyListeners(this.state),this.broadcastState()}setState(t){this.state=t,this.notifyListeners(t),this.broadcastState()}onUpdate(t){return this.stateListeners.push(t),()=>{this.stateListeners=this.stateListeners.filter(e=>e!==t)}}hasSomeoneElseInRoom(){const e=t.getState().currentRoom;return(e?.spectators?.length||0)+(e?.players?.length||0)>1}broadcastState(){if(this.isHost){const t=this.getState();this.hasSomeoneElseInRoom()&&this.socket.emit("game:state",{roomId:this.roomId,state:{...t}}),this.saveStateToStorage()}}sendSocketGameAction(t){this.hasSomeoneElseInRoom()?this.socket.emit("game:action",{roomId:this.roomId,action:t}):this.onSocketGameAction({action:t})}onSocketGameState(t){this.isHost||this.setState(t.state)}broadcastGameEnd(t){this.socket.emit("game:end",{roomId:this.roomId,result:t}),this.clearSavedState()}saveStateToStorage(){if(this.isHost&&"unknown"!==this.gameName)try{const t=`saved_game_${this.gameName}`,e={state:this.getState(),timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("Failed to save game state:",t)}}clearSavedState(){if(this.isHost&&"unknown"!==this.gameName)try{localStorage.removeItem(`saved_game_${this.gameName}`)}catch(t){console.error("Failed to clear game state:",t)}}destroy(){this.socket.off("game:state"),this.socket.off("game:action")}}export{e as B};
