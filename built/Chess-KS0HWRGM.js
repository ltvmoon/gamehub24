import{B as t}from"./BaseGame-BjLvdXwv.js";import{C as s}from"./chess-DTd62Tay.js";import"./socket-DRbsQkF5.js";class e extends t{state;onStateChange;chess;constructor(t,e,i,a,h){super(t,e,i,a),this.chess=new s,this.state={fen:this.chess.fen(),turn:"w",winner:null,isDraw:!1,check:!1,players:{white:h[0]?.id||null,black:h[1]?.id||null},gameOver:!1,history:[],lastMove:null,capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null,isBotLoading:!1},this.init()}init(){this.isHost&&(this.broadcastState(),this.checkBotTurn())}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const s=t.action;if(console.log("[Chess] handleAction:",s,"isHost:",this.isHost),this.isHost)switch(s.type){case"MAKE_MOVE":this.makeMove(s);break;case"UNDO_REQUEST":case"UNDO_RESPONSE":break;case"RESET_GAME":this.reset();break;case"NEW_GAME_REQUEST":this.handleNewGameRequest(s.playerId);break;case"NEW_GAME_RESPONSE":this.handleNewGameResponse(s.accepted)}}makeMove(t){const{from:e,to:i,promotion:a,playerId:h}=t;if(console.log("[Chess] makeMove called",{from:e,to:i,playerId:h,turn:this.state.turn}),console.log("[Chess] Players:",this.state.players),this.state.gameOver)return void console.log("[Chess] Game over, ignoring move");let o=null;if(this.state.players.white===h?o="w":this.state.players.black===h&&(o="b"),console.log("[Chess] Player color resolved:",o),null!==o&&this.state.turn===o)try{const t=new s(this.state.fen),h=t.move({from:e,to:i,promotion:a});h?(this.chess.load(t.fen()),this.updateStateFromChess(h),this.broadcastState(),this.checkBotTurn()):console.log("[Chess] Move validation failed (move returned null)")}catch(r){console.error("Invalid move:",r)}else console.log("[Chess] Invalid turn or player. Turn:",this.state.turn,"Color:",o)}updateStateFromChess(t){this.state.fen=this.chess.fen(),this.state.turn=this.chess.turn(),this.state.gameOver=this.chess.isGameOver(),this.state.check=this.chess.inCheck(),this.state.isDraw=this.chess.isDraw(),this.state.lastMove={from:t.from,to:t.to},this.state.history.push(this.state.fen),this.state.gameOver?(this.chess.isCheckmate()?this.state.winner="w"===this.chess.turn()?"black":"white":this.state.winner=null,this.broadcastGameEnd({winner:this.state.winner||void 0})):t.captured&&("w"===t.color?this.state.capturedPieces.white.push(t.captured):this.state.capturedPieces.black.push(t.captured)),this.setState({...this.state})}checkGameEnd(){return this.state.gameOver?{winner:this.state.winner||void 0}:null}reset(){this.chess.reset(),this.state={fen:this.chess.fen(),turn:"w",winner:null,isDraw:!1,check:!1,players:this.state.players,gameOver:!1,history:[],lastMove:null,capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null,isBotLoading:!1},this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}requestMove(t,s,e){const i={type:"MAKE_MOVE",from:t,to:s,promotion:e,playerId:this.userId};this.isHost?this.makeMove(i):this.sendAction(i)}requestReset(){if("BOT"===this.state.players.black||"BOT"===this.state.players.white)return void(this.isHost&&this.reset());const t={type:"NEW_GAME_REQUEST",playerId:this.userId};this.isHost?this.handleNewGameRequest(this.userId):this.sendAction(t)}requestUndo(){}handleNewGameRequest(t){this.state.pendingNewGameRequest=t,this.broadcastState(),this.setState({...this.state})}handleNewGameResponse(t){t?this.reset():(this.state.pendingNewGameRequest=null,this.broadcastState(),this.setState({...this.state}))}getPlayerColor(){return this.state.players.white===this.userId?"w":this.state.players.black===this.userId?"b":null}updatePlayers(t){this.state.players.white=t[0]?.id||null,t[1]?this.state.players.black=t[1].id:"BOT"!==this.state.players.black&&(this.state.players.black=null),this.broadcastState(),this.setState({...this.state})}stockfishWorker=null;isBotThinking=!1;async addBot(){if(this.isHost)if(this.state.players.black?this.state.players.white||(this.state.players.white="BOT"):this.state.players.black="BOT",this.state.isBotLoading=!0,this.broadcastState(),this.setState({...this.state}),this.stockfishWorker)this.state.isBotLoading=!1,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn();else{const t=new Blob([`importScripts('${"https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"}');`],{type:"application/javascript"}),s=URL.createObjectURL(t);this.stockfishWorker=new Worker(s),this.stockfishWorker.onmessage=t=>{this.handleStockfishMessage(t.data)};const e=new Promise(t=>{this.onBotReady=t});this.stockfishWorker.postMessage("uci"),this.stockfishWorker.postMessage("isready"),await e}}onBotReady;checkBotTurn(){if(!this.isHost)return;if(this.state.gameOver)return;"BOT"!==("w"===this.state.turn?this.state.players.white:this.state.players.black)||this.isBotThinking||this.makeBotMove()}makeBotMove(){!this.state.gameOver&&this.stockfishWorker&&(this.isBotThinking=!0,this.stockfishWorker.postMessage(`position fen ${this.state.fen}`),this.stockfishWorker.postMessage("go movetime 1000"))}handleStockfishMessage(t){if("readyok"===t&&(this.state.isBotLoading=!1,this.broadcastState(),this.setState({...this.state}),this.checkBotTurn(),this.onBotReady&&(this.onBotReady(),this.onBotReady=void 0)),t.startsWith("bestmove")){const s=t.split(" ")[1];if(s&&"(none)"!==s){const t=s.substring(0,2),e=s.substring(2,4),i=s.length>4?s.substring(4,5):void 0;this.makeMove({type:"MAKE_MOVE",from:t,to:e,promotion:i,playerId:"BOT"})}this.isBotThinking=!1}}destroy(){super.destroy(),this.stockfishWorker&&(this.stockfishWorker.terminate(),this.stockfishWorker=null)}}export{e as default};
