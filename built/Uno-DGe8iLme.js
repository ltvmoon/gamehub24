import{B as t}from"./BaseGame-gcDpxcTe.js";import{C as e,e as s,d as a,a as r}from"./types-Cr3Q3Kxu.js";import"./socket-DRbsQkF5.js";import"./index--Q6lzWr_.js";import"./react-vendor-RjW9glnC.js";import"./zustand-CR18f17S.js";class n extends t{isGameOver(t){return"ended"===t.gamePhase}getInitState(){return{players:Array(4).fill(null).map((t,e)=>{const s=this.players[e];return{id:s?.id||null,username:s?.username||`Slot ${e+1}`,hand:[],isBot:!1,isHost:s?.id===this.userId,calledUno:!1}}),discardPile:[],drawPile:[],currentTurnIndex:0,turnDirection:1,currentColor:e.RED,pendingDraw:0,winner:null,gamePhase:"waiting",newGameRequest:null,mustDraw:!1,hasDrawn:!1}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"PLAY_CARD":this.handlePlayCard(e.playerId,e.card,e.chosenColor);break;case"DRAW_CARD":this.handleDrawCard(e.playerId);break;case"CALL_UNO":this.handleCallUno(e.playerId);break;case"CATCH_UNO":this.handleCatchUno(e.playerId,e.targetId);break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"JOIN_SLOT":this.handleJoinSlot(e.slotIndex,e.playerId,e.playerName);break;case"REMOVE_PLAYER":this.handleRemovePlayer(e.slotIndex);break;case"START_GAME":this.handleStartGame();break;case"NEW_GAME":case"ACCEPT_NEW_GAME":this.reset();break;case"REQUEST_NEW_GAME":this.handleNewGameRequest(e.playerId,e.playerName);break;case"DECLINE_NEW_GAME":this.state.newGameRequest=null}}createDeck(){const t=[];for(const a of[e.RED,e.BLUE,e.GREEN,e.YELLOW]){t.push(s(a,r.NUMBER,0));for(let e=1;e<=9;e++)t.push(s(a,r.NUMBER,e)),t.push(s(a,r.NUMBER,e));t.push(s(a,r.SKIP)),t.push(s(a,r.SKIP)),t.push(s(a,r.REVERSE)),t.push(s(a,r.REVERSE)),t.push(s(a,r.DRAW_TWO)),t.push(s(a,r.DRAW_TWO))}for(let a=0;a<4;a++)t.push(s(e.WILD,r.WILD));for(let a=0;a<4;a++)t.push(s(e.WILD,r.WILD_DRAW_FOUR));return t}shuffleDeck(t){const e=[...t];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}dealCards(){const t=this.shuffleDeck(this.createDeck());let e=0;for(const a of this.state.players)null!==a.id&&(a.hand=t.slice(e,e+7),e+=7);let s=e;for(;s<t.length;){const e=a(t[s]);if(e.type!==r.WILD&&e.type!==r.WILD_DRAW_FOUR)break;s++}const n=t[s];this.state.discardPile=[n],this.state.currentColor=a(n).color;const i=[...t.slice(e,s),...t.slice(s+1)];this.state.drawPile=i}canPlayCard(t){const e=this.state.discardPile[this.state.discardPile.length-1],s=a(t),n=a(e);return!(this.state.pendingDraw>0)&&(s.type===r.WILD||s.type===r.WILD_DRAW_FOUR||(s.color===this.state.currentColor||(s.type===r.NUMBER&&n.type===r.NUMBER?s.value===n.value:s.type===n.type)))}hasPlayableCard(t){return t.some(t=>this.canPlayCard(t))}handlePlayCard(t,e,s){if("playing"!==this.state.gamePhase)return;const n=this.state.players.findIndex(e=>e.id===t);if(-1===n||n!==this.state.currentTurnIndex)return;const i=this.state.players[n],h=i.hand.findIndex(t=>t===e);if(-1===h)return;if(!this.canPlayCard(e))return;if(i.hand.splice(h,1),this.state.discardPile.push(e),1!==i.hand.length&&(i.calledUno=!1),this.applyCardEffect(e,s),0===i.hand.length)return this.state.winner=t,this.state.gamePhase="ended",void this.clearSavedState();this.state.hasDrawn=!1,this.state.mustDraw=!1;a(e).type!==r.SKIP||this.advanceTurn(),this.advanceTurn(),this.checkBotTurn()}applyCardEffect(t,s){const n=a(t);switch(n.type===r.WILD||n.type===r.WILD_DRAW_FOUR?this.state.currentColor=s??e.RED:this.state.currentColor=n.color,n.type){case r.REVERSE:2===this.state.players.filter(t=>null!==t.id&&t.hand.length>0).length?this.advanceTurn():this.state.turnDirection=1===this.state.turnDirection?-1:1;break;case r.DRAW_TWO:this.state.pendingDraw+=2;break;case r.WILD_DRAW_FOUR:this.state.pendingDraw+=4}}handleDrawCard(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players.findIndex(e=>e.id===t);if(-1===e||e!==this.state.currentTurnIndex)return;const s=this.state.players[e];if(s.calledUno=!1,this.state.pendingDraw>0)this.drawCards(s,this.state.pendingDraw),this.state.pendingDraw=0,this.state.hasDrawn=!1,this.advanceTurn();else if(this.state.hasDrawn)this.state.hasDrawn=!1,this.advanceTurn();else{this.drawCards(s,1),this.state.hasDrawn=!0;const t=s.hand[s.hand.length-1];this.canPlayCard(t)||(this.state.hasDrawn=!1,this.advanceTurn())}this.checkBotTurn()}drawCards(t,e){for(let s=0;s<e;s++)if(0===this.state.drawPile.length&&this.reshuffleDiscardPile(),this.state.drawPile.length>0){const e=this.state.drawPile.pop();t.hand.push(e)}}reshuffleDiscardPile(){if(this.state.discardPile.length<=1)return;const t=this.state.discardPile.pop();this.state.drawPile=this.shuffleDeck(this.state.discardPile),this.state.discardPile=[t]}handleCallUno(t){const e=this.state.players.findIndex(e=>e.id===t);if(-1===e)return;const s=this.state.players[e];s.hand.length<=2&&(s.calledUno=!0)}handleCatchUno(t,e){const s=this.state.players.findIndex(t=>t.id===e);if(-1===s)return;const a=this.state.players[s];1!==a.hand.length||a.calledUno||this.drawCards(a,2)}advanceTurn(){let t=this.state.currentTurnIndex,e=0;do{t=(t+this.state.turnDirection+4)%4,e++}while(e<4&&(null===this.state.players[t].id||0===this.state.players[t].hand.length));this.state.currentTurnIndex=t}handleAddBot(t){if(t<0||t>=4)return;if("waiting"!==this.state.gamePhase)return;if(null!==this.state.players[t].id)return;const e=`BOT_${t}_${Date.now()}`,s=[...this.state.players];s[t]={id:e,username:`Bot ${t+1}`,hand:[],isBot:!0,isHost:!1,calledUno:!1},this.state.players=s}handleJoinSlot(t,e,s){if(t<0||t>=4)return;if("waiting"!==this.state.gamePhase)return;if(null!==this.state.players[t].id)return;if(this.state.players.some(t=>t.id===e))return;const a=[...this.state.players];a[t]={id:e,username:s,hand:[],isBot:!1,isHost:!1,calledUno:!1},this.state.players=a}handleRemovePlayer(t){if(t<0||t>=4)return;if("waiting"!==this.state.gamePhase)return;if(!this.state.players[t].isBot)return;const e=[...this.state.players];e[t]={id:null,username:`Slot ${t+1}`,hand:[],isBot:!1,isHost:!1,calledUno:!1},this.state.players=e}handleStartGame(){if("waiting"!==this.state.gamePhase)return;if(this.state.players.filter(t=>null!==t.id).length<2)return;for(this.dealCards(),this.state.gamePhase="playing",this.state.currentTurnIndex=0,this.state.turnDirection=1,this.state.pendingDraw=0,this.state.hasDrawn=!1,this.state.mustDraw=!1;null===this.state.players[this.state.currentTurnIndex].id;)this.state.currentTurnIndex=(this.state.currentTurnIndex+1)%4;const t=this.state.discardPile[this.state.discardPile.length-1],e=a(t);e.type===r.SKIP?this.advanceTurn():e.type===r.REVERSE?this.state.turnDirection=-1:e.type===r.DRAW_TWO&&(this.state.pendingDraw=2),this.checkBotTurn()}handleNewGameRequest(t,e){this.state.newGameRequest={fromId:t,fromName:e}}reset(){const t=this.state.players.map((t,e)=>({id:t.id,username:t.username,hand:[],isBot:t.isBot,isHost:t.isHost,calledUno:!1}));this.state={players:t,discardPile:[],drawPile:[],currentTurnIndex:0,turnDirection:1,currentColor:e.RED,pendingDraw:0,winner:null,gamePhase:"waiting",newGameRequest:null,mustDraw:!1,hasDrawn:!1}}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}updatePlayers(t){for(let e=0;e<4;e++){const s=this.state.players[e];if(!s.isBot&&s.id){const a=t.find(t=>t.id===s.id);a?s.username=a.username:(s.id=null,s.username=`Slot ${e+1}`,s.hand=[],s.calledUno=!1)}}}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentTurnIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t),1e3)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;if(!t.id)return;if(this.state.pendingDraw>0)return void this.handleDrawCard(t.id);const e=t.hand.filter(t=>this.canPlayCard(t));if(e.length>0){const s=this.selectBotCard(e);let n;2===t.hand.length&&this.handleCallUno(t.id);const i=a(s);i.type!==r.WILD&&i.type!==r.WILD_DRAW_FOUR||(n=this.chooseBotColor(t.hand)),this.handlePlayCard(t.id,s,n)}else this.handleDrawCard(t.id)}selectBotCard(t){const e=[r.WILD_DRAW_FOUR,r.DRAW_TWO,r.SKIP,r.REVERSE,r.WILD,r.NUMBER];for(const s of e){const e=t.filter(t=>a(t).type===s);if(e.length>0)return s===r.NUMBER?e.sort((t,e)=>a(e).value-a(t).value)[0]:e[0]}return t[0]}chooseBotColor(t){const s={[e.RED]:0,[e.BLUE]:0,[e.GREEN]:0,[e.YELLOW]:0};for(const i of t){const t=a(i);t.color!==e.WILD&&s[t.color]++}let r=e.RED,n=0;for(const[e,a]of Object.entries(s))a>n&&(n=a,r=parseInt(e));return r}requestPlayCard(t,e){const s={type:"PLAY_CARD",playerId:this.userId,card:t,chosenColor:e};this.makeAction(s)}requestDrawCard(){const t={type:"DRAW_CARD",playerId:this.userId};this.makeAction(t)}requestCallUno(){const t={type:"CALL_UNO",playerId:this.userId};this.makeAction(t)}requestCatchUno(t){const e={type:"CATCH_UNO",playerId:this.userId,targetId:t};this.makeAction(e)}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeAction(e)}requestJoinSlot(t,e){const s={type:"JOIN_SLOT",slotIndex:t,playerId:this.userId,playerName:e};this.makeAction(s)}requestRemovePlayer(t){const e={type:"REMOVE_PLAYER",slotIndex:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestNewGame(){if(this.isHost)this.onSocketGameAction({action:{type:"NEW_GAME"}});else{const t={type:"REQUEST_NEW_GAME",playerId:this.userId,playerName:this.state.players.find(t=>t.id===this.userId)?.username||"Player"};this.sendSocketGameAction(t)}}acceptNewGame(){this.onSocketGameAction({action:{type:"ACCEPT_NEW_GAME"}})}declineNewGame(){this.onSocketGameAction({action:{type:"DECLINE_NEW_GAME"}})}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}getUserId(){return this.userId}canStartGame(){return this.state.players.filter(t=>null!==t.id).length>=2}canPlayCardCheck(t){return this.canPlayCard(t)}hasPlayableCardCheck(){const t=this.getMyPlayerIndex();return-1!==t&&this.hasPlayableCard(this.state.players[t].hand)}}export{n as default};
