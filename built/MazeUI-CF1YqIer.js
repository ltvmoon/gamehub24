import{u as e,b as t,j as s}from"./index-BLcGWsmB.js";import{c as r,a7 as n,aU as l,aV as o,z as a,aW as i,aX as c,a9 as d,aE as u}from"./react-vendor-DeJ0i39y.js";import{DIFFICULTY_CONFIG as h}from"./Maze-DuIqkgvS.js";import{u as x}from"./useGameState-D1GsuIT1.js";import"./socket-DRbsQkF5.js";import"./zustand-ie0NTbcC.js";import"./BaseGame-BoHpQUK3.js";const m=(e,t,s)=>{const r=window.devicePixelRatio||1;e.width=t*r,e.height=s*r,e.style.width=`${t}px`,e.style.height=`${s}px`;const n=e.getContext("2d");return n&&n.scale(r,r),n},f=({game:f})=>{const g=f,[p]=x(g),w=r.useRef(null),v=r.useRef(null),y=r.useRef(null),b=r.useRef({}),{ts:j}=e(),{confirm:N}=t(),[E,T]=r.useState(30),P=r.useMemo(()=>g.userId?p.players[g.userId]:void 0,[g.userId,p.players]),k=r.useMemo(()=>g.getMazeGrid(),[p.config,p.seed,g]);r.useEffect(()=>{const e=()=>{if(!y.current)return;const{rows:e,cols:t}=p.config,s=Math.min(window.innerWidth-32,800),r=window.innerHeight-180-32,n=Math.floor(s/t),l=Math.floor(r/e);let o=Math.min(n,l);o=Math.max(10,Math.min(o,40)),T(o)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[p.config.rows,p.config.cols]);const[I,S]=r.useState(!1);r.useEffect(()=>{const e=()=>{S(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e)}},[]);const z=r.useRef(void 0),[R,L]=r.useState(!1),[M,G]=r.useState(new Set),A=r.useRef(new Set);r.useEffect(()=>{const e=new Set;G(e),A.current=e},[p.seed,p.level,p.status,g]),r.useEffect(()=>{if(!P)return;const e=Date.now();if(!(P.moveEnd&&e<P.moveEnd&&P.currentPath&&P.currentPath.length>=2)){const e=`${P.x},${P.y}`;A.current.has(e)||(A.current.add(e),G(new Set(A.current)))}},[P?.x,P?.y,P?.moveEnd,P?.currentPath,R]),r.useEffect(()=>{const e=v.current;if(!e)return;const{rows:t,cols:s}=p.config,r=s*E,n=t*E,l=m(e,r,n);l&&(l.clearRect(0,0,r,n),P&&(l.fillStyle=P.color+"33",M.forEach(e=>{const[t,s]=e.split(",").map(Number);l.fillRect(t*E,s*E,E,E)})))},[M,p.config.rows,p.config.cols,E,P]),r.useEffect(()=>{const e=w.current;if(!e||!k)return;const{rows:t,cols:s}=p.config,r=s*E,n=t*E,l=m(e,r,n);if(l){l.clearRect(0,0,r,n),l.fillStyle="rgba(34, 197, 94, 0.2)",l.fillRect((s-1)*E,(t-1)*E,E,E),l.fillStyle="rgba(59, 130, 246, 0.2)",l.fillRect(0,0,E,E),l.lineWidth=3;for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=k?.[e]?.[t];if(s?.portalTo){const r=t*E+E/2,n=e*E+E/2;l.beginPath(),l.arc(r,n,.35*E,0,2*Math.PI),l.fillStyle=s.portalTo.color+"40",l.fill(),l.beginPath(),l.arc(r,n,.25*E,0,2*Math.PI),l.strokeStyle=s.portalTo.color,l.stroke(),l.beginPath(),l.arc(r,n,.1*E,0,2*Math.PI),l.fillStyle=s.portalTo.color,l.fill()}}l.strokeStyle="#4b5563",l.lineWidth=2,l.lineCap="round",l.beginPath();for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=k[e][t],r=t*E,n=e*E;s.walls.top&&(l.moveTo(r,n),l.lineTo(r+E,n)),s.walls.right&&(l.moveTo(r+E,n),l.lineTo(r+E,n+E)),s.walls.bottom&&(l.moveTo(r,n+E),l.lineTo(r+E,n+E)),s.walls.left&&(l.moveTo(r,n),l.lineTo(r,n+E))}l.stroke()}},[k,p.config.rows,p.config.cols,E]),r.useEffect(()=>{const e=e=>{if("PLAYING"!==p.status)return;let t=null;"ArrowUp"===e.key&&(t="UP"),"ArrowDown"===e.key&&(t="DOWN"),"ArrowLeft"===e.key&&(t="LEFT"),"ArrowRight"===e.key&&(t="RIGHT")," "===e.key&&F(),t&&(e.preventDefault(),C(t))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[p.status,g]),r.useEffect(()=>{let e=!1;const t=()=>{const s=Date.now();if(Object.values(p.players).forEach(e=>{const t=b.current[e.id];if(!t)return;let r=e.x,n=e.y;if(!!e.moveStart&&!!e.moveEnd&&!!e.currentPath&&e.currentPath.length>=2&&s<e.moveEnd){const t=e.moveEnd-e.moveStart,l=s-e.moveStart,o=Math.max(0,Math.min(l/t,1)),a=e.currentPath,i=a.length-1,c=o*i,d=Math.floor(c),u=c-d;if(d<i){const e=a[d],t=a[d+1];r=e.x+(t.x-e.x)*u,n=e.y+(t.y-e.y)*u}if(e.id===g.userId){let e=!1;for(let t=0;t<=d&&t<a.length;t++){const s=a[t],r=`${s.x},${s.y}`;A.current.has(r)||(A.current.add(r),e=!0)}e&&G(new Set(A.current))}}t.style.left=r*E+.15*E+"px",t.style.top=n*E+.15*E+"px",t.style.width=.7*E+"px",t.style.height=.7*E+"px"}),g.userId&&p.players[g.userId]){const t=p.players[g.userId],r=!!(t.moveEnd&&s<t.moveEnd);r!==e&&(e=r,L(r))}z.current=requestAnimationFrame(t)};return z.current=requestAnimationFrame(t),()=>{z.current&&cancelAnimationFrame(z.current)}},[p.players,E,g.userId]);const D=e=>{const t=p.winners.indexOf(e);return-1===t?void 0:t+1},F=()=>{g.userId&&g.makeAction({type:"TELEPORT",playerId:g.userId})},C=e=>{g.userId&&g.makeAction({type:"MOVE",direction:e,playerId:g.userId})};return s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-full @md:p-4 p-2 overflow-hidden pb-16!",ref:y,children:[s.jsx("div",{className:"flex flex-col w-full max-w-2xl bg-gray-800 @md:p-4 p-2 rounded-xl shadow-lg gap-4 z-10 shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("span",{className:"text-sm text-gray-400",children:["Level ",p.level," ",s.jsx("span",{className:"text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded-full",children:p.config.difficulty})]}),s.jsxs("div",{className:"flex gap-1 mt-2",children:[g.isHost&&s.jsx("button",{onClick:async()=>{await N(j({en:"Current progress will be lost",vi:"Tiến trình hiện tại sẽ mất"}),j({en:"Reset Game?",vi:"Chơi lại?"}))&&g.makeAction({type:"RESET_GAME"})},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:"Reset Game",children:s.jsx(n,{size:18})}),s.jsx("button",{onClick:()=>{y.current&&(document.fullscreenElement?document.exitFullscreen():y.current.requestFullscreen().catch(e=>{console.error(`Error attempting to enable fullscreen: ${e.message}`)}))},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:I?"Exit Fullscreen":"Fullscreen",children:I?s.jsx(l,{size:18}):s.jsx(o,{size:18})})]})]}),s.jsx("div",{className:"flex flex-col flex-wrap gap-0",children:Object.values(p.players).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 px-3 bg-gray-900/50 rounded-lg border border-gray-700/50",children:[s.jsx("div",{className:"w-3 h-3 rounded-full border border-white/20 shrink-0",style:{backgroundColor:e.color}}),s.jsxs("div",{className:"truncate font-medium text-sm text-gray-300 max-w-[100px]",children:[e.username||e.id.slice(0,8),e.id===g.userId&&s.jsxs("span",{className:"text-blue-400 ml-1",children:["(",j({en:"You",vi:"Bạn"}),")"]})]}),D(e.id)&&s.jsxs("span",{className:"text-xs font-bold bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded ml-1",children:["#",D(e.id)]})]},e.id))})]})}),s.jsxs("div",{className:"relative shadow-2xl rounded-lg border border-gray-700 select-none bg-[#1a1a1a] mt-4 shrink-0 transition-all duration-300",style:{width:p.config.cols*E,height:p.config.rows*E},children:[s.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-lg",children:[s.jsx("canvas",{ref:v,className:"absolute inset-0 z-0",style:{width:"100%",height:"100%"}}),s.jsx("canvas",{ref:w,className:"absolute inset-0 z-10",style:{width:"100%",height:"100%"}}),Object.values(p.players).map(e=>s.jsx("div",{ref:t=>{b.current[e.id]=t},className:"absolute rounded-full shadow-sm flex items-center justify-center border-2 border-white",style:{width:.7*E+"px",height:.7*E+"px",backgroundColor:e.color,zIndex:e.id===g.userId?20:10},children:D(e.id)&&s.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-md",children:["#",D(e.id)]})},e.id)),"WAITING"===p.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/40 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsx("div",{className:"text-white text-3xl font-bold",children:g.isHost?j({en:"Setup Game",vi:"Cài đặt Game"}):j({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})}),g.isHost&&s.jsxs("div",{className:"flex flex-col gap-4 items-center animate-in fade-in zoom-in duration-300",children:[s.jsx("div",{className:"flex bg-gray-800 rounded-lg p-1.5 ring-1 ring-gray-700",children:Object.keys(h).map(e=>s.jsx("button",{onClick:()=>{return t=e,void g.makeAction({type:"UPDATE_SETTINGS",difficulty:t});var t},className:"px-4 py-2 text-sm font-bold rounded-md transition-all "+(p.config.difficulty===e?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"),children:e},e))}),s.jsxs("button",{onClick:()=>{g.makeAction({type:"START_GAME"})},className:"flex items-center gap-2 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all hover:-translate-y-0.5",children:[s.jsx(a,{size:24,fill:"currentColor"})," ",j({en:"Start Game",vi:"Chơi"})]})]})]}),"FINISHED"===p.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsxs("div",{className:"text-green-400 text-4xl font-bold drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]",children:[j({en:"Level Complete!",vi:"Xong Level"})," ",p.level]}),P&&D(P.id)&&s.jsxs("div",{className:"text-white text-xl",children:[j({en:"You finished",vi:"Bạn về đích"})," ",s.jsxs("span",{className:"font-bold text-yellow-400",children:["#",D(P.id)]})]}),g.isHost?s.jsxs("button",{onClick:()=>{g.makeAction({type:"NEXT_LEVEL"})},className:"flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all hover:-translate-y-0.5",children:[j({en:"Next Level",vi:"Level tiếp theo"})," ",s.jsx(a,{size:24,fill:"currentColor"})]}):s.jsx("div",{children:j({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})})]})]}),(()=>{const e=R;if("PLAYING"!==p.status||!P||e||D(P.id))return null;const t=(()=>{if(!P||!k)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const{x:e,y:t}=P;if(t<0||e<0||t>=p.config.rows||e>=p.config.cols)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const s=k[t][e];return{UP:!s.walls.top,DOWN:!s.walls.bottom,LEFT:!s.walls.left,RIGHT:!s.walls.right}})(),r=40,l=P.x*E+E/2,o=P.y*E+E/2,a=p.config.cols*E,h=p.config.rows*E,x=t.LEFT?60:20,m=t.RIGHT?60:20,f=t.UP?60:20,g=t.DOWN?60:20,w=Math.max(x,Math.min(a-m,l)),v=Math.max(f,Math.min(h-g,o)),y=(e,t)=>({width:"40px",height:"40px",left:w+e-20+"px",top:v+t-20+"px"}),b="absolute flex items-center justify-center bg-white/10 hover:bg-white/40 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-30 border border-white/10 shadow-lg ring-1 ring-black/20 opacity-50";return s.jsxs(s.Fragment,{children:[t.UP&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),C("UP")},className:b,style:y(0,-40),children:s.jsx(i,{size:24,className:"text-white drop-shadow-md"})}),t.DOWN&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),C("DOWN")},className:b,style:y(0,r),children:s.jsx(c,{size:24,className:"text-white drop-shadow-md"})}),t.LEFT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),C("LEFT")},className:b,style:y(-40,0),children:s.jsx(d,{size:24,className:"text-white drop-shadow-md"})}),t.RIGHT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),C("RIGHT")},className:b,style:y(r,0),children:s.jsx(u,{size:24,className:"text-white drop-shadow-md"})}),k?.[P.y]?.[P.x]?.portalTo&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),F()},className:"absolute flex items-center justify-center bg-purple-500/80 hover:bg-purple-400 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-40 border border-white/20 shadow-[0_0_15px_rgba(168,85,247,0.5)] animate-pulse opacity-50",style:{width:"40px",height:"40px",left:w-20+"px",top:v-20+"px"},children:s.jsx(n,{size:24,className:"text-white drop-shadow-md animate-spin",style:{animationDirection:"reverse"}})})]})})()]}),s.jsx("div",{className:"mt-4 text-gray-500 text-sm",children:j({vi:"Về đích đầu tiên để dành chiến thắng",en:"First to the finish wins!"})})]})};export{f as default};
