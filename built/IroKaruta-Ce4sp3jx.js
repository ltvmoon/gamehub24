import{B as t}from"./BaseGame-gcDpxcTe.js";import{s as a,b as e,c as s}from"./helper-CQgxB6Hs.js";import"./socket-DRbsQkF5.js";import"./index--Q6lzWr_.js";import"./react-vendor-RjW9glnC.js";import"./zustand-CR18f17S.js";const r=[{color:[0,255,255],label:"C"},{color:[255,0,255],label:"M"},{color:[255,255,0],label:"Y"},{color:[0,0,0],label:"K"},{color:[255,255,255],label:"W"}],o=[.3,.5,.7];class i extends t{roundTimer=null;init(){this.setGameName("irokaruta")}getInitState(){return{phase:"waiting",round:0,maxRounds:5,targetColor:[0,0,0],availableCards:[],playerData:{},roundStartTime:0,answerCardIds:[]}}isGameOver(t){return"summary"===t.phase&&t.round>=t.maxRounds}onSocketGameAction({action:t}){if(!this.isHost)return;const a=t;switch(a.type){case"START_GAME":this.startGame();break;case"DROP_CARD":this.handleDropCard(a.playerId,a.cardId);break;case"REMOVE_CARD":this.handleRemoveCard(a.playerId,a.cardId);break;case"NEXT_ROUND":this.startRound();break;case"RESET_GAME":this.resetGame()}}startGame(){const t={};for(const a of this.players)t[a.id]={cardsInZone:[],finishedAt:null,score:0};this.state.playerData=t,this.state.round=0,this.startRound()}startRound(){if(this.state.round++,this.state.round>this.state.maxRounds)return void(this.state.phase="summary");const t=function(){const t=[];let a=0;for(const e of r)for(const s of o)t.push({id:a++,color:e.color,opacity:s,label:e.label});return t}(),s=Math.random()<.5?2:3,i=a(t),n=i.filter(t=>!(255===t.color[0]&&255===t.color[1]&&255===t.color[2]))[0],l=i.filter(t=>t.id!==n.id),d=[n,...l.slice(0,s-1)],h=e(d),c=a(t),u=c.filter(t=>d.some(a=>a.color[0]===t.color[0]&&a.color[1]===t.color[1]&&a.color[2]===t.color[2]&&a.opacity===t.opacity)).map(t=>t.id);for(const a of Object.keys(this.state.playerData))this.state.playerData[a].cardsInZone=[],this.state.playerData[a].finishedAt=null;for(const a of this.players)this.state.playerData[a.id]||(this.state.playerData[a.id]={cardsInZone:[],finishedAt:null,score:0});this.state.targetColor=h,this.state.availableCards=c,this.state.answerCardIds=u,this.state.roundStartTime=Date.now(),this.state.phase="playing"}handleDropCard(t,a){if("playing"!==this.state.phase)return;const e=this.state.playerData[t];e&&null===e.finishedAt&&(e.cardsInZone.includes(a)||(e.cardsInZone.push(a),this.evaluatePlayer(t)))}handleRemoveCard(t,a){if("playing"!==this.state.phase)return;const e=this.state.playerData[t];if(!e||null!==e.finishedAt)return;const s=e.cardsInZone.indexOf(a);-1!==s&&e.cardsInZone.splice(s,1),this.evaluatePlayer(t)}evaluatePlayer(t){const a=this.state.playerData[t];if(!a)return;if(0===a.cardsInZone.length)return;const r=a.cardsInZone.map(t=>this.state.availableCards.find(a=>a.id===t)).filter(Boolean),o=e(r);if(s(o,this.state.targetColor)>=100){a.finishedAt=Date.now();const t=a.finishedAt-this.state.roundStartTime,e=Math.max(100,Math.round(1e3-t/100));a.score+=e,this.checkRoundEnd()}}checkRoundEnd(){Object.values(this.state.playerData).every(t=>null!==t.finishedAt)&&(this.roundTimer&&clearTimeout(this.roundTimer),this.roundTimer=setTimeout(()=>{this.state.round,this.state.maxRounds,this.state.phase="summary"},1500))}resetGame(){const t=this.getInitState();Object.assign(this.state,t)}destroy(){this.roundTimer&&clearTimeout(this.roundTimer),super.destroy()}}export{i as default};
