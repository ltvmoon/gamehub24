import{B as t}from"./BaseGame-D8z93T-B.js";import{I as e,H as s,S as n,a}from"./types-BcXWPzzM.js";import{d as r,R as i,S as l,e as o}from"./types-qIwhz3td.js";import"./socket-DRbsQkF5.js";import"./index-7ewwbQld.js";import"./react-vendor-BLBa7-IT.js";import"./zustand-BEg5S8SY.js";class d extends t{deck=[];timer=null;isGameOver(t){return"ended"===t.gamePhase}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}getUserId(){return this.userId}getInitState(){const t=Array(4).fill(null).map((t,e)=>this.createEmptyPlayer(e));return this.players&&this.players.length>0&&this.players.forEach(e=>{const s=t.findIndex(t=>null===t.id);-1!==s&&(t[s]={...t[s],id:e.id,username:e.username||`Player ${e.id.substr(0,4)}`})}),{players:t,gamePhase:"waiting",timerEndsAt:0,roundResults:[],roundEvents:[],roundNumber:0}}createEmptyPlayer(t){return{id:null,username:`Seat ${t+1}`,hand:[],front:[],middle:[],back:[],isBot:!1,isReady:!1,score:0,isFouled:!1,instantWin:e.NONE,usedAuto:!1}}onSocketGameAction(t){if(!this.isHost)return;const e=t.action;switch(e.type){case"START_GAME":this.startGame();break;case"ARRANGE_CARDS":this.handleArrangeCards(e.playerId,e.front,e.middle,e.back,e.isAuto);break;case"AUTO_ARRANGE":this.handleAutoArrange(e.playerId);break;case"DECLARE_INSTANT_WIN":this.handleDeclareInstantWin(e.playerId);break;case"ADD_BOT":this.addBot(e.slotIndex);break;case"RESET_GAME":this.resetGame();break;case"JOIN_SLOT":this.joinSlot(e.slotIndex,e.playerId,e.playerName);break;case"REMOVE_PLAYER":this.removePlayer(e.slotIndex)}}updatePlayers(t){if(console.log("updatePlayers",t),!this.isHost)return;const e="waiting"===this.state.gamePhase;for(const s of t){const t=this.state.players.findIndex(t=>t.id===s.id);if(-1!==t)this.state.players[t].username=s.username||this.state.players[t].username;else if(e){const t=this.state.players.findIndex(t=>null===t.id);-1!==t&&(this.state.players[t].id=s.id,this.state.players[t].username=s.username||`Player ${s.id.substr(0,4)}`)}}if(e){const e=new Set(t.map(t=>t.id));this.state.players.forEach((t,s)=>{!t.id||t.isBot||e.has(t.id)||this.removePlayer(s)})}}startGame(){this.state.players.filter(t=>null!==t.id).length<2||(this.state.roundNumber++,this.deck=this.createDeck(),this.shuffleDeck(this.deck),this.state.gamePhase="arranging",this.state.timerEndsAt=Date.now()+9e4,this.state.roundResults=[],this.state.roundEvents=[],this.state.players.forEach(t=>{if(null!==t.id){t.hand=[],t.front=[],t.middle=[],t.back=[],t.isReady=!1,t.isFouled=!1,t.instantWin=e.NONE,t.usedAuto=!1;for(let e=0;e<13;e++)t.hand.push(this.deck.pop());t.hand.sort((t,e)=>r(e).rank-r(t).rank)}}),this.state.players.forEach(t=>{if(t.id&&t.isBot){const s=this.generateSuggestions(t.hand);let n=s[0],a=-1/0;for(const t of s){const e=3*this.evaluate5CardHand(t.back).value+2*this.evaluate5CardHand(t.middle).value+this.evaluate3CardHand(t.front).value;e>a&&(a=e,n=t)}t.front=n.front,t.middle=n.middle,t.back=n.back,t.instantWin=this.checkInstantWin(t.hand,t.front,t.middle,t.back),t.isFouled=t.instantWin===e.NONE&&!this.isValidArrangement(t.front,t.middle,t.back),t.isReady=!0}}),this.startTimer())}startTimer(){this.clearTimer(),this.timer=setInterval(()=>{"arranging"===this.state.gamePhase?Date.now()>=this.state.timerEndsAt&&(this.clearTimer(),this.forceSubmitAll()):this.clearTimer()},500)}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}forceSubmitAll(){this.state.players.forEach(t=>{if(t.id&&!t.isReady){const s=this.autoArrange(t.hand);t.front=s.front,t.middle=s.middle,t.back=s.back,t.instantWin=this.checkInstantWin(t.hand,t.front,t.middle,t.back),t.isFouled=t.instantWin===e.NONE&&!this.isValidArrangement(t.front,t.middle,t.back),t.usedAuto=!0,t.isReady=!0}}),this.compareHands()}handleArrangeCards(t,s,n,a,r){if("arranging"!==this.state.gamePhase)return;const i=this.state.players.findIndex(e=>e.id===t);if(-1===i)return;const l=this.state.players[i];if(l.isReady)return;const o=[...s,...n,...a];if(13!==o.length||3!==s.length||5!==n.length||5!==a.length)return;const d=new Set(l.hand);o.every(t=>d.has(t))&&(l.front=s,l.middle=n,l.back=a,l.usedAuto=r,l.instantWin=this.checkInstantWin(l.hand,s,n,a),l.isFouled=l.instantWin===e.NONE&&!this.isValidArrangement(s,n,a),l.isReady=!0,this.checkAllReady())}handleAutoArrange(t){if("arranging"!==this.state.gamePhase)return;const e=this.state.players.findIndex(e=>e.id===t);if(-1===e)return;const s=this.state.players[e];if(s.isReady)return;const n=this.autoArrange(s.hand);s.front=n.front,s.middle=n.middle,s.back=n.back,s.instantWin=this.checkInstantWin(s.hand,s.front,s.middle,s.back),s.isFouled=!1,s.usedAuto=!0,s.isReady=!0,this.checkAllReady()}handleDeclareInstantWin(t){if("arranging"!==this.state.gamePhase)return;const s=this.state.players.findIndex(e=>e.id===t);if(-1===s)return;const n=this.state.players[s];if(n.isReady)return;const a=this.checkInstantWinRaw(n.hand);if(a===e.NONE)return;const r=this.autoArrange(n.hand);n.front=r.front,n.middle=r.middle,n.back=r.back,n.instantWin=a,n.isFouled=!1,n.isReady=!0,this.checkAllReady()}checkAllReady(){this.state.players.filter(t=>null!==t.id).every(t=>t.isReady)&&(this.clearTimer(),this.compareHands())}checkInstantWinRaw(t){return 13!==t.length?e.NONE:this.isDragon(t)?e.DRAGON:this.isSameColor(t,13)?e.SAME_COLOR_13:this.isSameColor(t,12)?e.SAME_COLOR_12:this.isSixPairs(t)?e.SIX_PAIRS:e.NONE}checkInstantWin(t,s,n,a){const r=this.checkInstantWinRaw(t);return r!==e.NONE?r:this.isThreeFlushes(s,n,a)?e.THREE_FLUSHES:this.isThreeStraights(s,n,a)?e.THREE_STRAIGHTS:e.NONE}isDragon(t){const e=t.map(t=>r(t).rank).sort((t,e)=>t-e);for(let s=0;s<13;s++)if(e[s]!==s+2)return!1;return new Set(t.map(t=>r(t).suit)).size>1}isSameColor(t,e){let s=0,n=0;return t.forEach(t=>{const{suit:e}=r(t);e===l.DIAMOND||e===l.HEART?s++:n++}),s>=e||n>=e}isSixPairs(t){const e={};t.forEach(t=>{const{rank:s}=r(t);e[s]=(e[s]||0)+1});const s=Object.values(e),n=s.filter(t=>t>=2),a=s.filter(t=>t>=3);return n.length>=6||n.length>=5&&a.length>=1}isThreeFlushes(t,e,s){const n=t=>{if(t.length<3)return!1;return 1===new Set(t.map(t=>r(t).suit)).size};return n(t)&&n(e)&&n(s)}isThreeStraights(t,e,s){const n=t=>{const e=t.map(t=>r(t).rank).sort((t,e)=>t-e);return 3===t.length?e[2]-e[0]===2&&3===new Set(e).size:e[4]-e[0]===4&&5===new Set(e).size||e[0]===i.TWO&&e[1]===i.THREE&&e[2]===i.FOUR&&e[3]===i.FIVE&&e[4]===i.ACE};return n(t)&&n(e)&&n(s)}isValidArrangement(t,e,s){if(3!==t.length||5!==e.length||5!==s.length)return!1;const n=this.evaluate3CardHand(t).value,a=this.evaluate5CardHand(e).value;return this.evaluate5CardHand(s).value>=a&&a>=n}evaluate3CardHand(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank),n=e.map(t=>r(t).rank);return n[0]===n[1]&&n[1]===n[2]?{rank:s.THREE_OF_A_KIND,value:1e8*s.THREE_OF_A_KIND+1e4*n[0],cards:e}:n[0]===n[1]?{rank:s.PAIR,value:1e8*s.PAIR+1e4*n[0]+n[2],cards:e}:n[1]===n[2]?{rank:s.PAIR,value:1e8*s.PAIR+1e4*n[1]+n[0],cards:[e[1],e[2],e[0]]}:{rank:s.HIGH_CARD,value:1e8*s.HIGH_CARD+1e4*n[0]+15*n[1]+n[2],cards:e}}evaluate5CardHand(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank),n=e.map(t=>r(t).rank),a=e.map(t=>r(t).suit),l=1===new Set(a).size,o=[...new Set(n)].sort((t,e)=>e-t);let d=!1,u=0;if(5===o.length&&(o[0]-o[4]===4&&(d=!0,u=o[0]),d||o[0]!==i.ACE||o[1]!==i.FIVE||o[4]!==i.TWO||(d=!0,u=5)),l&&d)return{rank:s.STRAIGHT_FLUSH,value:1e8*s.STRAIGHT_FLUSH+1e4*u,cards:e};const h={};n.forEach(t=>h[t]=(h[t]||0)+1);const c=Object.entries(h).map(([t,e])=>({rank:Number(t),count:e})).sort((t,e)=>e.count-t.count||e.rank-t.rank);if(4===c[0]?.count)return{rank:s.FOUR_OF_A_KIND,value:1e8*s.FOUR_OF_A_KIND+1e4*c[0].rank+c[1].rank,cards:e};if(3===c[0]?.count&&2===c[1]?.count)return{rank:s.FULL_HOUSE,value:1e8*s.FULL_HOUSE+1e4*c[0].rank+c[1].rank,cards:e};if(l){let t=1e8*s.FLUSH;return o.forEach((e,s)=>t+=e*Math.pow(15,4-s)),{rank:s.FLUSH,value:t,cards:e}}if(d)return{rank:s.STRAIGHT,value:1e8*s.STRAIGHT+1e4*u,cards:e};if(3===c[0].count){let t=1e8*s.THREE_OF_A_KIND+1e4*c[0].rank;return c.filter(t=>3!==t.count).sort((t,e)=>e.rank-t.rank).forEach((e,s)=>t+=e.rank*Math.pow(15,1-s)),{rank:s.THREE_OF_A_KIND,value:t,cards:e}}if(2===c[0]?.count&&2===c[1]?.count){const t=Math.max(c[0]?.rank,c[1]?.rank),n=Math.min(c[0]?.rank,c[1]?.rank),a=c.find(t=>1===t.count).rank;return{rank:s.TWO_PAIR,value:1e8*s.TWO_PAIR+1e4*t+15*n+a,cards:e}}if(2===c[0]?.count){let t=1e8*s.PAIR+1e4*c[0].rank;return c.filter(t=>1===t.count).sort((t,e)=>e.rank-t.rank).forEach((e,s)=>t+=e.rank*Math.pow(15,2-s)),{rank:s.PAIR,value:t,cards:e}}let p=1e8*s.HIGH_CARD;return o.forEach((t,e)=>p+=t*Math.pow(15,4-e)),{rank:s.HIGH_CARD,value:p,cards:e}}compareHands(){this.state.gamePhase="comparing";const t=this.state.players.map((t,e)=>({player:t,index:e})).filter(({player:t})=>null!==t.id),e=[];for(let s=0;s<t.length;s++)for(let n=s+1;n<t.length;n++){const a=t[s],r=t[n],i=this.compareTwoPlayers(a.player,a.index,r.player,r.index);e.push(i)}this.state.roundResults=e,this.state.roundEvents=[];for(const s of e)this.state.players[s.p1Index].score+=s.p1Total,this.state.players[s.p2Index].score+=s.p2Total;for(const s of t){const r=e.filter(t=>t.p1Index===s.index||t.p2Index===s.index);if(r.every(t=>t.p1Index===s.index?t.frontResult>0&&t.middleResult>0&&t.backResult>0:t.frontResult<0&&t.middleResult<0&&t.backResult<0)&&r.length>0&&t.length>2){const e=n[a.SCOOP_ALL];s.player.score+=e,this.state.roundEvents.push({playerIndex:s.index,type:"SCOOP_ALL",points:e});for(const n of t)n.index!==s.index&&(this.state.players[n.index].score-=Math.floor(e/(t.length-1)))}}for(const s of t)if(!s.player.usedAuto&&!s.player.isBot&&!s.player.isFouled){e.filter(t=>t.p1Index===s.index||t.p2Index===s.index).reduce((t,e)=>t+(e.p1Index===s.index?e.p1Total:e.p2Total),0)>0&&(s.player.score+=1,this.state.roundEvents.push({playerIndex:s.index,type:"MANUAL_BONUS",points:1}))}this.state.gamePhase="ended"}compareTwoPlayers(t,r,i,l){const o={p1Index:r,p2Index:l,frontResult:0,middleResult:0,backResult:0,p1Bonus:0,p2Bonus:0,p1Total:0,p2Total:0,p1SpecialBonuses:[],p2SpecialBonuses:[],p1InstantWin:t.instantWin,p2InstantWin:i.instantWin,scoopResult:0};if(t.instantWin!==e.NONE&&i.instantWin!==e.NONE)t.instantWin>i.instantWin?(o.frontResult=1,o.middleResult=1,o.backResult=1):t.instantWin<i.instantWin&&(o.frontResult=-1,o.middleResult=-1,o.backResult=-1);else if(t.instantWin!==e.NONE)o.frontResult=1,o.middleResult=1,o.backResult=1;else if(i.instantWin!==e.NONE)o.frontResult=-1,o.middleResult=-1,o.backResult=-1;else if(t.isFouled&&i.isFouled);else if(t.isFouled)o.frontResult=-1,o.middleResult=-1,o.backResult=-1;else if(i.isFouled)o.frontResult=1,o.middleResult=1,o.backResult=1;else{const e=this.evaluate3CardHand(t.front),r=this.evaluate3CardHand(i.front);o.frontResult=e.value>r.value?1:e.value<r.value?-1:0;const l=this.evaluate5CardHand(t.middle),d=this.evaluate5CardHand(i.middle);o.middleResult=l.value>d.value?1:l.value<d.value?-1:0;const u=this.evaluate5CardHand(t.back),h=this.evaluate5CardHand(i.back);o.backResult=u.value>h.value?1:u.value<h.value?-1:0,1===o.frontResult&&e.rank===s.THREE_OF_A_KIND&&(o.p1Bonus+=n[a.THREE_OF_KIND_FRONT],o.p1SpecialBonuses.push(a.THREE_OF_KIND_FRONT)),1===o.middleResult&&(l.rank===s.FULL_HOUSE&&(o.p1Bonus+=n[a.FULL_HOUSE_MIDDLE],o.p1SpecialBonuses.push(a.FULL_HOUSE_MIDDLE)),l.rank===s.FOUR_OF_A_KIND&&(o.p1Bonus+=n[a.FOUR_KIND_MIDDLE],o.p1SpecialBonuses.push(a.FOUR_KIND_MIDDLE)),l.rank===s.STRAIGHT_FLUSH&&(o.p1Bonus+=n[a.STRAIGHT_FLUSH_MIDDLE],o.p1SpecialBonuses.push(a.STRAIGHT_FLUSH_MIDDLE))),1===o.backResult&&(u.rank===s.FOUR_OF_A_KIND&&(o.p1Bonus+=n[a.FOUR_KIND_BACK],o.p1SpecialBonuses.push(a.FOUR_KIND_BACK)),u.rank===s.STRAIGHT_FLUSH&&(o.p1Bonus+=n[a.STRAIGHT_FLUSH_BACK],o.p1SpecialBonuses.push(a.STRAIGHT_FLUSH_BACK))),-1===o.frontResult&&r.rank===s.THREE_OF_A_KIND&&(o.p2Bonus+=n[a.THREE_OF_KIND_FRONT],o.p2SpecialBonuses.push(a.THREE_OF_KIND_FRONT)),-1===o.middleResult&&(d.rank===s.FULL_HOUSE&&(o.p2Bonus+=n[a.FULL_HOUSE_MIDDLE],o.p2SpecialBonuses.push(a.FULL_HOUSE_MIDDLE)),d.rank===s.FOUR_OF_A_KIND&&(o.p2Bonus+=n[a.FOUR_KIND_MIDDLE],o.p2SpecialBonuses.push(a.FOUR_KIND_MIDDLE)),d.rank===s.STRAIGHT_FLUSH&&(o.p2Bonus+=n[a.STRAIGHT_FLUSH_MIDDLE],o.p2SpecialBonuses.push(a.STRAIGHT_FLUSH_MIDDLE))),-1===o.backResult&&(h.rank===s.FOUR_OF_A_KIND&&(o.p2Bonus+=n[a.FOUR_KIND_BACK],o.p2SpecialBonuses.push(a.FOUR_KIND_BACK)),h.rank===s.STRAIGHT_FLUSH&&(o.p2Bonus+=n[a.STRAIGHT_FLUSH_BACK],o.p2SpecialBonuses.push(a.STRAIGHT_FLUSH_BACK)))}const d=[o.frontResult,o.middleResult,o.backResult].filter(t=>t>0).length,u=[o.frontResult,o.middleResult,o.backResult].filter(t=>t<0).length,h=o.frontResult+o.middleResult+o.backResult;let c=0,p=0;return 3===d&&(c=n[a.SCOOP],o.scoopResult=1),3===u&&(p=n[a.SCOOP],o.scoopResult=-1),o.p1Total=h+o.p1Bonus+c-o.p2Bonus-p,o.p2Total=-h+o.p2Bonus+p-o.p1Bonus-c,o}autoArrange(t){const e=this.generateSuggestions(t);return{front:e[0].front,middle:e[0].middle,back:e[0].back}}generateSuggestions(t){const e=[],s=this.arrangeBalanced(t);s&&e.push(this.makeSuggestion(s,{en:"âš–ï¸ Balanced",vi:"âš–ï¸ CÃ¢n báº±ng"}));const n=this.arrangeBackHeavy(t);n&&e.push(this.makeSuggestion(n,{en:"ðŸ’ª Strong Back",vi:"ðŸ’ª Máº¡nh chi Ä‘áº§u"}));const a=this.arrangeFrontHeavy(t);a&&e.push(this.makeSuggestion(a,{en:"ðŸŽ¯ Strong Front",vi:"ðŸŽ¯ Máº¡nh chi cuá»‘i"}));const i=[],l=new Set;for(const r of e){if(!this.isValidArrangement(r.front,r.middle,r.back))continue;const t=[...r.back,...r.middle,...r.front].join(",");l.has(t)||(l.add(t),i.push(r))}if(0===i.length){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank);i.push(this.makeSuggestion({back:e.slice(0,5),middle:e.slice(5,10),front:e.slice(10,13)},{en:"ðŸ“‹ Default",vi:"ðŸ“‹ Máº·c Ä‘á»‹nh"}))}return i}makeSuggestion(t,e){const s=this.evaluate3CardHand(t.front),n=this.evaluate5CardHand(t.middle),a=this.evaluate5CardHand(t.back);return{label:e,front:t.front,middle:t.middle,back:t.back,frontRank:s.rank,middleRank:n.rank,backRank:a.rank}}arrangeBalanced(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank),s=this.groupByRank(e),n=[],a=[],i=[],l=[];if(s.quads.length>0){n.push(...s.quads[0]);for(let t=1;t<s.quads.length;t++)l.push(...s.quads[t])}if(s.trips.length>0){0===n.length?n.push(...s.trips[0]):a.push(...s.trips[0]);for(let t=1;t<s.trips.length;t++)l.push(...s.trips[t])}for(let r=0;r<s.pairs.length;r++)n.length<5&&n.length>=3?n.push(...s.pairs[r]):a.length<5?a.push(...s.pairs[r]):i.length<3?i.push(...s.pairs[r]):l.push(...s.pairs[r]);for(l.push(...s.singles),l.sort((t,e)=>r(e).rank-r(t).rank),this.tryUpgrade5(n,l),this.tryUpgrade5(a,l);n.length<5&&l.length>0;)n.push(l.shift());for(;a.length<5&&l.length>0;)a.push(l.shift());for(;i.length<3&&l.length>0;)i.push(l.shift());return this.sortHand(n),this.sortHand(a),this.sortHand(i),this.isValidArrangement(i,a,n)?{front:i,middle:a,back:n}:this.fixArrangement(t)}arrangeBackHeavy(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank),s=this.findFlush(e,5);if(s){const t=e.filter(t=>!s.includes(t)),n=t.slice(0,5),a=t.slice(5,8);if(this.sortHand(s),this.sortHand(n),this.sortHand(a),this.isValidArrangement(a,n,s))return{front:a,middle:n,back:s}}const n=this.findStraight(e,5);if(n){const t=e.filter(t=>!n.includes(t)),s=t.slice(0,5),a=t.slice(5,8);if(this.sortHand(n),this.sortHand(s),this.sortHand(a),this.isValidArrangement(a,s,n))return{front:a,middle:s,back:n}}const a=this.groupByRank(e),i=[],l=[];for(const r of a.quads)i.push(...r);for(const r of a.trips)i.length<5?i.push(...r):l.push(...r);for(const r of a.pairs)i.length<5?i.push(...r):l.push(...r);for(l.push(...a.singles),l.sort((t,e)=>r(e).rank-r(t).rank);i.length<5&&l.length>0;)i.push(l.shift());for(;i.length>5;)l.unshift(i.pop());const o=l.splice(0,5),d=l.splice(0,3);return this.sortHand(i),this.sortHand(o),this.sortHand(d),this.isValidArrangement(d,o,i)?{front:d,middle:o,back:i}:this.fixArrangement(t)}arrangeFrontHeavy(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank),s=this.groupByRank(e),n=[],a=[];if(s.trips.length>=2){n.push(...s.trips[s.trips.length-1]);for(let t=0;t<s.trips.length-1;t++)a.push(...s.trips[t])}else{if(!(s.pairs.length>=3))return null;n.push(...s.pairs[s.pairs.length-1]);for(let t=0;t<s.pairs.length-1;t++)a.push(...s.pairs[t]);for(const t of s.trips)a.push(...t)}for(const r of s.quads)a.push(...r);for(a.push(...s.singles),a.sort((t,e)=>r(e).rank-r(t).rank);n.length<3&&a.length>0;)n.push(a.shift());const i=a.splice(0,5),l=a.splice(0,5);return this.sortHand(i),this.sortHand(l),this.sortHand(n),this.isValidArrangement(n,l,i)?{front:n,middle:l,back:i}:null}groupByRank(t){const e={};t.forEach(t=>{const{rank:s}=r(t);e[s]||(e[s]=[]),e[s].push(t)});const s=[],n=[],a=[],i=[];return Object.entries(e).sort(([t],[e])=>Number(e)-Number(t)).forEach(([,t])=>{4===t.length?s.push(t):3===t.length?n.push(t):2===t.length?a.push(t):i.push(...t)}),{quads:s,trips:n,pairs:a,singles:i}}findFlush(t,e){const s={};t.forEach(t=>{const{suit:e}=r(t);s[e]||(s[e]=[]),s[e].push(t)});for(const n of Object.values(s))if(n.length>=e)return n.slice(0,e);return null}findStraight(t,e){const s=new Map;t.forEach(t=>{const{rank:e}=r(t);s.has(e)||s.set(e,t)});const n=[...s.keys()].sort((t,e)=>e-t);for(let a=0;a<=n.length-e;a++)if(n[a]-n[a+e-1]===e-1)return n.slice(a,a+e).map(t=>s.get(t));return 5===e&&s.has(i.ACE)&&s.has(i.TWO)&&s.has(i.THREE)&&s.has(i.FOUR)&&s.has(i.FIVE)?[i.ACE,i.FIVE,i.FOUR,i.THREE,i.TWO].map(t=>s.get(t)):null}tryUpgrade5(t,e){if(5!==t.length)return;const s=[...t,...e],n=this.findFlush(s,5);if(n){const a=new Set(n),r=s.filter(t=>!a.has(t));return t.length=0,t.push(...n),e.length=0,void e.push(...r)}}fixArrangement(t){const e=[...t].sort((t,e)=>r(e).rank-r(t).rank);return{back:e.slice(0,5),middle:e.slice(5,10),front:e.slice(10,13)}}sortHand(t){t.sort((t,e)=>r(e).rank-r(t).rank)}calculateTotalPointsForArrangement(t,e){const s=JSON.parse(JSON.stringify(this.state.players)),r=s[t];r.front=e.front,r.middle=e.middle,r.back=e.back,r.instantWin=this.checkInstantWin(r.hand,r.front,r.middle,r.back);const i=this.isValidArrangement(r.front,r.middle,r.back);r.isFouled=!i;let l=0;const o=s.map((t,e)=>({pl:t,idx:e})).filter(({pl:t})=>null!==t.id).map(({idx:t})=>t);for(const n of o){if(n===t)continue;l+=this.compareTwoPlayers(r,t,s[n],n).p1Total}if(o.length>2&&!r.isFouled){let e=!0;for(const n of o){if(n===t)continue;const a=this.compareTwoPlayers(r,t,s[n],n);if(!(a.frontResult>0&&a.middleResult>0&&a.backResult>0)){e=!1;break}}e&&(l+=n[a.SCOOP_ALL])}return l}computePostGameAnalysis(t,s){const n=[];for(let a=0;a<t.length;a++){const r=t[a];if(r.isBot||!r.id||0===r.hand.length)continue;if(r.instantWin!==e.NONE)continue;const i=this.generateSuggestions(r.hand),l=this.calculateTotalPointsForArrangement(s[a],{front:r.front,middle:r.middle,back:r.back});let o=i[0],d=-1/0;for(const t of i){const e=this.calculateTotalPointsForArrangement(s[a],t);e>d&&(d=e,o=t)}d===-1/0&&(d=l,o=this.makeSuggestion({front:r.front,middle:r.middle,back:r.back},{en:"Current",vi:"Hiá»‡n táº¡i"}));const u=this.evaluate3CardHand(r.front),h=this.evaluate5CardHand(r.middle),c=this.evaluate5CardHand(r.back),p=u.value+h.value+c.value,f=this.evaluate3CardHand(o.front),k=this.evaluate5CardHand(o.middle),m=this.evaluate5CardHand(o.back),R=f.value+k.value+m.value;(d>l||R>1.05*p)&&n.push({playerIndex:s[a],actual:{front:r.front,middle:r.middle,back:r.back},optimal:{front:o.front,middle:o.middle,back:o.back},actualScore:Math.round(p/1e4),optimalScore:Math.round(R/1e4),actualPoints:l,optimalPoints:d,actualFrontRank:u.rank,actualMiddleRank:h.rank,actualBackRank:c.rank,optimalFrontRank:f.rank,optimalMiddleRank:k.rank,optimalBackRank:m.rank})}return n}createDeck(){const t=[];for(const e of[l.SPADE,l.CLUB,l.DIAMOND,l.HEART])for(let s=i.TWO;s<=i.ACE;s++)t.push(o(s,e));return t}shuffleDeck(t){for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}addBot(t){const e=this.state.players[t];null===e.id&&(e.id=`BOT_${Date.now()}_${t}`,e.username=`Bot ${t+1}`,e.isBot=!0)}resetGame(){this.clearTimer(),this.state.gamePhase="waiting",this.state.roundResults=[],this.state.timerEndsAt=0,this.state.players.forEach(t=>{t.hand=[],t.front=[],t.middle=[],t.back=[],t.isReady=!1,t.isFouled=!1,t.instantWin=e.NONE,t.usedAuto=!1,null!==t.id&&(t.score=0)})}joinSlot(t,e,s){if(null!==this.state.players[t].id)return;const n=this.state.players.findIndex(t=>t.id===e);-1!==n&&this.removePlayer(n);const a=this.state.players[t];a.id=e,a.username=s,a.isBot=!1}removePlayer(t){const e=this.state.players[t];Object.assign(e,this.createEmptyPlayer(t))}requestStartGame(){this.makeAction({type:"START_GAME"})}requestResetGame(){this.makeAction({type:"RESET_GAME"})}requestAddBot(t){this.makeAction({type:"ADD_BOT",slotIndex:t})}requestRemovePlayer(t){this.makeAction({type:"REMOVE_PLAYER",slotIndex:t})}requestJoinSlot(t,e){this.makeAction({type:"JOIN_SLOT",slotIndex:t,playerId:this.userId,playerName:e})}requestArrangeCards(t,e,s,n){this.makeAction({type:"ARRANGE_CARDS",playerId:this.userId,front:t,middle:e,back:s,isAuto:n})}requestAutoArrange(){this.makeAction({type:"AUTO_ARRANGE",playerId:this.userId})}requestDeclareInstantWin(){this.makeAction({type:"DECLARE_INSTANT_WIN",playerId:this.userId})}destroy(){this.clearTimer(),super.destroy()}}export{d as default};
