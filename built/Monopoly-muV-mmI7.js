import{B as e}from"./BaseGame-bOx6xEpu.js";import{C as t,a as s,S as i,P as a,B as n,M as r,J as o,b as d}from"./types-gixil7wH.js";import{d as h}from"./index-Di-nc6fj.js";import"./socket-DRbsQkF5.js";import"./react-vendor-CVGOeHNa.js";import"./zustand-D55yBrsf.js";class l extends e{chanceCards=[...t].sort(()=>Math.random()-.5);chestCards=[...s].sort(()=>Math.random()-.5);getOutOfJailCards=new Map;getInitState(){const e=[];for(let t=0;t<4;t++){const s=this.players[t];e.push({id:s?.id||null,username:s?.username||`Player ${t+1}`,color:a[t],position:0,money:i,inJail:!1,jailTurns:0,isBankrupt:!1,isBot:!1,moneyHistory:{[Date.now()]:i}})}return{players:e,currentPlayerIndex:0,properties:[],diceValues:null,doublesCount:0,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,pendingAction:null,lastAction:null,logs:{},tradeOffers:[]}}notifyAndBroadcast(){this.state.players.forEach(e=>{e.moneyHistory||(e.moneyHistory={});const t=Object.keys(e.moneyHistory).sort(),s=t[t.length-1];if((s?e.moneyHistory[s]:null)!==e.money){const s=Date.now();if(e.moneyHistory[s]=e.money,t.length>=100){const s=t.length+1-100;for(let i=0;i<s;i++)delete e.moneyHistory[t[i]]}}}),this.syncState()}handleOfferTrade(e,t,s,i){if(!this.isHost)return;if(this.state.tradeOffers.length>=20)return this.addLog({en:"Too many active trade offers. Please cancel or reject some first.",vi:"Quá nhiều lời mời giao dịch. Vui lòng hủy hoặc từ chối bớt."},"alert"),void this.notifyAndBroadcast();const a=this.state.properties.find(e=>e.spaceId===s);if(!a)return;const r=a.ownerId===e,o=a.ownerId===t;if(!r&&!o)return;if(i<0)return;const d={id:Math.random().toString(36).substr(2,9),fromPlayerId:e,toPlayerId:t,propertyId:s,price:i,status:"pending"};this.state.tradeOffers.push(d);const l=this.state.players.find(t=>t.id===e),c=this.state.players.find(e=>e.id===t),u=n[s];r?this.addLog({en:`${l?.username} offered to sell ${h(u?.name)} to ${c?.username} for ${i}đ`,vi:`${l?.username} đề nghị bán ${h(u?.name)} cho ${c?.username} với giá ${i}đ`},"info"):this.addLog({en:`${l?.username} offered to buy ${h(u?.name)} from ${c?.username} for ${i}đ`,vi:`${l?.username} đề nghị mua ${h(u?.name)} từ ${c?.username} với giá ${i}đ`},"info"),this.notifyAndBroadcast(),c?.isBot&&this.botEvaluateTrade(d)}handleRespondTrade(e,t,s){if(!this.isHost)return;const i=this.state.tradeOffers.findIndex(t=>t.id===e);if(-1===i)return;const a=this.state.tradeOffers[i],r=this.state.properties.find(e=>e.spaceId===a.propertyId),o=n[a.propertyId];if(!t||!r){a.status="declined";const t=this.state.players.find(e=>e.id===a.toPlayerId),i=this.state.players.find(e=>e.id===a.fromPlayerId);return s&&(a.responseMessage={en:s,vi:s}),this.addLog({en:`${t?.username} declined the trade offer from ${i?.username}`,vi:`${t?.username} từ chối lời mời giao dịch từ ${i?.username}`},"info"),this.notifyAndBroadcast(),void setTimeout(()=>{const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&"declined"===this.state.tradeOffers[t].status&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())},8e3)}{const e=r.ownerId===a.fromPlayerId,t=e?a.toPlayerId:a.fromPlayerId,s=e?a.fromPlayerId:a.toPlayerId,n=this.state.players.find(e=>e.id===t),d=this.state.players.find(e=>e.id===s);if(!n||!d)return;if(n.money<a.price)return this.addLog({en:`Trade failed: ${n.username} cannot afford ${a.price}đ`,vi:`Giao dịch thất bại: ${n.username} không đủ ${a.price}đ`},"alert"),this.state.tradeOffers.splice(i,1),void this.notifyAndBroadcast();n.money-=a.price,d.money+=a.price,r.ownerId=n.id,a.status="accepted",this.addLog({en:`Trade successful! ${n.username} bought ${h(o?.name)} from ${d.username} for ${a.price}đ`,vi:`Giao dịch thành công! ${n.username} mua ${h(o?.name)} từ ${d.username} giá ${a.price}đ`},"action")}this.state.tradeOffers.splice(i,1),this.notifyAndBroadcast()}handleCancelTrade(e){if(!this.isHost)return;const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())}botEvaluateTrade(e){setTimeout(()=>{const t=this.state.tradeOffers.find(t=>t.id===e.id);if(!t||"pending"!==t.status)return;const s=this.state.players.find(e=>e.id===t.toPlayerId);if(!s||!s.isBot)return;const i=n[t.propertyId];if(!i)return;const a=this.state.properties.find(e=>e.spaceId===t.propertyId),r=a?.ownerId===s.id;let o=0;"property"!==i.type&&"railroad"!==i.type&&"utility"!==i.type||(o=i.price);const d=n.filter(e=>"property"===e.type&&"property"===i.type&&e.color===i.color),l=this.state.properties.filter(e=>e.ownerId===s.id&&d.some(t=>t.id===e.spaceId)).length;d.length>0&&(l>=d.length-1?o*=2.5:l>0&&(o*=1.5));if(r){const e=1.2*o;this.addLog({en:`${s.username} thinks ${h(i?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${h(i?.name)} đáng giá ${e}đ`},"info"),t.price>=e?this.handleRespondTrade(t.id,!0):(t.responseMessage={en:`I want at least ${e.toLocaleString()}đ`,vi:`Tôi muốn ít nhất ${e.toLocaleString()}đ`},this.handleRespondTrade(t.id,!1))}else{const e=1*o,a=s.money>=t.price,n=t.price<=e;this.addLog({en:`${s.username} thinks ${h(i?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${h(i?.name)} đáng giá ${e}đ`},"info"),a&&n?this.handleRespondTrade(t.id,!0):(t.responseMessage=a?{en:`I only pay up to ${e.toLocaleString()}đ`,vi:`Tôi chỉ trả tối đa ${e.toLocaleString()}đ`}:{en:"I don't have enough money",vi:"Tôi không đủ tiền"},this.handleRespondTrade(t.id,!1))}},2e3)}handleSellHouse(e,t){if(!this.isHost)return;const s=n[t],i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!i||i.houses<=0||"property"!==s.type||!s.houseCost)return;i.houses--;const a=Math.floor(.5*s.houseCost),r=this.state.players.find(t=>t.id===e);r&&(r.money+=a,this.addLog({en:`${r.username} sold a house on ${h(s?.name)} for ${a}đ`,vi:`${r.username} bán 1 nhà trên ${h(s?.name)} được ${a}đ`},"action")),this.notifyAndBroadcast()}handleMortgage(e,t){if(!this.isHost)return;const s=n[t],i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!i||i.mortgaged||i.houses>0||"property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type)return;const a=Math.floor(.5*s.price);i.mortgaged=!0;const r=this.state.players.find(t=>t.id===e);r&&(r.money+=a,this.addLog({en:`${r.username} mortgaged ${h(s?.name)} for ${a}đ`,vi:`${r.username} thế chấp ${h(s?.name)} được ${a}đ`},"action")),this.notifyAndBroadcast()}handleUnmortgage(e,t){if(!this.isHost)return;const s=n[t],i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!i||!i.mortgaged||"property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type)return;const a=Math.floor(.5*s.price),r=a+Math.floor(.1*a),o=this.state.players.find(t=>t.id===e);!o||o.money<r||(o.money-=r,i.mortgaged=!1,this.addLog({en:`${o.username} unmortgaged ${h(s?.name)} for ${r}đ`,vi:`${o.username} chuộc ${h(s?.name)} giá ${r}đ`},"action"),this.notifyAndBroadcast())}onSocketGameAction(e){const t=e.action;switch(t.type){case"START_GAME":this.handleStartGame();break;case"ROLL_DICE":this.handleRollDice(t.playerId);break;case"BUY_PROPERTY":this.handleBuyProperty(t.playerId,t.spaceId);break;case"DECLINE_PROPERTY":this.handleDeclineProperty(t.playerId);break;case"BUILD_HOUSE":this.handleBuildHouse(t.playerId,t.spaceId);break;case"PAY_RENT":this.handlePayRent(t.playerId);break;case"PAY_TAX":this.handlePayTax(t.playerId);break;case"USE_CARD":this.handleUseCard(t.playerId);break;case"PAY_JAIL_FINE":this.handlePayJailFine(t.playerId);break;case"END_TURN":this.handleEndTurn(t.playerId);break;case"ADD_BOT":this.handleAddBot(t.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(t.slotIndex);break;case"OFFER_TRADE":this.handleOfferTrade(t.fromPlayerId,t.toPlayerId,t.spaceId,t.price);break;case"RESPOND_TRADE":this.handleRespondTrade(t.offerId,t.accepted,t.message);break;case"CANCEL_TRADE":this.handleCancelTrade(t.offerId);break;case"SELL_HOUSE":this.handleSellHouse(t.playerId,t.spaceId);break;case"MORTGAGE":this.handleMortgage(t.playerId,t.spaceId);break;case"UNMORTGAGE":this.handleUnmortgage(t.playerId,t.spaceId);break;case"RESET_GAME":this.reset()}}addLog(e,t="info"){const s={id:Math.random().toString(36).substr(2,9),message:e,type:t,timestamp:Date.now()};this.state.logs[s.id]=s;const i=Object.keys(this.state.logs);if(i.length>50){const e=i.sort((e,t)=>(this.state.logs[e]?.timestamp||0)-(this.state.logs[t]?.timestamp||0)),t=i.length-50;for(let s=0;s<t;s++)delete this.state.logs[e[s]]}this.state.lastAction=e}handleStartGame(){if(!this.isHost)return;if("waiting"!==this.state.gamePhase)return;this.state.players.filter(e=>null!==e.id).length<2||(this.state={...this.state,gamePhase:"playing",currentPlayerIndex:this.findFirstActivePlayer(),lastAction:{en:"Game started!",vi:"Trò chơi bắt đầu!"},logs:{}},this.addLog({en:"Game started!",vi:"Trò chơi bắt đầu!"},"info"),this.notifyAndBroadcast(),this.checkBotTurn())}findFirstActivePlayer(){for(let e=0;e<this.state.players.length;e++)if(this.state.players[e].id&&!this.state.players[e].isBankrupt)return e;return 0}handleRollDice(e){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;if(this.state.pendingAction)return;const s=Math.floor(6*Math.random())+1,i=Math.floor(6*Math.random())+1;this.state.diceValues=[s,i],this.state.hasRolled=!0,this.addLog({en:"Rolling...",vi:"Đang đổ xí ngầu..."},"info"),this.notifyAndBroadcast(),setTimeout(()=>{this.processDiceResult(e,s,i)},1200)}processDiceResult(e,t,s){const i=this.state.players.find(t=>t.id===e);if(!i)return;const a=t+s,n=t===s;if(n){if(this.state.doublesCount++,this.state.doublesCount>=3)return this.sendToJail(i),this.addLog({en:`${i.username} rolled 3 doubles, goes to jail!`,vi:`${i.username} đổ 3 lần đôi, phải vào tù!`},"alert"),this.endTurn(),void this.notifyAndBroadcast();this.state.canRollAgain=!0}else this.state.canRollAgain=!1;i.inJail?n?(i.inJail=!1,i.jailTurns=0,this.addLog({en:`${i.username} rolled doubles and escapes jail!`,vi:`${i.username} đổ đôi và được ra tù!`},"action"),this.movePlayer(i,a)):(i.jailTurns++,i.jailTurns>=r?(i.money-=o,i.inJail=!1,i.jailTurns=0,this.addLog({en:`${i.username} paid ${o}đ and leaves jail`,vi:`${i.username} trả ${o}đ để ra tù`},"action"),this.movePlayer(i,a)):(this.state.lastAction={en:`${i.username} stays in jail (turn ${i.jailTurns}/${r})`,vi:`${i.username} ở trong tù (lượt ${i.jailTurns}/${r})`},this.state.canRollAgain=!1)):this.movePlayer(i,a),this.notifyAndBroadcast(),this.state.pendingAction||this.checkBotTurn()}movePlayer(e,t){const s=e.position,i=(e.position+t)%40;i<s&&t>0&&(e.money+=d,this.addLog({en:`${e.username} passed GO, collects ${d}đ`,vi:`${e.username} đi qua KHỞI HÀNH, nhận ${d}đ`},"info")),e.position=i,this.handleLanding(e)}handleLanding(e){const t=n[e.position];if(t)switch(t.type){case"go":this.addLog({en:`${e.username} landed on GO`,vi:`${e.username} vào ô KHỞI HÀNH`},"info");break;case"property":case"railroad":case"utility":this.handlePropertyLanding(e,t.id);break;case"tax":this.state.pendingAction={type:"PAY_TAX",amount:t.taxAmount||0},this.addLog({en:`${e.username} must pay ${t.taxAmount}đ tax`,vi:`${e.username} phải nộp thuế ${t.taxAmount}đ`},"alert");break;case"chance":this.drawCard(e,"chance");break;case"chest":this.drawCard(e,"chest");break;case"jail":this.addLog({en:`${e.username} is just visiting jail`,vi:`${e.username} thăm nuôi tù`},"info");break;case"parking":this.addLog({en:`${e.username} landed on Free Parking`,vi:`${e.username} vào Bãi Đỗ Xe`},"info");break;case"gotojail":this.sendToJail(e),this.addLog({en:`${e.username} goes to jail!`,vi:`${e.username} vào tù!`},"alert")}}handlePropertyLanding(e,t){const s=n[t],i=this.state.properties.find(e=>e.spaceId===t);if(i)if(i.ownerId!==e.id)if(i.mortgaged)this.addLog({en:`${e.username} landed on ${h(s.name)} which is mortgaged. No rent!`,vi:`${e.username} vào ${h(s.name)} đang thế chấp. Không cần trả tiền thuê!`},"info");else{const s=this.calculateRent(t,i),a=this.state.players.find(e=>e.id===i.ownerId);a&&!a.isBankrupt&&(this.state.pendingAction={type:"PAY_RENT",amount:s,toPlayerId:i.ownerId},this.addLog({en:`${e.username} owes ${s}đ rent to ${a.username}`,vi:`${e.username} trả ${s}đ tiền thuê cho ${a.username}`},"alert"))}else this.addLog({en:`${e.username} landed on their own property`,vi:`${e.username} vào nhà mình`},"info");else("property"===s.type||"railroad"===s.type||"utility"===s.type)&&s.price&&e.money>=s.price?(this.state.pendingAction={type:"BUY_DECISION",spaceId:t},this.addLog({en:`${e.username} can buy ${h(s?.name)} for ${s.price}đ`,vi:`${e.username} có thể mua ${h(s?.name)} giá ${s.price}đ`},"action")):this.addLog({en:`${e.username} cannot afford ${h(s?.name)}`,vi:`${e.username} không đủ tiền mua ${h(s?.name)}`},"alert")}calculateRent(e,t){const s=n[e];if(!s)return 0;if("railroad"===s.type){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&"railroad"===n[e.spaceId]?.type).length;return(s.baseRent||250)*e}if("utility"===s.type){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&"utility"===n[e.spaceId]?.type).length,i=(this.state.diceValues?.[0]||1)+(this.state.diceValues?.[1]||1);return s.baseRent+(2===e?10*i:4*i)}if("property"!==s.type||!s.rent)return 0;const i=n.filter(e=>"property"===e.type&&e.color===s.color),a=i.filter(e=>this.state.properties.some(s=>s.spaceId===e.id&&s.ownerId===t.ownerId)).length===i.length,r=t.houses;return r>0&&r<=5?s.rent[r]:a?2*s.rent[0]:s.rent[0]}drawCard(e,t){const s="chance"===t?this.chanceCards:this.chestCards,i=s.shift();i&&("GET_OUT_JAIL"!==i.action.type&&s.push(i),this.state.pendingAction={type:"CARD",card:i},this.addLog({en:`${e.username} draws: ${h(i.text)}`,vi:`${e.username} rút thẻ: ${h(i.text)}`},"action"))}sendToJail(e){e.position=10,e.inJail=!0,e.jailTurns=0,this.state.canRollAgain=!1}handleBuyProperty(e,t){if(!this.isHost)return;const s=this.state.players[this.state.currentPlayerIndex];if(!s||s.id!==e)return;const i=this.state.pendingAction;if(!i||"BUY_DECISION"!==i.type||i.spaceId!==t)return;const a=n[t];!a||"property"!==a.type&&"railroad"!==a.type&&"utility"!==a.type||s.money<a.price||(s.money-=a.price,this.state.properties.push({spaceId:t,ownerId:s.id,houses:0,mortgaged:!1}),this.state.pendingAction=null,this.addLog({en:`${s.username} bought ${h(a?.name)} for ${a.price}đ`,vi:`${s.username} đã mua ${h(a?.name)} với giá ${a.price}đ`},"action"),this.notifyAndBroadcast(),this.checkBotTurn())}handleDeclineProperty(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;if(!this.state.pendingAction||"BUY_DECISION"!==this.state.pendingAction.type)return;const s=n[this.state.pendingAction.spaceId];this.state.pendingAction=null,this.addLog({en:`${t.username} declined to buy ${h(s?.name)}`,vi:`${t.username} không mua ${h(s?.name)}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}canBuildHouse(e,t){const s=this.state.players.find(t=>t.id===e);if(!s)return{allowed:!1,reason:{en:"Player not found",vi:"Không tìm thấy người chơi"}};const i=n[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!i||!a||"property"!==i.type||!i.houseCost)return{allowed:!1,reason:{en:"Cannot build here",vi:"Không thể xây ở đây"}};if(a.houses>=5)return{allowed:!1,reason:{en:"Max level reached",vi:"Đã đạt cấp tối đa"}};if(s.money<i.houseCost)return{allowed:!1,reason:{en:"Not enough money",vi:"Không đủ tiền"}};if(a.mortgaged)return{allowed:!1,reason:{en:"Property is mortgaged",vi:"Tài sản đang thế chấp"}};const r=n.filter(e=>"property"===e.type&&e.color===i.color),o=this.state.properties.filter(t=>r.some(e=>e.id===t.spaceId)&&t.ownerId===e);if(o.length!==r.length)return{allowed:!1,reason:{en:"Must own full color set",vi:"Phải sở hữu đủ bộ màu"}};const d=Math.min(...o.map(e=>e.houses));return a.houses>d?{allowed:!1,reason:{en:"Must build evenly",vi:"Phải xây đều các ô"}}:{allowed:!0}}handleBuildHouse(e,t){if(!this.isHost)return;if(!this.canBuildHouse(e,t).allowed)return;const s=this.state.players.find(t=>t.id===e),i=n[t];if("property"!==i.type||!i.houseCost)return;const a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);s.money-=i.houseCost,a.houses++;const r=5===a.houses?"hotel":"house",o=5===a.houses?"khách sạn":"nhà";this.addLog({en:`${s.username} built a ${r} on ${h(i?.name)}`,vi:`${s.username} xây ${o} trên ${h(i?.name)}`},"action"),this.notifyAndBroadcast()}handlePayRent(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;if(!s||"PAY_RENT"!==s.type)return;const i=this.state.players.find(e=>e.id===s.toPlayerId);i&&(t.money>=s.amount?(t.money-=s.amount,i.money+=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ rent to ${i.username}`,vi:`${t.username} trả ${s.amount}đ thuê cho ${i.username}`},"action")):this.handleBankruptcy(t,i),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handlePayTax(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;s&&"PAY_TAX"===s.type&&(t.money>=s.amount?(t.money-=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ tax`,vi:`${t.username} đóng thuế ${s.amount}đ`},"action")):this.handleBankruptcy(t,null),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handleUseCard(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;if(!s||"CARD"!==s.type)return;const i=s.card;switch(this.state.pendingAction=null,i.action.type){case"COLLECT":t.money+=i.action.amount;break;case"PAY":t.money>=i.action.amount?t.money-=i.action.amount:this.handleBankruptcy(t,null);break;case"MOVE":const e=t.position;t.position=i.action.position,t.position<e&&(t.money+=d),this.handleLanding(t);break;case"MOVE_RELATIVE":const s=(t.position+i.action.spaces+40)%40;t.position=s,this.handleLanding(t);break;case"GO_TO_JAIL":this.sendToJail(t);break;case"GET_OUT_JAIL":const a=this.getOutOfJailCards.get(t.id)||0;this.getOutOfJailCards.set(t.id,a+1);break;case"PAY_EACH_PLAYER":{const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id),s=i.action.amount,a=s*e.length;t.money>=a&&(t.money-=a,e.forEach(e=>e.money+=s));break}case"COLLECT_FROM_EACH":{const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id),s=i.action.amount;e.forEach(e=>{e.money>=s&&(e.money-=s,t.money+=s)});break}case"REPAIRS":{const e=this.state.properties.filter(e=>e.ownerId===t.id),s=i.action.perHouse,a=i.action.perHotel;let n=0;e.forEach(e=>{5===e.houses?n+=a:n+=e.houses*s}),t.money>=n?t.money-=n:this.handleBankruptcy(t,null);break}}this.addLog({en:`${t.username}: ${h(i.text)}`,vi:`${t.username}: ${h(i.text)}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}handlePayJailFine(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e||!t.inJail)return;const s=this.getOutOfJailCards.get(e)||0;s>0?(this.getOutOfJailCards.set(e,s-1),t.inJail=!1,t.jailTurns=0,this.addLog({en:`${t.username} used Get Out of Jail Free card`,vi:`${t.username} dùng thẻ Ra tù miễn phí`},"action")):t.money>=o&&(t.money-=o,t.inJail=!1,t.jailTurns=0,this.addLog({en:`${t.username} paid ${o}đ to leave jail`,vi:`${t.username} trả ${o}đ để ra tù`},"action")),this.notifyAndBroadcast()}handleBankruptcy(e,t){e.isBankrupt=!0,this.addLog({en:`${e.username} is bankrupt!`,vi:`${e.username} phá sản!`},"alert"),this.state.properties=this.state.properties.map(s=>s.ownerId===e.id?t?{...s,ownerId:t.id,houses:0}:null:s).filter(Boolean),t&&e.money>0&&(t.money+=e.money),e.money=0;const s=this.state.players.filter(e=>e.id&&!e.isBankrupt);if(1===s.length)this.state.gamePhase="ended",this.state.winner=s[0].id,this.addLog({en:`${s[0].username} wins!`,vi:`${s[0].username} chiến thắng!`},"alert");else{const t=this.state.players[this.state.currentPlayerIndex];t?.id===e.id&&this.endTurn()}}handleEndTurn(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];t&&t.id===e&&(this.state.pendingAction||this.state.hasRolled&&(this.state.canRollAgain&&!t.inJail||this.endTurn()))}endTurn(){this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.doublesCount=0,this.state.diceValues=null,this.state.pendingAction=null;let e=(this.state.currentPlayerIndex+1)%4,t=0;for(;t<4;){const s=this.state.players[e];if(s&&s.id&&!s.isBankrupt)break;e=(e+1)%4,t++}this.state.currentPlayerIndex=e;const s=this.state.players[e];this.addLog({en:`${s?.username}'s turn`,vi:`Lượt của ${s?.username}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}handleAddBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(this.state.players[e].id)return;const t=`bot-${e}-${Date.now()}`,s=[...this.state.players];s[e]={...s[e],id:t,username:`Bot ${e+1}`,isBot:!0},this.state={...this.state,players:s},this.notifyAndBroadcast()}handleRemoveBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(!this.state.players[e].isBot)return;const t=[...this.state.players];t[e]={...t[e],id:null,username:`Player ${e+1}`,isBot:!1},this.state={...this.state,players:t},this.notifyAndBroadcast()}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];e?.isBot&&(e.isBankrupt?this.endTurn():setTimeout(()=>this.executeBotTurn(e),1e3))}executeBotTurn(e){if(!this.isHost||"playing"!==this.state.gamePhase)return;const t=this.state.players.find(t=>t.id===e.id);if(!t||t.isBankrupt)return;const s=e=>{let s=t.money;if(s>=e)return;const i=this.state.properties.filter(e=>e.ownerId===t.id),a=i.filter(e=>e.houses>0);for(const r of a){if(s>=e)break;for(;r.houses>0&&s<e;){const e=n[r.spaceId];this.handleSellHouse(t.id,r.spaceId),s+="property"===e.type&&e.houseCost?e.houseCost/2:0}}if(s<e){const a=i.filter(e=>!e.mortgaged&&0===e.houses);a.sort((e,t)=>{const s=n[e.spaceId],i=n[t.spaceId],a="property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type||!s.price?0:s.price;return("property"!==i.type&&"railroad"!==i.type&&"utility"!==i.type||!i.price?0:i.price)-a});for(const i of a){if(s>=e)break;const a=n[i.spaceId];this.handleMortgage(t.id,i.spaceId),s+="property"!==a.type&&"railroad"!==a.type&&"utility"!==a.type||!a.price?0:a.price/2}}};if(this.state.pendingAction)switch(this.state.pendingAction.type){case"BUY_DECISION":const e=n[this.state.pendingAction.spaceId],i=1e3;return void("property"===e.type&&e?.price&&t.money>=e.price+i?this.handleBuyProperty(t.id,this.state.pendingAction.spaceId):this.handleDeclineProperty(t.id));case"PAY_RENT":return s(this.state.pendingAction.amount),void this.handlePayRent(t.id);case"PAY_TAX":return s(this.state.pendingAction.amount),void this.handlePayTax(t.id);case"CARD":const a=this.state.pendingAction.card;if("PAY"===a.action.type)s(a.action.amount);else if("PAY_EACH_PLAYER"===a.action.type){const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id).length;s(a.action.amount*e)}else a.action.type;return void this.handleUseCard(t.id)}if(t.inJail&&t.money>=o+500&&!this.state.hasRolled)return this.handlePayJailFine(t.id),void setTimeout(()=>this.executeBotTurn(t),500);if(!this.state.hasRolled||this.state.canRollAgain)return this.handleRollDice(t.id),void setTimeout(()=>this.executeBotTurn(t),1500);const i=this.state.properties.filter(e=>e.ownerId===t.id);for(const a of i){const e=n[a.spaceId];if(e&&"property"===e.type&&e.houseCost&&e.color&&a.houses<5&&!a.mortgaged){const s=n.filter(t=>"property"===t.type&&t.color===e.color),r=i.filter(e=>s.some(t=>t.id===e.spaceId)),o=this.canBuildHouse(t.id,a.spaceId);if(r.length===s.length&&"property"===e.type&&e.houseCost&&t.money>=e.houseCost+3e3&&o.allowed)return this.handleBuildHouse(t.id,a.spaceId),void setTimeout(()=>this.executeBotTurn(t),500)}}this.state.pendingAction||this.state.canRollAgain||this.handleEndTurn(t.id)}requestRollDice(){this.makeAction({type:"ROLL_DICE",playerId:this.userId})}requestBuyProperty(e){this.makeAction({type:"BUY_PROPERTY",playerId:this.userId,spaceId:e})}requestDeclineProperty(){this.makeAction({type:"DECLINE_PROPERTY",playerId:this.userId})}requestBuildHouse(e){this.makeAction({type:"BUILD_HOUSE",playerId:this.userId,spaceId:e})}requestPayRent(){this.makeAction({type:"PAY_RENT",playerId:this.userId})}requestPayTax(){this.makeAction({type:"PAY_TAX",playerId:this.userId})}requestUseCard(){this.makeAction({type:"USE_CARD",playerId:this.userId})}requestPayJailFine(){this.makeAction({type:"PAY_JAIL_FINE",playerId:this.userId})}requestEndTurn(){this.makeAction({type:"END_TURN",playerId:this.userId})}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(e){this.makeAction({type:"ADD_BOT",slotIndex:e})}requestRemoveBot(e){this.makeAction({type:"REMOVE_BOT",slotIndex:e})}requestOfferTrade(e,t,s){this.makeAction({type:"OFFER_TRADE",fromPlayerId:this.userId,toPlayerId:e,spaceId:t,price:s})}requestRespondTrade(e,t,s){this.makeAction({type:"RESPOND_TRADE",offerId:e,accepted:t,message:s})}requestResetGame(){this.isHost&&this.makeAction({type:"RESET_GAME"})}requestCancelTrade(e){this.makeAction({type:"CANCEL_TRADE",offerId:e})}requestSellHouse(e){this.makeAction({type:"SELL_HOUSE",playerId:this.userId,spaceId:e})}requestMortgage(e){this.makeAction({type:"MORTGAGE",playerId:this.userId,spaceId:e})}requestUnmortgage(e){this.makeAction({type:"UNMORTGAGE",playerId:this.userId,spaceId:e})}reset(){this.state.players.forEach(e=>{e.id&&(e.position=0,e.money=i,e.inJail=!1,e.jailTurns=0,e.isBankrupt=!1,e.moneyHistory={[Date.now()]:i})}),this.state.properties=[],this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValues=null,this.state.doublesCount=0,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.gamePhase="waiting",this.state.winner=null,this.state.pendingAction=null,this.state.logs={},this.addLog({en:"Game reset!",vi:"Trò chơi được đặt lại!"},"info"),this.getOutOfJailCards.clear(),this.chanceCards=[...t].sort(()=>Math.random()-.5),this.chestCards=[...s].sort(()=>Math.random()-.5),this.notifyAndBroadcast()}updatePlayers(e){this.state.players.forEach((e,t)=>{e.isBot||(e.id=null,e.username=`Player ${t+1}`)});let t=0;for(let s=0;s<4&&!(t>=e.length);s++)this.state.players[s].isBot||(this.state.players[s].id=e[t].id,this.state.players[s].username=e[t].username,t++);this.syncState()}getMyPlayerIndex(){return this.state.players.findIndex(e=>e.id===this.userId)}canStartGame(){return this.state.players.filter(e=>null!==e.id).length>=2}getPlayerProperties(e){return this.state.properties.filter(t=>t.ownerId===e)}}export{l as default};
