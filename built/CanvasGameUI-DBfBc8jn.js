import{c as e,j as t}from"./index-DvVjFfh0.js";import{i as r,P as n,_ as o,p as s}from"./react-vendor-DdoU0YZ6.js";import"./socket-DRbsQkF5.js";import"./zustand-BHVQ_asN.js";import"./chess-DTd62Tay.js";const l=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"],a=[{label:"S",value:3},{label:"M",value:7},{label:"L",value:15}];function i({game:i,currentUserId:c}){const d=r.useRef(null),[u,h]=r.useState(i.getState()),[m,x]=r.useState(!1),[f,g]=r.useState(l[6]),[p,w]=r.useState(5),[b,v]=r.useState([]),[k,j]=r.useState(!1),{confirm:y}=e(),C=r.useRef(new Set),N=r.useRef(new Set),S=r.useRef([]),T=r.useRef(!1),R=r.useRef(u),M=r.useRef(0),E=r.useRef(!1);r.useEffect(()=>{R.current=u},[u]);const P=(e,t)=>{const r=d.current;if(!r)return;const n=r.getContext("2d");n&&(n.clearRect(0,0,r.width,r.height),R.current.strokes.forEach(r=>{if(r.points.length<2)return;let o=r.points.length;r.id===e&&void 0!==t&&(o=Math.max(2,t)),n.strokeStyle=r.color,n.lineWidth=r.width,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(r.points[0].x,r.points[0].y);for(let e=1;e<o;e++)n.lineTo(r.points[e].x,r.points[e].y);n.stroke()}))},I=e=>new Promise(t=>{const r=d.current;if(!r||e.points.length<2)return void t();if(!r.getContext("2d"))return void t();const n=Math.max(e.duration||500,200),o=e.points.length,s=performance.now(),l=r=>{const a=r-s,i=Math.min(a/n,1),c=Math.floor(i*o);P(e.id,c),i<1?requestAnimationFrame(l):t()};requestAnimationFrame(l)});r.useEffect(()=>{const e=setTimeout(()=>{E.current=!0},500);return i.onUpdate(e=>{if(!E.current)return e.strokes.forEach(e=>{C.current.add(e.id),N.current.add(e.id)}),void h(e);e.strokes.filter(e=>!C.current.has(e.id)&&e.playerId!==c).forEach(e=>{S.current.push(e),C.current.add(e.id)}),e.strokes.forEach(e=>{e.playerId===c&&C.current.add(e.id)}),h(e),setTimeout(()=>(async()=>{if(!T.current&&0!==S.current.length){for(T.current=!0;S.current.length>0;){const e=S.current.shift();N.current.has(e.id)||(N.current.add(e.id),await I(e))}T.current=!1,P()}})(),0)}),h(i.getState()),i.requestSync(),()=>clearTimeout(e)},[i,c]),r.useEffect(()=>{T.current||P()},[u.strokes]);const $=e=>{const t=d.current,r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top;return{x:n*(t.width/r.width),y:o*(t.height/r.height)}},U=()=>{if(!m||b.length<2)return x(!1),void v([]);const e=performance.now()-M.current,t={id:`${c}_${Date.now()}`,playerId:c,points:b,color:f,width:p,duration:e};N.current.add(t.id),i.draw(t),x(!1),v([])},q=e=>{const t=d.current,r=t.getBoundingClientRect(),n=e.touches[0]||e.changedTouches[0],o=n.clientX-r.left,s=n.clientY-r.top;return{x:o*(t.width/r.width),y:s*(t.height/r.height)}};return t.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[t.jsx("button",{onClick:()=>j(!0),className:"md:hidden w-8 h-8 rounded-full border-2 border-white",style:{backgroundColor:f},title:"Pick color"}),t.jsx(n,{className:"w-4 h-4 text-slate-400 hidden md:block"}),t.jsx("div",{className:"hidden md:flex items-center gap-1.5",children:l.map(e=>t.jsx("button",{onClick:()=>g(e),className:"w-8 h-8 rounded-full border-2 transition-all "+(f===e?"border-white scale-110":"border-slate-600 hover:scale-105"),style:{backgroundColor:e},title:e},e))}),t.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),a.map(e=>t.jsx("button",{onClick:()=>w(e.value),className:"w-7 h-7 md:w-8 md:h-8 rounded-lg border-2 transition-all flex items-center justify-center text-xs font-bold "+(p===e.value?"border-white bg-slate-600 text-white":"border-slate-600 bg-slate-700 text-slate-400 hover:border-slate-500"),title:`Stroke size: ${e.label}`,children:e.label},e.value)),t.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),t.jsx("button",{onClick:()=>i.undo(),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-yellow-400",title:"Undo last stroke",children:t.jsx(o,{className:"w-4 h-4"})}),t.jsx("button",{onClick:async()=>{await y("Clear canvas for everyone","Clear canvas?")&&i.clear()},className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:"Clear canvas",children:t.jsx(s,{className:"w-4 h-4"})})]}),t.jsx("canvas",{ref:d,width:800,height:600,onMouseDown:e=>{x(!0),M.current=performance.now();const t=$(e);v([t])},onMouseMove:e=>{if(!m)return;const t=$(e);v(e=>[...e,t]);const r=d.current.getContext("2d");b.length>0&&(r.strokeStyle=f,r.lineWidth=p,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(b[b.length-1].x,b[b.length-1].y),r.lineTo(t.x,t.y),r.stroke())},onMouseUp:U,onMouseLeave:U,onTouchStart:e=>{x(!0),M.current=performance.now();const t=q(e);v([t])},onTouchMove:e=>{if(!m)return;const t=q(e);v(e=>[...e,t]);const r=d.current.getContext("2d");b.length>0&&(r.strokeStyle=f,r.lineWidth=p,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(b[b.length-1].x,b[b.length-1].y),r.lineTo(t.x,t.y),r.stroke())},onTouchEnd:()=>{if(!m||b.length<2)return x(!1),void v([]);const e=performance.now()-M.current,t={id:`${c}_${Date.now()}`,playerId:c,points:b,color:f,width:p,duration:e};N.current.add(t.id),i.draw(t),x(!1),v([])},className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none shadow-lg",style:{aspectRatio:"4/3",minHeight:"200px"}}),t.jsxs("div",{className:"text-xs text-slate-500",children:[u.strokes.length," strokes"]}),k&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>j(!1),children:t.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 shadow-xl",onClick:e=>e.stopPropagation(),children:[t.jsx("h3",{className:"text-sm font-medium text-slate-300 mb-3 text-center",children:"Pick a color"}),t.jsx("div",{className:"grid grid-cols-4 gap-3",children:l.map(e=>t.jsx("button",{onClick:()=>{g(e),j(!1)},className:"w-12 h-12 rounded-full border-3 transition-all "+(f===e?"border-white scale-110 ring-2 ring-white/50":"border-slate-600"),style:{backgroundColor:e}},e))})]})})]})}export{i as default};
