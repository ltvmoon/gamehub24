import{B as t}from"./BaseGame-Bk_CJ4n7.js";import"./socket-DRbsQkF5.js";import"./index-Dp6FX8_v.js";import"./react-vendor-DWJY-O-l.js";import"./zustand-DSzZ-G-z.js";class e extends t{isGameOver(t){return t.isGameEnded}getInitState(){return{gridSize:6,horizontalLines:Array(6).fill(null).map(()=>Array(5).fill(!1)),verticalLines:Array(5).fill(null).map(()=>Array(6).fill(!1)),boxes:Array(5).fill(null).map(()=>Array(5).fill(null)),players:[{...this.players[0],color:"red",score:0},{...this.players[1],color:"blue",score:0}],currentPlayerIndex:0,winner:null,isGameEnded:!1,gamePhase:"waiting",lastLine:null,undoRequest:null}}moveHistory=[];onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"PLACE_LINE":this.handlePlaceLine(e.playerId,e.lineType,e.row,e.col);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex);break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId);break;case"APPROVE_UNDO":this.handleApproveUndo();break;case"REJECT_UNDO":this.handleRejectUndo()}}handleAddBot(t){this.state.isGameEnded||this.state.boxes.some(t=>t.some(t=>null!==t))||t<0||t>=2||(this.state.players[t]={...this.state.players[t],id:`BOT_${Date.now()}_${t}`,username:`Bot ${t+1}`,isHost:!1,isBot:!0,color:0===t?"red":"blue",score:0})}handleRemoveBot(t){this.state.isGameEnded||this.state.boxes.some(t=>t.some(t=>null!==t))||t<0||t>=2||this.state.players[t]?.isBot&&(this.state.players[t]=null)}handleStartGame(){this.canStartGame()&&(this.reset(),this.state.gamePhase="playing",this.checkBotTurn())}canStartGame(){return this.state.players.every(t=>null!=t?.id)}handlePlaceLine(t,e,s,i){if("playing"!==this.state.gamePhase)return;const r=this.state.players[this.state.currentPlayerIndex];if(r?.id!==t)return;if(this.state.isGameEnded)return;if("horizontal"===e){if(s<0||s>=this.state.gridSize||i<0||i>=this.state.gridSize-1)return;if(this.state.horizontalLines[s][i])return}else{if(s<0||s>=this.state.gridSize-1||i<0||i>=this.state.gridSize)return;if(this.state.verticalLines[s][i])return}"horizontal"===e?this.state.horizontalLines[s][i]=!0:this.state.verticalLines[s][i]=!0;const a=this.checkCompletedBoxes(e,s,i);this.moveHistory.push({line:{type:e,row:s,col:i},playerId:t,boxesCaptured:a,prevPlayerIndex:this.state.currentPlayerIndex}),a.length>0?a.forEach(e=>{this.state.boxes[e.row][e.col]=t,r.score++}):this.state.currentPlayerIndex=(this.state.currentPlayerIndex+1)%this.state.players.length,this.state.lastLine={type:e,row:s,col:i},this.state.undoRequest=null,this.updateGameStatus(),this.checkBotTurn()}checkBotTurn(){if(this.state.isGameEnded)return;const t=this.state.players[this.state.currentPlayerIndex];t?.isBot&&t.id&&setTimeout(()=>this.executeBotTurn(t.id),800)}executeBotTurn(t){if(this.state.isGameEnded)return;const e=this.state.players[this.state.currentPlayerIndex];if(e?.id!==t)return;const s=this.calculateBestMove(t);s&&this.handlePlaceLine(t,s.lineType,s.row,s.col)}calculateBestMove(t){const e=this.findScoringMove();if(e)return e;const s=this.findSafeMove();return s||this.findRandomMove()}findScoringMove(){for(let t=0;t<this.state.gridSize;t++)for(let e=0;e<this.state.gridSize-1;e++)if(!this.state.horizontalLines[t][e]){this.state.horizontalLines[t][e]=!0;const s=this.checkCompletedBoxes("horizontal",t,e);if(this.state.horizontalLines[t][e]=!1,s.length>0)return{lineType:"horizontal",row:t,col:e}}for(let t=0;t<this.state.gridSize-1;t++)for(let e=0;e<this.state.gridSize;e++)if(!this.state.verticalLines[t][e]){this.state.verticalLines[t][e]=!0;const s=this.checkCompletedBoxes("vertical",t,e);if(this.state.verticalLines[t][e]=!1,s.length>0)return{lineType:"vertical",row:t,col:e}}return null}findSafeMove(){const t=[];for(let e=0;e<this.state.gridSize;e++)for(let s=0;s<this.state.gridSize-1;s++)this.state.horizontalLines[e][s]||t.push({lineType:"horizontal",row:e,col:s});for(let e=0;e<this.state.gridSize-1;e++)for(let s=0;s<this.state.gridSize;s++)this.state.verticalLines[e][s]||t.push({lineType:"vertical",row:e,col:s});for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}for(const e of t)if(!this.doesMoveGiveAwayBox(e))return e;return null}doesMoveGiveAwayBox(t){let e=!1;return"horizontal"===t.lineType?(this.state.horizontalLines[t.row][t.col]=!0,e=this.checkIfAnyBoxHas3Sides(t.lineType,t.row,t.col),this.state.horizontalLines[t.row][t.col]=!1):(this.state.verticalLines[t.row][t.col]=!0,e=this.checkIfAnyBoxHas3Sides(t.lineType,t.row,t.col),this.state.verticalLines[t.row][t.col]=!1),e}checkIfAnyBoxHas3Sides(t,e,s){if("horizontal"===t){if(e>0&&3===this.countBoxSides(e-1,s))return!0;if(e<this.state.gridSize-1&&3===this.countBoxSides(e,s))return!0}else{if(s>0&&3===this.countBoxSides(e,s-1))return!0;if(s<this.state.gridSize-1&&3===this.countBoxSides(e,s))return!0}return!1}countBoxSides(t,e){let s=0;return this.state.horizontalLines[t][e]&&s++,this.state.horizontalLines[t+1][e]&&s++,this.state.verticalLines[t][e]&&s++,this.state.verticalLines[t][e+1]&&s++,s}findRandomMove(){for(let t=0;t<this.state.gridSize;t++)for(let e=0;e<this.state.gridSize-1;e++)if(!this.state.horizontalLines[t][e])return{lineType:"horizontal",row:t,col:e};for(let t=0;t<this.state.gridSize-1;t++)for(let e=0;e<this.state.gridSize;e++)if(!this.state.verticalLines[t][e])return{lineType:"vertical",row:t,col:e};return null}checkCompletedBoxes(t,e,s){const i=[],r=(t,e)=>{const s=this.state.horizontalLines[t][e],i=this.state.horizontalLines[t+1][e],r=this.state.verticalLines[t][e],a=this.state.verticalLines[t][e+1];return s&&i&&r&&a};return"horizontal"===t?(e>0&&r(e-1,s)&&i.push({row:e-1,col:s}),e<this.state.gridSize-1&&r(e,s)&&i.push({row:e,col:s})):(s>0&&r(e,s-1)&&i.push({row:e,col:s-1}),s<this.state.gridSize-1&&r(e,s)&&i.push({row:e,col:s})),i}updateGameStatus(){const t=(this.state.gridSize-1)*(this.state.gridSize-1);if(this.state.players.reduce((t,e)=>t+(e?.score||0),0)===t){this.state.isGameEnded=!0;const t=this.state.players[0],e=this.state.players[1];if(!t||!e)return;t.score>e.score?this.state.winner=t.id:e.score>t.score?this.state.winner=e.id:this.state.winner="draw"}}reset(){this.state.horizontalLines=Array(this.state.gridSize).fill(null).map(()=>Array(this.state.gridSize-1).fill(!1)),this.state.verticalLines=Array(this.state.gridSize-1).fill(null).map(()=>Array(this.state.gridSize).fill(!1)),this.state.boxes=Array(this.state.gridSize-1).fill(null).map(()=>Array(this.state.gridSize-1).fill(null)),this.state.currentPlayerIndex=0,this.state.winner=null,this.state.isGameEnded=!1,this.state.gamePhase="waiting",this.state.lastLine=null,this.state.undoRequest=null,this.state.players.forEach(t=>t&&(t.score=0)),this.moveHistory=[]}handleRequestUndo(t){0!==this.moveHistory.length&&(this.state.players.find(t=>t?.isBot)?this.handleApproveUndo():this.state.undoRequest||(this.state.undoRequest={requesterId:t}))}handleRejectUndo(){this.state.undoRequest=null}handleApproveUndo(){const t=this.moveHistory.pop();if(!t)return void(this.state.undoRequest=null);"horizontal"===t.line.type?this.state.horizontalLines[t.line.row][t.line.col]=!1:this.state.verticalLines[t.line.row][t.line.col]=!1;const e=this.state.players.find(e=>e?.id===t.playerId);e&&(e.score-=t.boxesCaptured.length),t.boxesCaptured.forEach(t=>{this.state.boxes[t.row][t.col]=null}),this.state.currentPlayerIndex=t.prevPlayerIndex,this.state.isGameEnded=!1,this.state.winner=null;const s=this.moveHistory[this.moveHistory.length-1];this.state.lastLine=s?s.line:null,this.state.undoRequest=null}updatePlayers(t){for(let e=0;e<2;e++){const s=t[e];s?this.state.players[e]={id:s.id,username:s.username,isHost:s.isHost,isBot:s.isBot,color:0===e?"red":"blue",score:this.state.players[e]?.score||0}:this.state.players[e]?.isBot||(this.state.players[e]=null)}}requestPlaceLine(t,e,s){const i={type:"PLACE_LINE",lineType:t,row:e,col:s,playerId:this.userId};this.makeAction(i)}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeAction(e)}requestRemoveBot(t){const e={type:"REMOVE_BOT",slotIndex:t};this.makeAction(e)}requestUndo(){const t={type:"REQUEST_UNDO",playerId:this.userId};this.makeAction(t)}approveUndo(){this.makeAction({type:"APPROVE_UNDO"})}rejectUndo(){this.makeAction({type:"REJECT_UNDO"})}requestNewGame(){this.makeAction({type:"RESET"})}requestStartGame(){this.makeAction({type:"START_GAME"})}}export{e as default};
