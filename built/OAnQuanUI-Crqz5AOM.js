import{b as e,u as t,j as n}from"./index-BiWvX6AI.js";import{c as s,Y as r,R as i,z as a,a6 as l,a8 as o,aD as c,ak as u,X as d}from"./react-vendor-CyPxdFQK.js";import{simulateOAnQuanMove as h}from"./OAnQuan-B4oEAyxP.js";import{u as m}from"./useGameState-CG4d3mB9.js";import"./socket-DRbsQkF5.js";import"./zustand-BbtpVoJv.js";import"./BaseGame-iDkECrzW.js";const x=e=>{if(!e)return{x:0,y:0};const t=e.getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}},g=({game:i,currentUserId:g})=>{const y=i,{confirm:v}=e(),{ti:w,ts:j}=t(),[N,q]=s.useState(()=>[...y.snapshot.board]),[k,C]=s.useState(!1),[R,S]=s.useState({count:0}),[P,I]=s.useState(null),[M,T]=s.useState(null),[B,H]=s.useState(!1),z=s.useRef(void 0),$=s.useRef([]),G=s.useRef(N),Q=s.useRef([]),A=s.useRef([]),O=s.useRef([]),W=s.useRef(null),E=s.useRef(null);s.useEffect(()=>{G.current=N},[N]);const L=s.useCallback(async e=>{if(0===$.current.length)return C(!1),void(W.current&&(e(W.current),q(W.current.board),W.current=null));C(!0),O.current=Q.current.map(e=>x(e));const t=$.current.shift();t&&(await _(t.move),e(t.state),q(t.state.board),G.current=t.state.board,L(e))},[y]),V=s.useCallback((e,t)=>{e.lastMove&&e.lastMove!==z.current?($.current.push({move:e.lastMove,state:e}),z.current=e.lastMove,k||L(t)):k||0!==$.current.length?W.current=e:(t(e),q(e.board))},[k,L]),[F]=m(y,V),_=async e=>{const t=[...G.current],{steps:n}=h(t,e.squareId,e.direction);let s=0,i=e.squareId;for(const a of n)if("sow"===a.type){const e=O.current[i]||x(Q.current[i]),t=O.current[a.squareId]||x(Q.current[a.squareId]);if(r.flushSync(()=>{S({count:s})}),E.current){E.current.style.opacity="1";const n=E.current.animate([{left:`${e.x}px`,top:`${e.y}px`,transform:"translate(-50%, -50%)"},{left:`${t.x}px`,top:`${t.y}px`,transform:"translate(-50%, -50%)"}],{duration:300,easing:"linear",fill:"forwards"});await n.finished}else await new Promise(e=>setTimeout(e,300));E.current&&(E.current.style.opacity="0");const n=[...G.current];n[a.squareId]+=1,s--,q(n),G.current=n,T(a.squareId),i=a.squareId}else if("pickup"===a.type){const e=[...G.current];s=a.amount,e[a.squareId]=0,q(e),G.current=e,i=a.squareId,await new Promise(e=>setTimeout(e,150))}else if("capture"===a.type){const t=y.state.players.findIndex(t=>t.id===e.player);if(-1!==t&&A.current[t]){const e=O.current[a.squareId]||x(Q.current[a.squareId]),n=x(A.current[t]),s=[...G.current];if(s[a.squareId]=0,r.flushSync(()=>{q(s),G.current=s,S({count:a.amount}),T(a.squareId)}),E.current){E.current.style.opacity="1";const t=E.current.animate([{left:`${e.x}px`,top:`${e.y}px`,transform:"translate(-50%, -50%)"},{left:`${n.x}px`,top:`${n.y}px`,transform:"translate(-50%, -50%)"}],{duration:500,easing:"ease-in",fill:"forwards"});await t.finished,E.current.style.opacity="0"}else await new Promise(e=>setTimeout(e,300));T(null)}else{const e=[...G.current];e[a.squareId]=0,q(e),G.current=e,await new Promise(e=>setTimeout(e,300))}}},D=e=>{if(!U||k)return;if(0===e||6===e)return;if(0===y.state.board[e])return;const t=0===y.getMyPlayerIndex()?[7,11]:[1,5];e<t[0]||e>t[1]||I(P===e?null:e)},K=e=>{null!==P&&(y.requestMove(P,e),I(null))},U=F.currentTurn===g,Y=y.getMyPlayerIndex(),J=F.players[0],X=F.players[1],Z=e=>{const t=F.players[e];if(!t)return w({en:"Waiting for player...",vi:"Chờ người chơi tham gia..."});let n=t.username;return t.id===g&&(n+=w({en:" (You)",vi:" (Bạn)"})),n};return n.jsxs("div",{className:"flex flex-col items-center justify-center p-4 w-full max-w-4xl mx-auto touch-none @md:min-h-[500px] pb-16!",children:[r.createPortal(n.jsx("div",{ref:E,className:"fixed z-100 pointer-events-none",style:{opacity:0,width:"40px",height:"40px",left:0,top:0},children:n.jsx("div",{className:"w-full h-full relative",children:n.jsx(b,{count:R.count})})}),document.body),n.jsxs("div",{className:"flex flex-col items-center",children:[n.jsx("div",{className:"text-xl font-bold bg-slate-700 px-4 py-1 rounded-full mb-2",children:"waiting"===F.gamePhase?F.players.length<2?w({en:"Wait for player to join...",vi:"Chờ người chơi tham gia..."}):w({en:"Wait for host to start game...",vi:"Chờ chủ phòng bắt đầu game..."}):F.winner?w({en:"GAME OVER",vi:"KẾT THÚC"}):null}),F.winner&&n.jsxs("div",{className:"text-green-400 font-bold animate-pulse mb-4",children:[w({en:"Winner: ",vi:"Người thắng: "}),F.players.find(e=>e.id===F.winner)?.username]})]}),y.isHost&&n.jsxs("div",{className:"mb-2 flex gap-4 flex-wrap justify-center",children:["waiting"===F.gamePhase&&F.players.length>=2&&n.jsxs("button",{onClick:()=>y.requestStartGame(),className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow",children:[n.jsx(a,{size:16})," ",w({en:"Start Game",vi:"Bắt đầu"})]}),"waiting"!==F.gamePhase&&n.jsxs("button",{onClick:async()=>{(F.winner||await v(j({en:"Are you sure you want to reset the game?",vi:"Bạn có chắc chắn muốn chơi lại không?"}),j({en:"Reset Game",vi:"Chơi lại"})))&&(y.requestResetGame(),T(null),I(null))},className:"flex items-center gap-2 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded shadow",children:[n.jsx(l,{size:16})," ",w({en:"Reset Game",vi:"Chơi lại"})]})]}),n.jsxs("div",{className:"flex flex-col items-center gap-2 justify-center",children:[n.jsxs("div",{ref:e=>{A.current[0]=e},className:"p-2 rounded border-2 "+(F.currentTurn===J?.id?"bg-yellow-600 border-yellow-400 animate-bounce":"bg-slate-700/50 border-transparent"),children:[n.jsx("div",{className:"text-lg",children:Z(0)}),n.jsx("div",{className:"text-2xl font-mono text-yellow-300 text-center",children:F.playerScores[J?.id]||0})]}),n.jsxs("div",{className:"relative bg-amber-100 p-2 @md:p-4 rounded-xl select-none overflow-x-auto max-w-full",children:[n.jsxs("div",{className:"flex flex-row items-center gap-2 justify-center",children:[n.jsx(f,{count:N[0],onClick:()=>{},isMandarin:!0,forwardRef:e=>Q.current[0]=e,left:!0}),n.jsxs("div",{className:"flex flex-col @md:gap-2 gap-1",children:[n.jsx("div",{className:"flex @md:gap-2 gap-1",children:[11,10,9,8,7].map(e=>n.jsx(p,{idx:e,count:N[e],playerOwner:0,isSelectable:U&&0===Y&&!k&&N[e]>0,isSelected:P===e,isHighlighted:M===e,onClick:()=>D(e),forwardRef:t=>Q.current[e]=t},e))}),n.jsx("div",{className:"flex @md:gap-2 gap-1",children:[1,2,3,4,5].map(e=>n.jsx(p,{idx:e,count:N[e],playerOwner:1,isSelectable:U&&1===Y&&!k&&N[e]>0,isSelected:P===e,isHighlighted:M===e,onClick:()=>D(e),forwardRef:t=>Q.current[e]=t},e))})]}),n.jsx(f,{count:N[6],onClick:()=>{},isMandarin:!0,forwardRef:e=>Q.current[6]=e,isHighlighted:6===M})]}),null!==P&&n.jsxs("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 z-10 rounded-xl gap-2",onClick:()=>I(null),children:[n.jsx("button",{onClick:()=>K("left"),className:"p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors",children:n.jsx(o,{size:32})}),n.jsx("button",{onClick:()=>K("right"),className:"p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors",children:n.jsx(c,{size:32})})]})]}),n.jsxs("div",{ref:e=>{A.current[1]=e},className:"p-2 rounded border-2 "+(F.currentTurn===X?.id?"bg-yellow-600 border-yellow-400 animate-bounce":"bg-slate-700/50 border-transparent"),children:[n.jsx("div",{className:"text-lg",children:Z(1)}),n.jsx("div",{className:"text-2xl font-mono text-yellow-300 text-center",children:F.playerScores[X?.id]||0}),y.isHost&&"waiting"===F.gamePhase&&n.jsxs("div",{className:"flex items-center justify-center gap-2 mt-1",children:[F.players.length<2&&n.jsx("button",{onClick:()=>y.requestAddBot(F.players.length),className:"px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs flex items-center gap-1",children:"+Bot"}),F.players.length>=2&&F.players[1]?.isBot&&n.jsxs("button",{onClick:()=>y.requestRemoveBot(1),className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs flex items-center gap-1",children:["- ",w({en:"Remove Bot",vi:"Xóa Bot"})]})]})]})]}),n.jsx("button",{onClick:()=>H(!0),className:"absolute bottom-2 right-2 p-3 bg-slate-700 hover:bg-slate-600 rounded-full text-yellow-500 transition-colors z-20",title:j({en:"Rules",vi:"Luật chơi"}),children:n.jsx(u,{size:20})}),B&&r.createPortal(B?n.jsx("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/80 p-4",children:n.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl max-w-lg w-full max-h-[85vh] overflow-y-auto shadow-2xl relative",children:[n.jsxs("div",{className:"flex justify-between sticky top-0 p-4 pr-2 bg-slate-900",children:[n.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[n.jsx(u,{className:"w-6 h-6 text-yellow-500"}),w({en:"Game Rules: O An Quan",vi:"Luật Chơi: Ô Ăn Quan"})]}),n.jsx("button",{onClick:()=>H(!1),className:"p-2 hover:bg-white/10 rounded-full transition-colors text-slate-400 hover:text-white",children:n.jsx(d,{className:"w-5 h-5"})})]}),n.jsx("div",{className:"p-4 pt-0 space-y-4 text-slate-300 leading-relaxed",children:n.jsxs("div",{className:"space-y-4",children:[n.jsx("p",{children:w({en:"O An Quan (Mandarin Square Capturing) is a traditional Vietnamese board game for two players. The goal is to capture as many stones as possible.",vi:"Ô Ăn Quan là trò chơi dân gian Việt Nam dành cho 2 người. Mục tiêu là ăn được càng nhiều quân càng tốt."})}),n.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:w({en:"Setup",vi:"Thiết lập"})}),n.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[n.jsx("li",{children:w({en:"Board: 10 'Rice Fields' (squares) and 2 'Mandarin Squares' (semicircles at ends).",vi:"Bàn cờ: 10 ô 'Ruộng' và 2 ô 'Quan' (bán nguyệt ở hai đầu)."})}),n.jsx("li",{children:w({en:"Stones: 5 small stones in each Rice Field. 1 big stone (worth 10) in each Mandarin Square.",vi:"Quân: 5 quân dân ở mỗi ruộng. 1 quân quan (giá trị 10) ở mỗi ô quan."})})]}),n.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:w({en:"How to Play",vi:"Cách chơi"})}),n.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[n.jsx("li",{children:w({en:"Players take turns. Valid moves must start from a Rice Field on your side (Player 1: Top, Player 2: Bottom).",vi:"Người chơi lần lượt đi. Nước đi phải bắt đầu từ ô Ruộng phía mình (P1: Trên, P2: Dưới)."})}),n.jsx("li",{children:w({en:"Choose a square with stones and a direction (Left or Right).",vi:"Chọn một ô có quân và hướng đi (Trái hoặc Phải)."})}),n.jsx("li",{children:w({en:"Stones are distributed one by one into subsequent squares.",vi:"Các quân sẽ được rải lần lượt vào từng ô tiếp theo."})}),n.jsx("li",{children:w({en:"If the last stone lands in a square with stones, pick them all up and continue distributing.",vi:"Nếu quân cuối cùng rơi vào ô có quân, bốc hết quân ở đó lên và tiếp tục rải."})}),n.jsx("li",{children:w({en:"If the last stone lands in an empty square, and the next square has stones, you CAPTURE those stones.",vi:"Nếu quân cuối rơi vào ô trống, và ô kế tiếp có quân, bạn sẽ ĂN số quân đó."})}),n.jsx("li",{children:w({en:"Turn ends when the last stone lands in an empty square followed by another empty square, or hits a Mandarin square.",vi:"Lượt đi kết thúc khi quân cuối rơi vào ô mà ô kế tiếp cũng trống, hoặc rơi vào ô Quan."})})]}),n.jsx("h3",{className:"text-lg font-bold text-yellow-400 mt-4",children:w({en:"Winning",vi:"Chiến thắng"})}),n.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[n.jsx("li",{children:w({en:"Game ends when both Mandarin Squares are empty.",vi:"Trò chơi hết khi 2 ô Quan đều trống."})}),n.jsx("li",{children:w({en:"Remaining stones on player's side belong to them.",vi:"Số quân còn lại trong ruộng của ai thuộc về người đó."})}),n.jsx("li",{children:w({en:"Player with the highest score wins.",vi:"Người có tổng điểm cao nhất sẽ thắng."})})]})]})})]})}):null,document.body)]})},p=i.memo(({count:e,isSelectable:t,isSelected:s,isHighlighted:r,onClick:i,forwardRef:a})=>n.jsxs("div",{ref:a,onClick:i,className:`\n                w-10 h-10 @md:w-16 @md:h-16 flex items-center justify-center rounded-lg border-2 relative transition-all\n                ${s?"border-yellow-400 ring-2 ring-yellow-400 bg-amber-200 z-10":t?"border-green-500 ring-2 ring-green-400/50 bg-green-50 cursor-pointer hover:bg-green-100 hover:scale-105 z-0":"border-amber-700 bg-amber-50 cursor-default opacity-90"}\n            `,children:[n.jsx(b,{count:e,isHighlighted:r}),n.jsx("div",{className:"absolute bottom-0 right-0 text-[10px] text-amber-900 p-0.5",children:e})]}),(e,t)=>e.count===t.count&&e.isSelectable===t.isSelectable&&e.isSelected===t.isSelected&&e.isHighlighted===t.isHighlighted&&e.playerOwner===t.playerOwner),f=i.memo(({count:e,forwardRef:t,left:s,isHighlighted:r})=>n.jsxs("div",{ref:t,className:`\n             w-16 h-24 @md:w-20 @md:h-32 flex flex-col items-center justify-center ${s?"rounded-l-full":"rounded-r-full"} border-2 border-amber-900\n             bg-amber-400 text-white font-bold text-xl relative shadow-inner\n        `,children:[n.jsx("div",{className:"text-white drop-shadow-md z-1",children:n.jsx(b,{count:e,isBig:!0,isHighlighted:r})}),n.jsx("div",{className:"absolute bottom-2 text-xs opacity-70 text-amber-900",children:e})]}),(e,t)=>e.count===t.count&&e.isHighlighted===t.isHighlighted&&e.left===t.left),b=i.memo(({count:e,isBig:t,isHighlighted:s})=>{const r=Math.min(e,30),i=Array.from({length:r});return n.jsx("div",{className:"flex flex-wrap justify-center items-center content-center w-full h-full p-1 gap-0.5 "+(s?"scale-110 bg-green-400/50 rounded-lg shadow-[0_0_10px_rgba(74,222,128,0.8)]":"transition-transform duration-200"),children:i.map((s,r)=>n.jsx("div",{className:`\n                    rounded-full shadow-sm border border-black/10\n                    ${t&&r<Math.floor(e/10)?"w-4 h-4 bg-red-500":"w-2 h-2 @md:w-2.5 @md:h-2.5 bg-slate-700"}\n                 `},r))})});export{g as default};
