import{a as e,u as t,j as n}from"./index-D69VEbX5.js";import{c as s,a9 as a,a3 as l,aa as i,ac as r}from"./react-vendor-BYtLKAeB.js";import"./socket-DRbsQkF5.js";import{e as o,B as c,T as u,a as d,P as h,b as x}from"./types-BG1nVOgd.js";import"./zustand-BLoNJECv.js";function m({game:m}){const f=m,[g,y]=s.useState(f.getState()),{username:p}=e(),{ti:b}=t(),v=s.useRef(null),w=s.useRef(null),j=s.useRef(f.getState().balls),P=s.useRef(new Map),S=s.useRef([]),M=s.useRef(new Set),[N,k]=s.useState(!1),[T,A]=s.useState(0),[B,R]=s.useState(0),[E,C]=s.useState(null),[I,L]=s.useState(1),F=f.isMyTurn(),q=s.useRef(()=>{}),W=s.useRef(!1);W.current=N;const Y=s.useRef(0);Y.current=T;const D=s.useRef(0);D.current=B,s.useEffect(()=>{const e=()=>{if(w.current){const e=w.current.clientWidth-16,t=Math.min(1,e/u);L(t)}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const X=s.useRef({isAiming:N,aimAngle:T,aimPower:B,mousePos:E});X.current={isAiming:N,aimAngle:T,aimPower:B,mousePos:E};const H=s.useRef(I);H.current=I;const G=s.useCallback((e,t,n)=>{const s=o[t.id]||"#FFF";n&&(e.save(),e.shadowColor=n,e.shadowBlur=15,e.fillStyle=n,e.globalAlpha=.6,e.beginPath(),e.arc(t.x,t.y,c+4,0,2*Math.PI),e.fill(),e.restore()),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,c,0,2*Math.PI),e.fill(),e.fillStyle=s,e.beginPath(),e.arc(t.x,t.y,c,0,2*Math.PI),e.fill(),t.id>=9&&t.id<=15&&(e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,.7*c,0,2*Math.PI),e.fill()),0!==t.id&&(e.fillStyle=t.id>=9&&t.id<=15?"black":"white",e.font=`bold ${c}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(t.id.toString(),t.x,t.y)),e.fillStyle="rgba(255, 255, 255, 0.3)",e.beginPath(),e.arc(t.x-.3*c,t.y-.3*c,.3*c,0,2*Math.PI),e.fill()},[]),z=s.useCallback(()=>{const e=v.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const n=H.current,{isAiming:s,aimAngle:a,aimPower:l}=X.current;e.width=u*n,e.height=d*n,t.save(),t.scale(n,n),t.fillStyle="#1a472a",t.fillRect(0,0,u,d),t.strokeStyle="#5d3a1a",t.lineWidth=20,t.strokeRect(10,10,u-20,d-20),t.fillStyle="#111";for(const o of h)t.beginPath(),t.arc(o.x,o.y,x,0,2*Math.PI),t.fill();P.current.forEach((e,n)=>{if(e.length<2)return;const s=o[n]||"#FFF";for(let a=0;a<e.length;a++){const n=e[a],l=a/e.length*.4;t.beginPath(),t.arc(n.x,n.y,c,0,2*Math.PI),t.fillStyle=s,t.globalAlpha=l,t.fill(),t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(n.x-.3*c,n.y-.3*c,.3*c,0,2*Math.PI),t.globalAlpha=l,t.fill()}t.globalAlpha=1});const i=f.getState(),r=f.getMySlot(),m=r===i.currentTurn&&"playing"===i.gamePhase&&!i.isSimulating,g=r?i.players[r].ballType:null,y=g&&0===j.current.filter(e=>!e.pocketed&&e.type===g).length;for(const o of j.current){if(o.pocketed)continue;let e;m&&(0===o.id?e="#00ff88":g&&(y&&8===o.id?e="#ffcc00":o.type===g&&(e="#00aaff"))),G(t,o,e)}const p=j.current.find(e=>0===e.id&&!e.pocketed);if(s&&p&&l>0){let e=p.x,n=p.y,s=a,i=2e3;const r=4;t.beginPath(),t.moveTo(e,n);for(let a=0;a<r;a++){let l=i,r={x:e+Math.cos(s)*l,y:n+Math.sin(s)*l},o=null,h=null,x={x:0,y:0};const m=Math.cos(s),f=Math.sin(s);if(m>0){const t=(u-c-e)/m;t>0&&t<l&&(l=t,r={x:u-c,y:n+t*f},o="wall",x={x:-1,y:0})}else if(m<0){const t=(c-e)/m;t>0&&t<l&&(l=t,r={x:c,y:n+t*f},o="wall",x={x:1,y:0})}if(f>0){const t=(d-c-n)/f;t>0&&t<l&&(l=t,r={x:e+t*m,y:d-c},o="wall",x={x:0,y:-1})}else if(f<0){const t=(c-n)/f;t>0&&t<l&&(l=t,r={x:e+t*m,y:c},o="wall",x={x:0,y:1})}for(const t of j.current){if(0===t.id||t.pocketed)continue;const s=e-t.x,a=n-t.y,i=2*(m*s+f*a),u=i*i-4*(s*s+a*a-4*c*c);if(u>=0){const s=(-i-Math.sqrt(u))/2,a=(-i+Math.sqrt(u))/2;let c=-1;s>.001?c=s:a>.001&&(c=a),c>0&&c<l&&(l=c,r={x:e+c*m,y:n+c*f},o="ball",h=t)}}if(t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.setLineDash([5,5]),t.lineTo(r.x,r.y),t.stroke(),t.beginPath(),t.moveTo(r.x,r.y),t.save(),t.beginPath(),t.arc(r.x,r.y,c,0,2*Math.PI),t.fillStyle="rgba(255, 255, 255, 0.2)",t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1,t.setLineDash([]),t.stroke(),t.fillStyle="rgba(255, 255, 255, 0.8)",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText((a+1).toString(),r.x,r.y),t.restore(),"ball"===o&&h){const e=Math.atan2(h.y-r.y,h.x-r.x);t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=2,t.setLineDash([]),t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(h.x+75*Math.cos(e),h.y+75*Math.sin(e)),t.stroke();break}if("wall"!==o)break;{const t=.7;let a=Math.cos(s),o=Math.sin(s);if(0!==x.x?a=-a*t:o=-o*t,s=Math.atan2(o,a),e=r.x+.1*x.x,n=r.y+.1*x.y,i-=l,i<=0)break}}const o=200,h=c+5+50*l,x=p.x-Math.cos(a)*h,m=p.y-Math.sin(a)*h,f=x-Math.cos(a)*o,g=m-Math.sin(a)*o;t.strokeStyle="#8B4513",t.lineWidth=6,t.lineCap="round",t.beginPath(),t.moveTo(x,m),t.lineTo(f,g),t.stroke(),t.fillStyle="#E6D5B8",t.beginPath(),t.arc(x,m,4,0,2*Math.PI),t.fill()}const b=performance.now(),w=[];for(const o of S.current){const e=(b-o.startTime)/o.duration;if(e<1){w.push(o);for(let n=0;n<5;n++){const s=Math.max(0,e-.15*n);if(s>0&&s<1){const e=x+40*s,n=.6*(1-s);t.strokeStyle="white",t.globalAlpha=n,t.lineWidth=3-2*s,t.beginPath(),t.arc(o.x,o.y,e,0,2*Math.PI),t.stroke()}}t.globalAlpha=1}}S.current=w,t.restore()},[G]);q.current=z,s.useEffect(()=>{z()},[z,g,N,T,B,I]),s.useEffect(()=>{const e=f.onUpdate(e=>{y(e),j.current=e.balls,("waiting"===e.gamePhase||1===e.currentTurn&&"playing"===e.gamePhase&&!e.lastShot)&&P.current.clear(),q.current()});return f.onFrame(e=>{const t=new Set(e.filter(e=>e.pocketed).map(e=>e.id));for(const n of e)if(n.pocketed&&!M.current.has(n.id))for(const e of h){const t=n.x-e.x,s=n.y-e.y;if(Math.sqrt(t*t+s*s)<2*x){const t=o[n.id]||"#FFF";S.current.push({x:e.x,y:e.y,color:t,startTime:performance.now(),duration:2e3});break}}M.current=t,j.current=e}),()=>{e()}},[f]),s.useEffect(()=>{let e;const t=()=>{const n=j.current;for(const e of n){const t=P.current.get(e.id)||[];Math.sqrt(e.vx*e.vx+e.vy*e.vy)>.2&&!e.pocketed?(t.push({x:e.x,y:e.y}),t.length>20&&t.shift(),P.current.set(e.id,t)):t.length>0&&(t.shift(),0===t.length?P.current.delete(e.id):P.current.set(e.id,t))}q.current(),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>{cancelAnimationFrame(e)}},[]);const O=s.useCallback((e,t)=>{const n=v.current;if(!n)return null;const s=n.getBoundingClientRect();return{x:(e-s.left)/I,y:(t-s.top)/I}},[I]),$=e=>{if(!F||g.isSimulating)return;const t=j.current.find(e=>0===e.id&&!e.pocketed);if(!t)return;const n="touches"in e?e.touches[0].clientX:e.clientX,s="touches"in e?e.touches[0].clientY:e.clientY,a=O(n,s);if(!a)return;const l=a.x-t.x,i=a.y-t.y;Math.sqrt(l*l+i*i)<5*c&&(e.preventDefault(),k(!0),C(a))},U=s.useCallback((e,t)=>{const n=j.current.find(e=>0===e.id&&!e.pocketed);if(!n)return;const s=O(e,t);if(!s)return;C(s);const a=Math.atan2(s.y-n.y,s.x-n.x)+Math.PI;A(a);const l=s.x-n.x,i=s.y-n.y,r=Math.sqrt(l*l+i*i),o=Math.min(1,r/200);R(o)},[O]),V=e=>{if(!N)return;e.preventDefault();const t="touches"in e?e.touches[0].clientX:e.clientX,n="touches"in e?e.touches[0].clientY:e.clientY;U(t,n)},J=s.useCallback(()=>{D.current>.05&&(P.current.clear(),f.shoot(Y.current,D.current)),k(!1),R(0),C(null)},[f]);s.useEffect(()=>{const e=e=>{W.current&&U(e.clientX,e.clientY)},t=()=>{W.current&&J()},n=e=>{W.current&&e.touches.length>0&&U(e.touches[0].clientX,e.touches[0].clientY)},s=()=>{W.current&&J()};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),document.addEventListener("touchmove",n,{passive:!1}),document.addEventListener("touchend",s),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t),document.removeEventListener("touchmove",n),document.removeEventListener("touchend",s)}},[U,J]);const K=e=>{const t=g.players[e];return t.id?"BOT"===t.id?"Bot ü§ñ":t.id===f.userId?p||b({en:"You",vi:"B·∫°n"}):t.username||b({en:"Player",vi:"Ng∆∞·ªùi ch∆°i"})+" "+e:b({en:"(waiting...)",vi:"(ƒëang ch·ªù...)"})},Q=e=>{const t=g.players[e].ballType;return t?b("solid"===t?{en:"(Solids 1-7)",vi:"(Tr∆°n 1-7)"}:{en:"(Stripes 9-15)",vi:"(S·ªçc 9-15)"}):""};return n.jsxs("div",{className:"flex flex-col items-center gap-4 p-4 w-full max-w-4xl mx-auto",ref:w,children:[n.jsxs("div",{className:"flex flex-col gap-2 p-4 bg-slate-800 rounded-lg w-full max-w-[500px]",children:[n.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-1",children:"Players"}),[1,2].map(e=>{const t=g.players[e],s=g.currentTurn===e&&"playing"===g.gamePhase,l=t.id===f.userId,i="BOT"===t.id;return n.jsxs("div",{className:`\n                flex items-center justify-between p-3 rounded-lg\n                ${s?"bg-slate-600 ring-2 ring-blue-400":"bg-slate-700"}\n              `,children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-6 h-6 rounded-full "+(1===e?"bg-blue-500":"bg-red-500")}),n.jsxs("div",{children:[n.jsxs("span",{className:"text-white font-medium",children:[K(e),l&&t.id&&b({en:" (You)",vi:" (B·∫°n)"})]}),n.jsx("span",{className:"text-gray-400 text-sm ml-2",children:Q(e)})]})]}),i&&f.isHost&&"waiting"===g.gamePhase&&n.jsx("button",{onClick:()=>f.removeBot(),className:"text-xs px-2 py-1 bg-red-600 hover:bg-red-500 text-white rounded transition-colors",children:b({en:"Remove",vi:"X√≥a"})}),!t.id&&f.isHost&&2===e&&"waiting"===g.gamePhase&&n.jsxs("button",{onClick:()=>f.addBot(),className:"text-xs px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded transition-colors flex items-center gap-1",children:[n.jsx(a,{className:"w-3 h-3"})," ",b({en:"Add Bot",vi:"Th√™m Bot"})]})]},e)})]}),"waiting"===g.gamePhase&&f.isHost&&n.jsx("div",{className:"flex flex-col items-center gap-2",children:f.canStartGame()?n.jsxs("button",{onClick:()=>f.startGame(),className:"px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg text-white font-medium transition-colors flex items-center gap-2",children:[n.jsx(l,{className:"w-5 h-5"}),b({en:"Start Game",vi:"B·∫Øt ƒë·∫ßu"})]}):n.jsx("span",{className:"text-sm text-slate-400",children:b({en:"Waiting for opponent to join...",vi:"ƒêang ch·ªù ƒë·ªëi th·ªß tham gia..."})})}),"playing"===g.gamePhase&&f.isHost&&!g.isSimulating&&n.jsxs("button",{onClick:()=>f.requestReset(),className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300 text-sm font-medium transition-colors flex items-center gap-2",children:[n.jsx(i,{className:"w-4 h-4"}),b({en:"New Game",vi:"V√°n m·ªõi"})]}),"waiting"===g.gamePhase&&!f.isHost&&n.jsx("div",{className:"text-sm text-slate-400",children:b({en:"Waiting for host to start the game...",vi:"ƒêang ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu..."})}),"playing"===g.gamePhase&&!g.winner&&n.jsx("div",{className:"text-lg text-gray-400",children:g.isSimulating?n.jsx("span",{className:"text-yellow-400",children:b({en:"Balls in motion...",vi:"B√≥ng ƒëang lƒÉn..."})}):F?n.jsxs("span",{className:"text-green-400 flex items-center gap-2",children:[n.jsx(r,{className:"w-5 h-5"}),b({en:"Your turn! Click near the cue ball and drag to aim.",vi:"L∆∞·ª£t c·ªßa b·∫°n! Nh·∫•p v√†o b√≥ng tr·∫Øng v√† k√©o ƒë·ªÉ ng·∫Øm."})]}):n.jsx("span",{children:b({en:"Waiting for opponent...",vi:"ƒêang ch·ªù ƒë·ªëi th·ªß..."})})}),g.turnMessage&&n.jsx("div",{className:"text-yellow-400 text-sm",children:g.turnMessage}),n.jsx("div",{className:"relative bg-slate-900 p-2 rounded-xl shadow-2xl overflow-hidden",children:n.jsx("canvas",{ref:v,width:u*I,height:d*I,className:"rounded-lg cursor-crosshair block",style:{touchAction:"none"},onMouseDown:$,onMouseMove:V,onTouchStart:$,onTouchMove:V})}),N&&n.jsxs("div",{className:"w-full max-w-xs",children:[n.jsxs("div",{className:"text-sm text-gray-400 mb-1",children:[b({en:"Power",vi:"L·ª±c"}),": ",Math.round(100*B),"%"]}),n.jsx("div",{className:"h-3 bg-slate-700 rounded-full overflow-hidden",children:n.jsx("div",{className:"h-full transition-all duration-75",style:{width:100*B+"%",background:"linear-gradient(90deg, #22c55e, #eab308, #ef4444)"}})})]}),g.winner&&n.jsxs("div",{className:"text-center",children:[n.jsxs("div",{className:"text-2xl font-bold text-green-400 mb-4",children:["üèÜ ",K(g.winner)," ",b({en:"wins!",vi:"th·∫Øng!"})]}),n.jsxs("button",{onClick:()=>f.requestReset(),className:"px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-medium transition-colors flex items-center gap-2 mx-auto",children:[n.jsx(i,{className:"w-5 h-5"}),b({en:"Play Again",vi:"Ch∆°i l·∫°i"})]})]}),n.jsxs("div",{className:"flex flex-wrap gap-2 justify-center text-xs text-gray-400",children:[n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 rounded-full bg-yellow-500"})," ",b({en:"Solids (1-7)",vi:"Tr∆°n (1-7)"})]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 rounded-full border-2 border-yellow-500 bg-white"})," ",b({en:"Stripes (9-15)",vi:"S·ªçc (9-15)"})]}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"w-3 h-3 rounded-full bg-black border border-gray-600"})," ",b({en:"8-Ball",vi:"B√≥ng 8"})]})]})]})}export{m as default};
