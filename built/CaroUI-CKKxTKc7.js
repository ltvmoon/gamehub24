import{b as e,j as t}from"./index-BrrJSH2n.js";import{j as s,X as n,e as l,M as o,Q as i,V as a,Y as r,K as c}from"./react-vendor-BZRLljed.js";import"./socket-DRbsQkF5.js";import"./zustand-B3oBTGP0.js";const h=50,d=40;function x({game:x}){const m=x,[u,p]=s.useState(m.getState()),{userId:g}=e(),{board:f,winningLine:w,pendingUndoRequest:v}=u,j=m.getPlayerSymbol(),b=u.currentTurn===j;s.useEffect(()=>{m.onUpdate(e=>p(e))},[m]);const y=s.useRef(null),N=s.useRef(null),[M,k]=s.useState({x:20,y:20}),[O,Y]=s.useState(!1),[T,X]=s.useState({x:0,y:0,viewportX:0,viewportY:0}),[S,C]=s.useState(null),[q,R]=s.useState({width:600,height:600}),P=()=>{const e=u.history;if(0===e.length)return null;const t=e[e.length-1],[s,n]=t.split(",").map(Number);return{row:s,col:n}};s.useEffect(()=>{const e=()=>{if(N.current){const e=N.current.clientWidth,t=window.innerHeight-200,s=Math.min(e,t,600);R({width:s,height:s})}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),s.useEffect(()=>{const e=y.current;if(!e)return;const t=e.getContext("2d");if(!t)return;t.clearRect(0,0,q.width,q.height);const s=d,n=Math.ceil(q.width/s),l=Math.ceil(q.height/s),o=-M.x*s%s,i=-M.y*s%s,a=Math.floor(M.x),r=Math.floor(M.y);t.strokeStyle="#334155",t.lineWidth=1;for(let c=0;c<=n+1;c++){const e=o+c*s;t.beginPath(),t.moveTo(e,0),t.lineTo(e,q.height),t.stroke()}for(let c=0;c<=l+1;c++){const e=i+c*s;t.beginPath(),t.moveTo(0,e),t.lineTo(q.width,e),t.stroke()}if(S&&b&&!u.gameOver){const e=S.col-a,c=S.row-r;e>=0&&e<n&&c>=0&&c<l&&(t.fillStyle="rgba(148, 163, 184, 0.2)",t.fillRect(o+e*s,i+c*s,s,s))}for(let c=0;c<n+1;c++)for(let e=0;e<l+1;e++){const n=a+c,l=r+e;if(n<0||n>=h||l<0||l>=h)continue;const d=f[`${l},${n}`];if(!d)continue;const x=o+c*s+20,m=i+e*s+20,u=w?.some(([e,t])=>e===l&&t===n),p=P(),g=p&&p.row===l&&p.col===n;if(g&&!u&&(t.fillStyle="rgba(251, 191, 36, 0.25)",t.fillRect(o+c*s,i+e*s,s,s)),"X"===d){t.strokeStyle=u?"#4ade80":"#3b82f6",t.lineWidth=g?4:3;const e=12;t.beginPath(),t.moveTo(x-e,m-e),t.lineTo(x+e,m+e),t.stroke(),t.beginPath(),t.moveTo(x+e,m-e),t.lineTo(x-e,m+e),t.stroke()}else{t.strokeStyle=u?"#4ade80":"#ef4444",t.lineWidth=g?4:3;const e=10;t.beginPath(),t.arc(x,m,e,0,2*Math.PI),t.stroke()}}t.fillStyle="#64748b",t.font="10px monospace",t.fillText(`(${a}, ${r})`,5,15)},[M,f,w,S,b,u.gameOver,q]);const U=(e,t)=>{const s=y.current;if(!s)return null;const n=s.getBoundingClientRect(),l=e-n.left,o=t-n.top,i=Math.floor(M.x+l/40),a=Math.floor(M.y+o/40);return i<0||i>=h||a<0||a>=h?null:{row:a,col:i}};return t.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"text-sm font-semibold",children:u.gameOver?u.winner?t.jsx("span",{className:u.winner===j?"text-green-400":"text-red-400",children:u.winner===j?"You Won!":"Opponent Won!"}):t.jsx("span",{className:"text-yellow-400",children:"Draw!"}):t.jsx("span",{className:b?"text-primary-400":"text-slate-400",children:b?"Your Turn":"Opponent's Turn"})}),t.jsxs("div",{className:"text-xs text-slate-500 flex items-center gap-2",children:[t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(n,{className:"w-3 h-3 text-blue-400"})," ","X"===j?"You":"Opp"]}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(l,{className:"w-3 h-3 text-red-400"})," ","O"===j?"You":"Opp"]})]})]}),t.jsxs("div",{className:"flex gap-1 md:gap-2 text-xs",children:[m.isHostUser&&!u.players.O&&!u.gameOver&&t.jsxs("button",{onClick:()=>m.addBot(),className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1",title:"Play against Bot",children:[t.jsx(o,{className:"w-3 h-3"}),t.jsx("span",{children:"Vs Bot"})]}),u.gameOver?t.jsxs("button",{onClick:()=>m.requestReset(),className:"px-2 py-1 bg-primary-600 hover:bg-primary-500 rounded text-white flex items-center gap-1",title:"New game",children:[t.jsx(i,{className:"w-3 h-3"}),t.jsx("span",{children:"New Game"})]}):Object.keys(f).length>0?t.jsxs("button",{onClick:()=>{const e=P();if(!e)return;const t=q.width/d,s=q.height/d,n=Math.max(0,e.col-t/2+.5),l=Math.max(0,e.row-s/2+.5),o=M.x,i=M.y,a=performance.now(),r=e=>{const t=e-a,s=Math.min(t/300,1),c=1-Math.pow(1-s,3);k({x:o+(n-o)*c,y:i+(l-i)*c}),s<1&&requestAnimationFrame(r)};requestAnimationFrame(r)},disabled:0===Object.keys(f).length,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Focus to last move",children:[t.jsx(a,{className:"w-3 h-3"}),t.jsx("span",{children:"Last"})]}):null,!u.gameOver&&Object.keys(f).length>0&&!b&&!v&&t.jsxs("button",{onClick:()=>m.requestUndo(),className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1",title:"Request undo from opponent",children:[t.jsx(r,{className:"w-3 h-3"}),t.jsx("span",{children:"Undo"})]}),!u.gameOver&&0===Object.keys(f).length&&b&&t.jsxs("button",{onClick:()=>m.switchTurn(),className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1",title:"Give first move to opponent",children:[t.jsx(c,{className:"w-3 h-3"}),t.jsx("span",{children:"Give First Move"})]})]})]}),v&&t.jsxs("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700",children:[v===g&&t.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-amber-400",children:[t.jsx(r,{className:"w-4 h-4 animate-pulse"}),t.jsx("span",{children:"Waiting for opponent to respond to undo request..."})]}),v!==g&&t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-300",children:[t.jsx(r,{className:"w-4 h-4 text-amber-400"}),t.jsx("span",{children:"Opponent is requesting to undo their last move"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>m.responseUndo(!0),className:"px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-medium flex items-center gap-1.5",title:"Allow undo",children:t.jsx("span",{children:"Allow"})}),t.jsx("button",{onClick:()=>m.responseUndo(!1),className:"px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-medium flex items-center gap-1.5",title:"Deny undo",children:t.jsx("span",{children:"Deny"})})]})]})]}),t.jsx("div",{ref:N,className:"w-full flex items-center justify-center",children:t.jsx("canvas",{ref:y,width:q.width,height:q.height,style:{width:q.width,height:q.height},className:"border-2 border-slate-700 rounded-lg bg-slate-900 cursor-move touch-none",onMouseDown:e=>{Y(!0),X({x:e.clientX,y:e.clientY,viewportX:M.x,viewportY:M.y})},onMouseMove:e=>{const t=U(e.clientX,e.clientY);if(C(t),O){const t=(T.x-e.clientX)/d,s=(T.y-e.clientY)/d;k({x:Math.max(0,Math.min(49,T.viewportX+t)),y:Math.max(0,Math.min(49,T.viewportY+s))})}},onMouseUp:()=>{Y(!1)},onMouseLeave:()=>{Y(!1),C(null)},onClick:e=>{if(Math.abs(e.clientX-T.x)>5||Math.abs(e.clientY-T.y)>5)return;if(!b||u.gameOver)return;const t=U(e.clientX,e.clientY);if(!t)return;const s=`${t.row},${t.col}`;f[s]||m.requestMove(t.row,t.col)},onTouchStart:e=>{const t=e.touches[0];Y(!0),X({x:t.clientX,y:t.clientY,viewportX:M.x,viewportY:M.y})},onTouchMove:e=>{const t=e.touches[0],s=U(t.clientX,t.clientY);if(C(s),O){const e=(T.x-t.clientX)/d,s=(T.y-t.clientY)/d;k({x:Math.max(0,Math.min(49,T.viewportX+e)),y:Math.max(0,Math.min(49,T.viewportY+s))})}},onTouchEnd:e=>{const t=e.changedTouches[0];if(Math.abs(t.clientX-T.x)>5||Math.abs(t.clientY-T.y)>5)return Y(!1),void C(null);if(Y(!1),C(null),!b||u.gameOver)return;const s=U(t.clientX,t.clientY);if(!s)return;const n=`${s.row},${s.col}`;f[n]||m.requestMove(s.row,s.col)}})}),t.jsx("div",{className:"text-xs text-slate-500 text-center",children:"Drag to pan â€¢ Click to place"})]})}export{x as default};
