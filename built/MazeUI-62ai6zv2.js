import{u as e,b as t,j as s}from"./index-BRLirKDd.js";import{c as n,a6 as l,z as i,aU as r,aV as o,a8 as a,aD as c}from"./react-vendor-DrrN8YCO.js";import{M as d,D as x}from"./Maze-BIrR2lXo.js";import"./socket-DRbsQkF5.js";import"./zustand-CxtZ_hFH.js";import"./BaseGame-B7FOWFqv.js";const h=({game:h,currentUserId:m})=>{const f=h,[u,g]=n.useState(f.getState()),p=n.useRef(null),w=n.useRef(null),v=n.useRef({}),{ti:y,ts:b}=e(),{confirm:j}=t(),[N,E]=n.useState(30),k=m?u.players[m]:void 0;n.useEffect(()=>f.onUpdate(e=>{g(e)}),[f]);const T=n.useMemo(()=>{const{rows:e,cols:t}=u.config;return new d(e,t,u.seed).generate()},[u.config,u.seed]);n.useEffect(()=>{const e=()=>{if(!w.current)return;const{rows:e,cols:t}=u.config,s=Math.min(window.innerWidth-32,800),n=window.innerHeight-180-32,l=Math.floor(s/t),i=Math.floor(n/e);let r=Math.min(l,i);r=Math.max(10,Math.min(r,40)),E(r)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[u.config]),n.useEffect(()=>{const e=p.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const{rows:s,cols:n}=u.config,l=n*N,i=s*N,r=window.devicePixelRatio||1;e.width=l*r,e.height=i*r,e.style.width=`${l}px`,e.style.height=`${i}px`,t.scale(r,r),t.fillStyle="#1a1a1a",t.fillRect(0,0,l,i),t.fillStyle="rgba(34, 197, 94, 0.2)",t.fillRect((n-1)*N,(s-1)*N,N,N),t.fillStyle="rgba(59, 130, 246, 0.2)",t.fillRect(0,0,N,N),t.strokeStyle="#4b5563",t.lineWidth=2,t.lineCap="round",t.beginPath();for(let o=0;o<s;o++)for(let e=0;e<n;e++){const s=T[o][e],n=e*N,l=o*N;s.walls.top&&(t.moveTo(n,l),t.lineTo(n+N,l)),s.walls.right&&(t.moveTo(n+N,l),t.lineTo(n+N,l+N)),s.walls.bottom&&(t.moveTo(n,l+N),t.lineTo(n+N,l+N)),s.walls.left&&(t.moveTo(n,l),t.lineTo(n,l+N))}t.stroke()},[T,u.config,N]),n.useEffect(()=>{const e=e=>{if("PLAYING"!==u.status)return;let t=null;"ArrowUp"===e.key&&(t="UP"),"ArrowDown"===e.key&&(t="DOWN"),"ArrowLeft"===e.key&&(t="LEFT"),"ArrowRight"===e.key&&(t="RIGHT"),t&&(e.preventDefault(),L(t))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[u.status,f]);const P=e=>{const t=u.winners.indexOf(e);return-1===t?void 0:t+1},L=e=>{m&&f.makeAction({type:"MOVE",direction:e,playerId:m})},R=n.useRef(void 0),[A,z]=n.useState(!1);n.useEffect(()=>{let e=!1;const t=()=>{const s=Date.now();if(Object.values(u.players).forEach(e=>{const t=v.current[e.id];if(!t)return;let n=e.x,l=e.y;if(e.moveStart&&e.moveEnd&&e.currentPath&&e.currentPath.length>=2&&s<e.moveEnd){const t=e.moveEnd-e.moveStart,i=s-e.moveStart,r=Math.max(0,Math.min(i/t,1)),o=e.currentPath,a=o.length-1,c=r*a,d=Math.floor(c),x=c-d;if(d<a){const e=o[d],t=o[d+1];n=e.x+(t.x-e.x)*x,l=e.y+(t.y-e.y)*x}}t.style.left=n*N+.15*N+"px",t.style.top=l*N+.15*N+"px",t.style.width=.7*N+"px",t.style.height=.7*N+"px";const i=s<(e.moveEnd||0);P(e.id)&&!i?t.style.opacity="0.5":t.style.opacity="1"}),m&&u.players[m]){const t=u.players[m],n=!!(t.moveEnd&&s<t.moveEnd);n!==e&&(e=n,z(n))}R.current=requestAnimationFrame(t)};return R.current=requestAnimationFrame(t),()=>{R.current&&cancelAnimationFrame(R.current)}},[u.players,m,N]);const G=n.useMemo(()=>{if(!k||!T||A)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const{x:e,y:t}=k;if(t<0||e<0||t>=u.config.rows||e>=u.config.cols)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const s=T[t][e];return{UP:!s.walls.top,DOWN:!s.walls.bottom,LEFT:!s.walls.left,RIGHT:!s.walls.right}},[k,T,u.config,A]);return s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-full p-4 overflow-hidden pb-16!",ref:w,children:[s.jsx("div",{className:"flex flex-col w-full max-w-2xl bg-gray-800 p-4 rounded-xl shadow-lg gap-4 z-10 shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-sm text-gray-400",children:"Level"}),s.jsxs("span",{className:"text-xl font-bold text-white flex gap-2 items-center",children:[u.level," ",s.jsx("span",{className:"text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded-full",children:u.config.difficulty})]}),f.isHost&&s.jsxs("button",{onClick:async()=>{await j(b({en:"Current progress will be lost",vi:"Tiến trình hiện tại sẽ mất"}),b({en:"Reset Game?",vi:"Chơi lại?"}))&&f.makeAction({type:"RESET_GAME"})},className:"flex items-center gap-2 p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:"Reset Game",children:[s.jsx(l,{size:18}),y({en:"Reset",vi:"Chơi lại"})]})]}),s.jsx("div",{className:"flex flex-col flex-wrap gap-0",children:Object.values(u.players).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 px-3 bg-gray-900/50 rounded-lg border border-gray-700/50",children:[s.jsx("div",{className:"w-3 h-3 rounded-full border border-white/20 shrink-0",style:{backgroundColor:e.color}}),s.jsxs("div",{className:"truncate font-medium text-sm text-gray-300 max-w-[100px]",children:[e.username||e.id.slice(0,8),e.id===m&&s.jsxs("span",{className:"text-blue-400 ml-1",children:["(",b({en:"You",vi:"Bạn"}),")"]})]}),P(e.id)&&s.jsxs("span",{className:"text-xs font-bold bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded ml-1",children:["#",P(e.id)]})]},e.id))})]})}),s.jsxs("div",{className:"relative shadow-2xl rounded-lg border border-gray-700 select-none bg-black mt-4 shrink-0 transition-all duration-300",style:{width:u.config.cols*N,height:u.config.rows*N},children:[s.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-lg",children:[s.jsx("canvas",{ref:p}),Object.values(u.players).map(e=>s.jsx("div",{ref:t=>{v.current[e.id]=t},className:"absolute rounded-full shadow-sm flex items-center justify-center border-2 border-white",style:{width:.7*N+"px",height:.7*N+"px",left:e.x*N+.15*N+"px",top:e.y*N+.15*N+"px",backgroundColor:e.color,zIndex:e.id===m?20:10},children:P(e.id)&&s.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-md",children:["#",P(e.id)]})},e.id)),"WAITING"===u.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/40 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsx("div",{className:"text-white text-3xl font-bold",children:f.isHost?b({en:"Setup Game",vi:"Cài đặt Game"}):b({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})}),f.isHost&&s.jsxs("div",{className:"flex flex-col gap-4 items-center animate-in fade-in zoom-in duration-300",children:[s.jsx("div",{className:"flex bg-gray-800 rounded-lg p-1.5 ring-1 ring-gray-700",children:Object.keys(x).map(e=>s.jsx("button",{onClick:()=>{return t=e,void f.makeAction({type:"UPDATE_SETTINGS",difficulty:t});var t},className:"px-4 py-2 text-sm font-bold rounded-md transition-all "+(u.config.difficulty===e?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"),children:e},e))}),s.jsxs("button",{onClick:()=>{f.makeAction({type:"START_GAME"})},className:"flex items-center gap-2 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all hover:-translate-y-0.5",children:[s.jsx(i,{size:24,fill:"currentColor"})," ",b({en:"Start Game",vi:"Chơi"})]})]})]}),"FINISHED"===u.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsxs("div",{className:"text-green-400 text-4xl font-bold drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]",children:[b({en:"Level Complete!",vi:"Xong Level"})," ",u.level]}),k&&P(k.id)&&s.jsxs("div",{className:"text-white text-xl",children:[b({en:"You finished",vi:"Bạn về đích"})," ",s.jsxs("span",{className:"font-bold text-yellow-400",children:["#",P(k.id)]})]}),f.isHost?s.jsxs("button",{onClick:()=>{f.makeAction({type:"NEXT_LEVEL"})},className:"flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all hover:-translate-y-0.5",children:[b({en:"Next Level",vi:"Level tiếp theo"})," ",s.jsx(i,{size:24,fill:"currentColor"})]}):s.jsx("div",{children:b({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})})]})]}),(()=>{if("PLAYING"!==u.status||!k||A||P(k.id))return null;const e=k.x*N+N/2,t=k.y*N+N/2,n=(s,n)=>({width:"48px",height:"48px",left:e+s-24+"px",top:t+n-24+"px"}),l="absolute flex items-center justify-center bg-white/10 hover:bg-white/40 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-30 border border-white/10 shadow-lg ring-1 ring-black/20";return s.jsxs(s.Fragment,{children:[G.UP&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),L("UP")},className:l,style:n(0,-50),children:s.jsx(r,{size:24,className:"text-white drop-shadow-md"})}),G.DOWN&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),L("DOWN")},className:l,style:n(0,50),children:s.jsx(o,{size:24,className:"text-white drop-shadow-md"})}),G.LEFT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),L("LEFT")},className:l,style:n(-50,0),children:s.jsx(a,{size:24,className:"text-white drop-shadow-md"})}),G.RIGHT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),L("RIGHT")},className:l,style:n(50,0),children:s.jsx(c,{size:24,className:"text-white drop-shadow-md"})})]})})()]}),s.jsx("div",{className:"mt-4 text-gray-500 text-sm hidden sm:block",children:b({vi:"Về đích đầu tiên để dành chiến thắng",en:"First to the finish wins!"})})]})};export{h as default};
