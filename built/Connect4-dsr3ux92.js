import{B as t}from"./BaseGame-Bk_CJ4n7.js";import{C as e,a as s,R as a,b as i,W as r}from"./types-BR_cD1-k.js";import{h as n}from"./index-Dp6FX8_v.js";import"./socket-DRbsQkF5.js";import"./react-vendor-DWJY-O-l.js";import"./zustand-DSzZ-G-z.js";class o extends t{isGameOver(t){return t.gamePhase===e.ENDED}localMoveHistory=[];getInitState(){const t=this.players[0],r=this.players[1];return{board:"0".repeat(a*i),players:[{id:t?.id||null,username:t?.username||"Player 1",isHost:t?.isHost||!1,isBot:t?.isBot||!1,flags:t?.isBot?s.BOT:0},{id:r?.id||null,username:r?.username||"Player 2",isHost:r?.isHost||!1,isBot:r?.isBot||!1,flags:r?.isBot?s.BOT:0}],currentPlayerIndex:0,winner:null,gamePhase:e.WAITING,undoRequest:null,lastMove:null,winningCells:[]}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.handleMakeMove(e.playerId,e.col);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot();break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId,e.playerName);break;case"ACCEPT_UNDO":this.handleAcceptUndo();break;case"DECLINE_UNDO":this.handleDeclineUndo()}}handleStartGame(){this.state.gamePhase===e.WAITING&&this.state.players[0].id&&this.state.players[1].id&&(this.state.gamePhase=e.PLAYING,this.state.currentPlayerIndex=0,this.state.board="0".repeat(a*i),this.localMoveHistory=[],this.state.winner=null,this.state.lastMove=null,this.state.winningCells=[],this.checkBotTurn())}handleMakeMove(t,s){if(this.state.gamePhase!==e.PLAYING)return;if(this.state.players[this.state.currentPlayerIndex].id!==t)return;const a=this.getLowestEmptyRow(s);if(-1===a)return;this.saveHistory();const r=this.state.board.split(""),n=0===this.state.currentPlayerIndex?"1":"2";r[a*i+s]=n,this.state.board=r.join(""),this.state.lastMove=a*i+s;const o=this.checkWin(a,s,n);o.length>0?(this.state.winningCells=o,this.state.winner=t,this.state.gamePhase=e.ENDED,this.clearSavedState()):this.isBoardFull()?(this.state.winner="draw",this.state.gamePhase=e.ENDED,this.clearSavedState()):this.state.currentPlayerIndex=1-this.state.currentPlayerIndex,this.checkBotTurn()}getLowestEmptyRow(t){for(let e=a-1;e>=0;e--)if("0"===this.state.board[e*i+t])return e;return-1}isBoardFull(){for(let t=0;t<i;t++)if("0"===this.state.board[t])return!1;return!0}checkWin(t,e,s){const a=[[0,1],[1,0],[1,1],[1,-1]];for(const[i,n]of a){const a=this.getConnectedCells(t,e,i,n,s);if(a.length>=r)return a}return[]}getConnectedCells(t,e,s,r,n){const o=[t*i+e];let l=t+s,h=e+r;for(;l>=0&&l<a&&h>=0&&h<i&&this.state.board[l*i+h]===n;)o.push(l*i+h),l+=s,h+=r;for(l=t-s,h=e-r;l>=0&&l<a&&h>=0&&h<i&&this.state.board[l*i+h]===n;)o.push(l*i+h),l-=s,h-=r;return o}saveHistory(){this.isHost&&(this.localMoveHistory.push({b:this.state.board,currentPlayerIndex:this.state.currentPlayerIndex}),this.localMoveHistory.length>50&&this.localMoveHistory.shift())}handleRequestUndo(t,a){if(this.state.gamePhase!==e.PLAYING)return;if(0===this.localMoveHistory.length)return;if(this.state.undoRequest)return;const i=1-this.state.players.findIndex(e=>e.id===t),r=this.state.players[i];r&&n(r.flags,s.BOT)?this.applyUndo():this.state.undoRequest={fromId:t,fromName:a}}handleAcceptUndo(){this.state.undoRequest&&this.applyUndo()}applyUndo(){const t=this.localMoveHistory.pop();t&&(this.state.board=t.b,this.state.currentPlayerIndex=t.currentPlayerIndex,this.state.undoRequest=null,this.state.lastMove=null,this.state.winningCells=[])}handleDeclineUndo(){this.state.undoRequest=null}handleAddBot(){this.state.gamePhase===e.WAITING&&(this.state.players[1].id||(this.state.players[1]={id:`BOT_${Date.now()}`,username:"Bot",isHost:!1,isBot:!0,flags:s.BOT}))}handleRemoveBot(){this.state.gamePhase===e.WAITING&&n(this.state.players[1].flags,s.BOT)&&(this.state.players[1]={id:null,username:"Player 2",isHost:!1,isBot:!1,flags:0})}checkBotTurn(){if(!this.isHost)return;if(this.state.gamePhase!==e.PLAYING)return;const t=this.state.players[this.state.currentPlayerIndex];n(t.flags,s.BOT)&&t.id&&setTimeout(()=>this.makeBotMove(t.id),600)}makeBotMove(t){if(this.state.gamePhase!==e.PLAYING)return;if(this.state.players[this.state.currentPlayerIndex].id!==t)return;const s=this.findBestMove();-1!==s&&this.handleMakeMove(t,s)}findBestMove(){const t=0===this.state.currentPlayerIndex?"1":"2",e=Date.now();let s=-1/0,a=-1;const i=[],r=[3,2,4,1,5,0,6];for(const n of r)-1!==this.getLowestEmptyRow(n)&&i.push(n);if(0===i.length)return-1;if(1===i.length)return i[0];for(const n of i){const e=this.getLowestEmptyRow(n),i=this.simulateMove(this.state.board,e,n,t),r=this.minimax(i,5,-1/0,1/0,!1,t);r>s&&(s=r,a=n)}return console.log(`[Connect4 Bot] Best move: ${a}, score: ${s}, time: ${Date.now()-e}ms`),a}simulateMove(t,e,s,a){const r=t.split("");return r[e*i+s]=a,r.join("")}minimax(t,e,s,a,i,r){const n="1"===r?"2":"1",o=this.getWinnerPiece(t);if(o===r)return 1e6+e;if(o===n)return-1e6-e;if(this.isBoardFullStatic(t))return 0;if(0===e)return this.evaluateBoard(t,r);const l=[3,2,4,1,5,0,6].filter(e=>-1!==this.getLowestEmptyRowStatic(t,e));if(i){let i=-1/0;for(const n of l){const o=this.getLowestEmptyRowStatic(t,n),l=this.simulateMove(t,o,n,r),h=this.minimax(l,e-1,s,a,!1,r);if(i=Math.max(i,h),a<=(s=Math.max(s,h)))break}return i}{let i=1/0;for(const o of l){const l=this.getLowestEmptyRowStatic(t,o),h=this.simulateMove(t,l,o,n),u=this.minimax(h,e-1,s,a,!0,r);if(i=Math.min(i,u),(a=Math.min(a,u))<=s)break}return i}}evaluateBoard(t,e){let s=0;const r="1"===e?"2":"1",n=Math.floor(i/2);for(let o=0;o<a;o++)t[o*i+n]===e&&(s+=3);for(let o=0;o<a;o++)for(let a=0;a<=i-4;a++){const n=[t[o*i+a],t[o*i+a+1],t[o*i+a+2],t[o*i+a+3]];s+=this.evaluateWindow(n,e,r)}for(let o=0;o<i;o++)for(let n=0;n<=a-4;n++){const a=[t[n*i+o],t[(n+1)*i+o],t[(n+2)*i+o],t[(n+3)*i+o]];s+=this.evaluateWindow(a,e,r)}for(let o=0;o<=a-4;o++)for(let a=0;a<=i-4;a++){const n=[t[o*i+a],t[(o+1)*i+(a+1)],t[(o+2)*i+(a+2)],t[(o+3)*i+(a+3)]];s+=this.evaluateWindow(n,e,r)}for(let o=0;o<=a-4;o++)for(let a=3;a<i;a++){const n=[t[o*i+a],t[(o+1)*i+(a-1)],t[(o+2)*i+(a-2)],t[(o+3)*i+(a-3)]];s+=this.evaluateWindow(n,e,r)}return s}evaluateWindow(t,e,s){let a=0;const i=t.filter(t=>t===e).length,r=t.filter(t=>t===s).length,n=t.filter(t=>"0"===t).length;return 4===i?a+=1e4:3===i&&1===n?a+=100:2===i&&2===n&&(a+=10),3===r&&1===n?a-=80:2===r&&2===n&&(a-=5),a}getWinnerPiece(t){const e=[[0,1],[1,0],[1,1],[1,-1]];for(let s=0;s<a;s++)for(let n=0;n<i;n++){const o=t[s*i+n];if("0"!==o)for(const[l,h]of e){let e=1;for(let u=1;u<r;u++){const r=s+l*u,d=n+h*u;if(r<0||r>=a||d<0||d>=i||t[r*i+d]!==o)break;e++}if(e===r)return o}}return null}getLowestEmptyRowStatic(t,e){for(let s=a-1;s>=0;s--)if("0"===t[s*i+e])return s;return-1}isBoardFullStatic(t){for(let e=0;e<i;e++)if("0"===t[e])return!1;return!0}requestMove(t){const e={type:"MAKE_MOVE",playerId:this.userId,col:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestAddBot(){this.makeAction({type:"ADD_BOT"})}requestRemoveBot(){this.makeAction({type:"REMOVE_BOT"})}requestUndo(){const t=this.state.players.find(t=>t.id===this.userId),e={type:"REQUEST_UNDO",playerId:this.userId,playerName:t?.username||"Player"};this.makeAction(e)}acceptUndo(){this.makeAction({type:"ACCEPT_UNDO"})}declineUndo(){this.makeAction({type:"DECLINE_UNDO"})}requestNewGame(){this.makeAction({type:"RESET"})}reset(){this.state.board="0".repeat(a*i),this.state.currentPlayerIndex=0,this.state.winner=null,this.state.gamePhase=e.WAITING,this.state.undoRequest=null,this.localMoveHistory=[],this.state.lastMove=null,this.state.winningCells=[]}updatePlayers(t){if(this.state.gamePhase!==e.WAITING)return;const a=t[0],i=t[1];this.state.players[0].id=a?.id||null,this.state.players[0].username=a?.username||"Player 1",this.state.players[0].isHost=a?.isHost||!1,this.state.players[0].isBot=a?.isBot||!1,i?(this.state.players[1].id=i.id,this.state.players[1].username=i.username,this.state.players[1].isHost=i.isHost||!1,this.state.players[1].isBot=i.isBot||!1,this.state.players[1].flags&=-2):n(this.state.players[1].flags,s.BOT)||(this.state.players[1].id=null,this.state.players[1].username="Player 2",this.state.players[1].isHost=!1,this.state.players[1].isBot=!1)}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}canStartGame(){return null!==this.state.players[0].id&&null!==this.state.players[1].id}isColumnFull(t){const e=t;return"0"!==this.state.board[e]}}export{o as default};
