import{B as e}from"./BaseGame-Bbf7EcO0.js";import{C as t,a as s,S as a,P as i,B as n,M as r,J as o,b as d}from"./types-gixil7wH.js";import{t as h}from"./index-CeSpnX2h.js";import"./socket-DRbsQkF5.js";import"./react-vendor-C7uwXrww.js";import"./zustand-D2o_pnFT.js";class l extends e{state;onStateChange;chanceCards;chestCards;getOutOfJailCards;constructor(e,n,r,o,d){super(e,n,r,o),this.chanceCards=[...t].sort(()=>Math.random()-.5),this.chestCards=[...s].sort(()=>Math.random()-.5),this.getOutOfJailCards=new Map;const h=[];for(let t=0;t<4;t++){const e=d[t];h.push({id:e?.id||null,username:e?.username||`Player ${t+1}`,color:i[t],position:0,money:a,inJail:!1,jailTurns:0,isBankrupt:!1,isBot:!1,moneyHistory:[a]})}this.state={players:h,currentPlayerIndex:0,properties:[],diceValues:null,doublesCount:0,hasRolled:!1,canRollAgain:!1,gamePhase:"waiting",winner:null,pendingAction:null,lastAction:null,logs:[],tradeOffers:[]}}init(){this.isHost&&this.broadcastState()}onUpdate(e){this.onStateChange=e}getState(){return this.state}setState(e){this.state=e,this.onStateChange?.(this.state),this.isHost&&this.checkBotTurn()}notifyAndBroadcast(){this.state.players.forEach(e=>{e.moneyHistory||(e.moneyHistory=[]);e.moneyHistory[e.moneyHistory.length-1]!==e.money&&(e.moneyHistory.push(e.money),e.moneyHistory.length>50&&e.moneyHistory.shift())}),this.state={...this.state,players:this.state.players.map(e=>({...e,moneyHistory:[...e.moneyHistory||[]]})),properties:this.state.properties.map(e=>({...e})),logs:[...this.state.logs],tradeOffers:this.state.tradeOffers.map(e=>({...e}))},this.onStateChange?.(this.state),this.broadcastState()}handleOfferTrade(e,t,s,a){if(!this.isHost)return;const i=this.state.properties.find(e=>e.spaceId===s);if(!i)return;const r=i.ownerId===e,o=i.ownerId===t;if(!r&&!o)return;if(a<0)return;const d={id:Math.random().toString(36).substr(2,9),fromPlayerId:e,toPlayerId:t,propertyId:s,price:a,status:"pending"};this.state.tradeOffers.push(d);const l=this.state.players.find(t=>t.id===e),c=this.state.players.find(e=>e.id===t),u=n[s];r?this.addLog({en:`${l?.username} offered to sell ${h(u?.name)} to ${c?.username} for ${a}đ`,vi:`${l?.username} đề nghị bán ${h(u?.name)} cho ${c?.username} với giá ${a}đ`},"info"):this.addLog({en:`${l?.username} offered to buy ${h(u?.name)} from ${c?.username} for ${a}đ`,vi:`${l?.username} đề nghị mua ${h(u?.name)} từ ${c?.username} với giá ${a}đ`},"info"),this.notifyAndBroadcast(),c?.isBot&&this.botEvaluateTrade(d)}handleRespondTrade(e,t,s){if(!this.isHost)return;const a=this.state.tradeOffers.findIndex(t=>t.id===e);if(-1===a)return;const i=this.state.tradeOffers[a],r=this.state.properties.find(e=>e.spaceId===i.propertyId),o=n[i.propertyId];if(!t||!r){i.status="declined";const t=this.state.players.find(e=>e.id===i.toPlayerId),a=this.state.players.find(e=>e.id===i.fromPlayerId);return s&&(i.responseMessage={en:s,vi:s}),this.addLog({en:`${t?.username} declined the trade offer from ${a?.username}`,vi:`${t?.username} từ chối lời mời giao dịch từ ${a?.username}`},"info"),this.notifyAndBroadcast(),void setTimeout(()=>{const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&"declined"===this.state.tradeOffers[t].status&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())},8e3)}{const e=r.ownerId===i.fromPlayerId,t=e?i.toPlayerId:i.fromPlayerId,s=e?i.fromPlayerId:i.toPlayerId,n=this.state.players.find(e=>e.id===t),d=this.state.players.find(e=>e.id===s);if(!n||!d)return;if(n.money<i.price)return this.addLog({en:`Trade failed: ${n.username} cannot afford ${i.price}đ`,vi:`Giao dịch thất bại: ${n.username} không đủ ${i.price}đ`},"alert"),this.state.tradeOffers.splice(a,1),void this.notifyAndBroadcast();n.money-=i.price,d.money+=i.price,r.ownerId=n.id,i.status="accepted",this.addLog({en:`Trade successful! ${n.username} bought ${h(o?.name)} from ${d.username} for ${i.price}đ`,vi:`Giao dịch thành công! ${n.username} mua ${h(o?.name)} từ ${d.username} giá ${i.price}đ`},"action")}this.state.tradeOffers.splice(a,1),this.notifyAndBroadcast()}handleCancelTrade(e){if(!this.isHost)return;const t=this.state.tradeOffers.findIndex(t=>t.id===e);-1!==t&&(this.state.tradeOffers.splice(t,1),this.notifyAndBroadcast())}botEvaluateTrade(e){setTimeout(()=>{const t=this.state.tradeOffers.find(t=>t.id===e.id);if(!t||"pending"!==t.status)return;const s=this.state.players.find(e=>e.id===t.toPlayerId);if(!s||!s.isBot)return;const a=n[t.propertyId];if(!a)return;const i=this.state.properties.find(e=>e.spaceId===t.propertyId),r=i?.ownerId===s.id;let o=0;"property"!==a.type&&"railroad"!==a.type&&"utility"!==a.type||(o=a.price);const d=n.filter(e=>"property"===e.type&&"property"===a.type&&e.color===a.color),l=this.state.properties.filter(e=>e.ownerId===s.id&&d.some(t=>t.id===e.spaceId)).length;d.length>0&&(l>=d.length-1?o*=2.5:l>0&&(o*=1.5));if(r){const e=1.2*o;this.addLog({en:`${s.username} thinks ${h(a?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${h(a?.name)} đáng giá ${e}đ`},"info"),t.price>=e?this.handleRespondTrade(t.id,!0):(t.responseMessage={en:`I want at least ${e.toLocaleString()}đ`,vi:`Tôi muốn ít nhất ${e.toLocaleString()}đ`},this.handleRespondTrade(t.id,!1))}else{const e=1*o,i=s.money>=t.price,n=t.price<=e;this.addLog({en:`${s.username} thinks ${h(a?.name)} is worth ${e}đ`,vi:`${s.username} nghĩ ${h(a?.name)} đáng giá ${e}đ`},"info"),i&&n?this.handleRespondTrade(t.id,!0):(t.responseMessage=i?{en:`I only pay up to ${e.toLocaleString()}đ`,vi:`Tôi chỉ trả tối đa ${e.toLocaleString()}đ`}:{en:"I don't have enough money",vi:"Tôi không đủ tiền"},this.handleRespondTrade(t.id,!1))}},2e3)}handleSellHouse(e,t){if(!this.isHost)return;const s=n[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||a.houses<=0||"property"!==s.type||!s.houseCost)return;a.houses--;const i=Math.floor(.5*s.houseCost),r=this.state.players.find(t=>t.id===e);r&&(r.money+=i,this.addLog({en:`${r.username} sold a house on ${h(s?.name)} for ${i}đ`,vi:`${r.username} bán 1 nhà trên ${h(s?.name)} được ${i}đ`},"action")),this.notifyAndBroadcast()}handleMortgage(e,t){if(!this.isHost)return;const s=n[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||a.mortgaged||a.houses>0||"property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type)return;const i=Math.floor(.5*s.price);a.mortgaged=!0;const r=this.state.players.find(t=>t.id===e);r&&(r.money+=i,this.addLog({en:`${r.username} mortgaged ${h(s?.name)} for ${i}đ`,vi:`${r.username} thế chấp ${h(s?.name)} được ${i}đ`},"action")),this.notifyAndBroadcast()}handleUnmortgage(e,t){if(!this.isHost)return;const s=n[t],a=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!s||!a||!a.mortgaged||"property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type)return;const i=Math.floor(.5*s.price),r=i+Math.floor(.1*i),o=this.state.players.find(t=>t.id===e);!o||o.money<r||(o.money-=r,a.mortgaged=!1,this.addLog({en:`${o.username} unmortgaged ${h(s?.name)} for ${r}đ`,vi:`${o.username} chuộc ${h(s?.name)} giá ${r}đ`},"action"),this.notifyAndBroadcast())}handleAction(e){const t=e.action;switch(t.type){case"START_GAME":this.handleStartGame();break;case"ROLL_DICE":this.handleRollDice(t.playerId);break;case"BUY_PROPERTY":this.handleBuyProperty(t.playerId,t.spaceId);break;case"DECLINE_PROPERTY":this.handleDeclineProperty(t.playerId);break;case"BUILD_HOUSE":this.handleBuildHouse(t.playerId,t.spaceId);break;case"PAY_RENT":this.handlePayRent(t.playerId);break;case"PAY_TAX":this.handlePayTax(t.playerId);break;case"USE_CARD":this.handleUseCard(t.playerId);break;case"PAY_JAIL_FINE":this.handlePayJailFine(t.playerId);break;case"END_TURN":this.handleEndTurn(t.playerId);break;case"ADD_BOT":this.handleAddBot(t.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(t.slotIndex);break;case"REQUEST_SYNC":this.isHost&&this.broadcastState();break;case"OFFER_TRADE":this.handleOfferTrade(t.fromPlayerId,t.toPlayerId,t.spaceId,t.price);break;case"RESPOND_TRADE":this.handleRespondTrade(t.offerId,t.accepted,t.message);break;case"CANCEL_TRADE":this.handleCancelTrade(t.offerId);break;case"SELL_HOUSE":this.handleSellHouse(t.playerId,t.spaceId);break;case"MORTGAGE":this.handleMortgage(t.playerId,t.spaceId);break;case"UNMORTGAGE":this.handleUnmortgage(t.playerId,t.spaceId);break;case"RESET_GAME":this.reset()}}addLog(e,t="info"){const s={id:Math.random().toString(36).substr(2,9),message:e,type:t,timestamp:Date.now()};this.state.logs.push(s),this.state.logs.length>50&&(this.state.logs=this.state.logs.slice(-50)),this.state.lastAction=e}makeMove(e){this.isHost?this.handleAction({action:e}):this.sendAction(e)}handleStartGame(){if(!this.isHost)return;if("waiting"!==this.state.gamePhase)return;this.state.players.filter(e=>null!==e.id).length<2||(this.state={...this.state,gamePhase:"playing",currentPlayerIndex:this.findFirstActivePlayer(),lastAction:{en:"Game started!",vi:"Trò chơi bắt đầu!"},logs:[]},this.addLog({en:"Game started!",vi:"Trò chơi bắt đầu!"},"info"),this.notifyAndBroadcast(),this.checkBotTurn())}findFirstActivePlayer(){for(let e=0;e<this.state.players.length;e++)if(this.state.players[e].id&&!this.state.players[e].isBankrupt)return e;return 0}handleRollDice(e){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;if(this.state.hasRolled&&!this.state.canRollAgain)return;if(this.state.pendingAction)return;const s=Math.floor(6*Math.random())+1,a=Math.floor(6*Math.random())+1;this.state.diceValues=[s,a],this.state.hasRolled=!0,this.addLog({en:"Rolling...",vi:"Đang đổ xí ngầu..."},"info"),this.notifyAndBroadcast(),setTimeout(()=>{this.processDiceResult(e,s,a)},1200)}processDiceResult(e,t,s){const a=this.state.players.find(t=>t.id===e);if(!a)return;const i=t+s,n=t===s;if(n){if(this.state.doublesCount++,this.state.doublesCount>=3)return this.sendToJail(a),this.addLog({en:`${a.username} rolled 3 doubles, goes to jail!`,vi:`${a.username} đổ 3 lần đôi, phải vào tù!`},"alert"),this.endTurn(),void this.notifyAndBroadcast();this.state.canRollAgain=!0}else this.state.canRollAgain=!1;a.inJail?n?(a.inJail=!1,a.jailTurns=0,this.addLog({en:`${a.username} rolled doubles and escapes jail!`,vi:`${a.username} đổ đôi và được ra tù!`},"action"),this.movePlayer(a,i)):(a.jailTurns++,a.jailTurns>=r?(a.money-=o,a.inJail=!1,a.jailTurns=0,this.addLog({en:`${a.username} paid ${o}đ and leaves jail`,vi:`${a.username} trả ${o}đ để ra tù`},"action"),this.movePlayer(a,i)):(this.state.lastAction={en:`${a.username} stays in jail (turn ${a.jailTurns}/${r})`,vi:`${a.username} ở trong tù (lượt ${a.jailTurns}/${r})`},this.state.canRollAgain=!1)):this.movePlayer(a,i),this.notifyAndBroadcast(),this.state.pendingAction||this.checkBotTurn()}movePlayer(e,t){const s=e.position,a=(e.position+t)%40;a<s&&t>0&&(e.money+=d,this.addLog({en:`${e.username} passed GO, collects ${d}đ`,vi:`${e.username} đi qua KHỞI HÀNH, nhận ${d}đ`},"info")),e.position=a,this.handleLanding(e)}handleLanding(e){const t=n[e.position];if(t)switch(t.type){case"go":this.addLog({en:`${e.username} landed on GO`,vi:`${e.username} vào ô KHỞI HÀNH`},"info");break;case"property":case"railroad":case"utility":this.handlePropertyLanding(e,t.id);break;case"tax":this.state.pendingAction={type:"PAY_TAX",amount:t.taxAmount||0},this.addLog({en:`${e.username} must pay ${t.taxAmount}đ tax`,vi:`${e.username} phải nộp thuế ${t.taxAmount}đ`},"alert");break;case"chance":this.drawCard(e,"chance");break;case"chest":this.drawCard(e,"chest");break;case"jail":this.addLog({en:`${e.username} is just visiting jail`,vi:`${e.username} thăm nuôi tù`},"info");break;case"parking":this.addLog({en:`${e.username} landed on Free Parking`,vi:`${e.username} vào Bãi Đỗ Xe`},"info");break;case"gotojail":this.sendToJail(e),this.addLog({en:`${e.username} goes to jail!`,vi:`${e.username} vào tù!`},"alert")}}handlePropertyLanding(e,t){const s=n[t],a=this.state.properties.find(e=>e.spaceId===t);if(a)if(a.ownerId!==e.id)if(a.mortgaged)this.addLog({en:`${e.username} landed on ${h(s.name)} which is mortgaged. No rent!`,vi:`${e.username} vào ${h(s.name)} đang thế chấp. Không cần trả tiền thuê!`},"info");else{const s=this.calculateRent(t,a),i=this.state.players.find(e=>e.id===a.ownerId);i&&!i.isBankrupt&&(this.state.pendingAction={type:"PAY_RENT",amount:s,toPlayerId:a.ownerId},this.addLog({en:`${e.username} owes ${s}đ rent to ${i.username}`,vi:`${e.username} trả ${s}đ tiền thuê cho ${i.username}`},"alert"))}else this.addLog({en:`${e.username} landed on their own property`,vi:`${e.username} vào nhà mình`},"info");else("property"===s.type||"railroad"===s.type||"utility"===s.type)&&s.price&&e.money>=s.price?(this.state.pendingAction={type:"BUY_DECISION",spaceId:t},this.addLog({en:`${e.username} can buy ${h(s?.name)} for ${s.price}đ`,vi:`${e.username} có thể mua ${h(s?.name)} giá ${s.price}đ`},"action")):this.addLog({en:`${e.username} cannot afford ${h(s?.name)}`,vi:`${e.username} không đủ tiền mua ${h(s?.name)}`},"alert")}calculateRent(e,t){const s=n[e];if(!s)return 0;if("railroad"===s.type){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&"railroad"===n[e.spaceId]?.type).length;return(s.baseRent||250)*e}if("utility"===s.type){const e=this.state.properties.filter(e=>e.ownerId===t.ownerId&&"utility"===n[e.spaceId]?.type).length,a=(this.state.diceValues?.[0]||1)+(this.state.diceValues?.[1]||1);return s.baseRent+(2===e?10*a:4*a)}if("property"!==s.type||!s.rent)return 0;const a=n.filter(e=>"property"===e.type&&e.color===s.color),i=a.filter(e=>this.state.properties.some(s=>s.spaceId===e.id&&s.ownerId===t.ownerId)).length===a.length,r=t.houses;return r>0&&r<=5?s.rent[r]:i?2*s.rent[0]:s.rent[0]}drawCard(e,t){const s="chance"===t?this.chanceCards:this.chestCards,a=s.shift();a&&("GET_OUT_JAIL"!==a.action.type&&s.push(a),this.state.pendingAction={type:"CARD",card:a},this.addLog({en:`${e.username} draws: ${h(a.text)}`,vi:`${e.username} rút thẻ: ${h(a.text)}`},"action"))}sendToJail(e){e.position=10,e.inJail=!0,e.jailTurns=0,this.state.canRollAgain=!1}handleBuyProperty(e,t){if(!this.isHost)return;const s=this.state.players[this.state.currentPlayerIndex];if(!s||s.id!==e)return;const a=this.state.pendingAction;if(!a||"BUY_DECISION"!==a.type||a.spaceId!==t)return;const i=n[t];!i||"property"!==i.type&&"railroad"!==i.type&&"utility"!==i.type||s.money<i.price||(s.money-=i.price,this.state.properties.push({spaceId:t,ownerId:s.id,houses:0,mortgaged:!1}),this.state.pendingAction=null,this.addLog({en:`${s.username} bought ${h(i?.name)} for ${i.price}đ`,vi:`${s.username} đã mua ${h(i?.name)} với giá ${i.price}đ`},"action"),this.notifyAndBroadcast(),this.checkBotTurn())}handleDeclineProperty(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;if(!this.state.pendingAction||"BUY_DECISION"!==this.state.pendingAction.type)return;const s=n[this.state.pendingAction.spaceId];this.state.pendingAction=null,this.addLog({en:`${t.username} declined to buy ${h(s?.name)}`,vi:`${t.username} không mua ${h(s?.name)}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}canBuildHouse(e,t){const s=this.state.players.find(t=>t.id===e);if(!s)return{allowed:!1,reason:{en:"Player not found",vi:"Không tìm thấy người chơi"}};const a=n[t],i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);if(!a||!i||"property"!==a.type||!a.houseCost)return{allowed:!1,reason:{en:"Cannot build here",vi:"Không thể xây ở đây"}};if(i.houses>=5)return{allowed:!1,reason:{en:"Max level reached",vi:"Đã đạt cấp tối đa"}};if(s.money<a.houseCost)return{allowed:!1,reason:{en:"Not enough money",vi:"Không đủ tiền"}};if(i.mortgaged)return{allowed:!1,reason:{en:"Property is mortgaged",vi:"Tài sản đang thế chấp"}};const r=n.filter(e=>"property"===e.type&&e.color===a.color),o=this.state.properties.filter(t=>r.some(e=>e.id===t.spaceId)&&t.ownerId===e);if(o.length!==r.length)return{allowed:!1,reason:{en:"Must own full color set",vi:"Phải sở hữu đủ bộ màu"}};const d=Math.min(...o.map(e=>e.houses));return i.houses>d?{allowed:!1,reason:{en:"Must build evenly",vi:"Phải xây đều các ô"}}:{allowed:!0}}handleBuildHouse(e,t){if(!this.isHost)return;if(!this.canBuildHouse(e,t).allowed)return;const s=this.state.players.find(t=>t.id===e),a=n[t];if("property"!==a.type||!a.houseCost)return;const i=this.state.properties.find(s=>s.spaceId===t&&s.ownerId===e);s.money-=a.houseCost,i.houses++;const r=5===i.houses?"hotel":"house",o=5===i.houses?"khách sạn":"nhà";this.addLog({en:`${s.username} built a ${r} on ${h(a?.name)}`,vi:`${s.username} xây ${o} trên ${h(a?.name)}`},"action"),this.notifyAndBroadcast()}handlePayRent(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;if(!s||"PAY_RENT"!==s.type)return;const a=this.state.players.find(e=>e.id===s.toPlayerId);a&&(t.money>=s.amount?(t.money-=s.amount,a.money+=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ rent to ${a.username}`,vi:`${t.username} trả ${s.amount}đ thuê cho ${a.username}`},"action")):this.handleBankruptcy(t,a),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handlePayTax(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;s&&"PAY_TAX"===s.type&&(t.money>=s.amount?(t.money-=s.amount,this.addLog({en:`${t.username} paid ${s.amount}đ tax`,vi:`${t.username} đóng thuế ${s.amount}đ`},"action")):this.handleBankruptcy(t,null),this.state.pendingAction=null,this.notifyAndBroadcast(),this.checkBotTurn())}handleUseCard(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e)return;const s=this.state.pendingAction;if(!s||"CARD"!==s.type)return;const a=s.card;switch(this.state.pendingAction=null,a.action.type){case"COLLECT":t.money+=a.action.amount;break;case"PAY":t.money>=a.action.amount?t.money-=a.action.amount:this.handleBankruptcy(t,null);break;case"MOVE":const e=t.position;t.position=a.action.position,t.position<e&&(t.money+=d),this.handleLanding(t);break;case"MOVE_RELATIVE":const s=(t.position+a.action.spaces+40)%40;t.position=s,this.handleLanding(t);break;case"GO_TO_JAIL":this.sendToJail(t);break;case"GET_OUT_JAIL":const i=this.getOutOfJailCards.get(t.id)||0;this.getOutOfJailCards.set(t.id,i+1);break;case"PAY_EACH_PLAYER":{const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id),s=a.action.amount,i=s*e.length;t.money>=i&&(t.money-=i,e.forEach(e=>e.money+=s));break}case"COLLECT_FROM_EACH":{const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id),s=a.action.amount;e.forEach(e=>{e.money>=s&&(e.money-=s,t.money+=s)});break}case"REPAIRS":{const e=this.state.properties.filter(e=>e.ownerId===t.id),s=a.action.perHouse,i=a.action.perHotel;let n=0;e.forEach(e=>{5===e.houses?n+=i:n+=e.houses*s}),t.money>=n?t.money-=n:this.handleBankruptcy(t,null);break}}this.addLog({en:`${t.username}: ${h(a.text)}`,vi:`${t.username}: ${h(a.text)}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}handlePayJailFine(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];if(!t||t.id!==e||!t.inJail)return;const s=this.getOutOfJailCards.get(e)||0;s>0?(this.getOutOfJailCards.set(e,s-1),t.inJail=!1,t.jailTurns=0,this.addLog({en:`${t.username} used Get Out of Jail Free card`,vi:`${t.username} dùng thẻ Ra tù miễn phí`},"action")):t.money>=o&&(t.money-=o,t.inJail=!1,t.jailTurns=0,this.addLog({en:`${t.username} paid ${o}đ to leave jail`,vi:`${t.username} trả ${o}đ để ra tù`},"action")),this.notifyAndBroadcast()}handleBankruptcy(e,t){e.isBankrupt=!0,this.addLog({en:`${e.username} is bankrupt!`,vi:`${e.username} phá sản!`},"alert"),this.state.properties=this.state.properties.map(s=>s.ownerId===e.id?t?{...s,ownerId:t.id,houses:0}:null:s).filter(Boolean),t&&e.money>0&&(t.money+=e.money),e.money=0;const s=this.state.players.filter(e=>e.id&&!e.isBankrupt);if(1===s.length)this.state.gamePhase="ended",this.state.winner=s[0].id,this.addLog({en:`${s[0].username} wins!`,vi:`${s[0].username} chiến thắng!`},"alert");else{const t=this.state.players[this.state.currentPlayerIndex];t?.id===e.id&&this.endTurn()}}handleEndTurn(e){if(!this.isHost)return;const t=this.state.players[this.state.currentPlayerIndex];t&&t.id===e&&(this.state.pendingAction||this.state.hasRolled&&(this.state.canRollAgain&&!t.inJail||this.endTurn()))}endTurn(){this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.doublesCount=0,this.state.diceValues=null,this.state.pendingAction=null;let e=(this.state.currentPlayerIndex+1)%4,t=0;for(;t<4;){const s=this.state.players[e];if(s&&s.id&&!s.isBankrupt)break;e=(e+1)%4,t++}this.state.currentPlayerIndex=e;const s=this.state.players[e];this.addLog({en:`${s?.username}'s turn`,vi:`Lượt của ${s?.username}`},"info"),this.notifyAndBroadcast(),this.checkBotTurn()}handleAddBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(this.state.players[e].id)return;const t=`bot-${e}-${Date.now()}`,s=[...this.state.players];s[e]={...s[e],id:t,username:`Bot ${e+1}`,isBot:!0},this.state={...this.state,players:s},this.notifyAndBroadcast()}handleRemoveBot(e){if(!this.isHost)return;if(e<0||e>=4)return;if(!this.state.players[e].isBot)return;const t=[...this.state.players];t[e]={...t[e],id:null,username:`Player ${e+1}`,isBot:!1},this.state={...this.state,players:t},this.notifyAndBroadcast()}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const e=this.state.players[this.state.currentPlayerIndex];e?.isBot&&(e.isBankrupt?this.endTurn():setTimeout(()=>this.executeBotTurn(e),1e3))}executeBotTurn(e){if(!this.isHost||"playing"!==this.state.gamePhase)return;const t=this.state.players.find(t=>t.id===e.id);if(!t||t.isBankrupt)return;const s=e=>{let s=t.money;if(s>=e)return;const a=this.state.properties.filter(e=>e.ownerId===t.id),i=a.filter(e=>e.houses>0);for(const r of i){if(s>=e)break;for(;r.houses>0&&s<e;){const e=n[r.spaceId];this.handleSellHouse(t.id,r.spaceId),s+="property"===e.type&&e.houseCost?e.houseCost/2:0}}if(s<e){const i=a.filter(e=>!e.mortgaged&&0===e.houses);i.sort((e,t)=>{const s=n[e.spaceId],a=n[t.spaceId],i="property"!==s.type&&"railroad"!==s.type&&"utility"!==s.type||!s.price?0:s.price;return("property"!==a.type&&"railroad"!==a.type&&"utility"!==a.type||!a.price?0:a.price)-i});for(const a of i){if(s>=e)break;const i=n[a.spaceId];this.handleMortgage(t.id,a.spaceId),s+="property"!==i.type&&"railroad"!==i.type&&"utility"!==i.type||!i.price?0:i.price/2}}};if(this.state.pendingAction)switch(this.state.pendingAction.type){case"BUY_DECISION":const e=n[this.state.pendingAction.spaceId],a=1e3;return void("property"===e.type&&e?.price&&t.money>=e.price+a?this.handleBuyProperty(t.id,this.state.pendingAction.spaceId):this.handleDeclineProperty(t.id));case"PAY_RENT":return s(this.state.pendingAction.amount),void this.handlePayRent(t.id);case"PAY_TAX":return s(this.state.pendingAction.amount),void this.handlePayTax(t.id);case"CARD":const i=this.state.pendingAction.card;if("PAY"===i.action.type)s(i.action.amount);else if("PAY_EACH_PLAYER"===i.action.type){const e=this.state.players.filter(e=>e.id&&!e.isBankrupt&&e.id!==t.id).length;s(i.action.amount*e)}else i.action.type;return void this.handleUseCard(t.id)}if(t.inJail&&t.money>=o+500&&!this.state.hasRolled)return this.handlePayJailFine(t.id),void setTimeout(()=>this.executeBotTurn(t),500);if(!this.state.hasRolled||this.state.canRollAgain)return this.handleRollDice(t.id),void setTimeout(()=>this.executeBotTurn(t),1500);const a=this.state.properties.filter(e=>e.ownerId===t.id);for(const i of a){const e=n[i.spaceId];if(e&&"property"===e.type&&e.houseCost&&e.color&&i.houses<5&&!i.mortgaged){const s=n.filter(t=>"property"===t.type&&t.color===e.color),r=a.filter(e=>s.some(t=>t.id===e.spaceId)),o=this.canBuildHouse(t.id,i.spaceId);if(r.length===s.length&&"property"===e.type&&e.houseCost&&t.money>=e.houseCost+3e3&&o.allowed)return this.handleBuildHouse(t.id,i.spaceId),void setTimeout(()=>this.executeBotTurn(t),500)}}this.state.pendingAction||this.state.canRollAgain||this.handleEndTurn(t.id)}requestRollDice(){this.makeMove({type:"ROLL_DICE",playerId:this.userId})}requestBuyProperty(e){this.makeMove({type:"BUY_PROPERTY",playerId:this.userId,spaceId:e})}requestDeclineProperty(){this.makeMove({type:"DECLINE_PROPERTY",playerId:this.userId})}requestBuildHouse(e){this.makeMove({type:"BUILD_HOUSE",playerId:this.userId,spaceId:e})}requestPayRent(){this.makeMove({type:"PAY_RENT",playerId:this.userId})}requestPayTax(){this.makeMove({type:"PAY_TAX",playerId:this.userId})}requestUseCard(){this.makeMove({type:"USE_CARD",playerId:this.userId})}requestPayJailFine(){this.makeMove({type:"PAY_JAIL_FINE",playerId:this.userId})}requestEndTurn(){this.makeMove({type:"END_TURN",playerId:this.userId})}requestStartGame(){this.makeMove({type:"START_GAME"})}requestAddBot(e){this.makeMove({type:"ADD_BOT",slotIndex:e})}requestRemoveBot(e){this.makeMove({type:"REMOVE_BOT",slotIndex:e})}requestSync(){this.isHost?this.broadcastState():this.sendAction({type:"REQUEST_SYNC"})}requestOfferTrade(e,t,s){this.makeMove({type:"OFFER_TRADE",fromPlayerId:this.userId,toPlayerId:e,spaceId:t,price:s})}requestRespondTrade(e,t,s){this.makeMove({type:"RESPOND_TRADE",offerId:e,accepted:t,message:s})}requestResetGame(){this.isHost&&this.makeMove({type:"RESET_GAME"})}requestCancelTrade(e){this.makeMove({type:"CANCEL_TRADE",offerId:e})}requestSellHouse(e){this.makeMove({type:"SELL_HOUSE",playerId:this.userId,spaceId:e})}requestMortgage(e){this.makeMove({type:"MORTGAGE",playerId:this.userId,spaceId:e})}requestUnmortgage(e){this.makeMove({type:"UNMORTGAGE",playerId:this.userId,spaceId:e})}reset(){this.state.players.forEach(e=>{e.id&&(e.position=0,e.money=a,e.inJail=!1,e.jailTurns=0,e.isBankrupt=!1,e.moneyHistory=[a])}),this.state.properties=[],this.state.currentPlayerIndex=this.findFirstActivePlayer(),this.state.diceValues=null,this.state.doublesCount=0,this.state.hasRolled=!1,this.state.canRollAgain=!1,this.state.gamePhase="waiting",this.state.winner=null,this.state.pendingAction=null,this.state.logs=[],this.addLog({en:"Game reset!",vi:"Trò chơi được đặt lại!"},"info"),this.getOutOfJailCards.clear(),this.chanceCards=[...t].sort(()=>Math.random()-.5),this.chestCards=[...s].sort(()=>Math.random()-.5),this.notifyAndBroadcast()}checkGameEnd(){const e=this.state.players.filter(e=>e.id&&!e.isBankrupt);return e.length<=1&&"playing"===this.state.gamePhase?{winner:e[0]?.id||void 0}:null}updatePlayers(e){this.state.players.forEach((e,t)=>{e.isBot||(e.id=null,e.username=`Player ${t+1}`)});let t=0;for(let s=0;s<4&&!(t>=e.length);s++)this.state.players[s].isBot||(this.state.players[s].id=e[t].id,this.state.players[s].username=e[t].username,t++);this.onStateChange?.(this.state),this.isHost&&this.broadcastState()}getMyPlayerIndex(){return this.state.players.findIndex(e=>e.id===this.userId)}canStartGame(){return this.state.players.filter(e=>null!==e.id).length>=2}getPlayerProperties(e){return this.state.properties.filter(t=>t.ownerId===e)}}export{l as default};
