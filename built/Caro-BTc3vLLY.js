import{B as t}from"./BaseGame-DUxbXJM9.js";import"./socket-DRbsQkF5.js";import"./index-C-PEJHEx.js";import"./react-vendor-CuhjoSvJ.js";import"./zustand-BnWM_GpQ.js";const e=50;class s extends t{getInitState(){return{board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:{X:this.players[0],O:this.players[1]},gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null,gamePhase:"waiting"}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"MAKE_MOVE":this.makeMove(e);break;case"UNDO_REQUEST":this.handleUndoRequest(e.playerId);break;case"UNDO_RESPONSE":this.handleUndoResponse(e.accepted);break;case"SWITCH_TURN":this.handleSwitchTurn();break;case"RESET_GAME":this.reset();break;case"START_GAME":this.handleStartGame()}}makeMove(t){const{row:e,col:s,playerId:a}=t;if("playing"!==this.state.gamePhase)return;if(this.state.gameOver)return;const i=`${e},${s}`;if(this.state.board[i])return;const n=this.getPlayerSymbolInternal(a);if(!n||n!==this.state.currentTurn)return;this.state.board[i]=n,this.state.history.push(i),this.state.pendingUndoRequest=null;const r=this.checkWin(e,s,n);r?(this.state.winner=n,this.state.winningLine=r,this.state.gameOver=!0,this.clearSavedState()):this.state.currentTurn="X"===n?"O":"X",this.syncState(),this.checkBotTurn()}reset(){this.state={board:{},currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:this.state.players,gameOver:!1,history:[],lastMove:null,pendingUndoRequest:null,gamePhase:"waiting"},this.syncState()}updatePlayers(t){const e=t[0]||null;let s=t[1]||null;!s?.isBot&&s||(s={id:"BOT",username:"Bot",isHost:!1,isBot:!0}),this.state.players={X:e,O:s},this.syncState()}checkWin(t,s,a){const i=[[0,1],[1,0],[1,1],[1,-1]];for(const[n,r]of i){const i=[[t,s]];let o=t+n,h=s+r;for(;o>=0&&o<e&&h>=0&&h<e&&this.state.board[`${o},${h}`]===a;)i.push([o,h]),o+=n,h+=r;for(o=t-n,h=s-r;o>=0&&o<e&&h>=0&&h<e&&this.state.board[`${o},${h}`]===a;)i.push([o,h]),o-=n,h-=r;if(i.length>=5)return i}return null}getPlayerSymbolInternal(t){return this.state.players.X?.id===t?"X":this.state.players.O?.id===t?"O":null}getPlayerSymbol(){return this.getPlayerSymbolInternal(this.userId)}requestMove(t,e){const s={type:"MAKE_MOVE",row:t,col:e,playerId:this.userId};this.isHost?this.makeMove(s):this.sendSocketGameAction(s)}requestUndo(){const t={type:"UNDO_REQUEST",playerId:this.userId};this.isHost?this.handleUndoRequest(this.userId):this.sendSocketGameAction(t)}responseUndo(t){const e={type:"UNDO_RESPONSE",accepted:t};this.isHost?this.handleUndoResponse(t):this.sendSocketGameAction(e)}switchTurn(){this.isHost?this.handleSwitchTurn():this.sendSocketGameAction({type:"SWITCH_TURN"})}requestReset(){this.isHost?this.reset():this.sendSocketGameAction({type:"RESET_GAME"})}handleUndoRequest(t){if(0===this.state.history.length)return;const e=this.state.history[this.state.history.length-1];this.state.board[e]===this.getPlayerSymbolInternal(t)&&(this.state.pendingUndoRequest=t,this.syncState())}handleUndoResponse(t){if(t){const t=this.state.history.pop();t&&(delete this.state.board[t],this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.state.gameOver=!1,this.state.winner=null,this.state.winningLine=null),this.state.pendingUndoRequest=null}else this.state.pendingUndoRequest=null;this.syncState()}handleSwitchTurn(){this.state.gameOver||this.state.history.length>0||(this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.syncState())}addBot(){this.isHost&&"waiting"===this.state.gamePhase&&(this.state.players.O={id:"BOT",username:"Bot",isHost:!1,isBot:!0},this.syncState())}removeBot(){this.isHost&&"waiting"===this.state.gamePhase&&this.state.players.O?.isBot&&(this.state.players.O=null,this.syncState())}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players.X&&this.state.players.O&&(this.state.gamePhase="playing",this.syncState(),this.checkBotTurn())}startGame(){this.isHost?this.handleStartGame():this.sendSocketGameAction({type:"START_GAME"})}canStartGame(){return!!this.state.players.X&&!!this.state.players.O&&"waiting"===this.state.gamePhase}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t="X"===this.state.currentTurn?this.state.players.X:this.state.players.O;t?.isBot&&!this.state.gameOver&&setTimeout(()=>this.makeBotMove(),600)}makeBotMove(){if(this.state.gameOver)return;const t=this.getBestMove();t&&this.makeMove({type:"MAKE_MOVE",row:t.row,col:t.col,playerId:"BOT"})}getBestMove(){const t=this.getCandidateMoves();if(0===t.length)return{row:Math.floor(25),col:Math.floor(25)};let e=-1/0,s=[];for(const a of t){const{row:t,col:i}=a,n=this.evaluateMove(t,i,"O","X");n>e?(e=n,s=[a]):n===e&&s.push(a)}if(s.length>0){return s[Math.floor(Math.random()*s.length)]}return null}getCandidateMoves(){const t=new Set,s=Object.keys(this.state.board);if(0===s.length)return[];const a=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const i of s){const[s,n]=i.split(",").map(Number);for(const[i,r]of a){const a=s+i,o=n+r;a>=0&&a<e&&o>=0&&o<e&&!this.state.board[`${a},${o}`]&&t.add(`${a},${o}`)}}return Array.from(t).map(t=>{const[e,s]=t.split(",").map(Number);return{row:e,col:s}})}evaluateMove(t,e,s,a){let i=0;const n=[[0,1],[1,0],[1,1],[1,-1]];for(const[r,o]of n)i+=this.evaluateLine(t,e,r,o,s,!0),i+=this.evaluateLine(t,e,r,o,a,!1);return i}evaluateLine(t,s,a,i,n,r){let o=0,h=0,l=t+a,u=s+i;for(;this.state.board[`${l},${u}`]===n;)o++,l+=a,u+=i;for(l>=0&&l<e&&u>=0&&u<e&&!this.state.board[`${l},${u}`]&&h++,l=t-a,u=s-i;this.state.board[`${l},${u}`]===n;)o++,l-=a,u-=i;l>=0&&l<e&&u>=0&&u<e&&!this.state.board[`${l},${u}`]&&h++;const c=o+1;if(c>=5)return 1e5;if(4===c){if(2===h)return 1e4;if(1===h)return r?1e3:2e3}if(3===c){if(2===h)return r?500:1e3;if(1===h)return 100}return 2===c&&2===h?10:c}}export{s as default};
