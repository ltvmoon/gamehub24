import{B as t}from"./BaseGame-BjLvdXwv.js";import"./socket-DRbsQkF5.js";class e extends t{state;onStateChange;constructor(t,e,s,a,i){super(t,e,s,a),this.state={board:Array(9).fill(null),currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:{X:i[0]?.id||null,O:i[1]?.id||null},gameOver:!1,lastMoveIndex:null,gamePhase:"waiting"},this.init()}init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;"MAKE_MOVE"===e.type&&this.isHost?this.makeMove(e):"RESET_GAME"===e.type&&this.isHost?this.reset():"SWITCH_TURN"===e.type&&this.isHost?this.handleSwitchTurn():"START_GAME"===e.type&&this.isHost&&this.handleStartGame()}makeMove(t){if("MAKE_MOVE"!==t.type)return;const{cellIndex:e,playerId:s}=t;if("playing"!==this.state.gamePhase)return;if(this.state.gameOver)return;if(null!==this.state.board[e])return;const a=this.getPlayerSymbolInternal(s);if(!a)return;if(a!==this.state.currentTurn)return;this.state.board[e]=a,this.state.lastMoveIndex=e;const i=this.checkGameEnd();i?(this.state.winner=i.winner||null,i.pattern&&(this.state.winningLine=i.pattern),this.state.isDraw=i.isDraw||!1,this.state.gameOver=!0,this.broadcastGameEnd(i)):this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkGameEnd(){const{board:t}=this.state,e=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const s of e){const[e,a,i]=s;if(t[e]&&t[e]===t[a]&&t[e]===t[i])return{winner:t[e],pattern:s}}return t.every(t=>null!==t)?{isDraw:!0}:null}reset(){this.state={board:Array(9).fill(null),currentTurn:"X",winner:null,winningLine:null,isDraw:!1,players:this.state.players,gameOver:!1,lastMoveIndex:null,gamePhase:"waiting"},this.broadcastState(),this.setState({...this.state})}updatePlayers(t){this.state.players.X=t[0]?.id||null,t[1]?this.state.players.O=t[1].id:"BOT"!==this.state.players.O&&(this.state.players.O=null),this.broadcastState(),this.setState({...this.state})}requestMove(t){const e={type:"MAKE_MOVE",cellIndex:t,playerId:this.userId};this.isHost?this.makeMove(e):this.sendAction(e)}requestReset(){this.isHost?this.reset():this.sendAction({type:"RESET_GAME"})}handleSwitchTurn(){this.state.gameOver||this.state.board.some(t=>null!==t)||(this.state.currentTurn="X"===this.state.currentTurn?"O":"X",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}switchTurn(){this.isHost?this.handleSwitchTurn():this.sendAction({type:"SWITCH_TURN"})}addBot(){this.isHost&&"waiting"===this.state.gamePhase&&(this.state.players.O="BOT",this.broadcastState(),this.setState({...this.state}))}removeBot(){this.isHost&&"waiting"===this.state.gamePhase&&"BOT"===this.state.players.O&&(this.state.players.O=null,this.broadcastState(),this.setState({...this.state}))}handleStartGame(){"waiting"===this.state.gamePhase&&this.state.players.X&&this.state.players.O&&(this.state.gamePhase="playing",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}startGame(){this.isHost?this.handleStartGame():this.sendAction({type:"START_GAME"})}canStartGame(){return!!this.state.players.X&&!!this.state.players.O&&"waiting"===this.state.gamePhase}checkBotTurn(){if(!this.isHost)return;"BOT"!==("X"===this.state.currentTurn?this.state.players.X:this.state.players.O)||this.state.gameOver||setTimeout(()=>this.makeBotMove(),600)}makeBotMove(){if(this.state.gameOver)return;const t=this.getBestMove();-1!==t&&this.makeMove({type:"MAKE_MOVE",cellIndex:t,playerId:"BOT"})}getBestMove(){const t=this.state.board;let e=-1/0,s=-1;for(let a=0;a<9;a++)if(null===t[a]){t[a]="O";const i=this.minimax(t,0,!1,"O","X");t[a]=null,i>e&&(e=i,s=a)}return s}minimax(t,e,s,a,i){const n=this.checkWinInternal(t);if(n===a)return 10-e;if(n===i)return e-10;if("draw"===n)return 0;if(s){let s=-1/0;for(let n=0;n<9;n++)if(null===t[n]){t[n]=a;const r=this.minimax(t,e+1,!1,a,i);t[n]=null,s=Math.max(r,s)}return s}{let s=1/0;for(let n=0;n<9;n++)if(null===t[n]){t[n]=i;const r=this.minimax(t,e+1,!0,a,i);t[n]=null,s=Math.min(r,s)}return s}}checkWinInternal(t){const e=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const s of e){const[e,a,i]=s;if(t[e]&&t[e]===t[a]&&t[e]===t[i])return t[e]}return t.every(t=>null!==t)?"draw":null}getPlayerSymbolInternal(t){return this.state.players.X===t?"X":this.state.players.O===t?"O":null}getPlayerSymbol(){return this.getPlayerSymbolInternal(this.userId)}}export{e as default};
