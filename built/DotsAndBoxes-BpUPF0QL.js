import{B as t}from"./BaseGame-BjLvdXwv.js";import"./socket-DRbsQkF5.js";class e extends t{state;onStateChange;constructor(t,e,s,i,a){super(t,e,s,i);const r=[{id:a[0]?.id||null,username:a[0]?.username||"Player 1",color:"red",score:0,isBot:!1},{id:a[1]?.id||null,username:a[1]?.username||"Player 2",color:"blue",score:0,isBot:!1}];this.state={gridSize:6,horizontalLines:Array(6).fill(null).map(()=>Array(5).fill(!1)),verticalLines:Array(5).fill(null).map(()=>Array(6).fill(!1)),boxes:Array(5).fill(null).map(()=>Array(5).fill(null)),players:r,currentPlayerIndex:0,winner:null,isGameEnded:!1,gamePhase:"waiting",lastLine:null,undoRequest:null},this.init()}moveHistory=[];init(){this.isHost&&this.broadcastState()}onUpdate(t){this.onStateChange=t}getState(){return{...this.state}}setState(t){this.state=t,this.onStateChange?.(this.state)}handleAction(t){const e=t.action;if(this.isHost||"REQUEST_SYNC"===e.type)switch(e.type){case"PLACE_LINE":this.handlePlaceLine(e.playerId,e.lineType,e.row,e.col);break;case"START_GAME":this.handleStartGame();break;case"RESET":this.reset();break;case"REQUEST_SYNC":this.broadcastState();break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"REMOVE_BOT":this.handleRemoveBot(e.slotIndex);break;case"REQUEST_UNDO":this.handleRequestUndo(e.playerId);break;case"APPROVE_UNDO":this.handleApproveUndo();break;case"REJECT_UNDO":this.handleRejectUndo()}}makeMove(t){this.isHost?this.handleAction({action:t}):this.sendAction(t)}handleAddBot(t){this.state.isGameEnded||this.state.boxes.some(t=>t.some(t=>null!==t))||t<0||t>=2||(this.state.players[t]={...this.state.players[t],id:`BOT_${Date.now()}_${t}`,username:`Bot ${t+1}`,isBot:!0},this.broadcastState(),this.setState({...this.state}))}handleRemoveBot(t){this.state.isGameEnded||this.state.boxes.some(t=>t.some(t=>null!==t))||t<0||t>=2||this.state.players[t].isBot&&(this.state.players[t]={...this.state.players[t],id:null,username:`Player ${t+1}`,isBot:!1},this.broadcastState(),this.setState({...this.state}))}handleStartGame(){this.canStartGame()&&(this.reset(),this.state.gamePhase="playing",this.broadcastState(),this.setState({...this.state}),this.checkBotTurn())}canStartGame(){return this.state.players.every(t=>null!==t.id)}handlePlaceLine(t,e,s,i){if("playing"!==this.state.gamePhase)return;const a=this.state.players[this.state.currentPlayerIndex];if(a.id!==t)return;if(this.state.isGameEnded)return;if("horizontal"===e){if(s<0||s>=this.state.gridSize||i<0||i>=this.state.gridSize-1)return;if(this.state.horizontalLines[s][i])return}else{if(s<0||s>=this.state.gridSize-1||i<0||i>=this.state.gridSize)return;if(this.state.verticalLines[s][i])return}"horizontal"===e?this.state.horizontalLines[s][i]=!0:this.state.verticalLines[s][i]=!0;const r=this.checkCompletedBoxes(e,s,i);this.moveHistory.push({line:{type:e,row:s,col:i},playerId:t,boxesCaptured:r,prevPlayerIndex:this.state.currentPlayerIndex}),r.length>0?r.forEach(e=>{this.state.boxes[e.row][e.col]=t,a.score++}):this.state.currentPlayerIndex=(this.state.currentPlayerIndex+1)%this.state.players.length,this.state.lastLine={type:e,row:s,col:i},this.state.undoRequest=null,this.updateGameStatus(),this.broadcastState(),this.setState({...this.state}),this.checkBotTurn()}checkBotTurn(){if(this.state.isGameEnded)return;const t=this.state.players[this.state.currentPlayerIndex];t.isBot&&t.id&&setTimeout(()=>this.executeBotTurn(t.id),800)}executeBotTurn(t){if(this.state.isGameEnded)return;if(this.state.players[this.state.currentPlayerIndex].id!==t)return;const e=this.calculateBestMove(t);e&&this.handlePlaceLine(t,e.lineType,e.row,e.col)}calculateBestMove(t){const e=this.findScoringMove();if(e)return e;const s=this.findSafeMove();return s||this.findRandomMove()}findScoringMove(){for(let t=0;t<this.state.gridSize;t++)for(let e=0;e<this.state.gridSize-1;e++)if(!this.state.horizontalLines[t][e]){this.state.horizontalLines[t][e]=!0;const s=this.checkCompletedBoxes("horizontal",t,e);if(this.state.horizontalLines[t][e]=!1,s.length>0)return{lineType:"horizontal",row:t,col:e}}for(let t=0;t<this.state.gridSize-1;t++)for(let e=0;e<this.state.gridSize;e++)if(!this.state.verticalLines[t][e]){this.state.verticalLines[t][e]=!0;const s=this.checkCompletedBoxes("vertical",t,e);if(this.state.verticalLines[t][e]=!1,s.length>0)return{lineType:"vertical",row:t,col:e}}return null}findSafeMove(){const t=[];for(let e=0;e<this.state.gridSize;e++)for(let s=0;s<this.state.gridSize-1;s++)this.state.horizontalLines[e][s]||t.push({lineType:"horizontal",row:e,col:s});for(let e=0;e<this.state.gridSize-1;e++)for(let s=0;s<this.state.gridSize;s++)this.state.verticalLines[e][s]||t.push({lineType:"vertical",row:e,col:s});for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}for(const e of t)if(!this.doesMoveGiveAwayBox(e))return e;return null}doesMoveGiveAwayBox(t){let e=!1;return"horizontal"===t.lineType?(this.state.horizontalLines[t.row][t.col]=!0,e=this.checkIfAnyBoxHas3Sides(t.lineType,t.row,t.col),this.state.horizontalLines[t.row][t.col]=!1):(this.state.verticalLines[t.row][t.col]=!0,e=this.checkIfAnyBoxHas3Sides(t.lineType,t.row,t.col),this.state.verticalLines[t.row][t.col]=!1),e}checkIfAnyBoxHas3Sides(t,e,s){if("horizontal"===t){if(e>0&&3===this.countBoxSides(e-1,s))return!0;if(e<this.state.gridSize-1&&3===this.countBoxSides(e,s))return!0}else{if(s>0&&3===this.countBoxSides(e,s-1))return!0;if(s<this.state.gridSize-1&&3===this.countBoxSides(e,s))return!0}return!1}countBoxSides(t,e){let s=0;return this.state.horizontalLines[t][e]&&s++,this.state.horizontalLines[t+1][e]&&s++,this.state.verticalLines[t][e]&&s++,this.state.verticalLines[t][e+1]&&s++,s}findRandomMove(){for(let t=0;t<this.state.gridSize;t++)for(let e=0;e<this.state.gridSize-1;e++)if(!this.state.horizontalLines[t][e])return{lineType:"horizontal",row:t,col:e};for(let t=0;t<this.state.gridSize-1;t++)for(let e=0;e<this.state.gridSize;e++)if(!this.state.verticalLines[t][e])return{lineType:"vertical",row:t,col:e};return null}checkCompletedBoxes(t,e,s){const i=[],a=(t,e)=>{const s=this.state.horizontalLines[t][e],i=this.state.horizontalLines[t+1][e],a=this.state.verticalLines[t][e],r=this.state.verticalLines[t][e+1];return s&&i&&a&&r};return"horizontal"===t?(e>0&&a(e-1,s)&&i.push({row:e-1,col:s}),e<this.state.gridSize-1&&a(e,s)&&i.push({row:e,col:s})):(s>0&&a(e,s-1)&&i.push({row:e,col:s-1}),s<this.state.gridSize-1&&a(e,s)&&i.push({row:e,col:s})),i}updateGameStatus(){const t=(this.state.gridSize-1)*(this.state.gridSize-1);if(this.state.players.reduce((t,e)=>t+e.score,0)===t){this.state.isGameEnded=!0;const t=this.state.players[0],e=this.state.players[1];t.score>e.score?this.state.winner=t.id:e.score>t.score?this.state.winner=e.id:this.state.winner="draw"}}reset(){this.state={...this.state,horizontalLines:Array(this.state.gridSize).fill(null).map(()=>Array(this.state.gridSize-1).fill(!1)),verticalLines:Array(this.state.gridSize-1).fill(null).map(()=>Array(this.state.gridSize).fill(!1)),boxes:Array(this.state.gridSize-1).fill(null).map(()=>Array(this.state.gridSize-1).fill(null)),currentPlayerIndex:0,winner:null,isGameEnded:!1,gamePhase:"waiting",lastLine:null,undoRequest:null},this.state.players.forEach(t=>t.score=0),this.moveHistory=[],this.broadcastState(),this.setState({...this.state})}handleRequestUndo(t){0!==this.moveHistory.length&&(this.state.undoRequest||(this.state.undoRequest={requesterId:t},this.broadcastState(),this.setState({...this.state})))}handleRejectUndo(){this.state.undoRequest=null,this.broadcastState(),this.setState({...this.state})}handleApproveUndo(){const t=this.moveHistory.pop();if(!t)return void(this.state.undoRequest=null);"horizontal"===t.line.type?this.state.horizontalLines[t.line.row][t.line.col]=!1:this.state.verticalLines[t.line.row][t.line.col]=!1;const e=this.state.players.find(e=>e.id===t.playerId);e&&(e.score-=t.boxesCaptured.length),t.boxesCaptured.forEach(t=>{this.state.boxes[t.row][t.col]=null}),this.state.currentPlayerIndex=t.prevPlayerIndex,this.state.isGameEnded=!1,this.state.winner=null;const s=this.moveHistory[this.moveHistory.length-1];this.state.lastLine=s?s.line:null,this.state.undoRequest=null,this.broadcastState(),this.setState({...this.state})}updatePlayers(t){for(let e=0;e<2;e++){const s=t[e];s?(this.state.players[e].id=s.id,this.state.players[e].username=s.username,this.state.players[e].isBot=!1):this.state.players[e].isBot||(this.state.players[e].id=null,this.state.players[e].username=`Player ${e+1}`,this.state.players[e].isBot=!1)}this.broadcastState(),this.setState({...this.state})}requestPlaceLine(t,e,s){const i={type:"PLACE_LINE",lineType:t,row:e,col:s,playerId:this.userId};this.makeMove(i)}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeMove(e)}requestRemoveBot(t){const e={type:"REMOVE_BOT",slotIndex:t};this.makeMove(e)}requestUndo(){const t={type:"REQUEST_UNDO",playerId:this.userId};this.makeMove(t)}approveUndo(){this.makeMove({type:"APPROVE_UNDO"})}rejectUndo(){this.makeMove({type:"REJECT_UNDO"})}requestNewGame(){this.makeMove({type:"RESET"})}requestStartGame(){this.makeMove({type:"START_GAME"})}requestSync(){const t={type:"REQUEST_SYNC"};this.isHost?this.broadcastState():this.sendAction(t)}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}}export{e as default};
