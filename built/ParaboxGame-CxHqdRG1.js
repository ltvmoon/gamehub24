import{B as e}from"./BaseGame-CsKbx1S6.js";import{I as t,T as s,a as r,b as i,c as n}from"./constants-HSy5Gk2x.js";import"./socket-DRbsQkF5.js";import"./index-BwFFTHxy.js";import"./react-vendor-BqGe223k.js";import"./zustand-B1murped.js";class l extends e{gameName="parabox";getInitState(){return{levels:JSON.parse(JSON.stringify(t)),players:{},winners:[]}}init(){this.ensurePlayerState(this.userId)}updatePlayers(e){super.updatePlayers(e),this.ensurePlayerState(this.userId),this.isHost&&e.forEach(e=>this.ensurePlayerState(e.id))}onSocketGameState(e){super.onSocketGameState(e),this.players.some(e=>e.id===this.userId)&&this.ensurePlayerState(this.userId)}resolveLevelId(e){return e.split("#")[0]}isPlayerAt(e,t,s,r){return Object.values(this.state.players).some(i=>i.currentLevelId===e&&i.pos.x===t&&i.pos.y===s&&i.id!==r)}ensurePlayerState(e){const t=this.players.find(t=>t.id===e);t&&(this.state.players[e]||(this.state.players[e]={id:e,username:t.username||"Unknown",pos:{x:3,y:5},currentLevelId:"root",levelStack:[]}))}onSocketGameAction({action:e}){if(!this.isHost)return;const t=e,s=t.playerId;this.ensurePlayerState(s),"MOVE"===t.type&&t.direction?this.handleMove(s,t.direction):"RESET"===t.type&&this.handleReset(s)}handleReset(e){const s={};Object.keys(this.state.players).forEach(e=>{s[e]={id:e,username:this.state.players[e].username,pos:{x:3,y:5},currentLevelId:"root",levelStack:[]}}),this.setState({levels:JSON.parse(JSON.stringify(t)),players:s,winners:[]})}checkBlockedMove(e,t){return!this.handleMove(e,t,!0)}handleMove(e,t,i=!1){const n=this.state.players[e],l=this.state.levels[n.currentLevelId];if(!l)return!1;let o=0,a=0;"up"===t&&(a=-1),"down"===t&&(a=1),"left"===t&&(o=-1),"right"===t&&(o=1);const h=n.pos.x+o,d=n.pos.y+a;if(this.isPlayerAt(n.currentLevelId,h,d,e))return!1;if(h<0||h>=l.width||d<0||d>=l.height){if(n.levelStack.length>0){const l=n.levelStack[n.levelStack.length-1],h=this.state.levels[l.levelId],d=l.pos.x+o,y=l.pos.y+a;if(this.isPlayerAt(l.levelId,d,y,e))return!1;if(d<0||d>=h.width||y<0||y>=h.height||h.grid[y][d]===s)return!1;if(h.grid[y][d]===r){if(!this.tryPerformPush(l.levelId,{x:d,y:y},t,n.levelStack.slice(0,-1),i))return!1}return i||(n.currentLevelId=l.levelId,n.levelStack.pop(),n.pos={x:d,y:y}),!0}return!1}const y=l.grid[d][h];if(y===s)return!1;if(y===r){const e=l.boxContents?.[`${h},${d}`];if(this.tryPerformPush(n.currentLevelId,{x:h,y:d},t,n.levelStack,i))return i||(n.pos={x:h,y:d}),!0;if(e&&this.isEdgeEnterable(this.resolveLevelId(e),t)){const s=this.resolveLevelId(e),l=this.state.levels[s],o=this.getEntryPos(s,t),a=l.grid[o.y][o.x];let y=!1;if(this.isWalkableForBox(a))y=!0;else if(a===r){this.tryPerformPush(s,o,t,[{levelId:n.currentLevelId,pos:{x:h,y:d}},...n.levelStack],i)&&(y=!0)}if(y)return i||(n.levelStack.push({levelId:n.currentLevelId,pos:{x:h,y:d}}),n.currentLevelId=s,n.pos=o),!0}return!1}return i||(n.pos={x:h,y:d},this.checkWinCondition()),!0}checkWinCondition(){let e=!0;for(const t of Object.values(this.state.levels)){for(let s=0;s<t.height;s++){for(let r=0;r<t.width;r++)if(t.grid[s][r]===i){e=!1;break}if(!e)break}if(!e)break}e&&0===this.state.winners.length&&(this.state.winners=this.players.map(e=>e.id))}isWalkableForBox(e){return e===n||e===i}getBaseTile(e,s,r){const l=this.resolveLevelId(e);return t[l].grid[r][s]===i?i:n}isEdgeEnterable(e,t){const r=this.state.levels[e];return"up"===t?r.grid[r.height-1].some(e=>e!==s):"down"===t?r.grid[0].some(e=>e!==s):"left"===t?r.grid.some(e=>e[r.width-1]!==s):"right"===t&&r.grid.some(e=>e[0]!==s)}getEntryPos(e,t){const r=this.state.levels[e];let i=0,n=0;const l=Math.floor(r.width/2),o=Math.floor(r.height/2);if("up"===t?(i=l,n=r.height-1):"down"===t?(i=l,n=0):"left"===t?(i=r.width-1,n=o):"right"===t&&(i=0,n=o),r.grid[n][i]===s){let e=i,l=n,o=1/0;const a="up"===t||"down"===t?r.width:r.height;for(let h=0;h<a;h++){const a="up"===t||"down"===t?h:i,d="left"===t||"right"===t?h:n;if(r.grid[d][a]!==s){const t=Math.abs(a-i)+Math.abs(d-n);t<o&&(o=t,e=a,l=d)}}return{x:e,y:l}}return{x:i,y:n}}tryPerformPush(e,t,s,i,n=!1){const l=this.state.levels[this.resolveLevelId(e)];if(!l)return!1;let o=0,a=0;"up"===s&&(a=-1),"down"===s&&(a=1),"left"===s&&(o=-1),"right"===s&&(o=1);const h=t.x+o,d=t.y+a,y=l.boxContents?.[`${t.x},${t.y}`];if(h<0||h>=l.width||d<0||d>=l.height){if(0===i.length)return!1;const h=i[i.length-1],d=h.pos.x+o,u=h.pos.y+a,c=this.state.levels[h.levelId];if(this.isPlayerAt(h.levelId,d,u))return!1;if(d<0||d>=c.width||u<0||u>=c.height){const r=this.tryPerformPush(e,t,s,i.slice(0,-1),n);return r&&!n&&(l.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete l.boxContents[`${t.x},${t.y}`]),r}const x=c.grid[u][d];return(this.isWalkableForBox(x)||!(x!==r||!this.tryPerformPush(h.levelId,{x:d,y:u},s,i.slice(0,-1),n)))&&(n||(l.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete l.boxContents[`${t.x},${t.y}`],c.grid[u][d]=r,y&&(c.boxContents||(c.boxContents={}),c.boxContents[`${d},${u}`]=y)),!0)}const u=l.grid[d][h];if(this.isPlayerAt(e,h,d))return!1;if(this.isWalkableForBox(u))return n||(l.grid[d][h]=r,l.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&(l.boxContents||(l.boxContents={}),delete l.boxContents[`${t.x},${t.y}`],l.boxContents[`${h},${d}`]=y)),!0;if(u===r){if(this.tryPerformPush(e,{x:h,y:d},s,i,n))return n||(l.grid[d][h]=r,l.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&(l.boxContents||(l.boxContents={}),delete l.boxContents[`${t.x},${t.y}`],l.boxContents[`${h},${d}`]=y)),!0;const o=l.boxContents?.[`${h},${d}`];if(o&&this.isEdgeEnterable(this.resolveLevelId(o),s)){const a=this.resolveLevelId(o),u=this.state.levels[a],c=this.getEntryPos(a,s);let x=!1;if(this.isPlayerAt(a,c.x,c.y)?x=!1:this.isWalkableForBox(u.grid[c.y][c.x])?x=!0:u.grid[c.y][c.x]===r&&(x=this.tryPerformPush(a,c,s,[{levelId:e,pos:{x:h,y:d}},...i],n)),x)return n||(l.grid[t.y][t.x]=this.getBaseTile(e,t.x,t.y),y&&delete l.boxContents[`${t.x},${t.y}`],u.grid[c.y][c.x]=r,y&&(u.boxContents||(u.boxContents={}),u.boxContents[`${c.x},${c.y}`]=y)),!0}}return!1}}export{l as default};
